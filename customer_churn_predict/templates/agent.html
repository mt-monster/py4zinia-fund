<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Agent 对话界面 - 客户流失预警系统</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/font-awesome@4.7.0/css/font-awesome.min.css" rel="stylesheet">
    <link href="{{ url_for('static', filename='css/style.css') }}" rel="stylesheet">
</head>
<body>
    <div class="header">
        <div class="container">
            <h1 class="display-4">
                <i class="fa fa-robot" aria-hidden="true"></i>
                Agent 对话界面
            </h1>
            <p class="lead">与 AI Agent 进行自然语言交互</p>
        </div>
    </div>

    <div class="container">
        <!-- Agent 状态 -->
        <div class="row mb-4">
            <div class="col-md-12">
                <div class="card">
                    <div class="card-body">
                        <h5 class="card-title">
                            <i class="fa fa-info-circle" aria-hidden="true"></i>
                            Agent 状态
                        </h5>
                        <div class="row">
                            <div class="col-md-3">
                                <strong>工具数量:</strong> <span id="tools-count">-</span>
                            </div>
                            <div class="col-md-3">
                                <strong>记忆数量:</strong> <span id="memory-count">-</span>
                            </div>
                            <div class="col-md-3">
                                <strong>LLM状态:</strong> <span id="llm-status">-</span>
                            </div>
                            <div class="col-md-3">
                                <button id="refresh-status-btn" class="btn btn-sm btn-secondary">
                                    <i class="fa fa-refresh"></i> 刷新状态
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- 对话区域 -->
        <div class="row mb-4">
            <div class="col-md-12">
                <div class="card">
                    <div class="card-body">
                        <h5 class="card-title">
                            <i class="fa fa-comments" aria-hidden="true"></i>
                            对话
                        </h5>
                        <div id="chat-container" class="chat-container">
                            <div class="message agent">
                                <div>您好！我是客户流失预警 Agent，可以帮您：</div>
                                <ul>
                                    <li>训练流失预测模型</li>
                                    <li>预测客户流失风险</li>
                                    <li>生成分析报告</li>
                                </ul>
                                <div class="message-time">系统消息</div>
                            </div>
                        </div>
                        <div class="mt-3">
                            <div class="input-group">
                                <input type="text" id="message-input" class="form-control" 
                                       placeholder="输入您的指令，例如：请帮我训练一个流失预测模型">
                                <button id="send-btn" class="btn btn-primary">
                                    <i class="fa fa-paper-plane"></i> 发送
                                </button>
                                <button id="clear-chat-btn" class="btn btn-secondary">
                                    <i class="fa fa-trash"></i> 清空
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- 执行计划展示 -->
        <div class="row mb-4" id="plan-section" style="display: none;">
            <div class="col-md-12">
                <div class="card">
                    <div class="card-body">
                        <h5 class="card-title">
                            <i class="fa fa-list-alt" aria-hidden="true"></i>
                            执行计划
                        </h5>
                        <div id="plan-container"></div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/axios/dist/axios.min.js"></script>
    <script>
        const API_BASE_URL = 'http://localhost:8000/api';
        
        const chatContainer = document.getElementById('chat-container');
        const messageInput = document.getElementById('message-input');
        const sendBtn = document.getElementById('send-btn');
        const clearChatBtn = document.getElementById('clear-chat-btn');
        const refreshStatusBtn = document.getElementById('refresh-status-btn');
        const planSection = document.getElementById('plan-section');
        const planContainer = document.getElementById('plan-container');

        // 发送消息
        sendBtn.addEventListener('click', sendMessage);
        messageInput.addEventListener('keypress', (e) => {
            if (e.key === 'Enter') sendMessage();
        });

        function sendMessage() {
            const message = messageInput.value.trim();
            if (!message) return;

            // 添加用户消息
            addMessage(message, 'user');
            messageInput.value = '';

            // 发送到 Agent
            axios.post(`${API_BASE_URL}/agent/chat`, { message })
                .then(response => {
                    const data = response.data;
                    addMessage(data.response, 'agent');
                    
                    // 显示执行计划
                    if (data.plan && data.plan.length > 0) {
                        displayPlan(data.plan);
                    }
                })
                .catch(error => {
                    addMessage('错误: ' + (error.response?.data?.message || error.message), 'agent');
                });
        }

        function addMessage(text, type) {
            const messageDiv = document.createElement('div');
            messageDiv.className = `message ${type}`;
            messageDiv.innerHTML = `
                <div>${text.replace(/\n/g, '<br>')}</div>
                <div class="message-time">${new Date().toLocaleTimeString()}</div>
            `;
            chatContainer.appendChild(messageDiv);
            chatContainer.scrollTop = chatContainer.scrollHeight;
        }

        function displayPlan(plan) {
            planSection.style.display = 'block';
            let html = '<ol>';
            plan.forEach(step => {
                html += `<li><strong>${step.description}</strong> (工具: ${step.tool})</li>`;
            });
            html += '</ol>';
            planContainer.innerHTML = html;
        }

        clearChatBtn.addEventListener('click', () => {
            chatContainer.innerHTML = '';
            planSection.style.display = 'none';
        });

        // 刷新状态
        refreshStatusBtn.addEventListener('click', () => {
            axios.get(`${API_BASE_URL}/agent/status`)
                .then(response => {
                    const status = response.data.agent_status;
                    document.getElementById('tools-count').textContent = status.tools_count;
                    document.getElementById('memory-count').textContent = status.memory_count;
                    document.getElementById('llm-status').textContent = status.has_llm ? '已启用' : '未启用';
                })
                .catch(error => {
                    console.error('获取状态失败:', error);
                });
        });

        // 页面加载时刷新状态
        window.addEventListener('load', () => {
            refreshStatusBtn.click();
        });
    </script>
</body>
</html>

