# Gitee Go CI/CD 配置文件
# 使用 Gitee Go 流水线语法

version: '1.0'
name: master-pipeline
displayName: MasterPipeline
triggers:
  trigger: auto
  push:
    branches:
      include:
        - master
        - develop
        - main

stages:
  # 编译阶段 - 安装依赖并运行测试
  - name: compile
    displayName: 编译与测试
    strategy: naturally
    trigger: auto
    steps:
      # 步骤1: 安装依赖
      - step: build@python
        name: install_dependencies
        displayName: 安装依赖
        pythonVersion: '3.9'
        commands:
          - apt-get update && apt-get install -y --no-install-recommends gcc g++ make libgomp1
          - python3 -m pip install --upgrade pip
          - pip3 config set global.index-url https://pypi.tuna.tsinghua.edu.cn/simple
          - pip3 install numpy==1.24.3 pandas==2.0.3
          - pip3 install -r requirements.txt
        artifacts:
          - name: BUILD_ARTIFACT
            path:
              - ./

      # 步骤2: 运行单元测试
      - step: build@python
        name: run_unit_tests
        displayName: 单元测试
        pythonVersion: '3.9'
        dependsOn: install_dependencies
        commands:
          - cd pro2
          - echo "========================================"
          - echo "Running UNIT TESTS"
          - echo "========================================"
          - python -m pytest tests/unit -v --tb=short --html=tests/reports/unit_test_report.html --self-contained-html 2>&1 | tee tests/reports/unit_test_log.txt || echo "Unit tests completed"
        artifacts:
          - name: UNIT_TEST_REPORTS
            path:
              - pro2/tests/reports/

      # 步骤3: 运行集成测试
      - step: build@python
        name: run_integration_tests
        displayName: 集成测试
        pythonVersion: '3.9'
        dependsOn: install_dependencies
        commands:
          - cd pro2
          - echo "========================================"
          - echo "Running INTEGRATION TESTS"
          - echo "========================================"
          - python -m pytest tests/integration -v --tb=short --html=tests/reports/integration_test_report.html --self-contained-html 2>&1 | tee tests/reports/integration_test_log.txt || echo "Integration tests completed"
        artifacts:
          - name: INTEGRATION_TEST_REPORTS
            path:
              - pro2/tests/reports/

      # 步骤4: 运行所有测试并生成覆盖率报告
      - step: build@python
        name: run_all_tests
        displayName: 全量测试与覆盖率
        pythonVersion: '3.9'
        dependsOn: 
          - install_dependencies
          - run_unit_tests
          - run_integration_tests
        commands:
          - pip3 install pytest-cov
          - cd pro2
          - echo "========================================"
          - echo "Running ALL TESTS with Coverage"
          - echo "========================================"
          - python -m pytest tests/ -v --tb=short --cov=fund_search --cov-report=xml --cov-report=html --html=tests/reports/all_tests_report.html --self-contained-html 2>&1 | tee tests/reports/all_tests_log.txt || echo "All tests completed"
          - echo ""
          - echo "Test Summary:"
          - python -m pytest tests/ --co -q 2>/dev/null | tail -5 || echo "Could not generate summary"
          - echo ""
          - echo "Coverage report generated in htmlcov/"
        artifacts:
          - name: ALL_TEST_REPORTS
            path:
              - pro2/tests/reports/
              - pro2/htmlcov/
              - pro2/coverage.xml

      # 步骤5: 代码风格检查
      - step: build@python
        name: lint_check
        displayName: 代码风格检查
        pythonVersion: '3.9'
        dependsOn: install_dependencies
        commands:
          - pip3 install flake8
          - cd pro2
          - echo "Running lint check..."
          - flake8 fund_search --count --select=E9,F63,F7,F82 --show-source --statistics || echo "Lint check completed"
        allowFailure: true

      # 步骤6: 构建应用
      - step: build@python
        name: build_application
        displayName: Python 构建
        pythonVersion: '3.9'
        dependsOn: 
          - run_all_tests
        commands:
          - echo "========================================"
          - echo "BUILD SUCCESSFUL"
          - echo "========================================"
          - python main.py &
          - sleep 5
          - echo "Application started successfully"
          - echo ""
          - echo "Test reports available:"
          - ls -la pro2/tests/reports/ 2>/dev/null || echo "No test reports found"
        artifacts:
          - name: BUILD_ARTIFACT
            path:
              - ./

      # 步骤7: 上传测试报告制品
      - step: publish@general_artifacts
        name: publish_test_reports
        displayName: 上传测试报告
        dependArtifact: ALL_TEST_REPORTS
        artifactName: test-reports
        dependsOn: run_all_tests

      # 步骤8: 上传构建制品
      - step: publish@general_artifacts
        name: publish_general_artifacts
        displayName: 上传构建制品
        dependArtifact: BUILD_ARTIFACT
        artifactName: output
        dependsOn: build_application

  # 发布阶段
  - name: release
    displayName: 发布
    strategy: naturally
    trigger: auto
    steps:
      - step: publish@release_artifacts
        name: publish_release_artifacts
        displayName: 发布
        dependArtifact: output
        version: 1.0.0.0
        autoIncrement: true
