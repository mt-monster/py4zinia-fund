# 昨日盈亏率百分数格式修复说明

## 问题描述

在"我的持仓"界面中，昨日盈亏率显示的数值多乘以了100，导致显示错误。

例如：
- 实际值应该是 `-0.41%`
- 显示值却是 `-41%`（多乘以了100）

## 根本原因

从 AKShare 接口获取的 `日增长率` 字段已经是百分数格式（如 `-0.41` 表示 `-0.41%`），不需要再乘以100。

但在 `enhanced_fund_data.py` 中，代码错误地判断：
```python
# 错误的判断逻辑
if abs(yesterday_return) < 0.1:
    yesterday_return = yesterday_return * 100
```

这个判断逻辑认为如果绝对值小于0.1，就是小数格式（如 `0.0041` 表示 `0.41%`），需要乘以100。但实际上 AKShare 返回的已经是百分数格式。

## 修复方案

### 修复位置

文件：`pro2/fund_search/data_retrieval/enhanced_fund_data.py`

### 修复内容

#### 1. QDII基金 - 当日盈亏率（第262-270行）

**修复前：**
```python
# 获取当日盈亏率（从最新一条数据的日增长率获取）
daily_return_raw = latest_data.get('日增长率', 0)
if pd.notna(daily_return_raw):
    daily_return = float(daily_return_raw)
    # 判断格式：如果绝对值 < 0.1，说明是小数格式，需要乘100
    if abs(daily_return) < 0.1:
        daily_return = daily_return * 100
    daily_return = round(daily_return, 2)
else:
    daily_return = 0.0
```

**修复后：**
```python
# 获取当日盈亏率（从最新一条数据的日增长率获取）
# 注意：akshare返回的日增长率已经是百分数格式（如-0.41），不需要再乘以100
daily_return_raw = latest_data.get('日增长率', 0)
if pd.notna(daily_return_raw):
    daily_return = float(daily_return_raw)
    daily_return = round(daily_return, 2)
else:
    daily_return = 0.0
```

#### 2. QDII基金 - 昨日盈亏率（第272-282行）

**修复前：**
```python
# 获取昨日盈亏率（从前一条数据的日增长率获取）
if len(fund_nav) > 1:
    yesterday_return_raw = previous_data.get('日增长率', 0)
    if pd.notna(yesterday_return_raw):
        yesterday_return = float(yesterday_return_raw)
        # 判断格式
        if abs(yesterday_return) < 0.1:
            yesterday_return = yesterday_return * 100
        yesterday_return = round(yesterday_return, 2)
    else:
        yesterday_return = 0.0
else:
    yesterday_return = 0.0
```

**修复后：**
```python
# 获取昨日盈亏率（从前一条数据的日增长率获取）
# 注意：akshare返回的日增长率已经是百分数格式（如-0.41），不需要再乘以100
if len(fund_nav) > 1:
    yesterday_return_raw = previous_data.get('日增长率', 0)
    if pd.notna(yesterday_return_raw):
        yesterday_return = float(yesterday_return_raw)
        yesterday_return = round(yesterday_return, 2)
    else:
        yesterday_return = 0.0
else:
    yesterday_return = 0.0
```

#### 3. 普通基金 - 昨日盈亏率（第352-361行）

**修复前：**
```python
# 获取昨日盈亏率（直接从最新一条数据的日增长率获取）
yesterday_return_raw = latest_data.get('日增长率', 0)
if pd.notna(yesterday_return_raw):
    yesterday_return = float(yesterday_return_raw)
    # 判断格式：如果绝对值 < 0.1，说明是小数格式（如0.0475），需要乘100
    if abs(yesterday_return) < 0.1:
        yesterday_return = yesterday_return * 100
    yesterday_return = round(yesterday_return, 2)
else:
    yesterday_return = 0.0
```

**修复后：**
```python
# 获取昨日盈亏率（直接从最新一条数据的日增长率获取）
# 注意：akshare返回的日增长率已经是百分数格式（如-0.94），不需要再乘以100
yesterday_return_raw = latest_data.get('日增长率', 0)
if pd.notna(yesterday_return_raw):
    yesterday_return = float(yesterday_return_raw)
    yesterday_return = round(yesterday_return, 2)
else:
    yesterday_return = 0.0
```

## 修复结果

修复后，昨日盈亏率将正确显示：
- QDII基金：`-0.41%`（而不是 `-41%`）
- 普通基金：`-0.94%`（而不是 `-94%`）

## 相关说明

### AKShare 数据格式

从 AKShare 的 `fund_open_fund_info_em` 接口获取的 `日增长率` 字段：
- **格式**：百分数格式
- **示例**：`-0.41` 表示 `-0.41%`
- **不需要**：再乘以100

### 后端API处理

在 `app.py` 中，已经正确标记了这些字段：
```python
# today_return, prev_day_return, yesterday_return 已经是百分比格式，不需要乘100
for key in ['today_return', 'prev_day_return', 'yesterday_return']:
    if fund.get(key) is not None:
        fund[key] = round(float(fund[key]), 2)
```

## 测试验证

修复后，请执行以下测试：

1. **重新运行数据获取**：
   ```bash
   cd pro2/fund_search
   python enhanced_main.py
   ```

2. **访问持仓界面**：
   - 打开浏览器访问：`http://localhost:5000/my-holdings`
   - 检查"昨日盈亏率"列的数值是否正确

3. **预期结果**：
   - 昨日盈亏率应该在 `-10%` 到 `+10%` 的合理范围内
   - 不应该出现 `-41%`、`-94%` 这样的异常值

## 修复日期

2026-01-21

## 修复人员

Kiro AI Assistant
