# 智能识别和手工导入指南

## 功能概述

新的智能识别系统可以处理多种格式的基金信息：

### ✅ **支持的识别格式**

1. **"基金XXXXXX"格式**：如"基金006257"
2. **纯6位数字代码**：如"006257"
3. **基金名称**：如"天弘标普500发起"
4. **混合格式**：代码+名称组合

### ✅ **智能处理流程**

```
OCR识别 → 智能解析器 → akshare验证 → 成功识别 ✓
                                    ↓
                              识别失败 → 手工导入提示
```

## 使用方法

### 1. 自动识别（推荐）

```python
from fund_search.data_retrieval.fund_screenshot_ocr import recognize_fund_screenshot

# 自动识别并导入持仓
funds = recognize_fund_screenshot(
    image_data="你的base64图片数据",
    import_to_portfolio=True,
    user_id="your_user_id"
)

# 检查识别结果
if funds:
    print(f"成功识别 {len(funds)} 只基金")
    for fund in funds:
        print(f"{fund['fund_code']} - {fund['fund_name']}")
else:
    print("未能识别到基金，请使用手工导入")
```

### 2. 智能解析（单独使用）

```python
from fund_search.data_retrieval.smart_fund_parser import parse_fund_info_with_manual_fallback

# OCR识别的文本
ocr_texts = [
    "基金006257",
    "681.30", 
    "+21.11",
    "基金007721",
    "568.11"
]

# 智能解析
result = parse_fund_info_with_manual_fallback(ocr_texts)

print(f"识别成功: {result['success']}")
print(f"基金数量: {result['funds_count']}")

# 成功识别的基金
for fund in result['funds']:
    print(f"{fund['fund_code']} - {fund['fund_name']}")

# 需要手工导入的项目
if result['manual_import_needed']:
    print("需要手工导入:")
    print(result['manual_prompt'])
```

### 3. 手工导入工具

#### 交互式导入
```bash
cd pro2
python fund_search/tools/manual_import_tool.py
```

#### 程序化导入
```python
from fund_search.tools.manual_import_tool import ManualImportTool

tool = ManualImportTool()

# 验证基金代码
validation = tool.validate_fund_code("006257")
if validation['valid']:
    print(f"基金: {validation['fund_info']['fund_name']}")

# 手工添加持仓
result = tool.manual_add_holding(
    fund_code="006257",
    nav_value=681.30,
    change_amount=21.11,
    change_percent=3.20,
    user_id="your_user_id"
)

if result['success']:
    print(f"添加成功: {result['message']}")
```

## 识别示例

### 示例1：标准格式识别

**输入文本**：
```
基金006257
681.30
+21.11
+3.20%
```

**识别结果**：
```
✓ 006257 - 信澳先进智造股票型A
  净值: 681.30
  涨跌: +21.11 (+3.20%)
```

### 示例2：混合格式识别

**输入文本**：
```
007721
天弘标普500发起(QDII-FOF)A
681.30
基金501225
664.00
```

**识别结果**：
```
✓ 007721 - 天弘标普500发起(QDII-FOF)A
✓ 501225 - 景顺长城全球半导体芯片股票A(QDII-LOF)(人民币)
```

### 示例3：需要手工导入

**输入文本**：
```
基金999999  # 无效代码
某某基金    # 无法识别的名称
```

**系统提示**：
```
以下内容无法自动识别，建议手工导入：

1. 识别文本: 基金999999
   原因: 基金代码 999999 无效或不存在
   建议代码: 999999

2. 识别文本: 某某基金
   原因: 无法通过名称找到匹配的基金
   建议名称: 某某基金

请手工确认基金代码和名称，或提供更清晰的截图。
```

## 手工导入流程

### 1. 启动手工导入工具

```bash
python fund_search/tools/manual_import_tool.py
```

### 2. 选择操作

```
=== 基金持仓手工导入工具 ===

请选择操作:
1. 添加单个基金持仓
2. 验证基金代码  
3. 退出
```

### 3. 添加基金持仓

```
请输入基金代码 (6位数字): 006257
找到基金: 信澳先进智造股票型A

请输入净值 (可选): 681.30
请输入涨跌金额 (可选): 21.11
请输入涨跌百分比 (可选): 3.20
请输入持仓金额 (可选): 10000
请输入持有份额 (可选): 1000
请输入用户ID (默认: default): my_user

✓ 成功添加持仓: 006257 - 信澳先进智造股票型A
```

## 故障排除

### 1. OCR识别不准确

**问题**：识别出"基金006257"但实际应该是其他基金

**解决方案**：
1. 检查截图质量，确保文字清晰
2. 使用手工导入工具验证基金代码
3. 手动输入正确的基金代码

### 2. 基金代码无效

**问题**：提示"基金代码 XXXXXX 无效或不存在"

**解决方案**：
1. 确认基金代码是否正确（6位数字）
2. 检查基金是否已停止交易或合并
3. 使用基金名称进行搜索

### 3. 网络连接问题

**问题**：akshare查询失败

**解决方案**：
1. 检查网络连接
2. 等待片刻后重试
3. 使用本地映射表作为备选

### 4. 重复识别

**问题**：同一基金被识别多次

**解决方案**：
- 系统会自动去重，相同基金代码只保留一条记录
- 数据库导入时会更新而不是重复插入

## 配置选项

### 环境变量

```bash
# 强制使用EasyOCR
set FORCE_EASYOCR=true

# 调整置信度阈值
set OCR_CONFIDENCE_THRESHOLD=0.6

# akshare缓存时间（秒）
set AKSHARE_CACHE_DURATION=7200
```

### 代码配置

```python
# 在 smart_fund_parser.py 中调整相似度阈值
similarity_threshold = 0.6  # 默认0.6

# 在 akshare_fund_lookup.py 中调整缓存时间
cache_duration = 3600  # 1小时
```

## 最佳实践

### 1. 截图质量

- ✅ 确保文字清晰可读
- ✅ 避免截图过小或模糊
- ✅ 包含完整的基金信息
- ❌ 避免倾斜或变形的截图

### 2. 识别策略

- ✅ 优先使用自动识别
- ✅ 对无法识别的项目使用手工导入
- ✅ 定期验证持仓数据的准确性
- ❌ 不要忽略手工导入提示

### 3. 数据管理

- ✅ 为不同用户使用不同的user_id
- ✅ 定期备份持仓数据
- ✅ 及时更新基金信息
- ❌ 避免手动修改数据库

## 技术细节

### 识别优先级

1. **"基金XXXXXX"格式** (置信度: 0.9)
2. **纯6位数字代码** (置信度: 0.85)  
3. **基金名称匹配** (置信度: 0.8)
4. **手工导入** (置信度: 1.0)

### 数据验证

- 基金代码：必须是6位数字且在akshare数据库中存在
- 净值：通常在0.1-100之间
- 涨跌幅：合理的百分比范围
- 持仓金额：正数且符合实际情况

### 性能优化

- akshare数据缓存1小时
- 重复查询使用缓存结果
- 批量处理减少API调用
- 异步处理大量数据

通过这套智能识别和手工导入系统，你可以高效地管理基金持仓信息，无论是自动识别还是手工导入都能得到准确的结果！