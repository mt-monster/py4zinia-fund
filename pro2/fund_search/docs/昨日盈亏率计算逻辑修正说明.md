# 昨日盈亏率计算逻辑修正说明

## 修正时间
2026-01-19

## 问题描述
系统中存在昨日盈亏率（yesterday_return / prev_day_return）计算逻辑不一致的问题。

### 错误逻辑
之前的代码从 `fund_nav.iloc[-2]` 获取昨日盈亏率，这实际上是**前天的盈亏率**，而不是昨天的。

```python
# ❌ 错误方式
previous_data = fund_nav.iloc[-2]  # 这是前天的数据
yesterday_return = previous_data.get('日增长率')  # 这是前天的盈亏率
```

### 正确逻辑
应该从 `fund_nav.iloc[-1]` 获取昨日盈亏率，这才是**昨天的盈亏率**。

```python
# ✅ 正确方式
latest_data = fund_nav.iloc[-1]  # 这是昨天的数据
yesterday_return = latest_data.get('日增长率')  # 这是昨天的盈亏率
```

## 修正内容

### 1. enhanced_fund_data.py (已修正)
**文件路径**: `pro2/fund_search/data_retrieval/enhanced_fund_data.py`

**修正位置**: 第 220 行左右

**修正内容**:
```python
# 获取昨日盈亏率（直接从最新一条数据的日增长率获取）
yesterday_return_raw = latest_data.get('日增长率', 0)  # ✅ 从 latest_data 获取
```

### 2. enhanced_main.py - analyze_fund 方法 (已修正)
**文件路径**: `pro2/fund_search/enhanced_main.py`

**修正位置**: 第 350-390 行左右

**修正内容**:
```python
# 如果实时数据中的昨日收益率不可用或异常，从历史数据获取
if yesterday_return == 0.0 and not historical_data.empty:
    if 'daily_growth_rate' in historical_data.columns:
        recent_growth = historical_data['daily_growth_rate'].dropna().tail(1)  # ✅ 改为 tail(1)
        if len(recent_growth) >= 1:  # ✅ 改为 >= 1
            # 昨日盈亏率直接从最新一条数据的日增长率获取
            raw_value = float(recent_growth.iloc[-1])  # ✅ 改为 iloc[-1]
            
    elif 'daily_return' in historical_data.columns:
        recent_returns = historical_data['daily_return'].dropna().tail(1)  # ✅ 改为 tail(1)
        if len(recent_returns) >= 1:  # ✅ 改为 >= 1
            # 昨日盈亏率直接从最新一条数据获取
            yesterday_return = recent_returns.iloc[-1] * 100  # ✅ 改为 iloc[-1]
```

### 3. enhanced_main.py - get_investment_strategy 方法 (已修正)
**文件路径**: `pro2/fund_search/enhanced_main.py`

**修正位置**: 第 871, 906, 928-929 行

**问题**: 函数参数名为 `prev_day_return`，但内部使用了未定义的 `yesterday_return` 变量

**修正内容**:
```python
# 修正前：使用未定义的 yesterday_return
elif today_return < 0 and yesterday_return == 0:  # ❌ 错误
elif today_return < 0 and yesterday_return < 0:  # ❌ 错误
elif (yesterday_return - today_return) > 0 and yesterday_return <= -2:  # ❌ 错误
elif (yesterday_return - today_return) > 0 and yesterday_return > -2:  # ❌ 错误

# 修正后：使用正确的 prev_day_return
elif today_return < 0 and prev_day_return == 0:  # ✅ 正确
elif today_return < 0 and prev_day_return < 0:  # ✅ 正确
elif (prev_day_return - today_return) > 0 and prev_day_return <= -2:  # ✅ 正确
elif (prev_day_return - today_return) > 0 and prev_day_return > -2:  # ✅ 正确
```

## 数据索引说明

假设有以下数据：
```
索引    日期          单位净值    日增长率
[-3]   2026-01-14    1.5210     -2.21%
[-2]   2026-01-15    1.5059     -0.99%   ← 前天的盈亏率
[-1]   2026-01-16    1.5775      4.75%   ← 昨天的盈亏率 ✅
```

- `iloc[-1]`: 最新一条数据（昨天）
- `iloc[-2]`: 倒数第二条数据（前天）

**昨日盈亏率应该从 `iloc[-1]` 获取，值为 4.75%**

## 测试验证

### 测试基金
- 基金代码: 001270
- 基金名称: 英大灵活配置A

### 测试结果
```
✅ 昨日盈亏率: 4.75% (正确，从 iloc[-1] 获取)
✅ 昨日净值: 1.5059元 (正确，从 iloc[-2] 获取)
✅ 日涨跌幅: 1.02% (正确，从新浪实时接口获取)
✅ 估算净值: 1.5936元 (正确，从新浪实时接口获取)
```

### 测试文件
- `pro2/fund_search/tests/test_fund_001270_data_retrieval.py` (6个测试全部通过)
- `pro2/fund_search/tests/quick_test_001270.py` (快速验证通过)

## 影响范围

### 已修正的文件
1. ✅ `pro2/fund_search/data_retrieval/enhanced_fund_data.py` (昨日盈亏率数据获取)
2. ✅ `pro2/fund_search/enhanced_main.py` - `analyze_fund` 方法 (历史数据fallback逻辑)
3. ✅ `pro2/fund_search/enhanced_main.py` - `get_investment_strategy` 方法 (变量名一致性)

### 相关字段
- `yesterday_return`: 昨日盈亏率（内部变量）
- `prev_day_return`: 昨日盈亏率（对外字段名）

## 注意事项

1. **数据源优先级**: 系统优先从 `realtime_data` 获取 `yesterday_return`，如果不可用才从历史数据获取
2. **格式判断**: 系统会自动判断数据格式（小数或百分比），并进行相应转换
3. **异常处理**: 如果昨日盈亏率超过 ±100%，系统会认为数据异常并使用默认值 0.0

## 修正完成
✅ 所有相关代码已修正
✅ 所有测试通过
✅ 数据计算逻辑一致
