# 基金分析系统字段计算逻辑说明

## 问题背景

用户发现 `fund_analysis_results` 表中存在两个疑似重复的字段：
- `daily_return`
- `today_return`

经过代码分析，发现这两个字段确实存在混淆和不一致的问题。

## 字段分析

### 1. 表结构中的字段

在 `fund_analysis_results` 表中，实际定义的字段包括：

```sql
CREATE TABLE IF NOT EXISTS fund_analysis_results (
    fund_code VARCHAR(20),
    fund_name VARCHAR(100),
    yesterday_nav FLOAT,
    current_estimate FLOAT,
    today_return FLOAT,              -- ✅ 存在
    yesterday_return FLOAT,           -- ⚠️ 存在但未使用
    prev_day_return FLOAT,            -- ✅ 存在
    status_label VARCHAR(50),
    ...
)
```

**重要发现：**
- 表中**没有** `daily_return` 字段
- 表中**有** `today_return` 字段
- 表中**有** `yesterday_return` 字段（但代码中未使用）
- 表中**有** `prev_day_return` 字段（实际使用的昨日收益率）

### 2. 数据插入逻辑

在 `enhanced_database.py` 的 `insert_fund_analysis_results` 方法中：

```python
sql = """
INSERT INTO fund_analysis_results (
    fund_code, fund_name, yesterday_nav, current_estimate, today_return, 
    prev_day_return, status_label, ...
) VALUES (
    :fund_code, :fund_name, :yesterday_nav, :current_estimate, :today_return,
    :prev_day_return, :status_label, ...
)
```

**插入的字段：**
- ✅ `today_return` - 今日收益率
- ✅ `prev_day_return` - 昨日收益率
- ❌ **没有插入** `yesterday_return` 字段

### 3. 数据来源

#### 3.1 `today_return` 的计算

在 `enhanced_main.py` 的 `analyze_single_fund` 方法中：

```python
# 从实时数据获取今日收益率
today_return = realtime_data.get('today_return', 0.0)
```

`realtime_data` 来自 `enhanced_fund_data.py`：

**普通基金（使用新浪接口）：**
```python
# 从新浪财经获取实时估算
estimate_nav = sina_data['estimate_nav']
sina_previous_nav = sina_data['previous_nav']

# 计算实时日涨跌幅
daily_return = (estimate_nav - sina_previous_nav) / sina_previous_nav * 100

return {
    'today_return': round(daily_return, 2),  # 返回今日收益率
    ...
}
```

**QDII基金（使用AKShare接口）：**
```python
# 获取最新数据的日增长率
daily_return_raw = latest_data.get('日增长率', 0)
if abs(daily_return) < 0.1:
    daily_return = daily_return * 100  # 转换为百分比

return {
    'today_return': round(daily_return, 2),  # 返回今日收益率
    ...
}
```

#### 3.2 `prev_day_return` 的计算

在 `enhanced_main.py` 中：

```python
# 首先尝试从实时数据获取昨日收益率
if 'yesterday_return' in realtime_data:
    yesterday_return = realtime_data['yesterday_return']
else:
    # 从历史数据获取
    recent_growth = historical_data['daily_growth_rate'].dropna().tail(1)
    yesterday_return = float(recent_growth.iloc[-1])

# 最终赋值
prev_day_return = round(yesterday_return, 2)
```

### 4. 字段值为0的原因

用户观察到 `daily_return` 和 `today_return` 都是0，原因分析：

1. **`daily_return` 字段不存在**
   - 表结构中没有这个字段
   - 用户可能看到的是其他表（如 `fund_performance`）的字段

2. **`today_return` 为0的可能原因**
   - 数据获取失败（API返回空或异常）
   - 基金当日净值未更新（非交易日）
   - 实时估算接口未返回数据

3. **`yesterday_return` 字段未使用**
   - 表中定义了这个字段，但插入时未赋值
   - 实际使用的是 `prev_day_return` 字段

## 字段重复问题总结

### 问题1：`yesterday_return` vs `prev_day_return`

**现状：**
- 表中同时存在 `yesterday_return` 和 `prev_day_return` 两个字段
- 代码中只使用 `prev_day_return`，`yesterday_return` 从未被赋值

**建议：**
- 删除 `yesterday_return` 字段（冗余字段）
- 统一使用 `prev_day_return` 表示昨日收益率

### 问题2：`daily_return` 不存在

**现状：**
- `fund_analysis_results` 表中没有 `daily_return` 字段
- 用户可能混淆了 `fund_performance` 表的字段

**说明：**
- `fund_performance` 表中有 `daily_return` 字段
- `fund_analysis_results` 表中使用 `today_return` 字段

## 字段命名规范建议

为避免混淆，建议统一字段命名：

| 字段名 | 含义 | 数据来源 | 格式 |
|--------|------|----------|------|
| `today_return` | 今日收益率 | 实时数据/最新净值 | 百分比（如 2.5 表示 2.5%） |
| `prev_day_return` | 昨日收益率 | 历史净值数据 | 百分比（如 -1.2 表示 -1.2%） |
| ~~`yesterday_return`~~ | ❌ 冗余字段 | 未使用 | - |
| ~~`daily_return`~~ | ❌ 不存在于此表 | - | - |

## 修复建议

### 1. 删除冗余字段

```sql
ALTER TABLE fund_analysis_results DROP COLUMN yesterday_return;
```

### 2. 确保数据正确填充

检查为什么 `today_return` 为0：

```python
# 在 enhanced_main.py 中添加日志
logger.info(f"基金 {fund_code} 今日收益率: {today_return}%")
logger.info(f"基金 {fund_code} 昨日收益率: {prev_day_return}%")
```

### 3. 统一字段使用

确保所有查询和显示都使用正确的字段名：
- 今日收益率：`today_return`
- 昨日收益率：`prev_day_return`

## 相关文件

- `pro2/fund_search/data_retrieval/enhanced_database.py` - 数据库表结构和插入逻辑
- `pro2/fund_search/enhanced_main.py` - 数据计算和分析逻辑
- `pro2/fund_search/data_retrieval/enhanced_fund_data.py` - 数据获取逻辑
- `pro2/fund_search/web/app.py` - Web接口查询逻辑

---

**文档创建时间：** 2026-01-20  
**分析人员：** Kiro AI Assistant
