# 基金数据字段计算逻辑说明

本文档详细说明基金分析系统中4个关键字段的计算逻辑和数据流程。

---

## 1. 日涨跌幅 (daily_return / today_return)

### 数据来源
- **实时数据**: AKShare `ak.fund_open_fund_info_em(symbol=fund_code, indicator="单位净值走势")` 的 `估算值` 字段
- **历史数据**: 同一接口的 `单位净值` 字段（昨日净值）
- **备用数据**: 同一接口的 `日增长率` 字段

### 计算逻辑

#### 方法1：使用实时估算值计算（优先，正确方式）
```python
# 获取昨日净值（历史数据）
previous_nav = fund_nav.iloc[-2].get('单位净值', 0)  # 或 iloc[-1]，取决于数据更新时间

# 获取今日估算净值（实时数据）
estimate_nav = fund_nav.iloc[-1].get('估算值', current_nav)

# 计算日涨跌幅
if previous_nav != 0:
    daily_return = (estimate_nav - previous_nav) / previous_nav * 100
```

**重要说明**：
- `估算值` 是基于基金持仓股票的**实时行情**估算的当日净值
- 在交易时间内，估算值会**实时变化**
- 这才是真正的"日涨跌幅"，反映当前的盈亏情况
- 非交易时间，估算值可能等于最新净值

#### 方法2：使用API的日增长率（备用，可能不是实时）
```python
daily_return_raw = latest_data.get('日增长率', None)
```

**格式判断与转换**：
- AKShare返回的`日增长率`格式不统一，需要判断：
  - 如果 `abs(daily_return) < 1`：小数格式（如 0.0475），需要 **乘以100** 转为百分比
  - 如果 `abs(daily_return) >= 1`：已是百分比格式（如 4.75），直接使用

```python
if abs(daily_return) < 1:
    daily_return = daily_return * 100  # 0.0475 → 4.75
```

**注意**：
- API的`日增长率`可能是昨日的数据，不是今日实时估算
- 仅在估算值不可用时使用

**异常值检测**：
- 如果 `abs(daily_return) > 100`（超过±100%），判定为异常，使用方法3计算

#### 方法3：使用净值计算（备用，历史数据）
当估算值和日增长率都不可用时：
```python
if previous_nav != 0:
    daily_return = (current_nav - previous_nav) / previous_nav * 100
else:
    daily_return = 0.0
```

**注意**：这种方式计算的是历史净值之间的涨跌，不是实时估算

### 数据流程
1. `enhanced_fund_data.py` → `get_realtime_data()` 获取估算值和历史净值
2. 计算：`(estimate_nav - previous_nav) / previous_nav * 100`
3. 返回字典中的 `daily_return` 字段
4. `enhanced_main.py` → `analyze_fund()` 接收为 `today_return`
5. 存入数据库 `fund_analysis_results` 表的 `daily_return` 和 `today_return` 字段
6. Web界面通过 `/api/funds` 接口获取并显示

### 最终格式
- **单位**: 百分比（%）
- **精度**: 保留2位小数
- **示例**: 4.75 表示今日估算上涨4.75%
- **实时性**: 交易时间内实时变化

---

## 2. 昨日盈亏率 (prev_day_return)

### 数据来源
- **API**: AKShare `ak.fund_open_fund_info_em(symbol=fund_code, indicator="单位净值走势")`
- **原始字段**: 前一日的 `日增长率`

### 计算逻辑

#### 方法1：从实时数据获取（优先，最可靠）
```python
# 获取倒数第二行数据（前一日）
previous_data = fund_nav.iloc[-2]
yesterday_return_raw = previous_data.get('日增长率', 0)
```

**格式判断与转换**（同日涨跌幅）：
```python
if abs(yesterday_return) < 1:
    yesterday_return = yesterday_return * 100
```

**异常值检测与修正**：
- 如果 `abs(yesterday_return) > 100`，使用净值计算：
```python
# 获取前前一日净值
day_before_yesterday_nav = fund_nav.iloc[-3].get('单位净值', 0)
if day_before_yesterday_nav != 0:
    yesterday_return = (previous_nav - day_before_yesterday_nav) / day_before_yesterday_nav * 100
```

#### 方法2：从历史数据获取（备用）
当实时数据不可用时，从30天历史数据中获取：
```python
recent_growth = historical_data['daily_growth_rate'].tail(2)
raw_value = recent_growth.iloc[-2]  # 倒数第二条

# 格式判断
if abs(raw_value) < 1:
    yesterday_return = raw_value * 100
else:
    yesterday_return = raw_value
```

### 数据流程
1. `enhanced_fund_data.py` → `get_realtime_data()` 获取前一日的`日增长率`
2. 返回字典中的 `yesterday_return` 字段（已废弃）
3. `enhanced_main.py` → `analyze_fund()` 处理为 `prev_day_return`
4. 存入数据库 `fund_analysis_results` 表的 `prev_day_return` 字段
5. Web界面通过 `/api/funds` 接口获取并显示

### 重要说明
- **字段变更**: `yesterday_return` 已废弃，统一使用 `prev_day_return`
- **不是计算值**: 直接从AKShare获取，不是通过净值差计算
- **时间点**: 表示前一个交易日的涨跌幅

### 最终格式
- **单位**: 百分比（%）
- **精度**: 保留2位小数
- **示例**: 4.75 表示昨日上涨4.75%

---

## 3. 昨日净值 (previous_nav / yesterday_nav)

### 数据来源
- **API**: AKShare `ak.fund_open_fund_info_em(symbol=fund_code, indicator="单位净值走势")`
- **原始字段**: `单位净值`

### 计算逻辑

#### 直接获取（无需计算）
```python
# 数据按日期升序排序，最新数据在最后
fund_nav = fund_nav.sort_values('净值日期', ascending=True)

# 获取倒数第二行（前一日）
if len(fund_nav) > 1:
    previous_data = fund_nav.iloc[-2]
    previous_nav = float(previous_data.get('单位净值', 0))
else:
    # 如果只有一条数据，使用当前净值
    previous_nav = float(latest_data.get('单位净值', 0))
```

### 数据流程
1. `enhanced_fund_data.py` → `get_realtime_data()` 获取
2. 返回字典中的 `previous_nav` 字段
3. `enhanced_main.py` → `analyze_fund()` 直接传递
4. 存入数据库 `fund_analysis_results` 表的 `previous_nav` 字段
5. Web界面通过 `/api/funds` 接口获取并显示

### 用途
- 用于计算日涨跌幅（当API的`日增长率`不可用时）
- 用于验证收益率计算的准确性
- 显示给用户作为参考数据

### 最终格式
- **单位**: 元
- **精度**: 通常4位小数
- **示例**: 1.2345 表示前一日单位净值为1.2345元

---

## 4. 当前估值 (current_estimate)

### 数据来源
- **API**: AKShare `ak.fund_open_fund_info_em(symbol=fund_code, indicator="单位净值走势")`
- **原始字段**: `估算值`

### 计算逻辑

#### 直接获取（优先）
```python
estimate_nav = float(latest_data.get('估算值', current_nav))
```

**说明**：
- `估算值`是基金公司或第三方机构根据持仓股票实时行情估算的当日净值
- 如果API未返回估算值，使用最新净值 `current_nav` 作为默认值

#### 估算收益率
```python
estimate_return = float(latest_data.get('日增长率', daily_return))
```

### 数据流程
1. `enhanced_fund_data.py` → `get_realtime_data()` 获取
2. 返回字典中的 `estimate_nav` 和 `estimate_return` 字段
3. `enhanced_main.py` → `analyze_fund()` 直接传递
4. 存入数据库 `fund_analysis_results` 表的 `estimate_nav` 字段
5. Web界面通过 `/api/funds` 接口获取并显示

### 重要说明
- **实时性**: 估算值在交易时间内实时更新，净值通常在交易日结束后更新
- **准确性**: 估算值仅供参考，实际净值以基金公司公布为准
- **可用性**: 并非所有基金都提供估算值

### 最终格式
- **单位**: 元
- **精度**: 通常4位小数
- **示例**: 1.2456 表示当前估算净值为1.2456元

---

## 数据更新流程

### 完整数据流
```
AKShare API
    ↓
enhanced_fund_data.py (get_realtime_data)
    ↓ 格式转换 + 异常处理
enhanced_main.py (analyze_fund)
    ↓ 策略分析
enhanced_database.py (save_fund_analysis)
    ↓ 存储
MySQL (fund_analysis_results表)
    ↓ 查询
web/app.py (/api/funds接口)
    ↓ JSON响应
前端 (my_holdings.html)
    ↓ 渲染显示
用户界面
```

### 更新命令
```bash
python enhanced_main.py
```

---

## 常见问题

### Q1: 为什么昨日盈亏率显示错误？
**A**: AKShare的`日增长率`字段格式不统一：
- 有时返回小数格式（0.0475）
- 有时返回百分比格式（4.75）
- 代码已添加自动判断逻辑（abs < 1 则乘100）

### Q2: yesterday_return 和 prev_day_return 有什么区别？
**A**: 
- `yesterday_return`: 旧字段名，已废弃
- `prev_day_return`: 新字段名，当前使用
- 两者含义相同，都表示昨日盈亏率

### Q3: 日涨跌幅和昨日盈亏率的区别？
**A**:
- **日涨跌幅** (daily_return): **今日实时估算净值**相对昨日净值的涨跌幅（实时变化）
- **昨日盈亏率** (prev_day_return): 昨天相对前天的涨跌幅（历史数据）

### Q4: 为什么有时估算值和净值相同？
**A**: 
- 非交易时间或API未提供估算值时，使用最新净值作为默认值
- 这是正常的降级处理逻辑

### Q5: 日涨跌幅为什么要用估算值而不是实际净值？
**A**:
- **实际净值**：每天交易结束后才公布，有延迟
- **估算值**：基于持仓股票实时行情计算，交易时间内实时更新
- **日涨跌幅**：应该反映当前的盈亏情况，所以要用实时估算值
- **示例**：
  - 昨日净值：1.2345元
  - 今日估算：1.2404元（上午10点）
  - 日涨跌幅：(1.2404 - 1.2345) / 1.2345 * 100 = 0.48%
  - 这个0.48%会随着股市行情实时变化

### Q6: 如何验证日涨跌幅计算是否正确？
**A**:
```python
# 正确的计算方式
daily_return = (estimate_nav - previous_nav) / previous_nav * 100

# 错误的计算方式（使用历史净值）
daily_return = (current_nav - previous_nav) / previous_nav * 100  # ❌
```

---

## 代码位置索引

| 功能 | 文件路径 | 函数/行号 |
|------|---------|----------|
| 实时数据获取 | `pro2/fund_search/data_retrieval/enhanced_fund_data.py` | `get_realtime_data()` (114-240行) |
| 数据处理与分析 | `pro2/fund_search/enhanced_main.py` | `analyze_fund()` (300-450行) |
| 数据库存储 | `pro2/fund_search/data_retrieval/enhanced_database.py` | `save_fund_analysis()` |
| Web API | `pro2/fund_search/web/app.py` | `/api/funds` 路由 |
| 前端显示 | `pro2/fund_search/web/templates/my_holdings.html` | 表格渲染部分 |

---

**文档版本**: 1.0  
**最后更新**: 2026-01-19  
**维护者**: 基金分析系统开发团队
