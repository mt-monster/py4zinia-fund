# 持仓导入使用指南

## 功能概述

新的持仓导入系统可以：
1. **智能识别基金**：通过OCR识别截图中的基金名称
2. **自动查找代码**：使用akshare接口反向查找基金代码
3. **提取持仓信息**：从截图中提取净值、涨跌幅等信息
4. **导入持仓列表**：将识别的信息自动导入到个人持仓数据库

## 系统架构

```
截图 → OCR识别 → 基金名称提取 → akshare查找代码 → 持仓信息提取 → 数据库导入
```

### 核心组件

1. **AkshareFundLookup** (`akshare_fund_lookup.py`)
   - 通过akshare接口查找基金代码
   - 支持模糊匹配和相似度计算
   - 带缓存机制，提高查询效率

2. **PortfolioImporter** (`portfolio_importer.py`)
   - 从OCR文本提取持仓信息
   - 解析净值、涨跌幅、持仓金额等
   - 导入到用户持仓数据库

3. **EnhancedFundParser** (`enhanced_fund_parser.py`)
   - 增强版基金解析器
   - 集成akshare查找功能
   - 支持本地映射表 + 在线查找

## 使用方法

### 1. 基本OCR识别（带持仓导入）

```python
from fund_search.data_retrieval.fund_screenshot_ocr import recognize_fund_screenshot

# 识别截图并导入持仓
image_data = "base64编码的图片数据"
funds = recognize_fund_screenshot(
    image_data, 
    import_to_portfolio=True,  # 启用持仓导入
    user_id="your_user_id"     # 用户ID
)

print(f"识别到 {len(funds)} 只基金")
```

### 2. 单独使用持仓导入

```python
from fund_search.data_retrieval.portfolio_importer import import_portfolio_from_screenshot

# 从OCR文本导入持仓
ocr_texts = [
    "天弘标普500发起(QDII-FOF)A",
    "681.30",
    "+21.11",
    "+3.20%"
]

result = import_portfolio_from_screenshot(ocr_texts, user_id="your_user_id")
print(f"导入结果: {result}")
```

### 3. 基金代码查找

```python
from fund_search.data_retrieval.akshare_fund_lookup import lookup_fund_info

# 查找基金信息
fund_info = lookup_fund_info("天弘标普500发起")
if fund_info:
    print(f"基金代码: {fund_info['fund_code']}")
    print(f"基金名称: {fund_info['fund_name']}")
```

### 4. 查看用户持仓

```python
from fund_search.data_retrieval.portfolio_importer import PortfolioImporter

importer = PortfolioImporter()
portfolio = importer.get_user_portfolio("your_user_id")

for holding in portfolio:
    print(f"{holding['fund_code']} - {holding['fund_name']}")
    print(f"净值: {holding['nav_value']}, 涨跌: {holding['change_amount']}")
```

## 数据库结构

### user_portfolio 表

| 字段名 | 类型 | 说明 |
|--------|------|------|
| id | INTEGER | 主键 |
| user_id | TEXT | 用户ID |
| fund_code | TEXT | 基金代码 |
| fund_name | TEXT | 基金名称 |
| nav_value | REAL | 净值 |
| change_amount | REAL | 涨跌金额 |
| change_percent | REAL | 涨跌百分比 |
| position_value | REAL | 持仓金额 |
| shares | REAL | 持有份额 |
| created_at | TEXT | 创建时间 |
| last_updated | TEXT | 更新时间 |

## 配置选项

### 环境变量

```bash
# OCR相关配置
set FORCE_EASYOCR=true                    # 强制使用EasyOCR
set OCR_CONFIDENCE_THRESHOLD=0.5          # OCR置信度阈值

# akshare相关配置
set AKSHARE_TIMEOUT=30                    # 查询超时时间
set AKSHARE_CACHE_DURATION=3600           # 缓存持续时间（秒）
```

### 代码配置

```python
# 在 akshare_fund_lookup.py 中
lookup = AkshareFundLookup()
lookup._cache_duration = 7200  # 设置缓存2小时
```

## 识别流程详解

### 1. OCR文本识别
- 使用EasyOCR或PaddleOCR识别截图文本
- 提取所有文本内容和位置信息

### 2. 基金名称识别
- 过滤掉数字、百分比等非基金名称文本
- 识别包含中文且长度适中的文本作为基金名称

### 3. 基金代码查找
- 首先在本地映射表中查找
- 如果未找到，使用akshare接口查找
- 自动将新找到的映射添加到本地缓存

### 4. 持仓信息提取
- 解析净值（格式：xxx.xx）
- 解析涨跌金额（格式：+/-xx.xx）
- 解析涨跌百分比（格式：+/-xx.xx%）
- 估算持仓金额（基于涨跌金额和百分比）

### 5. 数据库导入
- 检查是否已存在该基金的持仓记录
- 如果存在则更新，否则新增
- 记录导入时间和更新时间

## 故障排除

### 1. akshare查找失败
```python
# 检查网络连接
import akshare as ak
try:
    fund_list = ak.fund_open_fund_info_em()
    print("akshare连接正常")
except Exception as e:
    print(f"akshare连接失败: {e}")
```

### 2. OCR识别不准确
- 确保截图清晰，文字对比度高
- 调整OCR置信度阈值
- 检查图片格式和大小

### 3. 基金代码找不到
- 检查基金名称是否正确
- 尝试使用基金简称或关键词
- 手动添加到本地映射表

### 4. 持仓金额计算不准确
- 持仓金额是基于涨跌金额和百分比的估算
- 实际金额可能需要手动输入或从其他数据源获取

## 性能优化

### 1. 缓存机制
- akshare查询结果会缓存1小时
- 本地映射表会自动扩展
- 避免重复查询相同基金

### 2. 批量处理
```python
# 批量查找多个基金
lookup = AkshareFundLookup()
results = lookup.batch_lookup([
    "天弘标普500发起",
    "景顺长城全球半导体",
    "广发北证50成份"
])
```

### 3. 异步处理
- 对于大量基金的查找，建议使用异步处理
- 避免阻塞主线程

## 扩展功能

### 1. 自定义映射表
```python
from fund_search.data_retrieval.enhanced_fund_parser import add_fund_mapping

# 添加自定义映射
add_fund_mapping("我的基金简称", "123456")
```

### 2. 导出持仓数据
```python
import pandas as pd
from fund_search.data_retrieval.portfolio_importer import PortfolioImporter

importer = PortfolioImporter()
portfolio = importer.get_user_portfolio("your_user_id")

# 转换为DataFrame并导出
df = pd.DataFrame(portfolio)
df.to_excel("my_portfolio.xlsx", index=False)
```

### 3. 持仓分析
- 基于导入的持仓数据进行收益分析
- 计算总持仓价值和收益率
- 生成持仓报告

## 注意事项

1. **网络依赖**：akshare查找需要网络连接
2. **数据准确性**：OCR识别可能有误差，建议人工核对
3. **隐私保护**：持仓数据存储在本地数据库
4. **更新频率**：建议定期更新持仓信息以保持数据准确性