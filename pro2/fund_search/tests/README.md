# 基金数据获取测试套件

本目录包含针对基金数据获取逻辑的测试用例，特别是针对英大灵活配置A (001270) 基金的四个关键字段测试。

## 测试文件

### 1. `test_fund_001270_data_retrieval.py` - 完整测试套件

**功能**：全面测试英大灵活配置A基金的数据获取逻辑

**测试内容**：
- ✅ 测试1：AKShare原始API数据验证
- ✅ 测试2：日涨跌幅计算逻辑（实时估算）
- ✅ 测试3：昨日盈亏率计算逻辑
- ✅ 测试4：昨日净值获取逻辑
- ✅ 测试5：当前估值获取逻辑
- ✅ 测试6：完整数据流测试

**运行方式**：
```bash
cd pro2/fund_search
python tests/test_fund_001270_data_retrieval.py
```

---

### 2. `quick_test_001270.py` - 快速测试脚本

**功能**：快速查看英大灵活配置A基金的四个关键字段值

**测试内容**：
- 获取AKShare原始数据
- 显示系统处理后的数据
- 展示四个关键字段的最终值
- 验证计算准确性

**运行方式**：
```bash
cd pro2/fund_search
python tests/quick_test_001270.py
```

---

### 3. `test_sina_realtime_001270.py` - 新浪财经实时数据测试 ⭐ 新增

**功能**：测试新浪财经实时估算接口，对比不同数据源

**测试内容**：
- 从新浪财经获取实时估算数据（分钟级）
- 从AKShare获取历史数据
- 对比三种日涨跌幅计算方式
- 验证实时数据的准确性

**运行方式**：
```bash
cd pro2/fund_search
python tests/test_sina_realtime_001270.py
```

**测试结果示例**：
```
================================================================================
新浪财经实时数据测试 - 英大灵活配置A (001270)
================================================================================

【步骤1：新浪财经实时估算】
✅ 成功获取新浪财经数据
  昨日净值: 1.5775 元
  最新估算: 1.5936 元
  估算时间: 15:03
  分钟数据点数: 246

  ✅ 实时日涨跌幅: 1.02%

【日涨跌幅计算对比】
1️⃣ 新浪财经实时估算: 1.02% ✅ 实时更新
2️⃣ AKShare估算值: 0.00% ⚠️ 有延迟
3️⃣ 历史净值计算: 4.75% ❌ 错误方式
```

---

## 四个关键字段说明

### 1. 日涨跌幅 (daily_return / today_return)
- **正确方式**: 使用实时估算值计算
- **数据源**: 新浪财经实时接口（推荐）或 AKShare估算值（备用）
- **计算**: `(实时估算 - 昨日净值) / 昨日净值 * 100`
- **单位**: 百分比（%）
- **精度**: 2位小数
- **实时性**: 交易时间内实时变化

### 2. 昨日盈亏率 (prev_day_return)
- **数据源**: AKShare API前一日的`日增长率`字段
- **计算方式**: 直接从API获取，不是计算值
- **格式转换**: 自动判断小数/百分比格式
- **单位**: 百分比（%）
- **精度**: 2位小数

### 3. 昨日净值 (previous_nav)
- **数据源**: AKShare API前一日的`单位净值`字段
- **计算方式**: 直接获取，无需计算
- **单位**: 元
- **精度**: 4位小数

### 4. 当前估值 (current_estimate / estimate_nav)
- **数据源**: 新浪财经实时接口（推荐）或 AKShare的`估算值`字段
- **计算方式**: 直接获取
- **单位**: 元
- **精度**: 4位小数
- **说明**: 实时估算值，仅供参考

---

## 数据源对比

| 数据源 | 实时性 | 准确性 | 推荐度 | 说明 |
|--------|--------|--------|--------|------|
| **新浪财经** | ⭐⭐⭐⭐⭐ | ⭐⭐⭐⭐⭐ | ✅ 推荐 | 分钟级实时更新 |
| **AKShare估算值** | ⭐⭐ | ⭐⭐⭐ | ⚠️ 备用 | 可能有延迟 |
| **历史净值计算** | ⭐ | ⭐ | ❌ 错误 | 无法反映实时盈亏 |

---

## 测试场景

### 场景1：交易日上午10:00

```python
# 新浪财经实时估算
昨日净值: 1.5775元
实时估算: 1.5936元
日涨跌幅: 1.02% ✅ 正确

# AKShare估算值
单位净值: 1.5775元
估算值: 1.5775元
日涨跌幅: 0.00% ⚠️ 有延迟

# 历史净值计算
当前净值: 1.5775元
前一日净值: 1.5059元
日涨跌幅: 4.75% ❌ 错误（这是昨天的涨幅）
```

---

## 常见问题排查

### Q1: 新浪财经接口调用失败
**错误信息**: `从新浪财经获取数据失败`

**可能原因**:
1. 网络连接问题
2. 接口暂时不可用
3. 请求频率过高

**解决方案**:
```bash
# 检查网络连接
ping www.sina.com.cn

# 检查接口是否可访问
curl "https://app.xincai.com/fund/api/jsonp.json/var%20t1fu_001270=/XinCaiFundService.getFundYuCeNav?symbol=001270&___qn=3"

# 使用备用方案（AKShare）
```

### Q2: AKShare估算值为0或与净值相同
**问题**: 估算值 = 单位净值，日涨跌幅显示为0%

**原因**: AKShare的估算值字段可能没有实时数据

**解决方案**: 使用新浪财经实时接口

### Q3: 日涨跌幅显示异常（如4.75%）
**问题**: 日涨跌幅显示的是昨天的涨幅

**原因**: 使用了历史净值计算方式

**解决方案**: 
```python
# 错误方式 ❌
daily_return = (current_nav - previous_nav) / previous_nav * 100

# 正确方式 ✅
daily_return = (estimate_nav - previous_nav) / previous_nav * 100
```

---

## 相关文档

- [字段计算逻辑说明](../docs/字段计算逻辑说明.md) - 详细的计算逻辑文档
- [实时数据获取方案对比](../docs/实时数据获取方案对比.md) - 数据源对比分析
- [日涨跌幅计算修正说明](../docs/日涨跌幅计算修正说明.md) - 修正过程记录
- [enhanced_fund_data.py](../data_retrieval/enhanced_fund_data.py) - 数据获取实现
- [enhanced_main.py](../enhanced_main.py) - 数据处理流程

---

## 扩展测试

如需测试其他基金，可以修改测试脚本中的基金代码：

```python
# 修改 test_sina_realtime_001270.py
fund_code = "001270"  # 改为其他基金代码
fund_name = "英大灵活配置A"  # 改为对应基金名称
```

---

**最后更新**：2026-01-19  
**维护者**：基金分析系统开发团队
