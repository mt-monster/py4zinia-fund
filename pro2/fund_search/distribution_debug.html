<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>æ”¶ç›Šç‡åˆ†å¸ƒå›¾æ·±åº¦è°ƒè¯•</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        body {
            font-family: Arial, sans-serif;
            padding: 20px;
            background-color: #f5f7fa;
        }
        .debug-container {
            max-width: 1200px;
            margin: 0 auto;
        }
        .chart-wrapper {
            background: white;
            border-radius: 10px;
            padding: 30px;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.05);
            margin-bottom: 30px;
            min-height: 500px;
            position: relative;
            overflow: hidden;
        }
        .chart-wrapper canvas {
            width: 100% !important;
            height: 500px !important;
            display: block;
        }
        .debug-info {
            background: #f8f9fa;
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 20px;
            font-family: monospace;
            font-size: 12px;
            max-height: 300px;
            overflow-y: auto;
        }
        .step {
            margin: 10px 0;
            padding: 10px;
            border-left: 4px solid #3b82f6;
            background: white;
        }
        .success { border-left-color: #10b981; background: #f0fdf4; }
        .error { border-left-color: #ef4444; background: #fef2f2; }
        .warning { border-left-color: #f59e0b; background: #fffbeb; }
        button {
            background: #3b82f6;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 5px;
            cursor: pointer;
            margin: 5px;
        }
        button:hover { background: #2563eb; }
        .controls { 
            margin-bottom: 20px; 
            padding: 15px; 
            background: white; 
            border-radius: 8px; 
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1); 
        }
    </style>
</head>
<body>
    <div class="debug-container">
        <h1>æ”¶ç›Šç‡åˆ†å¸ƒå›¾æ·±åº¦è°ƒè¯•é¢æ¿</h1>
        
        <div class="controls">
            <button onclick="step1_checkData()">æ­¥éª¤1: æ£€æŸ¥æ•°æ®ç»“æ„</button>
            <button onclick="step2_checkCanvas()">æ­¥éª¤2: æ£€æŸ¥Canvaså…ƒç´ </button>
            <button onclick="step3_checkContext()">æ­¥éª¤3: æ£€æŸ¥Canvasä¸Šä¸‹æ–‡</button>
            <button onclick="step4_createChart()">æ­¥éª¤4: åˆ›å»ºå›¾è¡¨</button>
            <button onclick="step5_fullTest()">æ­¥éª¤5: å®Œæ•´æµ‹è¯•</button>
            <button onclick="clearLog()">æ¸…ç©ºæ—¥å¿—</button>
        </div>
        
        <div id="debug-log" class="debug-info">è°ƒè¯•æ—¥å¿—å°†åœ¨è¿™é‡Œæ˜¾ç¤º...</div>
        
        <div class="chart-wrapper">
            <canvas id="distribution-chart"></canvas>
        </div>
    </div>

    <script>
        let distributionChart = null;
        let logElement = document.getElementById('debug-log');
        
        function log(message, type = 'info') {
            const timestamp = new Date().toLocaleTimeString();
            const className = type === 'error' ? 'error' : type === 'success' ? 'success' : type === 'warning' ? 'warning' : '';
            logElement.innerHTML += `<div class="step ${className}">[${timestamp}] ${message}</div>`;
            logElement.scrollTop = logElement.scrollHeight;
            console.log(`[${type.toUpperCase()}]`, message);
        }
        
        function clearLog() {
            logElement.innerHTML = 'è°ƒè¯•æ—¥å¿—å·²æ¸…ç©º...';
        }
        
        // æ¨¡æ‹Ÿåç«¯è¿”å›çš„æ•°æ®ç»“æ„
        function getMockDistributionData() {
            return {
                bins: ['-10~-8', '-8~-6', '-6~-4', '-4~-2', '-2~0', '0~2', '2~4', '4~6', '6~8', '8~10'],
                fund1_counts: [2, 5, 15, 25, 30, 28, 18, 10, 5, 2],
                fund2_counts: [1, 3, 12, 20, 35, 25, 20, 12, 8, 4],
                fund1_name: 'åå®‰äº‹ä»¶é©±åŠ¨é‡åŒ–æ··åˆA',
                fund2_name: 'å¯Œå›½åˆ›ä¸šæ¿ETFè”æ¥C'
            };
        }
        
        function step1_checkData() {
            log('=== æ­¥éª¤1: æ£€æŸ¥æ•°æ®ç»“æ„ ===', 'info');
            
            const data = getMockDistributionData();
            log('åŸå§‹æ•°æ®:', 'info');
            log(JSON.stringify(data, null, 2), 'info');
            
            // éªŒè¯å¿…éœ€å­—æ®µ
            const requiredFields = ['bins', 'fund1_counts', 'fund2_counts'];
            let isValid = true;
            
            for (let field of requiredFields) {
                if (!data[field]) {
                    log(`âŒ ç¼ºå°‘å¿…éœ€å­—æ®µ: ${field}`, 'error');
                    isValid = false;
                } else {
                    log(`âœ… å­—æ®µ ${field} å­˜åœ¨ï¼Œé•¿åº¦: ${data[field].length}`, 'success');
                }
            }
            
            // æ£€æŸ¥æ•°ç»„é•¿åº¦ä¸€è‡´æ€§
            if (data.bins && data.fund1_counts && data.fund2_counts) {
                if (data.bins.length !== data.fund1_counts.length || 
                    data.bins.length !== data.fund2_counts.length) {
                    log(`âŒ æ•°ç»„é•¿åº¦ä¸ä¸€è‡´: bins(${data.bins.length}), fund1(${data.fund1_counts.length}), fund2(${data.fund2_counts.length})`, 'error');
                    isValid = false;
                } else {
                    log(`âœ… æ‰€æœ‰æ•°ç»„é•¿åº¦ä¸€è‡´: ${data.bins.length}`, 'success');
                }
            }
            
            if (isValid) {
                log('âœ… æ•°æ®ç»“æ„éªŒè¯é€šè¿‡', 'success');
            } else {
                log('âŒ æ•°æ®ç»“æ„éªŒè¯å¤±è´¥', 'error');
            }
        }
        
        function step2_checkCanvas() {
            log('=== æ­¥éª¤2: æ£€æŸ¥Canvaså…ƒç´  ===', 'info');
            
            const canvas = document.getElementById('distribution-chart');
            if (!canvas) {
                log('âŒ Canvaså…ƒç´ æœªæ‰¾åˆ° (id: distribution-chart)', 'error');
                return false;
            }
            
            log(`âœ… Canvaså…ƒç´ æ‰¾åˆ°`, 'success');
            log(`Canvas ID: ${canvas.id}`, 'info');
            log(`Canvas ç±»å: ${canvas.className}`, 'info');
            
            // æ£€æŸ¥Canvaså°ºå¯¸
            const rect = canvas.getBoundingClientRect();
            log(`Canvas å°ºå¯¸: ${rect.width} x ${rect.height}px`, 'info');
            log(`Canvas offsetWidth: ${canvas.offsetWidth}px`, 'info');
            log(`Canvas offsetHeight: ${canvas.offsetHeight}px`, 'info');
            
            // æ£€æŸ¥çˆ¶å®¹å™¨
            const parent = canvas.parentElement;
            if (parent) {
                log(`çˆ¶å®¹å™¨ç±»å: ${parent.className}`, 'info');
                const parentRect = parent.getBoundingClientRect();
                log(`çˆ¶å®¹å™¨å°ºå¯¸: ${parentRect.width} x ${parentRect.height}px`, 'info');
            }
            
            return true;
        }
        
        function step3_checkContext() {
            log('=== æ­¥éª¤3: æ£€æŸ¥Canvasä¸Šä¸‹æ–‡ ===', 'info');
            
            const canvas = document.getElementById('distribution-chart');
            if (!canvas) {
                log('âŒ Canvaså…ƒç´ ä¸å­˜åœ¨ï¼Œæ— æ³•è·å–ä¸Šä¸‹æ–‡', 'error');
                return false;
            }
            
            const ctx = canvas.getContext('2d');
            if (!ctx) {
                log('âŒ æ— æ³•è·å–2Dä¸Šä¸‹æ–‡', 'error');
                return false;
            }
            
            log('âœ… æˆåŠŸè·å–Canvas 2Dä¸Šä¸‹æ–‡', 'success');
            log(`ä¸Šä¸‹æ–‡ç±»å‹: ${ctx.constructor.name}`, 'info');
            
            // æµ‹è¯•åŸºæœ¬ç»˜å›¾åŠŸèƒ½
            try {
                ctx.fillStyle = '#3b82f6';
                ctx.fillRect(10, 10, 100, 50);
                log('âœ… Canvasç»˜å›¾åŠŸèƒ½æµ‹è¯•æˆåŠŸ', 'success');
                return true;
            } catch (error) {
                log(`âŒ Canvasç»˜å›¾æµ‹è¯•å¤±è´¥: ${error.message}`, 'error');
                return false;
            }
        }
        
        function step4_createChart() {
            log('=== æ­¥éª¤4: åˆ›å»ºChart.jså›¾è¡¨ ===', 'info');
            
            const canvas = document.getElementById('distribution-chart');
            if (!canvas) {
                log('âŒ Canvaså…ƒç´ ä¸å­˜åœ¨', 'error');
                return false;
            }
            
            const ctx = canvas.getContext('2d');
            if (!ctx) {
                log('âŒ Canvasä¸Šä¸‹æ–‡ä¸å­˜åœ¨', 'error');
                return false;
            }
            
            // é”€æ¯ç°æœ‰å›¾è¡¨
            if (distributionChart) {
                log('ğŸ—‘ï¸ é”€æ¯ç°æœ‰å›¾è¡¨', 'warning');
                distributionChart.destroy();
                distributionChart = null;
            }
            
            const data = getMockDistributionData();
            
            try {
                log('ğŸš€ å¼€å§‹åˆ›å»ºChart.jså›¾è¡¨...', 'info');
                
                distributionChart = new Chart(ctx, {
                    type: 'bar',
                    data: {
                        labels: data.bins,
                        datasets: [
                            {
                                label: data.fund1_name,
                                data: data.fund1_counts,
                                backgroundColor: 'rgba(59, 130, 246, 0.6)',
                                borderColor: 'rgba(59, 130, 246, 0.8)',
                                borderWidth: 1
                            },
                            {
                                label: data.fund2_name,
                                data: data.fund2_counts,
                                backgroundColor: 'rgba(16, 185, 129, 0.6)',
                                borderColor: 'rgba(16, 185, 129, 0.8)',
                                borderWidth: 1
                            }
                        ]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        layout: {
                            padding: {
                                left: 80,
                                right: 40,
                                top: 50,
                                bottom: 80
                            }
                        },
                        plugins: {
                            title: {
                                display: true,
                                text: 'æ”¶ç›Šç‡åˆ†å¸ƒå¯¹æ¯”å›¾',
                                font: {
                                    size: 18,
                                    weight: 'bold'
                                },
                                padding: {
                                    top: 10,
                                    bottom: 25
                                }
                            },
                            legend: {
                                display: true,
                                position: 'top',
                                labels: {
                                    font: {
                                        size: 14
                                    },
                                    padding: 15,
                                    usePointStyle: true
                                }
                            }
                        },
                        scales: {
                            x: {
                                title: {
                                    display: true,
                                    text: 'æ—¥æ”¶ç›Šç‡åŒºé—´ (%)',
                                    font: {
                                        size: 15,
                                        weight: 'bold'
                                    },
                                    padding: {
                                        top: 20
                                    }
                                }
                            },
                            y: {
                                title: {
                                    display: true,
                                    text: 'å¤©æ•°',
                                    font: {
                                        size: 15,
                                        weight: 'bold'
                                    },
                                    padding: {
                                        bottom: 20
                                    }
                                }
                            }
                        }
                    }
                });
                
                log('âœ… Chart.jså›¾è¡¨åˆ›å»ºæˆåŠŸ', 'success');
                log(`å›¾è¡¨ç±»å‹: ${distributionChart.config.type}`, 'info');
                log(`æ•°æ®é›†æ•°é‡: ${distributionChart.data.datasets.length}`, 'info');
                log(`æ ‡ç­¾æ•°é‡: ${distributionChart.data.labels.length}`, 'info');
                
                return true;
            } catch (error) {
                log(`âŒ Chart.jså›¾è¡¨åˆ›å»ºå¤±è´¥: ${error.message}`, 'error');
                console.error('Chart creation error details:', error);
                return false;
            }
        }
        
        function step5_fullTest() {
            log('=== æ­¥éª¤5: å®Œæ•´æµ‹è¯•æµç¨‹ ===', 'info');
            
            // é‡ç½®Canvas
            const canvas = document.getElementById('distribution-chart');
            const ctx = canvas.getContext('2d');
            ctx.clearRect(0, 0, canvas.width, canvas.height);
            
            // æŒ‰é¡ºåºæ‰§è¡Œæ‰€æœ‰æ­¥éª¤
            setTimeout(() => {
                step1_checkData();
                setTimeout(() => {
                    if (step2_checkCanvas()) {
                        setTimeout(() => {
                            if (step3_checkContext()) {
                                setTimeout(() => {
                                    step4_createChart();
                                }, 500);
                            }
                        }, 500);
                    }
                }, 500);
            }, 100);
        }
        
        // é¡µé¢åŠ è½½å®Œæˆåè‡ªåŠ¨è¿è¡Œå®Œæ•´æµ‹è¯•
        document.addEventListener('DOMContentLoaded', function() {
            log(`é¡µé¢åŠ è½½å®Œæˆï¼ŒChart.jsç‰ˆæœ¬: ${Chart.version}`, 'success');
            log('è‡ªåŠ¨å¼€å§‹å®Œæ•´æµ‹è¯•...', 'info');
            step5_fullTest();
        });
    </script>
</body>
</html>