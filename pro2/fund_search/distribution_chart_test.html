<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>æ”¶ç›Šç‡åˆ†å¸ƒå›¾æµ‹è¯•</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        body {
            font-family: Arial, sans-serif;
            padding: 20px;
            background-color: #f5f7fa;
        }
        .container {
            max-width: 1200px;
            margin: 0 auto;
        }
        .chart-wrapper {
            background: white;
            border-radius: 10px;
            padding: 30px;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.05);
            margin-bottom: 30px;
            min-height: 500px;
        }
        .chart-wrapper canvas {
            width: 100% !important;
            height: 500px !important;
        }
        .controls {
            margin-bottom: 20px;
            padding: 15px;
            background: white;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
        }
        button {
            background: #3b82f6;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 5px;
            cursor: pointer;
            margin-right: 10px;
        }
        button:hover {
            background: #2563eb;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>æ”¶ç›Šç‡åˆ†å¸ƒå›¾æµ‹è¯•é¡µé¢</h1>
        
        <div class="controls">
            <button onclick="testEmptyData()">æµ‹è¯•ç©ºæ•°æ®</button>
            <button onclick="testValidData()">æµ‹è¯•æœ‰æ•ˆæ•°æ®</button>
            <button onclick="testMissingFields()">æµ‹è¯•ç¼ºå¤±å­—æ®µ</button>
            <button onclick="clearChart()">æ¸…ç©ºå›¾è¡¨</button>
        </div>
        
        <div class="chart-wrapper">
            <canvas id="distribution-chart"></canvas>
        </div>
        
        <div id="log" style="background: #f8f9fa; padding: 15px; border-radius: 5px; margin-top: 20px; font-family: monospace; font-size: 12px;"></div>
    </div>

    <script>
        let distributionChart = null;
        
        function log(message) {
            const logDiv = document.getElementById('log');
            const timestamp = new Date().toLocaleTimeString();
            logDiv.innerHTML += `[${timestamp}] ${message}\n`;
            logDiv.scrollTop = logDiv.scrollHeight;
            console.log(message);
        }
        
        function clearChart() {
            if (distributionChart) {
                distributionChart.destroy();
                distributionChart = null;
                log('âœ… å›¾è¡¨å·²æ¸…ç©º');
            }
        }
        
        function initDistributionChart(distributionData) {
            log('ğŸ“ˆ åˆå§‹åŒ–æ”¶ç›Šç‡åˆ†å¸ƒå›¾');
            log('æ¥æ”¶æ•°æ®: ' + JSON.stringify(distributionData, null, 2));
            
            const canvas = document.getElementById('distribution-chart');
            if (!canvas) {
                log('âŒ Canvaså…ƒç´ æœªæ‰¾åˆ°');
                return;
            }
            
            // éªŒè¯æ•°æ®å®Œæ•´æ€§
            if (!distributionData) {
                log('âŒ åˆ†å¸ƒæ•°æ®ä¸ºç©º');
                return;
            }
            
            if (!distributionData.bins) {
                log('âŒ ç¼ºå°‘binsæ•°æ®');
                return;
            }
            
            if (!distributionData.fund1_counts || !distributionData.fund2_counts) {
                log('âŒ ç¼ºå°‘åŸºé‡‘è®¡æ•°æ•°æ®');
                return;
            }
            
            log(`ğŸ“Š æ•°æ®éªŒè¯é€šè¿‡ï¼Œbins: ${distributionData.bins.length}ä¸ª, fund1: ${distributionData.fund1_counts.length}ä¸ª, fund2: ${distributionData.fund2_counts.length}ä¸ª`);
            
            const ctx = canvas.getContext('2d');
            if (!ctx) {
                log('âŒ æ— æ³•è·å–Canvasä¸Šä¸‹æ–‡');
                return;
            }
            
            // é”€æ¯æ—§å›¾è¡¨
            if (distributionChart) {
                log('ğŸ—‘ï¸ é”€æ¯æ—§å›¾è¡¨');
                distributionChart.destroy();
            }
            
            try {
                distributionChart = new Chart(ctx, {
                    type: 'bar',
                    data: {
                        labels: distributionData.bins,
                        datasets: [
                            {
                                label: distributionData.fund1_name || 'åŸºé‡‘1',
                                data: distributionData.fund1_counts,
                                backgroundColor: 'rgba(59, 130, 246, 0.6)',
                                borderColor: 'rgba(59, 130, 246, 0.8)',
                                borderWidth: 1
                            },
                            {
                                label: distributionData.fund2_name || 'åŸºé‡‘2',
                                data: distributionData.fund2_counts,
                                backgroundColor: 'rgba(16, 185, 129, 0.6)',
                                borderColor: 'rgba(16, 185, 129, 0.8)',
                                borderWidth: 1
                            }
                        ]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        layout: {
                            padding: {
                                left: 80,
                                right: 40,
                                top: 50,
                                bottom: 80
                            }
                        },
                        plugins: {
                            title: {
                                display: true,
                                text: 'æ”¶ç›Šç‡åˆ†å¸ƒå¯¹æ¯”å›¾',
                                font: {
                                    size: 18,
                                    weight: 'bold'
                                },
                                padding: {
                                    top: 10,
                                    bottom: 25
                                }
                            },
                            legend: {
                                display: true,
                                position: 'top',
                                labels: {
                                    font: {
                                        size: 14
                                    },
                                    padding: 15,
                                    usePointStyle: true
                                }
                            },
                            tooltip: {
                                bodyFont: {
                                    size: 14
                                },
                                titleFont: {
                                    size: 14
                                },
                                callbacks: {
                                    title: function(tooltipItems) {
                                        return `æ”¶ç›Šç‡åŒºé—´: ${tooltipItems[0].label}%`;
                                    },
                                    label: function(context) {
                                        return `${context.dataset.label}: ${context.parsed.y} å¤©`;
                                    }
                                }
                            }
                        },
                        scales: {
                            x: {
                                title: {
                                    display: true,
                                    text: 'æ—¥æ”¶ç›Šç‡åŒºé—´ (%)',
                                    font: {
                                        size: 15,
                                        weight: 'bold'
                                    },
                                    padding: {
                                        top: 20
                                    }
                                },
                                ticks: {
                                    font: {
                                        size: 13
                                    }
                                }
                            },
                            y: {
                                title: {
                                    display: true,
                                    text: 'å¤©æ•°',
                                    font: {
                                        size: 15,
                                        weight: 'bold'
                                    },
                                    padding: {
                                        bottom: 20
                                    }
                                },
                                ticks: {
                                    font: {
                                        size: 13
                                    }
                                }
                            }
                        }
                    }
                });
                
                log('âœ… æ”¶ç›Šç‡åˆ†å¸ƒå›¾åˆ›å»ºæˆåŠŸ');
            } catch (error) {
                log('âŒ æ”¶ç›Šç‡åˆ†å¸ƒå›¾åˆ›å»ºå¤±è´¥: ' + error.message);
                console.error('Chart creation error:', error);
            }
        }
        
        function testEmptyData() {
            log('=== æµ‹è¯•ç©ºæ•°æ® ===');
            initDistributionChart(null);
        }
        
        function testValidData() {
            log('=== æµ‹è¯•æœ‰æ•ˆæ•°æ® ===');
            const testData = {
                bins: ['-10~-8', '-8~-6', '-6~-4', '-4~-2', '-2~0', '0~2', '2~4', '4~6', '6~8', '8~10'],
                fund1_counts: [2, 5, 15, 25, 30, 28, 18, 10, 5, 2],
                fund2_counts: [1, 3, 12, 20, 35, 25, 20, 12, 8, 4],
                fund1_name: 'åå®‰äº‹ä»¶é©±åŠ¨é‡åŒ–æ··åˆA',
                fund2_name: 'å¯Œå›½åˆ›ä¸šæ¿ETFè”æ¥C'
            };
            initDistributionChart(testData);
        }
        
        function testMissingFields() {
            log('=== æµ‹è¯•ç¼ºå¤±å­—æ®µ ===');
            const testData = {
                bins: ['-5~0', '0~5', '5~10'],
                fund1_counts: [10, 20, 5]
                // æ•…æ„ç¼ºå°‘ fund2_counts
            };
            initDistributionChart(testData);
        }
        
        // é¡µé¢åŠ è½½å®Œæˆåè‡ªåŠ¨æµ‹è¯•
        document.addEventListener('DOMContentLoaded', function() {
            log('é¡µé¢åŠ è½½å®Œæˆï¼ŒChart.jsç‰ˆæœ¬: ' + Chart.version);
            testValidData();
        });
    </script>
</body>
</html>