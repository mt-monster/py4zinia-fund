<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>市场指数测试</title>
</head>
<body>
    <h1>市场指数测试页面</h1>
    <p>沪深主板指数: <span id="index-value">--</span></p>
    <button onclick="testUpdate()">测试更新</button>
    <button onclick="startTimer()">开始定时更新</button>
    <button onclick="stopTimer()">停止定时更新</button>
    
    <script>
        let timer = null;
        
        // 模拟FundConfig
        const FundConfig = {
            api: {
                marketIndex: '/api/market/index'
            }
        };
        
        // 模拟FundAPI
        const FundAPI = {
            async getMarketIndex() {
                try {
                    const response = await fetch(FundConfig.api.marketIndex);
                    if (!response.ok) {
                        throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                    }
                    const data = await response.json();
                    if (!data.success) {
                        throw new Error(data.error || '获取指数失败');
                    }
                    return {
                        success: true,
                        data: data.data
                    };
                } catch (error) {
                    console.error('API Error - getMarketIndex:', error);
                    return {
                        success: false,
                        error: error.message
                    };
                }
            }
        };
        
        async function updateMarketIndex() {
            try {
                console.log('[Test] 开始更新市场指数');
                const response = await FundAPI.getMarketIndex();
                console.log('[Test] API响应:', response);
                if (response.success) {
                    const indexElement = document.getElementById('index-value');
                    console.log('[Test] indexElement:', indexElement);
                    const value = Number(response.data.value);
                    const change = Number(response.data.change);
                    const changePercent = Number(response.data.changePercent);
                    const formattedValue = Number.isNaN(value) ? '--' : value.toFixed(2);
                    const formattedChangePercent = Number.isNaN(changePercent)
                        ? '--'
                        : `${changePercent >= 0 ? '+' : ''}${changePercent.toFixed(2)}%`;
                    
                    console.log('[Test] 更新前文本:', indexElement.textContent);
                    indexElement.textContent = `${formattedValue} ${formattedChangePercent}`;
                    indexElement.className = change >= 0 ? 'cell-positive' : 'cell-negative';
                    console.log('[Test] 更新后文本:', indexElement.textContent);
                } else {
                    console.error('[Test] API调用失败:', response.error);
                }
            } catch (error) {
                console.error('Update market index error:', error);
            }
        }
        
        function testUpdate() {
            updateMarketIndex();
        }
        
        function startTimer() {
            if (timer) {
                clearInterval(timer);
            }
            console.log('[Test] 启动定时更新，每10秒更新一次');
            updateMarketIndex(); // 立即执行一次
            timer = setInterval(() => {
                console.log('[Test] 定时更新市场指数');
                updateMarketIndex();
            }, 10000); // 10秒间隔用于测试
        }
        
        function stopTimer() {
            if (timer) {
                clearInterval(timer);
                timer = null;
                console.log('[Test] 停止定时更新');
            }
        }
        
        // 页面加载后立即测试一次
        document.addEventListener('DOMContentLoaded', () => {
            console.log('[Test] 页面加载完成，开始测试');
            testUpdate();
        });
    </script>
</body>
</html>