<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>策略分析 - 基金分析系统</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.0/font/bootstrap-icons.css" rel="stylesheet">
    <style>
        :root { --primary-color: #3498db; --success-color: #27ae60; --danger-color: #e74c3c; }
        body { background-color: #f5f6fa; font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; }
        .navbar { background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); }
        .card { border: none; border-radius: 12px; box-shadow: 0 2px 12px rgba(0,0,0,0.08); margin-bottom: 20px; }
        .strategy-card { border-left: 4px solid var(--primary-color); }
        .strategy-card.buy { border-left-color: var(--success-color); }
        .strategy-card.sell { border-left-color: var(--danger-color); }
        .result-box { background: #f8f9fa; border-radius: 8px; padding: 20px; margin-top: 15px; }
        .positive { color: #e74c3c; }  /* 红色表示上涨 */
        .negative { color: #27ae60; }  /* 绿色表示下跌 */
        .btn-analyze { border-radius: 20px; padding: 10px 30px; }
    </style>
</head>
<body>
    <nav class="navbar navbar-expand-lg navbar-dark mb-4">
        <div class="container">
            <a class="navbar-brand" href="/"><i class="bi bi-graph-up-arrow me-2"></i>基金分析系统</a>
            <div class="navbar-nav ms-auto">
                <a class="nav-link" href="/"><i class="bi bi-house me-1"></i>首页</a>
                <a class="nav-link active" href="/strategy"><i class="bi bi-lightbulb me-1"></i>策略分析</a>
            </div>
        </div>
    </nav>

    <div class="container">
        <div class="row">
            <!-- 策略列表 -->
            <div class="col-md-4">
                <div class="card">
                    <div class="card-header bg-white"><h5 class="mb-0"><i class="bi bi-list-check me-2"></i>可用策略</h5></div>
                    <div class="card-body p-0">
                        <div class="list-group list-group-flush" id="strategy-list"></div>
                    </div>
                </div>
            </div>

            <!-- 策略测试 -->
            <div class="col-md-8">
                <!-- 手动测试 -->
                <div class="card">
                    <div class="card-header bg-white"><h5 class="mb-0"><i class="bi bi-calculator me-2"></i>策略测试</h5></div>
                    <div class="card-body">
                        <div class="row">
                            <div class="col-md-5">
                                <label class="form-label">今日收益率 (%)</label>
                                <input type="number" class="form-control" id="today-return" step="0.01" value="0.5">
                            </div>
                            <div class="col-md-5">
                                <label class="form-label">昨日收益率 (%)</label>
                                <input type="number" class="form-control" id="prev-day-return" step="0.01" value="-0.3">
                            </div>
                            <div class="col-md-2 d-flex align-items-end">
                                <button class="btn btn-primary btn-analyze w-100" onclick="analyzeStrategy()">
                                    <i class="bi bi-play-fill"></i> 分析
                                </button>
                            </div>
                        </div>
                        <div class="result-box" id="analyze-result" style="display:none;">
                            <h6><i class="bi bi-check-circle me-1"></i>分析结果</h6>
                            <div id="analyze-result-content"></div>
                        </div>
                    </div>
                </div>

                <!-- 策略回测 -->
                <div class="card">
                    <div class="card-header bg-white"><h5 class="mb-0"><i class="bi bi-clock-history me-2"></i>策略回测</h5></div>
                    <div class="card-body">
                        <div class="row mb-3">
                            <div class="col-md-4">
                                <label class="form-label">基金代码</label>
                                <input type="text" class="form-control" id="backtest-fund" placeholder="如: 000001">
                            </div>
                            <div class="col-md-4">
                                <label class="form-label">初始金额 (元)</label>
                                <input type="number" class="form-control" id="initial-amount" value="10000">
                            </div>
                            <div class="col-md-4">
                                <label class="form-label">回测天数</label>
                                <select class="form-select" id="backtest-days">
                                    <option value="30">近30天</option>
                                    <option value="60">近60天</option>
                                    <option value="90" selected>近90天</option>
                                </select>
                            </div>
                        </div>
                        <button class="btn btn-success btn-analyze" onclick="runBacktest()">
                            <i class="bi bi-play-circle me-1"></i>开始回测
                        </button>
                        <div class="result-box" id="backtest-result" style="display:none;">
                            <h6><i class="bi bi-bar-chart me-1"></i>回测结果</h6>
                            <div id="backtest-result-content"></div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        document.addEventListener('DOMContentLoaded', loadStrategies);

        async function loadStrategies() {
            try {
                const response = await fetch('/api/strategies');
                const result = await response.json();
                if (result.success && result.data) {
                    const list = document.getElementById('strategy-list');
                    list.innerHTML = result.data.map(s => `
                        <div class="list-group-item strategy-card ${s.action.includes('buy') ? 'buy' : s.action.includes('sell') ? 'sell' : ''}">
                            <div class="d-flex justify-content-between align-items-center">
                                <strong>${s.label}</strong>
                                <span class="badge ${s.action.includes('buy') ? 'bg-success' : s.action.includes('sell') ? 'bg-danger' : 'bg-secondary'}">${s.action}</span>
                            </div>
                            <small class="text-muted">${s.description}</small>
                            ${s.redeem_amount > 0 ? `<br><small class="text-danger">赎回: ¥${s.redeem_amount}</small>` : ''}
                        </div>
                    `).join('');
                }
            } catch (error) { console.error('加载策略失败:', error); }
        }

        async function analyzeStrategy() {
            const todayReturn = parseFloat(document.getElementById('today-return').value);
            const prevDayReturn = parseFloat(document.getElementById('prev-day-return').value);
            try {
                const response = await fetch('/api/strategy/analyze', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ today_return: todayReturn, prev_day_return: prevDayReturn })
                });
                const result = await response.json();
                if (result.success && result.data) {
                    const d = result.data;
                    document.getElementById('analyze-result').style.display = 'block';
                    document.getElementById('analyze-result-content').innerHTML = `
                        <table class="table table-sm mb-0">
                            <tr><td>策略名称</td><td><strong>${d.strategy_name}</strong></td></tr>
                            <tr><td>状态标签</td><td>${d.status_label}</td></tr>
                            <tr><td>操作建议</td><td>${d.operation_suggestion}</td></tr>
                            <tr><td>买入倍数</td><td class="positive">${d.buy_multiplier}×</td></tr>
                            <tr><td>赎回金额</td><td class="negative">¥${d.redeem_amount}</td></tr>
                            <tr><td>执行金额</td><td>${d.execution_amount}</td></tr>
                        </table>
                    `;
                }
            } catch (error) { console.error('策略分析失败:', error); alert('分析失败: ' + error.message); }
        }

        async function runBacktest() {
            const fundCode = document.getElementById('backtest-fund').value.trim();
            const initialAmount = parseFloat(document.getElementById('initial-amount').value);
            const backtestDays = parseInt(document.getElementById('backtest-days').value);
            
            if (!fundCode) { alert('请输入基金代码'); return; }
            if (isNaN(initialAmount) || initialAmount <= 0) { alert('请输入有效的初始金额'); return; }
            
            // 显示加载状态
            const btn = document.querySelector('.btn-success');
            const originalText = btn.innerHTML;
            btn.innerHTML = '<span class="spinner-border spinner-border-sm me-1"></span>回测中...';
            btn.disabled = true;
            
            try {
                const response = await fetch('/api/strategy/backtest', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ 
                        fund_code: fundCode, 
                        initial_amount: initialAmount,
                        days: backtestDays
                    })
                });
                const result = await response.json();
                
                console.log('回测结果:', result);  // 调试日志
                
                if (result.success && result.data) {
                    const d = result.data;
                    const returnClass = d.total_return >= 0 ? 'positive' : 'negative';
                    document.getElementById('backtest-result').style.display = 'block';
                    document.getElementById('backtest-result-content').innerHTML = `
                        <div class="row text-center mb-3">
                            <div class="col-md-3">
                                <div class="h4">¥${d.initial_amount.toLocaleString()}</div>
                                <small class="text-muted">初始金额</small>
                            </div>
                            <div class="col-md-3">
                                <div class="h4">¥${d.total_value.toLocaleString()}</div>
                                <small class="text-muted">最终价值</small>
                            </div>
                            <div class="col-md-3">
                                <div class="h4 ${returnClass}">${d.total_return >= 0 ? '+' : ''}${d.total_return.toFixed(2)}%</div>
                                <small class="text-muted">总收益率</small>
                            </div>
                            <div class="col-md-3">
                                <div class="h4">${d.trades_count}</div>
                                <small class="text-muted">交易次数</small>
                            </div>
                        </div>
                        <hr>
                        <div class="row">
                            <div class="col-md-6">
                                <p><strong>账户余额:</strong> ¥${d.final_balance.toFixed(2)}</p>
                                <p><strong>持仓价值:</strong> ¥${d.final_holdings.toFixed(2)}</p>
                            </div>
                            <div class="col-md-6">
                                <p><strong>回测天数:</strong> ${d.backtest_days || backtestDays}天</p>
                                <p><strong>数据条数:</strong> ${d.data_count || '--'}条</p>
                            </div>
                        </div>
                        ${d.trades && d.trades.length > 0 ? `
                            <hr>
                            <details>
                                <summary class="mb-2"><strong>交易记录 (${d.trades.length}条)</strong></summary>
                                <div class="table-responsive mt-2">
                                    <table class="table table-sm table-striped">
                                        <thead><tr><th>日期</th><th>操作</th><th>金额</th><th>余额</th><th>持仓</th></tr></thead>
                                        <tbody>
                                            ${d.trades.map(t => `
                                                <tr>
                                                    <td>${t.date}</td>
                                                    <td class="${t.action === 'buy' ? 'positive' : 'negative'}">${t.action === 'buy' ? '买入' : '卖出'}</td>
                                                    <td>¥${t.amount.toFixed(2)}</td>
                                                    <td>¥${t.balance.toFixed(2)}</td>
                                                    <td>¥${t.holdings.toFixed(2)}</td>
                                                </tr>
                                            `).join('')}
                                        </tbody>
                                    </table>
                                </div>
                            </details>
                        ` : '<p class="text-muted mt-3">回测期间无交易记录</p>'}
                    `;
                } else { 
                    document.getElementById('backtest-result').style.display = 'block';
                    document.getElementById('backtest-result-content').innerHTML = `
                        <div class="alert alert-warning mb-0">
                            <i class="bi bi-exclamation-triangle me-2"></i>${result.error || '回测失败，请检查基金代码是否正确'}
                        </div>
                    `;
                }
            } catch (error) { 
                console.error('回测失败:', error); 
                document.getElementById('backtest-result').style.display = 'block';
                document.getElementById('backtest-result-content').innerHTML = `
                    <div class="alert alert-danger mb-0">
                        <i class="bi bi-x-circle me-2"></i>回测请求失败: ${error.message}
                    </div>
                `;
            } finally {
                btn.innerHTML = originalText;
                btn.disabled = false;
            }
        }
    </script>
</body>
</html>
