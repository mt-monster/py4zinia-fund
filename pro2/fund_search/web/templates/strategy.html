<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>策略分析 - 基金分析系统</title>
    <!-- Bootstrap CSS with fallback -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet" 
          onerror="this.onerror=null;this.href='https://cdnjs.cloudflare.com/ajax/libs/bootstrap/5.3.0/css/bootstrap.min.css';">
    <!-- Bootstrap Icons with fallback -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.0/font/bootstrap-icons.css" rel="stylesheet"
          onerror="this.onerror=null;this.href='https://cdnjs.cloudflare.com/ajax/libs/bootstrap-icons/1.10.0/font/bootstrap-icons.min.css';">
    <style>
        :root { 
            --primary-color: #4361ee; 
            --primary-dark: #3a56d4;
            --primary-light: #edf2ff;
            --secondary-color: #6c757d;
            --success-color: #06d6a0; 
            --success-dark: #05b38a;
            --success-light: #e8fcf3;
            --danger-color: #ef476f; 
            --danger-dark: #d4355d;
            --danger-light: #fceced;
            --warning-color: #ffd166;
            --warning-dark: #e6bc5c;
            --warning-light: #fff9e6;
            --info-color: #118ab2;
            --info-dark: #0f7aa0;
            --info-light: #e6f7ff;
            --light-bg: #f8f9fa;
            --dark-bg: #343a40;
            --border-color: #e0e0e0;
            --text-primary: #212529;
            --text-secondary: #6c757d;
            --card-shadow: 0 6px 20px rgba(0, 0, 0, 0.08);
            --card-shadow-hover: 0 12px 30px rgba(67, 97, 238, 0.15);
            --transition: all 0.3s cubic-bezier(0.25, 0.8, 0.25, 1);
            --border-radius: 12px;
            --spacing-xs: 0.25rem;
            --spacing-sm: 0.5rem;
            --spacing-md: 1rem;
            --spacing-lg: 1.5rem;
            --spacing-xl: 2rem;
        }
        
        body { 
            background-color: #f5f7ff; 
            font-family: 'Inter', 'Segoe UI', system-ui, -apple-system, sans-serif; 
            color: var(--text-primary);
            line-height: 1.6;
        }
        
        /* Improved Navbar */
        .navbar { 
            background: linear-gradient(135deg, #4361ee 0%, #3a0ca3 100%); 
            box-shadow: 0 4px 12px rgba(67, 97, 238, 0.15);
            padding: 1rem 0;
            position: sticky;
            top: 0;
            z-index: 1030;
        }
        
        .navbar-brand {
            font-weight: 700;
            font-size: 1.25rem;
            letter-spacing: 0.5px;
            color: #fff !important;
            display: flex;
            align-items: center;
        }
        
        .navbar-brand i {
            font-size: 1.3rem;
        }
        
        .navbar-nav {
            gap: 0.5rem;
        }
        
        .nav-link {
            font-weight: 500;
            font-size: 0.95rem;
            color: rgba(255, 255, 255, 0.85) !important;
            transition: var(--transition);
            border-radius: 8px;
            padding: 0.5rem 1rem !important;
            display: flex;
            align-items: center;
        }
        
        .nav-link i {
            font-size: 1rem;
        }
        
        .nav-link:hover {
            background: rgba(255, 255, 255, 0.15);
            color: #fff !important;
            transform: translateY(-1px);
        }
        
        .nav-link.active {
            background: rgba(255, 255, 255, 0.25);
            color: #fff !important;
            font-weight: 600;
        }
        
        /* Enhanced Card Styling */
        .card { 
            border: none; 
            border-radius: var(--border-radius); 
            box-shadow: var(--card-shadow); 
            margin-bottom: var(--spacing-xl);
            transition: var(--transition);
            overflow: hidden;
            background: white;
        }
        
        .card:hover {
            box-shadow: var(--card-shadow-hover);
            transform: translateY(-5px);
        }
        
        .card-header { 
            background: transparent; 
            border-bottom: 1px solid var(--border-color); 
            font-weight: 700;
            font-size: 1.1rem;
            padding: 1.25rem 1.5rem;
        }
        
        /* Enhanced section headers */
        .section-header {
            margin-bottom: var(--spacing-xl);
            padding: var(--spacing-lg) var(--spacing-xl);
            background: white;
            border-radius: var(--border-radius);
            border-left: 4px solid var(--primary-color);
            box-shadow: var(--card-shadow);
            position: relative;
            overflow: hidden;
        }
        
        .section-header::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 2px;
            background: linear-gradient(90deg, var(--primary-color), var(--success-color));
        }
        
        .section-title {
            font-size: 1.4rem;
            font-weight: 700;
            color: var(--text-primary);
            margin-bottom: var(--spacing-xs);
            position: relative;
            z-index: 1;
        }
        
        .section-description {
            font-size: 0.95rem;
            color: var(--text-secondary);
            margin-bottom: 0;
            position: relative;
            z-index: 1;
        }
        
        /* Enhanced typography */
        h1, h2, h3, h4, h5, h6 {
            font-weight: 700;
            line-height: 1.3;
            color: var(--text-primary);
        }
        
        .metric-value { 
            font-size: 1.7rem; 
            font-weight: 800; 
            line-height: 1.2;
        }
        
        .metric-label { 
            font-size: 0.9rem; 
            color: var(--text-secondary); 
            font-weight: 500;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }
        
        /* Enhanced metric cards */
        .metric-card { 
            text-align: center; 
            padding: var(--spacing-lg); 
            border-radius: var(--border-radius); 
            background: white;
            border: 1px solid var(--border-color);
            transition: var(--transition);
            height: 100%;
        }
        
        .metric-card:hover {
            transform: translateY(-3px);
            box-shadow: 0 8px 20px rgba(0, 0, 0, 0.08);
            border-color: var(--primary-color);
        }
        
        /* Enhanced strategy cards */
        .strategy-card { 
            border-left: 4px solid var(--primary-color); 
            transition: var(--transition); 
            background: white;
            border: 1px solid var(--border-color);
        }
        
        .strategy-card:hover { 
            transform: translateX(5px); 
            box-shadow: var(--card-shadow-hover);
            border-left-color: var(--primary-dark);
        }
        
        .strategy-card.buy { 
            border-left-color: var(--success-color); 
        }
        
        .strategy-card.sell { 
            border-left-color: var(--danger-color); 
        }
        
        /* Enhanced result box */
        .result-box { 
            background: white; 
            border-radius: var(--border-radius); 
            padding: var(--spacing-xl); 
            margin-top: var(--spacing-lg);
            border: 1px solid var(--border-color);
            box-shadow: var(--card-shadow);
        }
        
        /* Enhanced positive/negative indicators */
        .positive { 
            color: var(--success-color); 
            font-weight: 700;
        }
        
        .negative { 
            color: var(--danger-color); 
            font-weight: 700;
        }
        
        /* Enhanced button styling */
        .btn-analyze { 
            border-radius: 30px; 
            padding: 12px 35px; 
            font-weight: 600;
            letter-spacing: 0.5px;
            box-shadow: 0 4px 15px rgba(67, 97, 238, 0.2);
            transition: var(--transition);
        }
        
        .btn-analyze:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(67, 97, 238, 0.3);
        }
        
        .btn-success {
            background: linear-gradient(135deg, var(--success-color), var(--success-dark));
            border: none;
        }
        
        .btn-primary {
            background: linear-gradient(135deg, var(--primary-color), var(--primary-dark));
            border: none;
        }
        
        .btn-danger {
            background: linear-gradient(135deg, var(--danger-color), var(--danger-dark));
            border: none;
        }
        
        /* Enhanced evaluation grid */
        .evaluation-grid { 
            display: grid; 
            grid-template-columns: repeat(auto-fit, minmax(160px, 1fr)); 
            gap: var(--spacing-md); 
            margin-top: var(--spacing-md);
        }
        
        .eval-item { 
            background: white; 
            padding: var(--spacing-md); 
            border-radius: var(--border-radius); 
            text-align: center; 
            border: 1px solid var(--border-color);
            transition: var(--transition);
        }
        
        .eval-item:hover {
            transform: translateY(-3px);
            box-shadow: 0 6px 15px rgba(0, 0, 0, 0.1);
        }
        
        .eval-value { 
            font-size: 1.3rem; 
            font-weight: 800; 
            color: var(--primary-color); 
            margin-bottom: var(--spacing-xs);
        }
        
        .eval-label { 
            font-size: 0.85rem; 
            color: var(--text-secondary); 
            font-weight: 500;
        }
        
        /* Enhanced form controls */
        .form-control, .form-select {
            border: 1px solid var(--border-color);
            border-radius: 8px;
            padding: 0.75rem 1rem;
            transition: var(--transition);
        }
        
        .form-control:focus, .form-select:focus {
            border-color: var(--primary-color);
            box-shadow: 0 0 0 0.2rem rgba(67, 97, 238, 0.25);
        }
        
        /* Enhanced Fund Selector Styles */
        .holdings-item { 
            padding: var(--spacing-md); 
            border-bottom: 1px solid var(--border-color); 
            display: flex; 
            align-items: center; 
            cursor: pointer;
            transition: var(--transition);
            border-radius: 8px;
            margin-bottom: var(--spacing-xs);
        }
        
        .holdings-item:hover { 
            background: var(--primary-light); 
            transform: translateX(3px);
        }
        
        .holdings-item:last-child { 
            border-bottom: none; 
        }
        
        .holdings-checkbox { 
            margin-right: var(--spacing-md); 
            cursor: pointer; 
            width: 18px;
            height: 18px;
        }
        
        .holdings-info { 
            flex: 1; 
        }
        
        .holdings-code { 
            font-weight: 700; 
            color: var(--primary-color); 
            font-size: 0.95rem; 
        }
        
        .holdings-name { 
            font-size: 0.9rem; 
            color: var(--text-secondary); 
            margin-top: var(--spacing-xs); 
        }
        
        .holdings-amount { 
            font-weight: 700; 
            color: var(--text-primary); 
            font-size: 0.95rem; 
        }
        
        .empty-holdings { 
            text-align: center; 
            padding: var(--spacing-xl) var(--spacing-md); 
            color: var(--text-secondary); 
        }
        
        .empty-holdings i { 
            font-size: 2.5rem; 
            margin-bottom: var(--spacing-md); 
            display: block; 
            color: var(--secondary-color);
        }
        
        /* Enhanced Strategy Selector Styles */
        
        /* 策略卡片网格布局 */
        #strategy-cards {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: var(--spacing-md);
            padding: var(--spacing-sm) 0;
        }
        
        @media (min-width: 1400px) {
            #strategy-cards {
                grid-template-columns: repeat(3, 1fr);
            }
        }
        
        @media (max-width: 991px) {
            #strategy-cards {
                grid-template-columns: repeat(2, 1fr);
            }
        }
        
        @media (max-width: 767px) {
            #strategy-cards {
                grid-template-columns: 1fr;
            }
        }
        
        .strategy-selector-card {
            border: 1px solid var(--border-color);
            border-radius: var(--border-radius);
            padding: var(--spacing-md);
            margin-bottom: 0;
            cursor: pointer;
            transition: var(--transition);
            background: white;
            position: relative;
            overflow: hidden;
            display: flex;
            flex-direction: column;
            height: 100%;
        }
        
        .strategy-selector-card::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 3px;
            background: var(--primary-color);
            transform: scaleX(0);
            transform-origin: left;
            transition: var(--transition);
        }
        
        .strategy-selector-card:hover {
            border-color: var(--primary-color);
            box-shadow: var(--card-shadow-hover);
            transform: translateY(-3px);
        }
        
        .strategy-selector-card:hover::before {
            transform: scaleX(1);
        }
        
        .strategy-selector-card.selected {
            border-color: var(--primary-color);
            background: var(--primary-light);
            box-shadow: 0 6px 20px rgba(67, 97, 238, 0.15);
        }
        
        .strategy-selector-card.selected .strategy-name {
            color: var(--primary-color);
            font-weight: 800;
        }
        
        /* 策略头部区域 */
        .strategy-header {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            margin-bottom: var(--spacing-sm);
        }
        
        .strategy-title-area {
            flex: 1;
        }
        
        .strategy-name {
            font-size: 1rem;
            font-weight: 700;
            margin-bottom: 2px;
            color: var(--text-primary);
            display: flex;
            align-items: center;
            gap: 6px;
        }
        
        .strategy-type-badge {
            display: inline-flex;
            align-items: center;
            padding: 2px 8px;
            font-size: 0.7rem;
            font-weight: 600;
            border-radius: 4px;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }
        
        .strategy-type-badge.trend {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
        }
        
        .strategy-type-badge.mean-reversion {
            background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);
            color: white;
        }
        
        .strategy-type-badge.value {
            background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%);
            color: white;
        }
        
        .strategy-type-badge.grid {
            background: linear-gradient(135deg, #43e97b 0%, #38f9d7 100%);
            color: #1a3e2a;
        }
        
        .strategy-type-badge.rule {
            background: linear-gradient(135deg, #fa709a 0%, #fee140 100%);
            color: #5a3a1a;
        }
        
        .strategy-id {
            font-size: 0.75rem;
            color: var(--text-secondary);
            font-family: 'SF Mono', Monaco, monospace;
        }
        
        /* 风险评级徽章 */
        .strategy-risk-rating {
            display: flex;
            flex-direction: column;
            align-items: center;
            padding: 6px 10px;
            border-radius: 6px;
            background: var(--light-bg);
            min-width: 60px;
        }
        
        .risk-rating-label {
            font-size: 0.6rem;
            color: var(--text-secondary);
            margin-bottom: 1px;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }
        
        .risk-rating-value {
            font-size: 1rem;
            font-weight: 700;
        }
        
        .risk-rating-value.low { color: var(--success-color); }
        .risk-rating-value.medium { color: var(--warning-color); }
        .risk-rating-value.high { color: var(--danger-color); }
        
        .risk-rating-stars {
            display: flex;
            gap: 1px;
            margin-top: 2px;
        }
        
        .risk-rating-stars i {
            font-size: 0.6rem;
        }
        
        .risk-rating-stars i.filled { color: var(--warning-color); }
        .risk-rating-stars i.empty { color: #ddd; }
        
        .strategy-description {
            font-size: 0.8rem;
            color: var(--text-secondary);
            margin-bottom: var(--spacing-sm);
            line-height: 1.5;
            padding: var(--spacing-xs) var(--spacing-sm);
            background: var(--light-bg);
            border-radius: 6px;
            border-left: 3px solid var(--primary-color);
        }
        
        /* 策略特征标签 */
        .strategy-tags {
            display: flex;
            flex-wrap: wrap;
            gap: 4px;
            margin-bottom: var(--spacing-sm);
        }
        
        .strategy-tag {
            display: inline-flex;
            align-items: center;
            gap: 3px;
            padding: 2px 8px;
            font-size: 0.65rem;
            border-radius: 10px;
            font-weight: 500;
        }
        
        .strategy-tag.market {
            background: #e3f2fd;
            color: #1565c0;
        }
        
        .strategy-tag.period {
            background: #f3e5f5;
            color: #7b1fa2;
        }
        
        .strategy-tag.risk {
            background: #fff3e0;
            color: #e65100;
        }
        
        .strategy-tag.style {
            background: #e8f5e9;
            color: #2e7d32;
        }
        
        /* 核心指标区域 - 重新设计 */
        .strategy-metrics {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: var(--spacing-xs);
            margin-bottom: var(--spacing-sm);
        }
        
        .strategy-metrics-section {
            margin-bottom: var(--spacing-sm);
        }
        
        .strategy-metrics-title {
            font-size: 0.7rem;
            font-weight: 600;
            color: var(--text-secondary);
            text-transform: uppercase;
            letter-spacing: 0.5px;
            margin-bottom: var(--spacing-xs);
            padding-bottom: 3px;
            border-bottom: 1px solid var(--border-color);
            display: flex;
            align-items: center;
            gap: 4px;
        }
        
        .strategy-metrics-title i {
            font-size: 0.75rem;
            color: var(--primary-color);
        }
        
        /* 核心绩效指标 - 大字突出 */
        .strategy-core-metrics {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: var(--spacing-sm);
            margin-bottom: var(--spacing-sm);
            padding: var(--spacing-sm);
            background: linear-gradient(135deg, var(--primary-light) 0%, #f8f9ff 100%);
            border-radius: 8px;
        }
        
        .core-metric {
            text-align: center;
        }
        
        .core-metric-value {
            font-size: 1.2rem;
            font-weight: 800;
            line-height: 1.2;
            margin-bottom: 1px;
        }
        
        .core-metric-label {
            font-size: 0.65rem;
            color: var(--text-secondary);
            text-transform: uppercase;
            letter-spacing: 0.3px;
        }
        
        /* 风险指标区域 */
        .strategy-risk-metrics {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: var(--spacing-xs) var(--spacing-sm);
        }
        
        .strategy-metric {
            display: flex;
            justify-content: space-between;
            align-items: center;
            font-size: 0.75rem;
            padding: 4px 0;
            border-bottom: 1px dashed #f0f0f0;
        }
        
        .strategy-metric:last-child {
            border-bottom: none;
        }
        
        .strategy-metric-label {
            color: var(--text-secondary);
            display: flex;
            align-items: center;
            gap: 3px;
        }
        
        .strategy-metric-label i {
            font-size: 0.65rem;
            opacity: 0.7;
        }
        
        .strategy-metric-value {
            font-weight: 600;
            color: var(--text-primary);
            font-family: 'SF Mono', Monaco, monospace;
            font-size: 0.8rem;
        }
        
        .strategy-metric-value.positive {
            color: var(--success-color);
        }
        
        .strategy-metric-value.negative {
            color: var(--danger-color);
        }
        
        .strategy-metric-value.neutral {
            color: var(--text-secondary);
        }
        
        /* 迷你风险收益图 */
        .strategy-mini-chart {
            height: 40px;
            background: var(--light-bg);
            border-radius: 6px;
            margin-top: var(--spacing-sm);
            position: relative;
            overflow: hidden;
        }
        
        .strategy-mini-chart canvas {
            width: 100%;
            height: 100%;
        }
        
        /* 策略适用性说明 */
        .strategy-suitability {
            margin-top: auto;
            padding-top: var(--spacing-sm);
            border-top: 1px solid var(--border-color);
        }
        
        .suitability-row {
            display: flex;
            align-items: flex-start;
            gap: 6px;
            font-size: 0.7rem;
            color: var(--text-secondary);
            margin-bottom: 4px;
            line-height: 1.4;
        }
        
        .suitability-row:last-child {
            margin-bottom: 0;
        }
        
        .suitability-row i {
            width: 16px;
            text-align: center;
            font-size: 0.7rem;
        }
        
        .suitability-row i.bi-check-circle-fill { color: var(--success-color); }
        .suitability-row i.bi-x-circle-fill { color: var(--danger-color); }
        .suitability-row i.bi-info-circle-fill { color: var(--info-color); }
        
        .strategy-selector-empty {
            text-align: center;
            padding: var(--spacing-xl) var(--spacing-md);
            color: var(--text-secondary);
        }
        
        .strategy-selector-empty i {
            font-size: 2.5rem;
            margin-bottom: var(--spacing-md);
            display: block;
            color: var(--secondary-color);
        }
        
        /* Enhanced Strategy Comparison Styles */
        .comparison-table {
            width: 100%;
            margin-top: var(--spacing-lg);
            border-radius: var(--border-radius);
            overflow: hidden;
            border: 1px solid var(--border-color);
        }
        
        .comparison-table th {
            background: linear-gradient(to bottom, var(--primary-light), #ffffff);
            font-weight: 700;
            padding: var(--spacing-md);
            border: none;
            position: sticky;
            top: 0;
            z-index: 10;
        }
        
        .comparison-table td {
            padding: var(--spacing-sm) var(--spacing-md);
            border-bottom: 1px solid var(--border-color);
            vertical-align: middle;
        }
        
        .comparison-table tr:last-child td {
            border-bottom: none;
        }
        
        .comparison-table .best-strategy {
            background: linear-gradient(135deg, var(--success-light) 0%, #d4edda 100%);
            font-weight: 700;
        }
        
        .comparison-table .metric-positive {
            color: var(--success-color);
            font-weight: 700;
        }
        
        .comparison-table .metric-negative {
            color: var(--danger-color);
            font-weight: 700;
        }
        
        .best-badge {
            background: var(--success-color);
            color: white;
            padding: 3px 10px;
            border-radius: 20px;
            font-size: 0.75rem;
            margin-left: var(--spacing-sm);
            font-weight: 600;
        }
        
        .comparison-report-section {
            margin-top: var(--spacing-lg);
        }
        
        .comparison-chart-card {
            background: #fff;
            border: 1px solid var(--border-color);
            border-radius: var(--border-radius);
            padding: var(--spacing-md);
            min-height: 400px;
            display: flex;
            flex-direction: column;
        }
        
        .comparison-chart-title {
            font-weight: 700;
            margin-bottom: var(--spacing-sm);
            display: flex;
            align-items: center;
            gap: 8px;
            flex-shrink: 0;
        }
        
        .comparison-chart-container {
            position: relative;
            flex: 1;
            min-height: 320px;
            width: 100%;
        }
        
        .comparison-chart-canvas {
            position: absolute;
            top: 0;
            left: 0;
            width: 100% !important;
            height: 100% !important;
        }
        
        /* 图表控制按钮样式 */
        .chart-controls {
            display: flex;
            align-items: center;
            gap: 8px;
        }
        
        .chart-controls .btn-sm {
            padding: 4px 10px;
            font-size: 0.8rem;
        }
        
        .chart-controls .text-muted {
            font-size: 0.75rem;
        }
        
        .comparison-report-card {
            background: #fff;
            border: 1px solid var(--border-color);
            border-radius: var(--border-radius);
            padding: var(--spacing-md);
            height: 100%;
            min-height: 400px;
            display: flex;
            flex-direction: column;
        }
        
        .comparison-report-card h6 {
            font-weight: 700;
            margin-bottom: var(--spacing-md);
        }
        
        .report-metric {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 6px 0;
            border-bottom: 1px dashed var(--border-color);
            font-size: 0.9rem;
        }
        
        .report-metric:last-child {
            border-bottom: none;
        }
        
        .report-highlight {
            background: var(--primary-light);
            border-radius: 8px;
            padding: var(--spacing-sm);
            margin-bottom: var(--spacing-sm);
            font-size: 0.9rem;
        }
        
        .strategy-selector-card.comparison-mode {

            border-color: var(--info-color);
            position: relative;
        }
        
        .strategy-selector-card.comparison-mode::before {
            content: '';
            position: absolute;
            top: 10px;
            right: 10px;
            width: 24px;
            height: 24px;
            border: 2px solid var(--info-color);
            border-radius: 50%;
            background: white;
            transition: all 0.2s ease;
        }
        
        .strategy-selector-card.comparison-mode.selected::before {
            content: '\2713';
            background: var(--info-color);
            color: white;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 14px;
            font-weight: bold;
        }
        
        .strategy-selector-card.comparison-mode.selected {
            border-color: var(--info-color);
            background: var(--info-light);
        }
        
        /* Enhanced Loading and Message Styles */
        .alert {
            border-radius: var(--border-radius);
            animation: fadeIn 0.3s ease-in;
            border: none;
            font-weight: 500;
        }
        
        .alert-success {
            background: var(--success-light);
            border-left: 4px solid var(--success-color);
            color: var(--success-dark);
        }
        
        .alert-info {
            background: var(--primary-light);
            border-left: 4px solid var(--primary-color);
            color: var(--primary-dark);
        }
        
        .alert-warning {
            background: var(--warning-light);
            border-left: 4px solid var(--warning-color);
            color: var(--warning-dark);
        }
        
        .alert-danger {
            background: var(--danger-light);
            border-left: 4px solid var(--danger-color);
            color: var(--danger-dark);
        }
        

        
        /* Strategy suggestion without borders */
        .strategy-suggestion {
            padding: 0.5rem 0;
            margin-bottom: 1rem;
            font-size: 0.95rem;
            line-height: 1.5;
        }
        
        .strategy-suggestion i {
            font-size: 1rem;
        }
        
        /* 策略优化特性标签 */
        .strategy-optimization-features {
            background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%);
            border-radius: 6px;
            padding: 8px 10px;
            border-left: 3px solid var(--success-color);
        }
        
        .strategy-optimization-features .badge {
            font-weight: 500;
            letter-spacing: 0.3px;
        }
        
        /* 优化状态徽章 */
        .optimization-badge {
            display: inline-flex;
            align-items: center;
            gap: 4px;
            padding: 4px 10px;
            border-radius: 20px;
            font-size: 0.75rem;
            font-weight: 600;
        }
        
        .optimization-badge.optimized {
            background: linear-gradient(135deg, #06d6a0 0%, #05b38a 100%);
            color: white;
        }
        
        .optimization-badge.adx_enabled {
            background: linear-gradient(135deg, #118ab2 0%, #0f7aa0 100%);
            color: white;
        }
        
        .optimization-badge.fully_optimized {
            background: linear-gradient(135deg, #4361ee 0%, #3a0ca3 100%);
            color: white;
        }
        
        /* ADX趋势强度指示器 */
        .adx-indicator {
            display: inline-flex;
            align-items: center;
            gap: 6px;
            padding: 4px 10px;
            border-radius: 6px;
            font-size: 0.8rem;
            font-weight: 600;
        }
        
        .adx-indicator.strong {
            background: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }
        
        .adx-indicator.moderate {
            background: #fff3cd;
            color: #856404;
            border: 1px solid #ffeeba;
        }
        
        .adx-indicator.weak {
            background: #d1ecf1;
            color: #0c5460;
            border: 1px solid #bee5eb;
        }
        
        .adx-indicator.none {
            background: #f8f9fa;
            color: #6c757d;
            border: 1px solid #dee2e6;
        }
        
        /* 市场状态标签 */
        .market-condition-badge {
            display: inline-flex;
            align-items: center;
            gap: 4px;
            padding: 3px 8px;
            border-radius: 4px;
            font-size: 0.75rem;
            font-weight: 500;
        }
        
        .market-condition-badge.bull {
            background: #d4edda;
            color: #155724;
        }
        
        .market-condition-badge.bear {
            background: #f8d7da;
            color: #721c24;
        }
        
        .market-condition-badge.neutral {
            background: #e2e3e5;
            color: #383d41;
        }
        
        /* 回测结果优化指标卡片 */
        .optimization-metrics-card {
            background: linear-gradient(135deg, #f8f9ff 0%, #ffffff 100%);
            border: 1px solid var(--border-color);
            border-radius: var(--border-radius);
            padding: var(--spacing-md);
            margin-bottom: var(--spacing-md);
        }
        
        .optimization-metrics-title {
            font-size: 0.9rem;
            font-weight: 700;
            color: var(--primary-color);
            margin-bottom: var(--spacing-sm);
            display: flex;
            align-items: center;
            gap: 6px;
        }
        
        .optimization-metrics-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(140px, 1fr));
            gap: var(--spacing-sm);
        }
        
        .optimization-metric {
            background: white;
            padding: var(--spacing-sm);
            border-radius: 6px;
            text-align: center;
            border: 1px solid var(--border-color);
        }
        
        .optimization-metric-value {
            font-size: 1.1rem;
            font-weight: 700;
            color: var(--text-primary);
            margin-bottom: 2px;
        }
        
        .optimization-metric-label {
            font-size: 0.7rem;
            color: var(--text-secondary);
        }
        
        @keyframes fadeIn {
            from {
                opacity: 0;
                transform: translateY(-10px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }
        
        .spinner-border-sm {
            width: 1rem;
            height: 1rem;
            border-width: 0.15em;
        }
        
        .btn:disabled {
            cursor: not-allowed;
            opacity: 0.65;
        }
        
        /* Enhanced Page Section Styles */
        .page-section {
            margin-bottom: calc(var(--spacing-xl) * 1.5);
            padding-bottom: var(--spacing-xl);
            border-bottom: 1px solid var(--border-color);
            position: relative;
        }
        
        .page-section:last-child {
            border-bottom: none;
        }
        
        /* Enhanced Responsive adjustments */
        @media (max-width: 768px) {
            .page-section {
                margin-bottom: var(--spacing-xl);
                padding-bottom: var(--spacing-lg);
            }
            
            .section-header {
                padding: var(--spacing-md);
                margin-bottom: var(--spacing-lg);
            }
            
            .section-title {
                font-size: 1.2rem;
            }
            
            .section-description {
                font-size: 0.9rem;
            }
            
            .card {
                margin-bottom: var(--spacing-lg);
            }
            
            .strategy-metrics {
                grid-template-columns: 1fr;
            }
            
            .strategy-core-metrics {
                grid-template-columns: repeat(3, 1fr);
                gap: var(--spacing-sm);
                padding: var(--spacing-sm);
            }
            
            .core-metric-value {
                font-size: 1.2rem;
            }
            
            .strategy-risk-metrics {
                grid-template-columns: 1fr;
            }
            
            .strategy-header {
                flex-direction: column;
                gap: var(--spacing-sm);
            }
            
            .strategy-risk-rating {
                align-self: flex-start;
                flex-direction: row;
                gap: 8px;
                padding: 6px 10px;
            }
            
            .strategy-tags {
                flex-wrap: wrap;
            }
            
            .evaluation-grid {
                grid-template-columns: repeat(2, 1fr);
            }
            
            .metric-value {
                font-size: 1.4rem;
            }
        }
        
        @media (max-width: 576px) {
            .section-title {
                font-size: 1.1rem;
            }
            
            .metric-card {
                padding: var(--spacing-md);
            }
            
            .metric-value {
                font-size: 1.3rem;
            }
            
            .evaluation-grid {
                grid-template-columns: 1fr;
            }
            
            .strategy-selector-card {
                padding: var(--spacing-sm);
            }
            
            .strategy-core-metrics {
                grid-template-columns: 1fr;
                gap: var(--spacing-xs);
            }
            
            .core-metric {
                display: flex;
                justify-content: space-between;
                align-items: center;
                padding: var(--spacing-xs) 0;
                border-bottom: 1px dashed #f0f0f0;
            }
            
            .core-metric:last-child {
                border-bottom: none;
            }
            
            .core-metric-value {
                font-size: 1.1rem;
            }
            
            .core-metric-label {
                font-size: 0.75rem;
            }
            
            .strategy-name {
                flex-wrap: wrap;
                font-size: 1rem;
            }
            
            .strategy-description {
                font-size: 0.8rem;
                padding: var(--spacing-xs) var(--spacing-sm);
            }
            
            .strategy-type-badge {
                margin-top: 4px;
            }
            
            .strategy-tags {
                gap: 4px;
            }
            
            .strategy-tag {
                font-size: 0.65rem;
                padding: 2px 6px;
            }
            
            .strategy-description {
                font-size: 0.8rem;
                padding: var(--spacing-xs) var(--spacing-sm);
            }
            
            .suitability-row {
                font-size: 0.7rem;
            }
        }
        
        /* Enhanced Smooth scroll animation */
        html {
            scroll-behavior: smooth;
        }
        
        /* Enhanced Scroll animation for results */
        @keyframes slideInUp {
            from {
                opacity: 0;
                transform: translateY(30px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }
        
        .results-animate {
            animation: slideInUp 0.5s ease-out;
        }
        
        /* Enhanced button and form styling */
        .form-check-input:checked {
            background-color: var(--primary-color);
            border-color: var(--primary-color);
        }
        
        .form-switch .form-check-input:checked {
            background-position: right center;
            background-color: var(--success-color);
            border-color: var(--success-color);
        }
        
        /* Table enhancements */
        .table {
            margin-bottom: 0;
        }
        
        .table th {
            border-top: none;
            border-bottom-width: 2px;
            font-weight: 700;
            text-transform: uppercase;
            font-size: 0.8rem;
            letter-spacing: 0.5px;
            color: var(--text-secondary);
        }
        
        .table td {
            vertical-align: middle;
        }
        
        .table-hover tbody tr:hover {
            background-color: rgba(67, 97, 238, 0.05);
        }
        
        .table-striped tbody tr:nth-of-type(odd) {
            background-color: rgba(0, 0, 0, 0.02);
        }
    </style>
</head>
<body>
    <nav class="navbar navbar-expand-lg navbar-dark mb-4">
        <div class="container">
            <a class="navbar-brand" href="/"><i class="bi bi-graph-up-arrow me-2"></i>基金分析系统</a>
            <div class="navbar-nav ms-auto">
                <a class="nav-link" href="/"><i class="bi bi-house me-1"></i>首页</a>
                <a class="nav-link" href="/etf"><i class="bi bi-bar-chart me-1"></i>ETF市场</a>
                <a class="nav-link active" href="/strategy"><i class="bi bi-lightbulb me-1"></i>策略分析</a>
                <a class="nav-link" href="/strategy-editor"><i class="bi bi-pencil-square me-1"></i>编写策略</a>
            </div>
        </div>
    </nav>

    <div class="container">
        <!-- Section 1: Fund Selection -->
        <section id="fund-selection-section" class="page-section">
            <div class="section-header">
                <h5 class="section-title">
                    <i class="bi bi-wallet2 me-2"></i>第一步：选择基金
                </h5>
                <p class="section-description text-muted">从您的持仓中选择要进行回测的基金</p>
            </div>
            
            <div class="row">
                <div class="col-lg-6 col-md-12">
                    <!-- Fund Selector Component -->
                    <div class="card" id="fund-selector-card">
                        <div class="card-header d-flex justify-content-between align-items-center">
                            <h6 class="mb-0"><i class="bi bi-wallet2 me-2"></i>我的持仓</h6>
                            <div class="select-all-container">
                                <input type="checkbox" id="select-all-holdings" class="form-check-input">
                                <label for="select-all-holdings" class="form-check-label ms-1">全选</label>
                            </div>
                        </div>
                        <div class="card-body">
                            <div id="holdings-list">
                                <div class="text-center text-muted py-3">
                                    <div class="spinner-border spinner-border-sm me-2"></div>加载中...
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </section>

        <!-- Section 2: Strategy Selection -->
        <section id="strategy-selection-section" class="page-section">
            <div class="section-header">
                <h5 class="section-title">
                    <i class="bi bi-graph-up me-2"></i>第二步：选择策略
                </h5>
                <p class="section-description text-muted">选择一个或多个策略进行回测分析 <span class="badge bg-success ms-2"><i class="bi bi-magic me-1"></i>已启用策略优化</span></p>
            </div>
            
            <!-- 策略优化说明横幅 -->
            <div class="alert alert-info mb-4" id="optimization-info-banner">
                <div class="d-flex align-items-start">
                    <i class="bi bi-info-circle-fill me-2 mt-1"></i>
                    <div>
                        <strong>策略优化已启用</strong> - 当前策略已应用以下优化：
                        <ul class="mb-0 mt-1">
                            <li><span class="badge bg-primary">均值回归</span> 高估卖出逻辑修正 + 趋势过滤器</li>
                            <li><span class="badge bg-warning text-dark">持续下跌</span> 判定条件优化（累计跌幅>2%或单日大跌>2%）</li>
                            <li><span class="badge bg-info">ADX趋势</span> 趋势强度确认（强/中/弱/无趋势）</li>
                            <li><span class="badge bg-secondary">市场Beta</span> 大盘调整 + 成交量确认</li>
                        </ul>
                        <a href="#optimization-details" class="text-decoration-none small" onclick="showOptimizationDetails()">
                            <i class="bi bi-link-45deg"></i>查看详细优化说明
                        </a>
                    </div>
                </div>
            </div>
            
            <div class="row">
                <div class="col-lg-8 col-md-12">
                    <!-- Strategy Selector Component -->
                    <div class="card" id="strategy-selector-card">
                        <div class="card-header">
                            <div class="d-flex justify-content-between align-items-center">
                                <h6 class="mb-0"><i class="bi bi-graph-up me-2"></i>选择策略</h6>
                                <div class="form-check form-switch">
                                    <input class="form-check-input" type="checkbox" id="comparison-mode-toggle">
                                    <label class="form-check-label" for="comparison-mode-toggle">
                                        <small>对比模式</small>
                                    </label>
                                </div>
                            </div>
                        </div>
                        <div class="card-body">
                            <div id="comparison-mode-info" class="alert alert-info py-2 px-3 mb-3" style="display:none;">
                                <small><i class="bi bi-info-circle me-1"></i>对比模式：选择多个策略进行比较</small>
                            </div>
                            <div id="strategy-cards">
                                <div class="text-center text-muted py-3">
                                    <div class="spinner-border spinner-border-sm me-2"></div>加载中...
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </section>

        <!-- Section 2.5: Advanced Strategy Parameters -->
        <section id="strategy-params-section" class="page-section">
            <div class="section-header">
                <h5 class="section-title">
                    <i class="bi bi-sliders me-2"></i>高级策略参数
                </h5>
                <p class="section-description text-muted">配置优化策略的高级参数（可选）</p>
            </div>
            
            <div class="row">
                <div class="col-12">
                    <div class="card">
                        <div class="card-header">
                            <h6 class="mb-0"><i class="bi bi-gear me-2"></i>策略优化参数</h6>
                        </div>
                        <div class="card-body">
                            <div class="row g-3">
                                <!-- ADX趋势强度参数 -->
                                <div class="col-lg-3 col-md-6">
                                    <label class="form-label">
                                        <i class="bi bi-activity me-1 text-info"></i>ADX强趋势阈值
                                        <i class="bi bi-question-circle" data-bs-toggle="tooltip" title="ADX > 40 判定为强趋势"></i>
                                    </label>
                                    <input type="number" class="form-control" id="adx-strong-threshold" value="40" min="20" max="60" step="5">
                                    <div class="form-text text-muted">默认: 40</div>
                                </div>
                                <div class="col-lg-3 col-md-6">
                                    <label class="form-label">
                                        <i class="bi bi-activity me-1 text-info"></i>ADX中等趋势阈值
                                        <i class="bi bi-question-circle" data-bs-toggle="tooltip" title="ADX > 25 判定为中等趋势"></i>
                                    </label>
                                    <input type="number" class="form-control" id="adx-moderate-threshold" value="25" min="15" max="35" step="5">
                                    <div class="form-text text-muted">默认: 25</div>
                                </div>
                                
                                <!-- 市场Beta调整参数 -->
                                <div class="col-lg-3 col-md-6">
                                    <label class="form-label">
                                        <i class="bi bi-graph-down-arrow me-1 text-secondary"></i>熊市买入倍数
                                        <i class="bi bi-question-circle" data-bs-toggle="tooltip" title="大盘跌2%以上时的买入倍数调整"></i>
                                    </label>
                                    <input type="number" class="form-control" id="bear-market-multiplier" value="0.7" min="0.3" max="1.0" step="0.1">
                                    <div class="form-text text-muted">默认: 0.7x</div>
                                </div>
                                <div class="col-lg-3 col-md-6">
                                    <label class="form-label">
                                        <i class="bi bi-pause-circle me-1 text-secondary"></i>牛市暂停卖出
                                        <i class="bi bi-question-circle" data-bs-toggle="tooltip" title="大盘涨2%以上时是否暂停止盈"></i>
                                    </label>
                                    <div class="form-check form-switch mt-2">
                                        <input class="form-check-input" type="checkbox" id="bull-market-hold" checked>
                                        <label class="form-check-label" for="bull-market-hold">启用</label>
                                    </div>
                                    <div class="form-text text-muted">牛市中让利润奔跑</div>
                                </div>
                            </div>
                            
                            <hr class="my-3">
                            
                            <div class="row g-3">
                                <!-- 均值回归策略参数 -->
                                <div class="col-lg-4 col-md-6">
                                    <label class="form-label">
                                        <i class="bi bi-arrow-repeat me-1 text-primary"></i>均值回归窗口
                                        <i class="bi bi-question-circle" data-bs-toggle="tooltip" title="计算均线偏离度的历史窗口"></i>
                                    </label>
                                    <select class="form-select" id="mean-reversion-window">
                                        <option value="60">60日（短期）</option>
                                        <option value="120">120日（中期）</option>
                                        <option value="250" selected>250日（长期）</option>
                                    </select>
                                </div>
                                <div class="col-lg-4 col-md-6">
                                    <label class="form-label">
                                        <i class="bi bi-percent me-1 text-primary"></i>偏离阈值
                                        <i class="bi bi-question-circle" data-bs-toggle="tooltip" title="价格偏离均线的百分比阈值"></i>
                                    </label>
                                    <select class="form-select" id="mean-reversion-threshold">
                                        <option value="0.03">3%（敏感）</option>
                                        <option value="0.05" selected>5%（默认）</option>
                                        <option value="0.08">8%（保守）</option>
                                    </select>
                                </div>
                                
                                <!-- 趋势过滤器开关 -->
                                <div class="col-lg-4 col-md-6">
                                    <label class="form-label">
                                        <i class="bi bi-funnel me-1 text-success"></i>趋势过滤器
                                        <i class="bi bi-question-circle" data-bs-toggle="tooltip" title="避免在强趋势中错误操作"></i>
                                    </label>
                                    <div class="form-check form-switch mt-2">
                                        <input class="form-check-input" type="checkbox" id="trend-filter-enabled" checked>
                                        <label class="form-check-label" for="trend-filter-enabled">启用趋势过滤器</label>
                                    </div>
                                    <div class="form-text text-muted">强趋势中暂停均值回归操作</div>
                                </div>
                            </div>
                            
                            <div class="mt-3">
                                <button class="btn btn-outline-primary btn-sm" onclick="resetStrategyParams()">
                                    <i class="bi bi-arrow-counterclockwise me-1"></i>恢复默认参数
                                </button>
                                <span class="text-muted ms-2 small">
                                    <i class="bi bi-info-circle me-1"></i>
                                    参数调整将应用于后续回测
                                </span>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </section>

        <!-- Section 3: Backtest Execution and Results -->
        <section id="results-section" class="page-section">
            <div class="section-header">
                <h5 class="section-title">
                    <i class="bi bi-play-circle me-2"></i>第三步：执行回测
                </h5>
                <p class="section-description text-muted">配置回测参数并查看结果</p>
            </div>
            
            <div class="row">
                <div class="col-12">
                    <!-- 统一策略分析 - 已隐藏，使用三步流程代替 -->
                    <div class="card" style="display:none;">
                        <div class="card-header">
                            <h6 class="mb-0"><i class="bi bi-calculator me-2"></i>统一策略分析</h6>
                        </div>
                        <div class="card-body">
                            <div class="row g-3">
                                <div class="col-lg-3 col-md-6">
                                    <label class="form-label">基金代码</label>
                                    <input type="text" class="form-control" id="analyze-fund-code" placeholder="如: 000001">
                                </div>
                                <div class="col-lg-3 col-md-6">
                                    <label class="form-label">今日收益率 (%)</label>
                                    <input type="number" class="form-control" id="today-return" step="0.01" value="0.5">
                                </div>
                                <div class="col-lg-3 col-md-6">
                                    <label class="form-label">昨日收益率 (%)</label>
                                    <input type="number" class="form-control" id="prev-day-return" step="0.01" value="-0.3">
                                </div>
                                <div class="col-lg-3 col-md-6">
                                    <label class="form-label">累计盈亏 (%)</label>
                                    <input type="number" class="form-control" id="cumulative-pnl" step="0.01" placeholder="可选">
                                </div>
                            </div>
                            <div class="mt-3">
                                <button class="btn btn-primary btn-analyze" onclick="analyzeUnifiedStrategy()">
                                    <i class="bi bi-play-fill me-1"></i>分析策略
                                </button>
                            </div>
                            
                            <!-- 分析结果 -->
                            <div class="result-box" id="analyze-result" style="display:none;">
                                <div id="analyze-result-content"></div>
                            </div>
                        </div>
                    </div>

                    <!-- 策略回测 -->
                    <div class="card">
                        <div class="card-header"><h6 class="mb-0"><i class="bi bi-clock-history me-2"></i>策略回测</h6></div>
                        <div class="card-body">
                            <div class="alert alert-info py-2 px-3 mb-3">
                                <small><i class="bi bi-info-circle me-1"></i>从上方选择基金和策略，配置回测参数后点击开始回测</small>
                            </div>
                            <div class="row g-3 mb-3">
                                <div class="col-lg-4 col-md-6">
                                    <label class="form-label">初始金额 (元)</label>
                                    <input type="number" class="form-control" id="initial-amount" value="10000" min="100">
                                    <div class="invalid-feedback" id="initial-amount-error"></div>
                                </div>
                                <div class="col-lg-4 col-md-6">
                                    <label class="form-label">基准定投 (元)</label>
                                    <input type="number" class="form-control" id="base-invest" value="100" min="10">
                                    <div class="invalid-feedback" id="base-invest-error"></div>
                                </div>
                                <div class="col-lg-4 col-md-6">
                                    <label class="form-label">回测周期</label>
                                    <select class="form-select" id="backtest-period">
                                        <option value="1">近一年</option>
                                        <option value="2">近两年</option>
                                        <option value="3" selected>近三年</option>
                                        <option value="5">近五年</option>
                                    </select>
                                    <div class="invalid-feedback" id="backtest-period-error"></div>
                                </div>
                            </div>
                            <button class="btn btn-success btn-analyze" onclick="runBacktest()" disabled>
                                <i class="bi bi-play-circle me-1"></i>开始回测
                            </button>
                            <div class="mt-3" id="backtest-status" style="display:none;">
                                <div class="alert alert-info">
                                    <div class="d-flex align-items-center">
                                        <div class="spinner-border spinner-border-sm me-2" role="status">
                                            <span class="visually-hidden">Loading...</span>
                                        </div>
                                        <span id="backtest-status-text">正在准备回测...</span>
                                    </div>
                                </div>
                            </div>
                            <div class="result-box" id="backtest-result" style="display:none;">
                                <div id="backtest-result-content"></div>
                            </div>
                        </div>
                    </div>

                    <!-- Results Visualizer Component -->
                    <div class="card" id="results-card" style="display:none;">
                        <div class="card-header">
                            <h6 class="mb-0"><i class="bi bi-bar-chart-line me-2"></i>回测结果</h6>
                        </div>
                        <div class="card-body">
                            <div id="results-summary"></div>
                            <div id="results-metrics"></div>
                            <div id="results-trades"></div>
                        </div>
                    </div>
                </div>
            </div>
        </section>
    </div>

    <!-- Bootstrap JS with fallback -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        if (typeof bootstrap === 'undefined') {
            console.warn('⚠️ Bootstrap JS 从 jsdelivr 加载失败，尝试备用CDN...');
            var bsScript = document.createElement('script');
            bsScript.src = 'https://cdnjs.cloudflare.com/ajax/libs/bootstrap/5.3.0/js/bootstrap.bundle.min.js';
            bsScript.onload = function() { console.log('✅ Bootstrap JS 从 cdnjs 加载成功'); };
            document.head.appendChild(bsScript);
        }
    </script>
    
    <!-- Chart.js with fallback CDN sources -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>
    <!-- Chart.js 缩放插件 - 需要先加载 hammer.js -->
    <script src="https://cdn.jsdelivr.net/npm/hammerjs@2.0.8/hammer.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-zoom@2.0.1/dist/chartjs-plugin-zoom.min.js"></script>
    <script>
        // Chart.js CDN fallback mechanism
        if (typeof Chart === 'undefined') {
            console.warn('⚠️ Chart.js 从 jsdelivr 加载失败，尝试备用CDN...');
            var script = document.createElement('script');
            script.src = 'https://unpkg.com/chart.js@4.4.1/dist/chart.umd.min.js';
            script.onload = function() {
                console.log('✅ Chart.js 从 unpkg 加载成功');
            };
            script.onerror = function() {
                console.warn('⚠️ Chart.js 从 unpkg 加载失败，尝试 cdnjs...');
                var script2 = document.createElement('script');
                script2.src = 'https://cdnjs.cloudflare.com/ajax/libs/Chart.js/4.4.1/chart.umd.min.js';
                script2.onload = function() {
                    console.log('✅ Chart.js 从 cdnjs 加载成功');
                };
                script2.onerror = function() {
                    console.error('❌ 所有CDN源加载Chart.js失败，图表功能将不可用');
                };
                document.head.appendChild(script2);
            };
            document.head.appendChild(script);
        } else {
            console.log('✅ Chart.js 已成功加载');
        }
        
        // 缩放插件 fallback
        if (typeof ChartZoom === 'undefined' && typeof window.ChartZoom === 'undefined') {
            console.log('📊 chartjs-plugin-zoom 插件加载中...');
        }
    </script>
    
    <!-- 投资组合分析脚本 -->
    <script src="/static/js/portfolio-analysis-integrated.js"></script>

    <script>
        // ==================== Fund Selector Component ====================
        class FundSelector {
            constructor(containerId) {
                this.container = document.getElementById(containerId);
                this.selectedFunds = new Set();
                this.holdings = [];
                this.selectionChangeCallbacks = [];
                this.initSelectAll();
            }
            
            /**
             * Initialize select all functionality
             */
            initSelectAll() {
                const selectAllCheckbox = document.getElementById('select-all-holdings');
                if (selectAllCheckbox) {
                    selectAllCheckbox.addEventListener('change', (e) => {
                        this.toggleSelectAll(e.target.checked);
                    });
                }
            }
            
            /**
             * Toggle select all functionality
             * @param {boolean} checked - Whether to select all or deselect all
             */
            toggleSelectAll(checked) {
                const checkboxes = this.container.querySelectorAll('.holdings-checkbox');
                checkboxes.forEach(checkbox => {
                    checkbox.checked = checked;
                    this.handleSelectionChange(checkbox.value, checked);
                });
                this.updateSelectAllStatus();
            }
            
            /**
             * Update select all checkbox status
             */
            updateSelectAllStatus() {
                const selectAllCheckbox = document.getElementById('select-all-holdings');
                if (!selectAllCheckbox) return;
                
                const checkboxes = this.container.querySelectorAll('.holdings-checkbox');
                if (checkboxes.length === 0) {
                    selectAllCheckbox.checked = false;
                    selectAllCheckbox.indeterminate = false;
                    return;
                }
                
                const checkedBoxes = this.container.querySelectorAll('.holdings-checkbox:checked');
                if (checkedBoxes.length === 0) {
                    selectAllCheckbox.checked = false;
                    selectAllCheckbox.indeterminate = false;
                } else if (checkedBoxes.length === checkboxes.length) {
                    selectAllCheckbox.checked = true;
                    selectAllCheckbox.indeterminate = false;
                } else {
                    selectAllCheckbox.checked = false;
                    selectAllCheckbox.indeterminate = true;
                }
            }

            /**
             * Load holdings from API and render the list
             * @param {string} userId - User ID to load holdings for (default: 'default_user')
             */
            async loadHoldings(userId = 'default_user') {
                try {
                    const response = await fetch(`/api/user-holdings?user_id=${userId}`);
                    const result = await response.json();
                    
                    if (result.success && result.data) {
                        this.holdings = result.data;
                        this.renderHoldings(result.data);
                    } else {
                        this.holdings = [];
                        this.renderEmpty('加载持仓失败');
                    }
                } catch (error) {
                    console.error('加载持仓失败:', error);
                    this.holdings = [];
                    this.renderEmpty('加载持仓失败，请刷新重试');
                }
            }

            /**
             * Render holdings list with checkboxes
             * @param {Array} holdings - Array of holding objects
             */
            renderHoldings(holdings) {
                if (!holdings || holdings.length === 0) {
                    this.renderEmpty('暂无持仓数据，请先添加持仓');
                    this.updateSelectAllStatus();
                    return;
                }

                const html = holdings.map(holding => `
                    <div class="holdings-item" data-fund-code="${holding.fund_code}">
                        <input type="checkbox" 
                               class="holdings-checkbox form-check-input" 
                               id="fund-${holding.fund_code}"
                               value="${holding.fund_code}"
                               onchange="fundSelector.handleSelectionChange('${holding.fund_code}', this.checked)">
                        <div class="holdings-info">
                            <div class="holdings-code">${holding.fund_code}</div>
                            <div class="holdings-name">${holding.fund_name}</div>
                        </div>
                        <div class="holdings-amount">¥${holding.holding_amount.toLocaleString()}</div>
                    </div>
                `).join('');

                this.container.innerHTML = html;
                this.updateSelectAllStatus();
            }

            /**
             * Render empty state with message
             * @param {string} message - Message to display
             */
            renderEmpty(message) {
                this.container.innerHTML = `
                    <div class="empty-holdings">
                        <i class="bi bi-inbox"></i>
                        <div>${message}</div>
                    </div>
                `;
            }

            /**
             * Handle checkbox selection change
             * @param {string} fundCode - Fund code that was selected/deselected
             * @param {boolean} checked - Whether the checkbox is checked
             */
            handleSelectionChange(fundCode, checked) {
                if (checked) {
                    this.selectedFunds.add(fundCode);
                } else {
                    this.selectedFunds.delete(fundCode);
                }
                
                // Update select all status
                this.updateSelectAllStatus();
                
                // Notify all registered callbacks
                this.selectionChangeCallbacks.forEach(callback => {
                    callback(this.getSelectedFunds());
                });
            }

            /**
             * Get array of selected fund codes
             * @returns {Array<string>} Array of selected fund codes
             */
            getSelectedFunds() {
                return Array.from(this.selectedFunds);
            }

            /**
             * Register a callback for selection changes
             * @param {Function} callback - Callback function to call when selection changes
             */
            onSelectionChange(callback) {
                if (typeof callback === 'function') {
                    this.selectionChangeCallbacks.push(callback);
                }
            }

            /**
             * Clear all selections
             */
            clearSelection() {
                this.selectedFunds.clear();
                const checkboxes = this.container.querySelectorAll('.holdings-checkbox');
                checkboxes.forEach(cb => cb.checked = false);
                
                // Update select all status
                this.updateSelectAllStatus();
                
                // Notify callbacks
                this.selectionChangeCallbacks.forEach(callback => {
                    callback(this.getSelectedFunds());
                });
            }
        }

        // Initialize Fund Selector
        const fundSelector = new FundSelector('holdings-list');

        // ==================== Strategy Selector Component ====================
        class StrategySelector {
            constructor(containerId) {
                this.container = document.getElementById(containerId);
                this.selectedStrategy = null;
                this.selectedStrategies = new Set(); // For comparison mode
                this.comparisonMode = false;
                this.strategies = [];
                this.selectionChangeCallbacks = [];
            }

            /**
             * Load strategies from API and render the cards
             */
            async loadStrategies() {
                try {
                    const response = await fetch('/api/strategies/metadata');
                    const result = await response.json();
                    
                    if (result.success && result.data) {
                        this.strategies = result.data;
                        this.renderStrategies(result.data);
                        
                        // Set default to enhanced_rule_based strategy (only in single mode)
                        if (!this.comparisonMode) {
                            const defaultStrategy = result.data.find(s => s.strategy_id === 'enhanced_rule_based');
                            if (defaultStrategy) {
                                this.selectStrategy(defaultStrategy.strategy_id);
                            }
                        }
                    } else {
                        this.renderEmpty('加载策略失败');
                    }
                } catch (error) {
                    console.error('加载策略失败:', error);
                    this.renderEmpty('加载策略失败，请刷新重试');
                }
            }

            /**
             * Render strategy cards with metrics display
             * @param {Array} strategies - Array of strategy objects
             */
            renderStrategies(strategies) {
                if (!strategies || strategies.length === 0) {
                    this.renderEmpty('暂无可用策略');
                    return;
                }

                const html = strategies.map(strategy => {
                    const strategyMeta = this.getStrategyMeta(strategy.strategy_id);
                    const riskRating = this.calculateRiskRating(strategy);
                    const comparisonClass = this.comparisonMode ? 'comparison-mode' : '';
                    
                    // 格式化指标值
                    const totalReturn = this.formatReturn(strategy.total_return);
                    const annualizedReturn = this.formatReturn(strategy.annualized_return);
                    const maxDrawdown = this.formatDrawdown(strategy.max_drawdown);
                    const sharpeRatio = this.formatRatio(strategy.sharpe_ratio);
                    const winRate = this.formatPercent(strategy.win_rate);
                    const profitLossRatio = this.formatRatio(strategy.profit_loss_ratio);
                    
                    // 计算额外指标
                    const volatility = strategy.volatility ? this.formatPercent(strategy.volatility) : this.estimateVolatility(strategy);
                    const calmarRatio = this.calculateCalmarRatio(strategy);
                    const sortinoRatio = strategy.sortino_ratio ? this.formatRatio(strategy.sortino_ratio) : this.estimateSortino(strategy);
                    
                    return `
                        <div class="strategy-selector-card ${comparisonClass}" 
                             data-strategy-id="${strategy.strategy_id}"
                             onclick="strategySelector.${this.comparisonMode ? 'toggleStrategy' : 'selectStrategy'}('${strategy.strategy_id}')">
                            
                            <!-- 策略头部 -->
                            <div class="strategy-header">
                                <div class="strategy-title-area">
                                    <div class="strategy-name">
                                        ${strategyMeta.displayName}
                                        <span class="strategy-type-badge ${strategyMeta.badgeClass}">${strategyMeta.type}</span>
                                    </div>
                                    <div class="strategy-id">${strategy.strategy_id}</div>
                                </div>
                                <div class="strategy-risk-rating">
                                    <span class="risk-rating-label">风险等级</span>
                                    <span class="risk-rating-value ${riskRating.class}">${riskRating.level}</span>
                                    <div class="risk-rating-stars">
                                        ${this.renderRiskStars(riskRating.stars)}
                                    </div>
                                </div>
                            </div>
                            
                            <!-- 策略描述 -->
                            <div class="strategy-description">
                                <strong>策略原理：</strong>${strategyMeta.description}
                            </div>
                            
                            <!-- 策略特征标签 -->
                            <div class="strategy-tags">
                                <span class="strategy-tag market"><i class="bi bi-graph-up-arrow"></i>${strategyMeta.marketEnv}</span>
                                <span class="strategy-tag period"><i class="bi bi-clock"></i>${strategyMeta.horizon}</span>
                                <span class="strategy-tag risk"><i class="bi bi-shield"></i>${strategyMeta.riskProfile}</span>
                                <span class="strategy-tag style"><i class="bi bi-diagram-3"></i>${strategyMeta.style}</span>
                                ${strategyMeta.isNew ? '<span class="badge bg-success ms-1"><i class="bi bi-stars"></i>新</span>' : ''}
                            </div>
                            
                            <!-- 策略优化特征标签 -->
                            ${strategyMeta.optimizationFeatures ? `
                            <div class="strategy-optimization-features mb-2">
                                <div class="small text-muted mb-1"><i class="bi bi-magic me-1"></i>优化功能:</div>
                                <div class="d-flex flex-wrap gap-1">
                                    ${strategyMeta.optimizationFeatures.map(feature => {
                                        let badgeClass = 'bg-light text-dark border';
                                        if (feature.includes('ADX')) badgeClass = 'bg-info text-white';
                                        if (feature.includes('趋势')) badgeClass = 'bg-success text-white';
                                        if (feature.includes('市场')) badgeClass = 'bg-secondary text-white';
                                        if (feature.includes('成交量')) badgeClass = 'bg-warning text-dark';
                                        if (feature.includes('下跌')) badgeClass = 'bg-primary text-white';
                                        if (feature.includes('卖出')) badgeClass = 'bg-danger text-white';
                                        return `<span class="badge ${badgeClass}" style="font-size: 0.6rem; padding: 2px 6px;">${feature}</span>`;
                                    }).join('')}
                                </div>
                            </div>
                            ` : ''}
                            
                            <!-- 核心绩效指标 -->
                            <div class="strategy-core-metrics">
                                <div class="core-metric">
                                    <div class="core-metric-value ${totalReturn.class}">${totalReturn.text}</div>
                                    <div class="core-metric-label">累计收益</div>
                                </div>
                                <div class="core-metric">
                                    <div class="core-metric-value ${annualizedReturn.class}">${annualizedReturn.text}</div>
                                    <div class="core-metric-label">年化收益</div>
                                </div>
                                <div class="core-metric">
                                    <div class="core-metric-value ${maxDrawdown.class}">${maxDrawdown.text}</div>
                                    <div class="core-metric-label">最大回撤</div>
                                </div>
                            </div>
                            
                            <!-- 风险调整收益指标 -->
                            <div class="strategy-metrics-section">
                                <div class="strategy-metrics-title">
                                    <i class="bi bi-bar-chart-line"></i>风险调整收益
                                </div>
                                <div class="strategy-risk-metrics">
                                    <div class="strategy-metric">
                                        <span class="strategy-metric-label"><i class="bi bi-speedometer2"></i>夏普比率</span>
                                        <span class="strategy-metric-value ${this.getRatioClass(strategy.sharpe_ratio)}">${sharpeRatio}</span>
                                    </div>
                                    <div class="strategy-metric">
                                        <span class="strategy-metric-label"><i class="bi bi-graph-down-arrow"></i>卡玛比率</span>
                                        <span class="strategy-metric-value ${this.getRatioClass(calmarRatio.value)}">${calmarRatio.text}</span>
                                    </div>
                                    <div class="strategy-metric">
                                        <span class="strategy-metric-label"><i class="bi bi-arrow-down-up"></i>索提诺比率</span>
                                        <span class="strategy-metric-value ${this.getRatioClass(parseFloat(sortinoRatio))}">${sortinoRatio}</span>
                                    </div>
                                    <div class="strategy-metric">
                                        <span class="strategy-metric-label"><i class="bi bi-activity"></i>年化波动率</span>
                                        <span class="strategy-metric-value neutral">${volatility}</span>
                                    </div>
                                </div>
                            </div>
                            
                            <!-- 交易统计指标 -->
                            <div class="strategy-metrics-section">
                                <div class="strategy-metrics-title">
                                    <i class="bi bi-clipboard-data"></i>交易统计
                                </div>
                                <div class="strategy-risk-metrics">
                                    <div class="strategy-metric">
                                        <span class="strategy-metric-label"><i class="bi bi-trophy"></i>胜率</span>
                                        <span class="strategy-metric-value ${this.getWinRateClass(strategy.win_rate)}">${winRate}</span>
                                    </div>
                                    <div class="strategy-metric">
                                        <span class="strategy-metric-label"><i class="bi bi-calculator"></i>盈亏比</span>
                                        <span class="strategy-metric-value ${this.getRatioClass(strategy.profit_loss_ratio)}">${profitLossRatio}</span>
                                    </div>
                                </div>
                            </div>
                            
                            <!-- 策略适用性说明 -->
                            <div class="strategy-suitability">
                                <div class="suitability-row">
                                    <i class="bi bi-check-circle-fill"></i>
                                    <span><strong>适用：</strong>${strategyMeta.suitableFor}</span>
                                </div>
                                <div class="suitability-row">
                                    <i class="bi bi-x-circle-fill"></i>
                                    <span><strong>不适用：</strong>${strategyMeta.notSuitableFor}</span>
                                </div>
                            </div>
                        </div>
                    `;
                }).join('');

                this.container.innerHTML = html;
                
                // Restore selections after re-render
                if (this.comparisonMode) {
                    this.selectedStrategies.forEach(strategyId => {
                        const card = this.container.querySelector(`[data-strategy-id="${strategyId}"]`);
                        if (card) {
                            card.classList.add('selected');
                        }
                    });
                } else if (this.selectedStrategy) {
                    const card = this.container.querySelector(`[data-strategy-id="${this.selectedStrategy}"]`);
                    if (card) {
                        card.classList.add('selected');
                    }
                }
            }
            
            /**
             * 获取策略元数据（专业描述、适用场景等）
             */
            getStrategyMeta(strategyId) {
                const metaMap = {
                    'dual_ma': {
                        displayName: '双均线策略',
                        type: '趋势跟踪',
                        badgeClass: 'trend',
                        description: '基于短期与长期移动平均线交叉信号进行交易。当短期均线上穿长期均线时产生买入信号，反之产生卖出信号。适合捕捉中长期趋势行情。',
                        marketEnv: '趋势市场',
                        horizon: '中长期',
                        riskProfile: '中等风险',
                        style: '动量策略',
                        suitableFor: '单边趋势行情、波动较大的市场环境',
                        notSuitableFor: '震荡盘整行情、低波动市场',
                        optimizationStatus: 'adx_enabled',
                        optimizationFeatures: ['ADX趋势强度确认', '市场Beta调整']
                    },
                    'mean_reversion': {
                        displayName: '均值回归策略',
                        type: '均值回归',
                        badgeClass: 'mean-reversion',
                        description: '基于价格偏离均值后回归的统计特性。当价格大幅偏离历史均值时建立反向头寸，预期价格将回归均值水平。适合震荡市场。<span class="badge bg-success ms-1">已优化</span>',
                        marketEnv: '震荡市场',
                        horizon: '短中期',
                        riskProfile: '中高风险',
                        style: '反转策略',
                        suitableFor: '区间震荡行情、均值回归特征明显的品种',
                        notSuitableFor: '强趋势行情、单边突破市场',
                        optimizationStatus: 'optimized',
                        optimizationFeatures: ['高估卖出逻辑修正', '趋势过滤器', 'ADX趋势确认']
                    },
                    'target_value': {
                        displayName: '目标市值策略',
                        type: '价值投资',
                        badgeClass: 'value',
                        description: '设定目标持仓市值，通过动态调整仓位使实际持仓接近目标值。价格下跌时自动加仓摊低成本，上涨时减仓锁定收益，实现低买高卖。',
                        marketEnv: '全市场',
                        horizon: '长期',
                        riskProfile: '低风险',
                        style: '被动策略',
                        suitableFor: '长期定投、风险承受能力较低的投资者',
                        notSuitableFor: '追求短期高收益、资金流动性要求高的场景',
                        optimizationStatus: 'adx_enabled',
                        optimizationFeatures: ['ADX趋势强度确认']
                    },
                    'grid': {
                        displayName: '网格交易策略',
                        type: '量化网格',
                        badgeClass: 'grid',
                        description: '在预设价格区间内设置多个买卖网格，当价格触及网格线时自动执行对应的买入或卖出操作，赚取网格区间内的波动收益。',
                        marketEnv: '震荡市场',
                        horizon: '短期',
                        riskProfile: '中等风险',
                        style: '波段策略',
                        suitableFor: '窄幅震荡行情、波动率稳定的市场',
                        notSuitableFor: '单边趋势行情、突破行情',
                        optimizationStatus: 'adx_enabled',
                        optimizationFeatures: ['ADX趋势强度确认']
                    },
                    'enhanced_rule_based': {
                        displayName: '增强型规则策略',
                        type: '多因子',
                        badgeClass: 'rule',
                        description: '综合多种技术指标和市场因子，通过规则引擎动态调整仓位和交易时机。融合趋势跟踪、均值回归和风险控制等多种策略逻辑。<span class="badge bg-success ms-1">已优化</span>',
                        marketEnv: '全市场',
                        horizon: '中期',
                        riskProfile: '中等风险',
                        style: '复合策略',
                        suitableFor: '多种市场环境、追求稳健收益的投资者',
                        notSuitableFor: '极端行情、黑天鹅事件',
                        optimizationStatus: 'fully_optimized',
                        optimizationFeatures: ['持续下跌判定优化', 'ADX趋势确认', '市场Beta调整', '成交量确认']
                    },
                    'mean_reversion_optimized': {
                        displayName: '均值回归-优化版',
                        type: '均值回归',
                        badgeClass: 'mean-reversion',
                        description: '基于标准均值回归策略，应用了完整的优化：高估卖出逻辑修正、趋势过滤器、ADX趋势强度确认。适合希望获得更稳健收益的投资者。<span class="badge bg-success ms-1">推荐</span>',
                        marketEnv: '震荡市场',
                        horizon: '中期',
                        riskProfile: '中等风险',
                        style: '反转+趋势过滤',
                        suitableFor: '希望降低回撤、减少频繁交易的投资者',
                        notSuitableFor: '追求极致收益、对策略复杂性不敏感的投资者',
                        optimizationStatus: 'fully_optimized',
                        optimizationFeatures: ['高估卖出逻辑修正', '趋势过滤器', 'ADX趋势确认', '市场Beta调整'],
                        isNew: true
                    },
                    'enhanced_rule_based_optimized': {
                        displayName: '增强规则-优化版',
                        type: '多因子',
                        badgeClass: 'rule',
                        description: '基于增强型规则策略，应用了持续下跌判定优化、ADX趋势强度确认、市场Beta调整和成交量确认。最全面的优化策略。<span class="badge bg-success ms-1">推荐</span>',
                        marketEnv: '全市场',
                        horizon: '中期',
                        riskProfile: '中等风险',
                        style: '复合+全优化',
                        suitableFor: '追求稳健收益、注重风险控制的投资者',
                        notSuitableFor: '追求短期高收益、对策略复杂性不耐受的投资者',
                        optimizationStatus: 'fully_optimized',
                        optimizationFeatures: ['持续下跌判定优化', 'ADX趋势确认', '市场Beta调整', '成交量确认'],
                        isNew: true
                    }
                };
                
                return metaMap[strategyId] || {
                    displayName: strategyId,
                    type: '自定义',
                    badgeClass: 'rule',
                    description: '自定义交易策略',
                    marketEnv: '待定',
                    horizon: '待定',
                    riskProfile: '待定',
                    style: '自定义',
                    suitableFor: '视策略参数而定',
                    notSuitableFor: '视策略参数而定'
                };
            }
            
            /**
             * 计算风险评级
             */
            calculateRiskRating(strategy) {
                const maxDrawdown = Math.abs(strategy.max_drawdown);
                const sharpe = strategy.sharpe_ratio;
                const winRate = strategy.win_rate;
                
                // 综合评分：回撤越大风险越高，夏普越高风险越低
                let riskScore = 0;
                
                // 回撤评分 (0-40分，回撤越大分数越高)
                if (maxDrawdown > 20) riskScore += 40;
                else if (maxDrawdown > 15) riskScore += 30;
                else if (maxDrawdown > 10) riskScore += 20;
                else if (maxDrawdown > 5) riskScore += 10;
                
                // 夏普评分 (0-30分，夏普越低分数越高)
                if (sharpe < 0.5) riskScore += 30;
                else if (sharpe < 1) riskScore += 20;
                else if (sharpe < 1.5) riskScore += 10;
                
                // 胜率评分 (0-30分，胜率越低分数越高)
                if (winRate < 40) riskScore += 30;
                else if (winRate < 50) riskScore += 20;
                else if (winRate < 60) riskScore += 10;
                
                // 转换为等级
                let level, levelClass, stars;
                if (riskScore >= 70) {
                    level = 'R5'; levelClass = 'high'; stars = 5;
                } else if (riskScore >= 55) {
                    level = 'R4'; levelClass = 'high'; stars = 4;
                } else if (riskScore >= 40) {
                    level = 'R3'; levelClass = 'medium'; stars = 3;
                } else if (riskScore >= 25) {
                    level = 'R2'; levelClass = 'low'; stars = 2;
                } else {
                    level = 'R1'; levelClass = 'low'; stars = 1;
                }
                
                return { level, class: levelClass, stars };
            }
            
            /**
             * 渲染风险星级
             */
            renderRiskStars(count) {
                let html = '';
                for (let i = 1; i <= 5; i++) {
                    if (i <= count) {
                        html += '<i class="bi bi-star-fill filled"></i>';
                    } else {
                        html += '<i class="bi bi-star empty"></i>';
                    }
                }
                return html;
            }
            
            /**
             * 格式化收益率
             */
            formatReturn(value) {
                if (value == null || isNaN(value)) return { text: '--', class: 'neutral' };
                const sign = value >= 0 ? '+' : '';
                return {
                    text: `${sign}${value.toFixed(2)}%`,
                    class: value >= 0 ? 'positive' : 'negative'
                };
            }
            
            /**
             * 格式化回撤
             */
            formatDrawdown(value) {
                if (value == null || isNaN(value)) return { text: '--', class: 'neutral' };
                return {
                    text: `${value.toFixed(2)}%`,
                    class: 'negative'
                };
            }
            
            /**
             * 格式化比率
             */
            formatRatio(value) {
                if (value == null || isNaN(value)) return '--';
                return value.toFixed(2);
            }
            
            /**
             * 格式化百分比
             */
            formatPercent(value) {
                if (value == null || isNaN(value)) return '--';
                return `${value.toFixed(2)}%`;
            }
            
            /**
             * 估算年化波动率
             */
            estimateVolatility(strategy) {
                // 根据回撤和夏普比率估算
                const annualizedReturn = strategy.annualized_return || 0;
                const sharpe = strategy.sharpe_ratio || 1;
                if (sharpe === 0) return '--';
                const estimated = Math.abs(annualizedReturn / sharpe);
                return `${estimated.toFixed(2)}%`;
            }
            
            /**
             * 计算卡玛比率
             */
            calculateCalmarRatio(strategy) {
                const annualizedReturn = strategy.annualized_return || 0;
                const maxDrawdown = Math.abs(strategy.max_drawdown) || 1;
                const ratio = annualizedReturn / maxDrawdown;
                return {
                    value: ratio,
                    text: ratio.toFixed(2)
                };
            }
            
            /**
             * 估算索提诺比率
             */
            estimateSortino(strategy) {
                // 简化估算：索提诺通常比夏普高20-50%
                const sharpe = strategy.sharpe_ratio || 0;
                const estimated = sharpe * 1.3;
                return estimated.toFixed(2);
            }
            
            /**
             * 获取比率的CSS类名
             */
            getRatioClass(value) {
                if (value == null || isNaN(value)) return 'neutral';
                if (value >= 1.5) return 'positive';
                if (value >= 1) return '';
                if (value >= 0) return '';
                return 'negative';
            }
            
            /**
             * 获取胜率的CSS类名
             */
            getWinRateClass(value) {
                if (value == null || isNaN(value)) return 'neutral';
                if (value >= 60) return 'positive';
                if (value >= 50) return '';
                return 'negative';
            }

            /**
             * Render empty state with message
             * @param {string} message - Message to display
             */
            renderEmpty(message) {
                this.container.innerHTML = `
                    <div class="strategy-selector-empty">
                        <i class="bi bi-inbox"></i>
                        <div>${message}</div>
                    </div>
                `;
            }

            /**
             * Select a strategy by ID (single selection with highlighting)
             * @param {string} strategyId - Strategy ID to select
             */
            selectStrategy(strategyId) {
                if (this.comparisonMode) {
                    // In comparison mode, use toggleStrategy instead
                    return;
                }
                
                // Remove previous selection
                const previousSelected = this.container.querySelector('.strategy-selector-card.selected');
                if (previousSelected) {
                    previousSelected.classList.remove('selected');
                }

                // Add selection to new card
                const card = this.container.querySelector(`[data-strategy-id="${strategyId}"]`);
                if (card) {
                    card.classList.add('selected');
                    this.selectedStrategy = strategyId;
                    
                    // Notify all registered callbacks
                    this.selectionChangeCallbacks.forEach(callback => {
                        callback(this.getSelectedStrategy());
                    });
                }
            }

            /**
             * Toggle strategy selection in comparison mode
             * @param {string} strategyId - Strategy ID to toggle
             */
            toggleStrategy(strategyId) {
                if (!this.comparisonMode) {
                    // In single mode, use selectStrategy instead
                    return;
                }
                
                const card = this.container.querySelector(`[data-strategy-id="${strategyId}"]`);
                if (!card) return;
                
                if (this.selectedStrategies.has(strategyId)) {
                    // Deselect
                    this.selectedStrategies.delete(strategyId);
                    card.classList.remove('selected');
                } else {
                    // Select
                    this.selectedStrategies.add(strategyId);
                    card.classList.add('selected');
                }
                
                // Notify all registered callbacks
                this.selectionChangeCallbacks.forEach(callback => {
                    callback(this.getSelectedStrategies());
                });
            }

            /**
             * Enable or disable comparison mode
             * @param {boolean} enabled - Whether comparison mode is enabled
             */
            setComparisonMode(enabled) {
                console.log('setComparisonMode called with:', enabled);
                console.log('Current strategies count:', this.strategies ? this.strategies.length : 0);
                
                this.comparisonMode = enabled;
                
                if (enabled) {
                    // Switching to comparison mode
                    this.selectedStrategies.clear();
                    if (this.selectedStrategy) {
                        this.selectedStrategies.add(this.selectedStrategy);
                    }
                    this.selectedStrategy = null;
                } else {
                    // Switching to single mode
                    if (this.selectedStrategies.size > 0) {
                        this.selectedStrategy = Array.from(this.selectedStrategies)[0];
                    }
                    this.selectedStrategies.clear();
                }
                
                // Re-render strategies with appropriate mode
                if (this.strategies && this.strategies.length > 0) {
                    this.renderStrategies(this.strategies);
                    console.log('Strategies re-rendered in', enabled ? 'comparison' : 'single', 'mode');
                } else {
                    console.warn('No strategies to render');
                }
            }

            /**
             * Get the currently selected strategy ID (single mode)
             * @returns {string|null} Selected strategy ID or null
             */
            getSelectedStrategy() {
                return this.selectedStrategy;
            }

            /**
             * Get array of selected strategy IDs (comparison mode)
             * @returns {Array<string>} Array of selected strategy IDs
             */
            getSelectedStrategies() {
                return Array.from(this.selectedStrategies);
            }

            /**
             * Get the full strategy object for the selected strategy
             * @returns {Object|null} Selected strategy object or null
             */
            getSelectedStrategyData() {
                if (!this.selectedStrategy) return null;
                return this.strategies.find(s => s.strategy_id === this.selectedStrategy);
            }

            /**
             * Register a callback for selection changes
             * @param {Function} callback - Callback function to call when selection changes
             */
            onSelectionChange(callback) {
                if (typeof callback === 'function') {
                    this.selectionChangeCallbacks.push(callback);
                }
            }

            /**
             * Clear selection
             */
            clearSelection() {
                const selected = this.container.querySelectorAll('.strategy-selector-card.selected');
                selected.forEach(card => card.classList.remove('selected'));
                
                this.selectedStrategy = null;
                this.selectedStrategies.clear();
                
                // Notify callbacks
                this.selectionChangeCallbacks.forEach(callback => {
                    callback(this.comparisonMode ? this.getSelectedStrategies() : this.getSelectedStrategy());
                });
            }
        }

        // Initialize Strategy Selector
        const strategySelector = new StrategySelector('strategy-cards');

        // ==================== Results Visualizer Component ====================
        class ResultsVisualizer {
            constructor(containerId) {
                this.container = document.getElementById(containerId);
                this.summaryContainer = document.getElementById('results-summary');
                this.metricsContainer = document.getElementById('results-metrics');
                this.tradesContainer = document.getElementById('results-trades');
            }

            /**
             * Display backtest results with summary, metrics, and trade history
             * @param {Object} backtestData - Backtest result data
             */
            displayResults(backtestData) {
                if (!backtestData) {
                    console.error('No backtest data provided');
                    return;
                }

                // Show the results card
                this.container.style.display = 'block';

                // Render summary metrics
                this.renderSummary(backtestData);

                // Render evaluation metrics
                this.renderMetrics(backtestData);

                // Render trade history
                this.renderTrades(backtestData);

                // Add animation class
                this.container.classList.add('results-animate');
                
                // Remove animation class after animation completes
                setTimeout(() => {
                    this.container.classList.remove('results-animate');
                }, 500);

                // Scroll to results section with smooth animation
                const resultsSection = document.getElementById('results-section');
                if (resultsSection) {
                    resultsSection.scrollIntoView({ behavior: 'smooth', block: 'start' });
                } else {
                    // Fallback to scrolling to results card if section not found
                    this.container.scrollIntoView({ behavior: 'smooth', block: 'start' });
                }
            }

            /**
             * Render summary metrics (initial amount, final value, total return)
             * @param {Object} data - Backtest result data
             */
            renderSummary(data) {
                const returnClass = data.total_return >= 0 ? 'positive' : 'negative';
                const returnSign = data.total_return >= 0 ? '+' : '';

                this.summaryContainer.innerHTML = `
                    <div class="row text-center mb-4">
                        <div class="col-md-3">
                            <div class="metric-card">
                                <div class="metric-value">¥${data.initial_amount.toLocaleString()}</div>
                                <div class="metric-label">初始金额</div>
                            </div>
                        </div>
                        <div class="col-md-3">
                            <div class="metric-card">
                                <div class="metric-value">¥${(data.final_value || data.total_value || 0).toLocaleString()}</div>
                                <div class="metric-label">最终价值</div>
                            </div>
                        </div>
                        <div class="col-md-3">
                            <div class="metric-card">
                                <div class="metric-value ${returnClass}">${returnSign}${data.total_return.toFixed(2)}%</div>
                                <div class="metric-label">总收益率</div>
                            </div>
                        </div>
                        <div class="col-md-3">
                            <div class="metric-card">
                                <div class="metric-value">${data.trades_count || 0}</div>
                                <div class="metric-label">交易次数</div>
                            </div>
                        </div>
                    </div>
                `;
            }

            /**
             * Render evaluation metrics
             * @param {Object} data - Backtest result data
             */
            renderMetrics(data) {
                const evaluation = data.evaluation || {};
                
                // Additional key metrics
                const annualizedReturn = data.annualized_return || 0;
                const maxDrawdown = data.max_drawdown || 0;
                const sharpeRatio = data.sharpe_ratio || 0;

                const annualizedClass = annualizedReturn >= 0 ? 'positive' : 'negative';
                const annualizedSign = annualizedReturn >= 0 ? '+' : '';

                this.metricsContainer.innerHTML = `
                    <h6 class="mb-3"><i class="bi bi-graph-up me-2"></i>关键指标</h6>
                    <div class="row mb-3">
                        <div class="col-md-4">
                            <div class="metric-card">
                                <div class="metric-value ${annualizedClass}">${annualizedSign}${annualizedReturn.toFixed(2)}%</div>
                                <div class="metric-label">年化收益率</div>
                            </div>
                        </div>
                        <div class="col-md-4">
                            <div class="metric-card">
                                <div class="metric-value negative">${maxDrawdown.toFixed(2)}%</div>
                                <div class="metric-label">最大回撤</div>
                            </div>
                        </div>
                        <div class="col-md-4">
                            <div class="metric-card">
                                <div class="metric-value">${sharpeRatio.toFixed(2)}</div>
                                <div class="metric-label">夏普比率</div>
                            </div>
                        </div>
                    </div>

                    ${(() => {
                        // 生成策略评估指标的HTML，只包含有数据的指标项
                        const evalMetrics = [
                            { key: 'hit_rate', label: '命中率', format: (value) => `${(value * 100).toFixed(1)}%` },
                            { key: 'profit_factor', label: '盈亏比', format: (value) => value.toFixed(2) },
                            { key: 'max_consecutive_losses', label: '最大连亏', format: (value) => value },
                            { key: 'max_consecutive_wins', label: '最大连赢', format: (value) => value },
                            { key: 'avg_profit_per_trade', label: '平均每笔收益', format: (value) => `¥${value.toFixed(2)}` },
                            { key: 'expectancy', label: '期望值', format: (value) => `¥${value.toFixed(2)}` }
                        ];

                        // 过滤出有有效值的指标项
                        const validEvalItems = evalMetrics.filter(item => 
                            evaluation[item.key] !== undefined && 
                            evaluation[item.key] !== null && 
                            !isNaN(evaluation[item.key])
                        );

                        if (validEvalItems.length === 0) {
                            return '';
                        }

                        // 生成评估指标的HTML
                        const evalHtml = validEvalItems.map(item => `
                            <div class="eval-item">
                                <div class="eval-value">${item.format(evaluation[item.key])}</div>
                                <div class="eval-label">${item.label}</div>
                            </div>
                        `).join('');

                        return `
                            <h6 class="mb-3"><i class="bi bi-bar-chart me-2"></i>策略评估指标</h6>
                            <div class="evaluation-grid mb-3">
                                ${evalHtml}
                            </div>
                        `;
                    })()}
                `;
            }

            /**
             * Render trade history table
             * @param {Object} data - Backtest result data
             */
            renderTrades(data) {
                const trades = data.trades || [];
                
                // 显示优化指标卡片
                const showOptimizationMetrics = data.optimization_metrics || data.adx_values || data.market_conditions;
                let optimizationMetricsHtml = '';
                
                if (showOptimizationMetrics) {
                    const avgAdx = data.avg_adx || 0;
                    const adxStrength = avgAdx > 40 ? 'strong' : avgAdx > 25 ? 'moderate' : avgAdx > 15 ? 'weak' : 'none';
                    const adxClass = avgAdx > 40 ? 'bg-danger' : avgAdx > 25 ? 'bg-warning text-dark' : avgAdx > 15 ? 'bg-info' : 'bg-secondary';
                    const adxText = avgAdx > 40 ? '强趋势' : avgAdx > 25 ? '中等趋势' : avgAdx > 15 ? '弱趋势' : '无趋势';
                    
                    optimizationMetricsHtml = `
                        <div class="optimization-metrics-card">
                            <div class="optimization-metrics-title">
                                <i class="bi bi-magic"></i>优化策略指标
                            </div>
                            <div class="optimization-metrics-grid">
                                <div class="optimization-metric">
                                    <div class="optimization-metric-value">
                                        <span class="badge ${adxClass}">${avgAdx.toFixed(1)}</span>
                                    </div>
                                    <div class="optimization-metric-label">ADX均值 (${adxText})</div>
                                </div>
                                <div class="optimization-metric">
                                    <div class="optimization-metric-value">${(data.trend_filter_triggered || 0)}次</div>
                                    <div class="optimization-metric-label">趋势过滤触发</div>
                                </div>
                                <div class="optimization-metric">
                                    <div class="optimization-metric-value">${(data.market_beta_adjusted || 0)}次</div>
                                    <div class="optimization-metric-label">市场Beta调整</div>
                                </div>
                                <div class="optimization-metric">
                                    <div class="optimization-metric-value">${(data.volume_confirmed || 0)}次</div>
                                    <div class="optimization-metric-label">成交量确认</div>
                                </div>
                            </div>
                        </div>
                    `;
                }

                if (trades.length === 0) {
                    this.tradesContainer.innerHTML = `
                        <hr>
                        ${optimizationMetricsHtml}
                        <p class="text-muted text-center py-3">
                            <i class="bi bi-inbox me-2"></i>回测期间无交易记录
                        </p>
                    `;
                    return;
                }

                const tradesHtml = trades.map(trade => {
                    const actionClass = trade.action === 'buy' ? 'positive' : 
                                       trade.action === 'stop_loss' ? 'text-danger fw-bold' : 
                                       'negative';
                    const actionText = trade.action === 'buy' ? '买入' : 
                                      trade.action === 'stop_loss' ? '止损' : 
                                      '卖出';
                    const trendIcon = trade.trend === 'uptrend' ? '📈' : 
                                     trade.trend === 'downtrend' ? '📉' : 
                                     trade.trend ? '➡️' : '-';
                    
                    // 优化指标显示
                    let optimizationIcons = '';
                    if (trade.adx_value !== undefined) {
                        const adxIcon = trade.adx_value > 40 ? '🔴' : trade.adx_value > 25 ? '🟡' : trade.adx_value > 15 ? '🔵' : '⚪';
                        optimizationIcons += `<span title="ADX: ${trade.adx_value.toFixed(1)}">${adxIcon}</span>`;
                    }
                    if (trade.market_adjusted) {
                        optimizationIcons += ` <span title="市场Beta调整">📊</span>`;
                    }
                    if (trade.volume_confirmed) {
                        optimizationIcons += ` <span title="成交量确认">📈</span>`;
                    }
                    if (trade.trend_filtered) {
                        optimizationIcons += ` <span title="趋势过滤">🚫</span>`;
                    }

                    return `
                        <tr>
                            <td>${trade.date}</td>
                            <td class="${actionClass}">${actionText}</td>
                            <td>¥${trade.amount.toFixed(2)}</td>
                            <td>¥${trade.balance.toFixed(2)}</td>
                            <td>¥${trade.holdings.toFixed(2)}</td>
                            <td>${trade.multiplier ? trade.multiplier.toFixed(1) + '×' : '-'}</td>
                            <td>${trendIcon}</td>
                            <td class="text-center">${optimizationIcons || '-'}</td>
                        </tr>
                    `;
                }).join('');

                this.tradesContainer.innerHTML = `
                    <hr>
                    ${optimizationMetricsHtml}
                    <h6 class="mb-3"><i class="bi bi-list-ul me-2"></i>交易记录 (${trades.length}条)</h6>
                    <div class="table-responsive">
                        <table class="table table-sm table-striped table-hover">
                            <thead class="table-light">
                                <tr>
                                    <th>日期</th>
                                    <th>操作</th>
                                    <th>金额</th>
                                    <th>余额</th>
                                    <th>持仓</th>
                                    <th>倍数</th>
                                    <th>趋势</th>
                                    <th>优化指标</th>
                                </tr>
                            </thead>
                            <tbody>
                                ${tradesHtml}
                            </tbody>
                        </table>
                    </div>
                    <div class="mt-2 small text-muted">
                        <span class="me-3">🔴 ADX强趋势</span>
                        <span class="me-3">🟡 ADX中等趋势</span>
                        <span class="me-3">🔵 ADX弱趋势</span>
                        <span class="me-3">⚪ ADX无趋势</span>
                        <span class="me-3">📊 市场Beta调整</span>
                        <span class="me-3">📈 成交量确认</span>
                        <span>🚫 趋势过滤</span>
                    </div>
                `;
            }

            /**
             * Clear all results and hide the container
             */
            clear() {
                this.summaryContainer.innerHTML = '';
                this.metricsContainer.innerHTML = '';
                this.tradesContainer.innerHTML = '';
                this.container.style.display = 'none';
            }
        }

        // Initialize Results Visualizer
        const resultsVisualizer = new ResultsVisualizer('results-card');

        // Strategy comparison charts
        let comparisonEquityChart = null;
        let comparisonRiskChart = null;

        // ==================== Loading State and Message Management ====================

        
        /**
         * Show loading state with spinner and progress message
         * @param {string} message - Progress message to display
         */
        function showLoadingState(message = '处理中...') {
            // Disable backtest button and show spinner
            const btn = document.querySelector('.btn-success');
            if (btn) {
                btn.dataset.originalText = btn.innerHTML;
                btn.innerHTML = `<span class="spinner-border spinner-border-sm me-1"></span>${message}`;
                btn.disabled = true;
            }
            
            // Show progress message in status area
            const statusDiv = document.getElementById('backtest-status');
            const statusText = document.getElementById('backtest-status-text');
            if (statusDiv && statusText) {
                statusText.textContent = message;
                statusDiv.style.display = 'block';
            }
        }
        
        /**
         * Clear loading state and restore button
         */
        function clearLoadingState() {
            // Restore backtest button
            const btn = document.querySelector('.btn-success');
            if (btn && btn.dataset.originalText) {
                btn.innerHTML = btn.dataset.originalText;
                btn.disabled = false;
                delete btn.dataset.originalText;
            }
            
            // Hide status area
            const statusDiv = document.getElementById('backtest-status');
            if (statusDiv) {
                statusDiv.style.display = 'none';
            }
        }
        
        /**
         * Show success message
         * @param {string} message - Success message to display
         */
        function showSuccessMessage(message) {
            // Hide loading status
            clearLoadingState();
            
            const resultsDiv = document.getElementById('backtest-result');
            const resultsContent = document.getElementById('backtest-result-content');
            if (resultsDiv && resultsContent) {
                resultsDiv.style.display = 'block';
                resultsContent.innerHTML = `
                    <div class="alert alert-success mb-3">
                        <i class="bi bi-check-circle me-2"></i>${message}
                    </div>
                ` + resultsContent.innerHTML;
            }
        }
        
        /**
         * Show error message with appropriate styling based on error type
         * @param {string} message - Error message to display
         * @param {string} errorType - Type of error: 'validation', 'missing_data', 'network', 'server', 'backtest'
         */
        function showErrorMessage(message, errorType = 'backtest') {
            // Hide loading status
            clearLoadingState();
            
            const resultsDiv = document.getElementById('backtest-result');
            const resultsContent = document.getElementById('backtest-result-content');
            
            // Determine alert class and icon based on error type
            let alertClass = 'alert-warning';
            let icon = 'exclamation-triangle';
            
            switch (errorType) {
                case 'validation':
                    alertClass = 'alert-warning';
                    icon = 'exclamation-triangle';
                    break;
                case 'missing_data':
                    alertClass = 'alert-info';
                    icon = 'info-circle';
                    break;
                case 'network':
                    alertClass = 'alert-danger';
                    icon = 'wifi-off';
                    break;
                case 'server':
                    alertClass = 'alert-danger';
                    icon = 'x-circle';
                    break;
                case 'backtest':
                default:
                    alertClass = 'alert-warning';
                    icon = 'exclamation-triangle';
                    break;
            }
            
            if (resultsDiv && resultsContent) {
                resultsDiv.style.display = 'block';
                resultsContent.innerHTML = `
                    <div class="alert ${alertClass} mb-0">
                        <i class="bi bi-${icon} me-2"></i>${message}
                    </div>
                `;
            }
        }

        // ==================== Comparison Mode Toggle ====================
        
        /**
         * Toggle comparison mode on/off
         */
        function toggleComparisonMode() {
            try {
                const toggle = document.getElementById('comparison-mode-toggle');
                const infoDiv = document.getElementById('comparison-mode-info');
                
                if (!toggle) {
                    console.error('Comparison mode toggle element not found');
                    return;
                }
                
                const isEnabled = toggle.checked;
                console.log('Toggle comparison mode:', isEnabled);
                
                // Update strategy selector mode
                if (strategySelector && typeof strategySelector.setComparisonMode === 'function') {
                    strategySelector.setComparisonMode(isEnabled);
                    console.log('Strategy selector mode updated');
                } else {
                    console.error('strategySelector not available or setComparisonMode not a function');
                }
                
                // Show/hide info message
                if (infoDiv) {
                    infoDiv.style.display = isEnabled ? 'block' : 'none';
                    console.log('Info div display:', infoDiv.style.display);
                }
                
                // Update backtest button state based on new mode
                if (typeof updateBacktestButtonState === 'function') {
                    updateBacktestButtonState();
                }
            } catch (error) {
                console.error('Error in toggleComparisonMode:', error);
            }
        }

        /**
         * Run strategy comparison
         */
        async function runStrategyComparison() {
            const selectedFunds = fundSelector.getSelectedFunds();
            const selectedStrategies = strategySelector.getSelectedStrategies();
            const initialAmount = parseFloat(document.getElementById('initial-amount').value);
            const baseInvest = parseFloat(document.getElementById('base-invest').value);
            const backtestPeriod = parseInt(document.getElementById('backtest-period').value);
            
            // Validate fund selection (must be exactly one fund)
            if (selectedFunds.length === 0) {
                showErrorMessage('请选择一个基金进行策略对比', 'validation');
                return;
            }
            if (selectedFunds.length > 1) {
                showErrorMessage('策略对比模式只支持单个基金，请选择一个基金', 'validation');
                return;
            }
            
            // Validate strategy selection (must be at least 2)
            if (selectedStrategies.length < 2) {
                showErrorMessage('请至少选择两个策略进行对比', 'validation');
                return;
            }
            
            // Validate parameters
            if (!validateBacktestParameters(initialAmount, baseInvest, backtestPeriod)) {
                return;
            }
            
            // Show loading state
            showLoadingState('正在执行策略对比，请稍候...');
            
            try {
                // 获取策略优化参数
                const strategyParams = getStrategyParams();
                
                const response = await fetch('/api/strategy/compare', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        fund_code: selectedFunds[0],
                        strategy_ids: selectedStrategies,
                        initial_amount: initialAmount,
                        base_invest: baseInvest,
                        period: backtestPeriod,
                        strategy_params: strategyParams  // 传递优化参数
                    })
                });
                
                const result = await response.json();
                
                console.log('Strategy comparison API response:', result);
                
                if (result.success && result.data) {
                    console.log('Comparison data received:', result.data);
                    console.log('Number of strategies:', result.data.strategies ? result.data.strategies.length : 0);
                    
                    showSuccessMessage('策略对比完成！');
                    displayComparisonResults(result.data);

                } else {
                    showErrorMessage(result.error || '策略对比失败', 'backtest');
                }
            } catch (error) {
                console.error('策略对比失败:', error);
                if (error.message.includes('Failed to fetch') || error.message.includes('NetworkError')) {
                    showErrorMessage('网络连接失败，请检查网络后重试', 'network');
                } else {
                    showErrorMessage(`策略对比请求失败: ${error.message}`, 'server');
                }
            } finally {
                clearLoadingState();
            }
        }

        /**
         * Display strategy comparison results in a side-by-side table
         * @param {Object} data - Comparison result data
         */
        function displayComparisonResults(data) {
            console.log('displayComparisonResults called');
            console.log('Input data:', JSON.stringify(data, null, 2));
            
            const strategies = data.strategies;
            const bestStrategyId = data.best_strategy_id;

            
            // Build comparison table
            let tableHtml = `
                <div class="alert alert-success mb-3">
                    <i class="bi bi-check-circle me-2"></i>
                    <strong>策略对比完成</strong> - 基金: ${data.fund_code}, 回测周期: ${data.period}年
                </div>
                <div class="table-responsive">
                    <table class="comparison-table table table-bordered">
                        <thead>
                            <tr>
                                <th>指标</th>
                                ${strategies.map(s => {
                                    const strategyData = strategySelector.strategies.find(st => st.strategy_id === s.strategy_id);
                                    const isBest = s.strategy_id === bestStrategyId;
                                    return `<th class="${isBest ? 'best-strategy' : ''}">
                                        ${strategyData ? strategyData.name : s.strategy_id}
                                        ${isBest ? '<span class="best-badge">最佳</span>' : ''}
                                    </th>`;
                                }).join('')}
                            </tr>
                        </thead>
                        <tbody>
                            <tr>
                                <td><strong>初始金额</strong></td>
                                ${strategies.map(s => `<td>¥${s.initial_amount.toLocaleString()}</td>`).join('')}
                            </tr>
                            <tr>
                                <td><strong>最终价值</strong></td>
                                ${strategies.map(s => {
                                    const isBest = s.strategy_id === bestStrategyId;
                                    return `<td class="${isBest ? 'best-strategy' : ''}">¥${(s.final_value || s.total_value || 0).toLocaleString()}</td>`;
                                }).join('')}
                            </tr>
                            <tr>
                                <td><strong>总收益率</strong></td>
                                ${strategies.map(s => {
                                    const isBest = s.strategy_id === bestStrategyId;
                                    const totalReturn = s.total_return || 0;
                                    const returnClass = totalReturn >= 0 ? 'metric-positive' : 'metric-negative';
                                    const returnSign = totalReturn >= 0 ? '+' : '';
                                    return `<td class="${isBest ? 'best-strategy' : ''} ${returnClass}">
                                        ${returnSign}${totalReturn.toFixed(2)}%
                                    </td>`;
                                }).join('')}
                            </tr>
                            <tr>
                                <td><strong>年化收益率</strong></td>
                                ${strategies.map(s => {
                                    const annualizedReturn = s.annualized_return || 0;
                                    const returnClass = annualizedReturn >= 0 ? 'metric-positive' : 'metric-negative';
                                    const returnSign = annualizedReturn >= 0 ? '+' : '';
                                    return `<td class="${returnClass}">${returnSign}${annualizedReturn.toFixed(2)}%</td>`;
                                }).join('')}
                            </tr>
                            <tr>
                                <td><strong>最大回撤</strong></td>
                                ${strategies.map(s => {
                                    const maxDrawdown = s.max_drawdown || 0;
                                    return `<td class="metric-negative">${maxDrawdown.toFixed(2)}%</td>`;
                                }).join('')}
                            </tr>
                            <tr>
                                <td><strong>夏普比率</strong></td>
                                ${strategies.map(s => {
                                    const sharpeRatio = s.sharpe_ratio || 0;
                                    return `<td>${sharpeRatio.toFixed(2)}</td>`;
                                }).join('')}
                            </tr>
                            <tr>
                                <td><strong>交易次数</strong></td>
                                ${strategies.map(s => `<td>${s.trades_count || 0}</td>`).join('')}
                            </tr>
                            <tr>
                                <td><strong>命中率</strong></td>
                                ${strategies.map(s => {
                                    const hitRate = s.evaluation && s.evaluation.hit_rate !== null ? s.evaluation.hit_rate * 100 : 0;
                                    return `<td>${hitRate.toFixed(1)}%</td>`;
                                }).join('')}
                            </tr>
                            <tr>
                                <td><strong>盈亏比</strong></td>
                                ${strategies.map(s => {
                                    const profitFactor = s.evaluation && s.evaluation.profit_factor !== null ? s.evaluation.profit_factor : 0;
                                    return `<td>${profitFactor.toFixed(2)}</td>`;
                                }).join('')}
                            </tr>
                        </tbody>
                    </table>
                </div>
                <div class="comparison-report-section">
                    <!-- 收益曲线对比 - 独占一行 -->
                    <div class="row g-4 mb-4">
                        <div class="col-12">
                            <div class="comparison-chart-card">
                                <div class="comparison-chart-title" style="display: flex; justify-content: space-between; align-items: center;">
                                    <span><i class="bi bi-graph-up"></i>收益曲线对比</span>
                                    <div class="chart-controls">
                                        <button class="btn btn-sm btn-outline-secondary" onclick="resetEquityChartZoom()" title="重置缩放">
                                            <i class="bi bi-arrows-angle-expand"></i> 重置
                                        </button>
                                        <small class="text-muted ms-2">滚轮缩放 | Ctrl+拖拽平移</small>
                                    </div>
                                </div>
                                <div class="comparison-chart-container">
                                    <canvas class="comparison-chart-canvas" id="comparison-equity-chart"></canvas>
                                </div>
                            </div>
                        </div>
                    </div>
                    <!-- 策略对比报告和风险指标对比 - 并排显示 -->
                    <div class="row g-4">
                        <div class="col-lg-6">
                            <div class="comparison-report-card" id="comparison-report"></div>
                        </div>
                        <div class="col-lg-6">
                            <div class="comparison-chart-card">
                                <div class="comparison-chart-title">
                                    <i class="bi bi-shield-check"></i>风险指标对比
                                </div>
                                <div class="comparison-chart-container">
                                    <canvas class="comparison-chart-canvas" id="comparison-risk-chart"></canvas>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            `;

            
            // Display in results area
            document.getElementById('backtest-result').style.display = 'block';
            document.getElementById('backtest-result-content').innerHTML = tableHtml;
            
            // Add animation class
            const resultsDiv = document.getElementById('backtest-result');
            resultsDiv.classList.add('results-animate');
            
            // Remove animation class after animation completes
            setTimeout(() => {
                resultsDiv.classList.remove('results-animate');
            }, 500);
            
            // Scroll to results section with smooth animation
            const resultsSection = document.getElementById('results-section');
            if (resultsSection) {
                resultsSection.scrollIntoView({ behavior: 'smooth', block: 'start' });
            } else {
                // Fallback to scrolling to results div if section not found
                resultsDiv.scrollIntoView({ behavior: 'smooth', block: 'start' });
            }
            
            renderComparisonCharts(data);
            console.log('📊 已调用 renderComparisonCharts，数据包含:', {
                strategies: data.strategies ? data.strategies.length : 0,
                fund_code: data.fund_code,
                period: data.period
            });
            renderComparisonReport(data);
            
            console.log('displayComparisonResults completed');
            
            // 注意：不要在策略对比表格上调用 updateFundNames()
            // 该函数是为多基金回测表格设计的（第1列=基金代码，第2列=基金名称）
            // 策略对比表格结构不同（第1列=指标名称，后续列=各策略数据）
            // 调用会导致第一个策略列的数据被错误覆盖


        }

        function getStrategyDisplayName(strategyId) {
            const strategyData = strategySelector.strategies.find(st => st.strategy_id === strategyId);
            return strategyData ? strategyData.name : strategyId;
        }
        
        // 重置收益曲线图表缩放
        function resetEquityChartZoom() {
            if (comparisonEquityChart) {
                comparisonEquityChart.resetZoom();
                console.log('📊 收益曲线图表缩放已重置');
            }
        }

        function renderComparisonCharts(data) {
            console.log('🚀 renderComparisonCharts 被调用');
            // 使用 requestAnimationFrame 确保DOM已渲染
            requestAnimationFrame(() => {
                console.log('⏳ requestAnimationFrame 触发，等待300ms...');
                // 额外延迟确保布局计算完成
                setTimeout(() => {
                    console.log('⏳ 延迟结束，开始渲染图表');
                    doRenderComparisonCharts(data);
                }, 300);
            });
        }
        
        function doRenderComparisonCharts(data) {
            console.log('📊 开始渲染策略对比图表...');
            console.log('📦 接收到的数据:', JSON.stringify(data, null, 2).substring(0, 500));
            
            const strategies = data.strategies || [];
            console.log(`📈 策略数量: ${strategies.length}`);
            
            // 详细打印每个策略的equity_curve情况
            strategies.forEach((strategy, idx) => {
                const curve = strategy.equity_curve;
                console.log(`📊 策略 ${idx + 1} (${strategy.strategy_id}): equity_curve 类型=${typeof curve}, 是否数组=${Array.isArray(curve)}, 长度=${Array.isArray(curve) ? curve.length : 'N/A'}`);
                if (Array.isArray(curve) && curve.length > 0) {
                    console.log(`   首条数据:`, curve[0]);
                    console.log(`   末条数据:`, curve[curve.length - 1]);
                }
            });
            
            const equityChartDom = document.getElementById('comparison-equity-chart');
            const riskChartDom = document.getElementById('comparison-risk-chart');
            
            if (!equityChartDom || !riskChartDom) {
                console.error('❌ Chart canvas elements not found!');
                console.log('equityChartDom:', equityChartDom);
                console.log('riskChartDom:', riskChartDom);
                return;
            }
            
            // 检查Canvas父容器尺寸
            const equityContainer = equityChartDom.parentElement;
            const riskContainer = riskChartDom.parentElement;
            
            if (!equityContainer || equityContainer.offsetWidth === 0) {
                console.warn('⚠️ Canvas container has no width, retrying in 200ms...');
                setTimeout(() => doRenderComparisonCharts(data), 200);
                return;
            }
            
            console.log(`📐 Canvas容器尺寸: ${equityContainer.offsetWidth}x${equityContainer.offsetHeight}`);
            
            if (!window.Chart) {
                console.warn('⚠️ Chart.js 尚未加载，等待500ms后重试...');
                // Chart.js可能正在从备用CDN加载，等待后重试
                setTimeout(() => doRenderComparisonCharts(data), 500);
                return;
            }
            console.log('✅ Chart.js 已加载');

            // 销毁旧图表
            if (comparisonEquityChart) {
                comparisonEquityChart.destroy();
                comparisonEquityChart = null;
                console.log('🗑️ 已销毁旧的收益曲线图表');
            }
            if (comparisonRiskChart) {
                comparisonRiskChart.destroy();
                comparisonRiskChart = null;
                console.log('🗑️ 已销毁旧的风险指标图表');
            }

            // Build equity curve chart
            const curves = strategies.map(strategy => {
                return Array.isArray(strategy.equity_curve) ? strategy.equity_curve : [];
            });
            
            console.log(`📊 收集到的曲线数据:`, curves.map((c, i) => `策略${i + 1}: ${c.length}个点`));
            
            const firstCurve = curves.find(curve => curve.length > 0);
            if (!firstCurve) {
                console.warn('⚠️ No equity curve data found in any strategy');
                if (equityContainer) {
                    equityContainer.innerHTML = '<div class="text-muted p-3 text-center"><i class="bi bi-info-circle me-2"></i>暂无收益曲线数据</div>';
                }
            } else {
                console.log(`📈 找到收益曲线数据，使用策略1作为基准，共 ${firstCurve.length} 个数据点`);
                
                const labels = firstCurve.map(point => point.date);
                console.log(`📅 日期标签: 从 ${labels[0]} 到 ${labels[labels.length - 1]}`);
                
                const palette = ['#4361ee', '#ef476f', '#06d6a0', '#ffd166', '#118ab2', '#8e7dbe'];
                const datasets = strategies.map((strategy, index) => {
                    const curve = curves[index] || [];
                    const base = curve.length ? curve[0].value : 0;
                    
                    // 计算累计收益率
                    const series = curve.map(point => {
                        if (base && base > 0) {
                            return ((point.value / base) - 1) * 100;
                        }
                        return 0;
                    });
                    
                    const strategyName = getStrategyDisplayName(strategy.strategy_id);
                    console.log(`📊 策略 "${strategyName}": 基准值=${base}, 数据点数=${series.length}, 最终收益率=${series.length > 0 ? series[series.length - 1].toFixed(2) : 'N/A'}%`);
                    
                    return {
                        label: strategyName,
                        data: series,
                        borderColor: palette[index % palette.length],
                        backgroundColor: palette[index % palette.length] + '20',
                        borderWidth: 2,
                        pointRadius: 0,
                        pointHoverRadius: 4,
                        tension: 0.2,
                        fill: false
                    };
                });
                
                // 添加沪深300基准曲线
                const benchmarkCurve = data.benchmark_curve || [];
                console.log(`📊 沪深300基准曲线数据: 长度=${benchmarkCurve.length}, 策略日期数=${labels.length}`, benchmarkCurve.length > 0 ? `首条=${JSON.stringify(benchmarkCurve[0])}, 末条=${JSON.stringify(benchmarkCurve[benchmarkCurve.length-1])}` : '无数据');
                
                if (benchmarkCurve.length > 0) {
                    // 验证基准曲线日期是否与策略曲线日期对齐
                    const benchmarkDates = benchmarkCurve.map(p => p.date);
                    const mismatchCount = labels.filter((label, idx) => benchmarkDates[idx] !== label).length;
                    if (mismatchCount > 0) {
                        console.warn(`⚠️ 基准曲线有 ${mismatchCount} 个日期与策略曲线不匹配`);
                    } else {
                        console.log(`✅ 基准曲线日期与策略曲线完全对齐`);
                    }
                    
                    const benchmarkBase = benchmarkCurve[0].value;
                    const benchmarkSeries = benchmarkCurve.map(point => {
                        if (benchmarkBase && benchmarkBase > 0) {
                            return ((point.value / benchmarkBase) - 1) * 100;
                        }
                        return 0;
                    });
                    
                    console.log(`📊 沪深300基准: 基准值=${benchmarkBase}, 数据点数=${benchmarkSeries.length}, 最终收益率=${benchmarkSeries.length > 0 ? benchmarkSeries[benchmarkSeries.length - 1].toFixed(2) : 'N/A'}%`);
                    
                    // 确保基准曲线数据点数量与标签数量一致
                    if (benchmarkSeries.length !== labels.length) {
                        console.warn(`⚠️ 基准曲线数据点数(${benchmarkSeries.length})与日期标签数(${labels.length})不一致，进行对齐处理`);
                        // 如果数据点少于标签，用最后一个值填充
                        while (benchmarkSeries.length < labels.length) {
                            benchmarkSeries.push(benchmarkSeries[benchmarkSeries.length - 1] || 0);
                        }
                        // 如果数据点多于标签，截断
                        benchmarkSeries.length = labels.length;
                    }
                    
                    datasets.push({
                        label: '沪深300基准',
                        data: benchmarkSeries,
                        borderColor: '#999999',
                        backgroundColor: 'rgba(153, 153, 153, 0.1)',
                        borderWidth: 2,
                        borderDash: [5, 5],  // 虚线样式
                        pointRadius: 0,
                        pointHoverRadius: 4,
                        tension: 0.2,
                        fill: false
                    });
                }

                console.log(`📊 准备创建图表，数据集数量: ${datasets.length}`);

                try {
                    comparisonEquityChart = new Chart(equityChartDom, {
                        type: 'line',
                        data: { labels, datasets },
                        options: {
                            responsive: true,
                            maintainAspectRatio: false,
                            interaction: {
                                mode: 'index',
                                intersect: false
                            },
                            plugins: { 
                                legend: { 
                                    position: 'bottom',
                                    labels: {
                                        usePointStyle: true,
                                        padding: 15,
                                        font: { size: 12 }
                                    }
                                },
                                tooltip: {
                                    backgroundColor: 'rgba(67, 97, 238, 0.9)',
                                    titleFont: { weight: 'bold' },
                                    bodySpacing: 4,
                                    padding: 12,
                                    callbacks: {
                                        label: function(context) {
                                            const sign = context.parsed.y >= 0 ? '+' : '';
                                            return `${context.dataset.label}: ${sign}${context.parsed.y.toFixed(2)}%`;
                                        }
                                    }
                                },
                                // 缩放插件配置
                                zoom: {
                                    pan: {
                                        enabled: true,
                                        mode: 'x',  // 只允许X轴平移
                                        modifierKey: 'ctrl'  // 按住Ctrl键平移
                                    },
                                    zoom: {
                                        wheel: {
                                            enabled: true,  // 启用滚轮缩放
                                            speed: 0.1      // 缩放速度
                                        },
                                        pinch: {
                                            enabled: true   // 触摸板捏合缩放
                                        },
                                        mode: 'x',  // 只允许X轴缩放
                                        onZoomComplete: function({chart}) {
                                            console.log('📊 图表缩放完成');
                                        }
                                    },
                                    limits: {
                                        x: {min: 'original', max: 'original'},  // 限制X轴范围
                                        y: {min: 'original', max: 'original'}   // 限制Y轴范围
                                    }
                                }
                            },
                            scales: {
                                y: {
                                    title: { display: true, text: '累计收益率 (%)' },
                                    ticks: { 
                                        callback: value => {
                                            const sign = value >= 0 ? '+' : '';
                                            return `${sign}${value.toFixed(1)}%`;
                                        }
                                    },
                                    grid: { color: 'rgba(0,0,0,0.05)' }
                                },
                                x: {
                                    ticks: {
                                        maxTicksLimit: 10,
                                        maxRotation: 45
                                    },
                                    grid: { display: false }
                                }
                            }
                        }
                    });
                    console.log('✅ 收益曲线图表创建成功！');
                } catch (err) {
                    console.error('❌ 创建收益曲线图表失败:', err);
                    console.error('错误详情:', err.stack);
                }
            }

            // Build risk metrics chart
            const riskLabels = strategies.map(strategy => getStrategyDisplayName(strategy.strategy_id));
            console.log(`📊 风险指标图表标签:`, riskLabels);
            
            const riskData = {
                labels: riskLabels,
                datasets: [
                    {
                        label: '年化收益率 (%)',
                        data: strategies.map(strategy => strategy.annualized_return || 0),
                        backgroundColor: 'rgba(67, 97, 238, 0.8)',
                        borderColor: '#4361ee',
                        borderWidth: 1,
                        yAxisID: 'y'
                    },
                    {
                        label: '最大回撤 (%)',
                        data: strategies.map(strategy => Math.abs(strategy.max_drawdown || 0)),
                        backgroundColor: 'rgba(239, 71, 111, 0.8)',
                        borderColor: '#ef476f',
                        borderWidth: 1,
                        yAxisID: 'y'
                    },
                    {
                        label: '夏普比率',
                        data: strategies.map(strategy => strategy.sharpe_ratio || 0),
                        backgroundColor: 'rgba(6, 214, 160, 0.8)',
                        borderColor: '#06d6a0',
                        borderWidth: 1,
                        yAxisID: 'y1'
                    }
                ]
            };
            
            console.log(`📊 风险指标数据:`, {
                annualized: riskData.datasets[0].data,
                maxDrawdown: riskData.datasets[1].data,
                sharpe: riskData.datasets[2].data
            });

            try {
                comparisonRiskChart = new Chart(riskChartDom, {
                    type: 'bar',
                    data: riskData,
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        interaction: {
                            mode: 'index',
                            intersect: false
                        },
                        plugins: { 
                            legend: { 
                                position: 'bottom',
                                labels: {
                                    usePointStyle: true,
                                    padding: 15,
                                    font: { size: 12 }
                                }
                            },
                            tooltip: {
                                backgroundColor: 'rgba(67, 97, 238, 0.9)',
                                padding: 12
                            }
                        },
                        scales: {
                            y: {
                                position: 'left',
                                title: { display: true, text: '百分比 (%)' },
                                ticks: { callback: value => `${value.toFixed(1)}%` },
                                grid: { color: 'rgba(0,0,0,0.05)' }
                            },
                            y1: {
                                position: 'right',
                                title: { display: true, text: '夏普比率' },
                                grid: { drawOnChartArea: false }
                            }
                        }
                    }
                });
                console.log('✅ 风险指标图表创建成功！');
            } catch (err) {
                console.error('❌ 创建风险指标图表失败:', err);
                console.error('错误详情:', err.stack);
            }
            
            console.log('📊 图表渲染流程完成');
        }


        function renderComparisonReport(data) {
            const reportDom = document.getElementById('comparison-report');
            if (!reportDom) return;

            const strategies = data.strategies || [];
            if (!strategies.length) {
                reportDom.innerHTML = '<div class="text-muted">暂无报告数据</div>';
                return;
            }

            const bestStrategy = strategies.find(strategy => strategy.strategy_id === data.best_strategy_id) || strategies[0];
            const strategyCount = strategies.length;
            const avgReturn = strategies.reduce((sum, strategy) => sum + (strategy.total_return || 0), 0) / strategyCount;
            const formatPercent = value => `${(value || 0).toFixed(2)}%`;
            const formatNumber = value => (value || 0).toFixed(2);

            const bestName = getStrategyDisplayName(bestStrategy.strategy_id);
            const strategyRows = strategies.map(strategy => {
                return `
                    <div class="report-metric">
                        <span>${getStrategyDisplayName(strategy.strategy_id)}</span>
                        <span>${formatPercent(strategy.total_return)} | 夏普 ${formatNumber(strategy.sharpe_ratio)}</span>
                    </div>
                `;
            }).join('');

            reportDom.innerHTML = `
                <h6><i class="bi bi-file-earmark-text me-2"></i>策略对比报告</h6>
                <div class="report-highlight">
                    本次对比共包含 ${strategyCount} 种策略，平均总收益率为 ${formatPercent(avgReturn)}。
                </div>
                <div class="report-highlight">
                    最佳策略：<strong>${bestName}</strong>，总收益率 ${formatPercent(bestStrategy.total_return)}，年化收益率 ${formatPercent(bestStrategy.annualized_return)}。
                </div>
                <div class="mb-2 text-muted">关键统计对比</div>
                ${strategyRows}
                <div class="report-highlight mt-3">
                    风险提示：过往业绩不代表未来表现，请结合自身风险承受能力选择策略。
                </div>
            `;
        }
        
        // 辅助函数：切换基金详情的显示/隐藏

        function toggleFundDetails(button) {
            const detailsDiv = button.nextElementSibling;
            if (detailsDiv && detailsDiv.classList.contains('fund-details')) {
                detailsDiv.classList.toggle('d-none');
                button.textContent = detailsDiv.classList.contains('d-none') ? '详情' : '收起';
            }
        }

        // ==================== Backtest Parameter Validation ====================
        
        /**
         * Validation configuration for backtest parameters
         */
        const VALIDATION_RULES = {
            initial_amount: {
                min: 100,
                errorMessage: '初始金额必须大于等于100元'
            },
            base_invest: {
                min: 10,
                errorMessage: '基准定投金额必须大于等于10元'
            },
            period: {
                validValues: [1, 2, 3, 5],
                errorMessage: '回测周期必须是1、2、3或5年'
            }
        };

        /**
         * Validate initial amount parameter
         * @param {number} value - Initial amount value
         * @returns {Object} Validation result with isValid and error properties
         */
        function validateInitialAmount(value) {
            const numValue = parseFloat(value);
            
            if (isNaN(numValue)) {
                return {
                    isValid: false,
                    error: '初始金额必须是有效数字'
                };
            }
            
            if (numValue < VALIDATION_RULES.initial_amount.min) {
                return {
                    isValid: false,
                    error: VALIDATION_RULES.initial_amount.errorMessage
                };
            }
            
            return { isValid: true, error: null };
        }

        /**
         * Validate base invest parameter
         * @param {number} value - Base invest value
         * @returns {Object} Validation result with isValid and error properties
         */
        function validateBaseInvest(value) {
            const numValue = parseFloat(value);
            
            if (isNaN(numValue)) {
                return {
                    isValid: false,
                    error: '基准定投金额必须是有效数字'
                };
            }
            
            if (numValue < VALIDATION_RULES.base_invest.min) {
                return {
                    isValid: false,
                    error: VALIDATION_RULES.base_invest.errorMessage
                };
            }
            
            return { isValid: true, error: null };
        }

        /**
         * Validate period parameter
         * @param {number} value - Period value (years)
         * @returns {Object} Validation result with isValid and error properties
         */
        function validatePeriod(value) {
            const numValue = parseInt(value);
            
            if (isNaN(numValue)) {
                return {
                    isValid: false,
                    error: '回测周期必须是有效数字'
                };
            }
            
            if (!VALIDATION_RULES.period.validValues.includes(numValue)) {
                return {
                    isValid: false,
                    error: VALIDATION_RULES.period.errorMessage
                };
            }
            
            return { isValid: true, error: null };
        }

        /**
         * Display inline validation error for a field
         * @param {string} fieldId - ID of the input field
         * @param {string} errorMessage - Error message to display
         */
        function showValidationError(fieldId, errorMessage) {
            const field = document.getElementById(fieldId);
            const errorDiv = document.getElementById(`${fieldId}-error`);
            
            if (field && errorDiv) {
                field.classList.add('is-invalid');
                errorDiv.textContent = errorMessage;
                errorDiv.style.display = 'block';
            }
        }

        /**
         * Clear validation error for a field
         * @param {string} fieldId - ID of the input field
         */
        function clearValidationError(fieldId) {
            const field = document.getElementById(fieldId);
            const errorDiv = document.getElementById(`${fieldId}-error`);
            
            if (field && errorDiv) {
                field.classList.remove('is-invalid');
                errorDiv.textContent = '';
                errorDiv.style.display = 'none';
            }
        }

        /**
         * Clear all validation errors
         */
        function clearAllValidationErrors() {
            clearValidationError('initial-amount');
            clearValidationError('base-invest');
            clearValidationError('backtest-period');
        }

        /**
         * Validate all backtest parameters
         * @param {number} initialAmount - Initial amount value
         * @param {number} baseInvest - Base invest value
         * @param {number} days - Days value
         * @returns {boolean} True if all parameters are valid, false otherwise
         */
        function validateBacktestParameters(initialAmount, baseInvest, period) {
            clearAllValidationErrors();
            let isValid = true;

            // Validate initial amount
            const initialAmountResult = validateInitialAmount(initialAmount);
            if (!initialAmountResult.isValid) {
                showValidationError('initial-amount', initialAmountResult.error);
                isValid = false;
            }

            // Validate base invest
            const baseInvestResult = validateBaseInvest(baseInvest);
            if (!baseInvestResult.isValid) {
                showValidationError('base-invest', baseInvestResult.error);
                isValid = false;
            }

            // Validate period
            const periodResult = validatePeriod(period);
            if (!periodResult.isValid) {
                showValidationError('backtest-period', periodResult.error);
                isValid = false;
            }

            return isValid;
        }

        // Add real-time validation on input change
        document.addEventListener('DOMContentLoaded', () => {
            // Initial amount validation on blur
            const initialAmountField = document.getElementById('initial-amount');
            if (initialAmountField) {
                initialAmountField.addEventListener('blur', function() {
                    const result = validateInitialAmount(this.value);
                    if (!result.isValid) {
                        showValidationError('initial-amount', result.error);
                    } else {
                        clearValidationError('initial-amount');
                    }
                });
                
                initialAmountField.addEventListener('input', function() {
                    // Clear error on input to give immediate feedback
                    if (this.classList.contains('is-invalid')) {
                        const result = validateInitialAmount(this.value);
                        if (result.isValid) {
                            clearValidationError('initial-amount');
                        }
                    }
                });
            }

            // Base invest validation on blur
            const baseInvestField = document.getElementById('base-invest');
            if (baseInvestField) {
                baseInvestField.addEventListener('blur', function() {
                    const result = validateBaseInvest(this.value);
                    if (!result.isValid) {
                        showValidationError('base-invest', result.error);
                    } else {
                        clearValidationError('base-invest');
                    }
                });
                
                baseInvestField.addEventListener('input', function() {
                    // Clear error on input to give immediate feedback
                    if (this.classList.contains('is-invalid')) {
                        const result = validateBaseInvest(this.value);
                        if (result.isValid) {
                            clearValidationError('base-invest');
                        }
                    }
                });
            }

            // Period validation on change
            const periodField = document.getElementById('backtest-period');
            if (periodField) {
                periodField.addEventListener('change', function() {
                    const result = validatePeriod(this.value);
                    if (!result.isValid) {
                        showValidationError('backtest-period', result.error);
                    } else {
                        clearValidationError('backtest-period');
                        // 选择周期后只更新界面显示，不自动触发回测
                        // 回测操作由用户点击"开始策略对比"按钮手动触发
                        console.log('回测周期已更新为: ' + this.value + ' 年');
                    }
                });
            }
        });

        /**
         * 自动触发回测功能
         */
        function autoTriggerBacktest() {
            const selectedFunds = fundSelector.getSelectedFunds();
            const selectedStrategy = strategySelector.getSelectedStrategy();
            const comparisonMode = document.getElementById('comparison-mode-toggle').checked;
            
            // 检查是否满足回测条件
            if (selectedFunds.length === 0 || (!comparisonMode && !selectedStrategy)) {
                return;
            }
            
            // 如果是对比模式，需要至少两个策略
            if (comparisonMode) {
                const selectedStrategies = strategySelector.getSelectedStrategies();
                if (selectedStrategies.length < 2) {
                    return;
                }
            }
            
            // 自动执行回测
            runBacktest();
        }

        // ==================== Button Enable/Disable Logic ====================
        
        /**
         * Update backtest button state based on fund and strategy selection
         */
        function updateBacktestButtonState() {
            const backtestBtn = document.querySelector('.btn-success');
            if (!backtestBtn) return;
            
            const selectedFunds = fundSelector.getSelectedFunds();
            const selectedStrategy = strategySelector.getSelectedStrategy();
            const comparisonMode = document.getElementById('comparison-mode-toggle').checked;
            
            // In comparison mode, need at least one fund and multiple strategies
            if (comparisonMode) {
                const selectedStrategies = strategySelector.getSelectedStrategies();
                const shouldEnable = selectedFunds.length > 0 && selectedStrategies.length >= 2;
                backtestBtn.disabled = !shouldEnable;
                
                // Update button text for comparison mode
                backtestBtn.innerHTML = '<i class="bi bi-bar-chart-line me-1"></i>开始策略对比';
                
                if (!shouldEnable) {
                    backtestBtn.title = selectedFunds.length === 0 ? 
                        '请先选择基金' : 
                        '请至少选择两个策略进行对比';
                } else {
                    backtestBtn.title = '';
                }
            } else {
                // In single mode, need at least one fund and one strategy
                const shouldEnable = selectedFunds.length > 0 && selectedStrategy !== null;
                backtestBtn.disabled = !shouldEnable;
                
                // Update button text for single mode
                backtestBtn.innerHTML = '<i class="bi bi-play-circle me-1"></i>开始回测';
                
                if (!shouldEnable) {
                    backtestBtn.title = selectedFunds.length === 0 ? 
                        '请先选择基金' : 
                        '请先选择策略';
                } else {
                    backtestBtn.title = '';
                }
            }
        }
        
        // ==================== Existing Code ====================
        document.addEventListener('DOMContentLoaded', () => {
            loadStrategies();
            fundSelector.loadHoldings();
            strategySelector.loadStrategies();
            
            // ==================== Comparison Mode Toggle Event Binding ====================
            const comparisonToggle = document.getElementById('comparison-mode-toggle');
            if (comparisonToggle) {
                comparisonToggle.addEventListener('change', function() {
                    console.log('Comparison mode toggle changed:', this.checked);
                    toggleComparisonMode();
                });
            }
            
            // ==================== WIRING: Register callbacks for button state updates ====================
            // Wire fund selector to backtest button enable/disable logic
            fundSelector.onSelectionChange((selectedFunds) => {

                updateBacktestButtonState();
            });
            
            // Wire strategy selector to backtest button enable/disable logic
            strategySelector.onSelectionChange((selectedStrategy) => {
                console.log('Strategy selection changed:', selectedStrategy);
                updateBacktestButtonState();
            });
            
            // Initial button state update
            setTimeout(() => {
                updateBacktestButtonState();
            }, 500); // Wait for components to load
        });

        async function loadStrategies() {
            try {
                const response = await fetch('/api/strategies');
                const result = await response.json();
                if (result.success && result.data) {
                    const list = document.getElementById('strategy-list');
                    if (list) {
                        list.innerHTML = result.data.map(s => `
                            <div class="list-group-item strategy-card ${s.action.includes('buy') ? 'buy' : s.action.includes('sell') ? 'sell' : ''}">
                                <div class="d-flex justify-content-between align-items-center">
                                    <strong>${s.label}</strong>
                                    <span class="badge ${s.action.includes('buy') ? 'bg-success' : s.action.includes('sell') ? 'bg-danger' : 'bg-secondary'}">${s.action}</span>
                                </div>
                                <small class="text-muted">${s.description}</small>
                            </div>
                        `).join('');
                    }
                }
            } catch (error) { console.error('加载策略失败:', error); }
        }

        async function analyzeUnifiedStrategy() {
            const fundCode = document.getElementById('analyze-fund-code').value.trim();
            const todayReturn = parseFloat(document.getElementById('today-return').value);
            const prevDayReturn = parseFloat(document.getElementById('prev-day-return').value);
            const cumulativePnl = document.getElementById('cumulative-pnl').value;
            
            try {
                const response = await fetch('/api/strategy/unified-analyze', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ 
                        fund_code: fundCode || null,
                        today_return: todayReturn, 
                        prev_day_return: prevDayReturn,
                        cumulative_pnl: cumulativePnl ? parseFloat(cumulativePnl) / 100 : null
                    })
                });
                const result = await response.json();
                
                if (result.success && result.data) {
                    const d = result.data;
                    document.getElementById('analyze-result').style.display = 'block';
                    
                    // 趋势徽章
                    const trendBadge = d.trend === 'uptrend' ? '<span class="trend-badge trend-up">📈 上涨趋势</span>' :
                                       d.trend === 'downtrend' ? '<span class="trend-badge trend-down">📉 下跌趋势</span>' :
                                       '<span class="trend-badge trend-sideways">➡️ 横盘整理</span>';
                    
                    // 波动率样式
                    const volClass = d.volatility_level === 'high' ? 'volatility-high' :
                                     d.volatility_level === 'low' ? 'volatility-low' : 'volatility-normal';
                    
                    // 止损状态
                    let stopLossHtml = '';
                    if (d.stop_loss_triggered) {
                        stopLossHtml = `<div class="stop-loss-triggered mb-3"><i class="bi bi-exclamation-triangle-fill me-2"></i>${d.stop_loss_label}</div>`;
                    } else if (d.stop_loss_level === 'warning') {
                        stopLossHtml = `<div class="stop-loss-warning mb-3"><i class="bi bi-exclamation-triangle me-2"></i>${d.stop_loss_label}</div>`;
                    }
                    
                    document.getElementById('analyze-result-content').innerHTML = `
                        ${stopLossHtml}
                        <div class="row mb-3">
                            <div class="col-md-4">
                                <div class="metric-card">
                                    <div class="metric-value ${d.action.includes('buy') ? 'text-success' : d.action.includes('sell') ? 'text-danger' : ''}">${d.final_buy_multiplier.toFixed(1)}×</div>
                                    <div class="metric-label">最终买入倍数</div>
                                </div>
                            </div>
                            <div class="col-md-4">
                                <div class="metric-card">
                                    <div class="metric-value">${trendBadge}</div>
                                    <div class="metric-label">趋势判断</div>
                                </div>
                            </div>
                            <div class="col-md-4">
                                <div class="metric-card">
                                    <div class="metric-value ${volClass}">${(d.volatility * 100).toFixed(1)}%</div>
                                    <div class="metric-label">波动率 (${d.volatility_level})</div>
                                </div>
                            </div>
                        </div>
                        <table class="table table-sm mb-3">
                            <tr><td width="30%">策略名称</td><td><strong>${d.strategy_name}</strong></td></tr>
                            <tr><td>状态标签</td><td>${d.status_label}</td></tr>
                            <tr><td>操作建议</td><td>${d.operation_suggestion}</td></tr>
                            <tr><td>基础倍数</td><td>${d.base_buy_multiplier}×</td></tr>
                            <tr><td>趋势调整</td><td>×${d.trend_adjustment.toFixed(2)}</td></tr>
                            <tr><td>波动率调整</td><td>×${d.volatility_adjustment.toFixed(2)}</td></tr>
                            <tr><td>赎回金额</td><td>¥${d.redeem_amount}</td></tr>
                            <tr><td>执行金额</td><td>${d.execution_amount}</td></tr>
                        </table>
                        <div class="strategy-suggestion mb-3">
                            <i class="bi bi-lightbulb me-2 text-muted"></i><strong>综合建议：</strong>${d.final_suggestion}
                        </div>
                    `;
                }
            } catch (error) { 
                console.error('策略分析失败:', error); 
                alert('分析失败: ' + error.message); 
            }
        }

        async function runBacktest() {
            // Check if we're in comparison mode
            const comparisonMode = document.getElementById('comparison-mode-toggle').checked;
            
            if (comparisonMode) {
                // Run strategy comparison
                await runStrategyComparison();
                return;
            }
            
            // ==================== WIRING: Get data from components ====================
            // Wire fund selector to get selected funds
            const selectedFunds = fundSelector.getSelectedFunds();
            
            // Wire strategy selector to get selected strategy
            const selectedStrategy = strategySelector.getSelectedStrategy();
            
            // Get backtest parameters from form
            const initialAmount = parseFloat(document.getElementById('initial-amount').value);
            const baseInvest = parseFloat(document.getElementById('base-invest').value);
            const backtestPeriod = parseInt(document.getElementById('backtest-period').value);
            
            // ==================== VALIDATION ====================
            // Validate fund selection
            if (selectedFunds.length === 0) { 
                showErrorMessage('请从持仓中选择至少一个基金', 'validation');
                return; 
            }
            
            // Validate strategy selection
            if (!selectedStrategy) {
                showErrorMessage('请选择一个策略', 'validation');
                return;
            }
            
            // Validate all parameters before proceeding
            if (!validateBacktestParameters(initialAmount, baseInvest, backtestPeriod)) {
                // Validation errors are already displayed inline
                return;
            }
            
            // ==================== EXECUTE BACKTEST ====================
            // Show loading state
            showLoadingState('正在执行回测，请稍候...');
            
            try {
                // 获取策略优化参数
                const strategyParams = getStrategyParams();
                
                // Wire backtest button to API endpoint with selected parameters
                const response = await fetch('/api/strategy/backtest-holdings', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ 
                        fund_codes: selectedFunds,
                        strategy_id: selectedStrategy,
                        initial_amount: initialAmount,
                        base_invest: baseInvest,
                        period: backtestPeriod,
                        strategy_params: strategyParams  // 传递优化参数
                    })
                });
                const result = await response.json();
                
                // ==================== DISPLAY RESULTS ====================                
                if (result.success && result.data) {
                    // Show success message
                    showSuccessMessage('回测完成！');
                    
                    // Check if this is a multi-fund backtest
                    if (result.data.portfolio) {
                        // Multi-fund backtest: display portfolio results
                        if (result.data.funds && result.data.funds.length > 0) {
                            displayMultiFundResults(result.data);
                        } else {
                            showErrorMessage('回测结果中缺少基金数据', 'backtest');
                        }
                    } else {
                        // Single-fund backtest: wire API response to results visualizer
                        resultsVisualizer.displayResults(result.data);
                    }
                } else { 
                    // Determine error type and show appropriate message
                    const errorMsg = result.error || '回测失败，请检查基金代码是否正确';
                    if (errorMsg.includes('数据') || errorMsg.includes('data')) {
                        showErrorMessage(errorMsg, 'missing_data');
                    } else if (errorMsg.includes('参数') || errorMsg.includes('parameter')) {
                        showErrorMessage(errorMsg, 'validation');
                    } else {
                        showErrorMessage(errorMsg, 'backtest');
                    }
                }
            } catch (error) { 
                console.error('回测失败:', error); 
                // Determine error type based on error message
                if (error.message.includes('Failed to fetch') || error.message.includes('NetworkError')) {
                    showErrorMessage('网络连接失败，请检查网络后重试', 'network');
                } else {
                    showErrorMessage(`回测请求失败: ${error.message}`, 'server');
                }
            } finally {
                clearLoadingState();
            }
        }
        
        // 基金名称缓存
        const fundNameCache = {};
        
        // 根据基金代码获取基金名称
        async function getFundNameByCode(fundCode) {
            // 先检查缓存
            if (fundNameCache[fundCode]) {
                return fundNameCache[fundCode];
            }
            
            try {
                // 调用API获取基金详情
                const response = await fetch(`/api/fund/${fundCode}`);
                if (response.ok) {
                    const data = await response.json();
                    if (data.success && data.data) {
                        const fundName = data.data.fund_name || `基金${fundCode}`;
                        // 存入缓存
                        fundNameCache[fundCode] = fundName;
                        return fundName;
                    }
                }
            } catch (error) {
                console.error(`获取基金名称失败: ${fundCode}`, error);
            }
            
            return `基金${fundCode}`;
        }
        
        // 异步更新基金名称
        async function updateFundNames() {
            const fundCodeCells = document.querySelectorAll('.comparison-table tbody td:first-child');
            const fundNameCells = document.querySelectorAll('.comparison-table tbody td:nth-child(2)');
            
            for (let i = 0; i < fundCodeCells.length; i++) {
                const codeCell = fundCodeCells[i];
                const nameCell = fundNameCells[i];
                
                if (codeCell && nameCell) {
                    const strongElement = codeCell.querySelector('strong');
                    if (strongElement) {
                        const fundCode = strongElement.textContent.trim();
                        if (fundCode) {
                            const fundName = await getFundNameByCode(fundCode);
                            nameCell.textContent = fundName;
                        }
                    }
                }
            }
        }
        
        /**
         * 获取策略优化参数
         * @returns {Object} 策略参数对象
         */
        function getStrategyParams() {
            return {
                adx: {
                    strong_threshold: parseInt(document.getElementById('adx-strong-threshold')?.value || 40),
                    moderate_threshold: parseInt(document.getElementById('adx-moderate-threshold')?.value || 25)
                },
                market_beta: {
                    bear_multiplier: parseFloat(document.getElementById('bear-market-multiplier')?.value || 0.7),
                    bull_hold: document.getElementById('bull-market-hold')?.checked ?? true
                },
                mean_reversion: {
                    window: parseInt(document.getElementById('mean-reversion-window')?.value || 250),
                    threshold: parseFloat(document.getElementById('mean-reversion-threshold')?.value || 0.05)
                },
                trend_filter: {
                    enabled: document.getElementById('trend-filter-enabled')?.checked ?? true
                }
            };
        }
        
        /**
         * 重置策略参数为默认值
         */
        function resetStrategyParams() {
            document.getElementById('adx-strong-threshold').value = 40;
            document.getElementById('adx-moderate-threshold').value = 25;
            document.getElementById('bear-market-multiplier').value = 0.7;
            document.getElementById('bull-market-hold').checked = true;
            document.getElementById('mean-reversion-window').value = 250;
            document.getElementById('mean-reversion-threshold').value = 0.05;
            document.getElementById('trend-filter-enabled').checked = true;
            
            // 显示提示
            showSuccessMessage('策略参数已恢复默认值');
        }
        
        /**
         * 显示策略优化详情
         */
        function showOptimizationDetails() {
            const detailsHtml = `
                <div class="modal fade" id="optimizationModal" tabindex="-1" aria-hidden="true">
                    <div class="modal-dialog modal-lg">
                        <div class="modal-content">
                            <div class="modal-header bg-primary text-white">
                                <h5 class="modal-title"><i class="bi bi-magic me-2"></i>策略优化详情</h5>
                                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
                            </div>
                            <div class="modal-body">
                                <div class="alert alert-info">
                                    <strong><i class="bi bi-info-circle me-2"></i>优化目标</strong><br>
                                    通过修复策略逻辑缺陷、添加趋势过滤和市场环境适配，降低最大回撤和波动率，减少频繁交易，提升整体投资体验。
                                </div>
                                
                                <h6 class="mt-4 mb-3"><i class="bi bi-check-circle-fill text-success me-2"></i>已完成的优化</h6>
                                
                                <div class="accordion" id="optimizationAccordion">
                                    <div class="accordion-item">
                                        <h2 class="accordion-header">
                                            <button class="accordion-button" type="button" data-bs-toggle="collapse" data-bs-target="#opt1">
                                                <span class="badge bg-primary me-2">1</span> 均值回归策略修复
                                            </button>
                                        </h2>
                                        <div id="opt1" class="accordion-collapse collapse show" data-bs-parent="#optimizationAccordion">
                                            <div class="accordion-body">
                                                <ul class="mb-0">
                                                    <li><strong>高估卖出逻辑修正</strong>: deviation > threshold * 2 时，从卖出0.5倍改为卖出1.0倍（清仓）</li>
                                                    <li><strong>高估买入错误修正</strong>: deviation > threshold 时，从买入0.5倍改为卖出0.5倍（部分止盈）</li>
                                                    <li><strong>趋势过滤器</strong>: 强上涨趋势中暂停止盈，强下跌趋势中暂停抄底</li>
                                                </ul>
                                            </div>
                                        </div>
                                    </div>
                                    <div class="accordion-item">
                                        <h2 class="accordion-header">
                                            <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#opt2">
                                                <span class="badge bg-warning text-dark me-2">2</span> 持续下跌判定优化
                                            </button>
                                        </h2>
                                        <div id="opt2" class="accordion-collapse collapse" data-bs-parent="#optimizationAccordion">
                                            <div class="accordion-body">
                                                <ul class="mb-0">
                                                    <li><strong>原条件</strong>: 连续2日下跌各超过0.5%</li>
                                                    <li><strong>新条件</strong>: 连续2日各下跌超过1.0%，或单日大跌超过2.0%</li>
                                                    <li><strong>累计跌幅检查</strong>: 累计跌幅>2%且今日跌幅>0.5%时优先匹配"持续下跌"规则</li>
                                                </ul>
                                            </div>
                                        </div>
                                    </div>
                                    <div class="accordion-item">
                                        <h2 class="accordion-header">
                                            <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#opt3">
                                                <span class="badge bg-info me-2">3</span> ADX趋势强度确认
                                            </button>
                                        </h2>
                                        <div id="opt3" class="accordion-collapse collapse" data-bs-parent="#optimizationAccordion">
                                            <div class="accordion-body">
                                                <p class="mb-2">ADX（Average Directional Index）趋势强度分级:</p>
                                                <ul class="mb-0">
                                                    <li><span class="badge bg-danger">强趋势</span> ADX > 40</li>
                                                    <li><span class="badge bg-warning">中等趋势</span> ADX > 25</li>
                                                    <li><span class="badge bg-info">弱趋势</span> ADX > 15</li>
                                                    <li><span class="badge bg-secondary">无趋势</span> ADX < 15</li>
                                                </ul>
                                                <p class="mt-2 mb-0 small text-muted">ADX < 20 时降低趋势置信度，ADX < 15 时强制归为横盘</p>
                                            </div>
                                        </div>
                                    </div>
                                    <div class="accordion-item">
                                        <h2 class="accordion-header">
                                            <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#opt4">
                                                <span class="badge bg-secondary me-2">4</span> 市场Beta调整和成交量确认
                                            </button>
                                        </h2>
                                        <div id="opt4" class="accordion-collapse collapse" data-bs-parent="#optimizationAccordion">
                                            <div class="accordion-body">
                                                <p class="mb-2"><strong>市场Beta调整:</strong></p>
                                                <ul class="mb-3">
                                                    <li>熊市中（大盘跌2%以上）：买入倍数降低至70%</li>
                                                    <li>牛市中（大盘涨2%以上）：暂停止盈，让利润奔跑</li>
                                                    <li>极端情绪调整：极度恐惧时买入倍数增加30%，极度贪婪时降低40%</li>
                                                </ul>
                                                <p class="mb-2"><strong>成交量确认:</strong></p>
                                                <ul class="mb-0">
                                                    <li>放量下跌（跌>1%且成交量比>1.5）：降低买入50%</li>
                                                    <li>缩量下跌（跌>0.5%且成交量比<0.8）：增加买入10%</li>
                                                    <li>放量上涨（涨>1%且成交量比>1.3）：趋势确认</li>
                                                </ul>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                                
                                <h6 class="mt-4 mb-3"><i class="bi bi-graph-up text-primary me-2"></i>回测验证结果</h6>
                                <div class="table-responsive">
                                    <table class="table table-sm table-bordered">
                                        <thead class="table-light">
                                            <tr>
                                                <th>指标</th>
                                                <th>原始策略</th>
                                                <th>优化策略</th>
                                                <th>改善幅度</th>
                                            </tr>
                                        </thead>
                                        <tbody>
                                            <tr>
                                                <td>最大回撤</td>
                                                <td>17.23%</td>
                                                <td class="text-success fw-bold">15.44%</td>
                                                <td><span class="badge bg-success">+10.4%</span></td>
                                            </tr>
                                            <tr>
                                                <td>波动率</td>
                                                <td>17.97%</td>
                                                <td class="text-success fw-bold">15.96%</td>
                                                <td><span class="badge bg-success">+11.2%</span></td>
                                            </tr>
                                            <tr>
                                                <td>卖出次数</td>
                                                <td>101</td>
                                                <td class="text-success fw-bold">56</td>
                                                <td><span class="badge bg-success">-44.6%</span></td>
                                            </tr>
                                        </tbody>
                                    </table>
                                </div>
                            </div>
                            <div class="modal-footer">
                                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">关闭</button>
                                <a href="/static/docs/OPTIMIZATION_SUMMARY.md" class="btn btn-primary" target="_blank">
                                    <i class="bi bi-file-earmark-text me-2"></i>查看完整文档
                                </a>
                            </div>
                        </div>
                    </div>
                </div>
            `;
            
            // 移除已存在的模态框
            const existingModal = document.getElementById('optimizationModal');
            if (existingModal) {
                existingModal.remove();
            }
            
            // 添加新的模态框到页面
            document.body.insertAdjacentHTML('beforeend', detailsHtml);
            
            // 显示模态框
            const modal = new bootstrap.Modal(document.getElementById('optimizationModal'));
            modal.show();
        }
        
        /**
         * Display multi-fund backtest results
         * @param {Object} data - Multi-fund backtest result data
         */
        function displayMultiFundResults(data) {
            const portfolio = data.portfolio;
            const funds = data.funds || [];
            const bestFund = data.best_fund;
            const worstFund = data.worst_fund;
            
            // 防御性检查
            if (!funds || funds.length === 0) {
                showErrorMessage('回测结果中没有基金数据', 'backtest');
                return;
            }
            
            // 辅助函数：格式化基金对象为可读字符串
            function formatFundObject(fund) {
                if (!fund || typeof fund !== 'object') {
                    return fund;
                }
                
                // 提取关键属性
                const fundCode = fund.fund_code || fund.code || '';
                const fundName = fund.name || fund.fund_name || '';
                const totalReturn = fund.total_return !== undefined ? fund.total_return : '';
                const returnSign = totalReturn >= 0 ? '+' : '';
                const returnClass = totalReturn >= 0 ? 'metric-positive' : 'metric-negative';
                
                // 构建基本信息
                let basicInfo = `<strong>${fundCode}</strong>`;
                if (fundName) {
                    basicInfo += ` <small class="text-muted">${fundName}</small>`;
                }
                if (totalReturn !== '') {
                    basicInfo += ` <span class="${returnClass}">: ${returnSign}${totalReturn.toFixed(2)}%</span>`;
                }
                
                // 创建可展开的详情
                const details = JSON.stringify(fund, null, 2);
                
                return `
                    <div class="fund-object">
                        <span class="fund-basic">${basicInfo}</span>
                        <button class="fund-details-btn btn btn-sm btn-outline-secondary ms-2" onclick="toggleFundDetails(this)">
                            详情
                        </button>
                        <div class="fund-details mt-2 p-2 bg-light rounded d-none">
                            <pre class="mb-0">${details}</pre>
                        </div>
                    </div>
                `;
            }
            
            // Build portfolio summary
            const portfolioReturnClass = portfolio.total_return >= 0 ? 'positive' : 'negative';
            const portfolioReturnSign = portfolio.total_return >= 0 ? '+' : '';
            
            let html = `
                <div class="alert alert-success mb-3">
                    <i class="bi bi-check-circle me-2"></i>
                    <strong>多基金回测完成</strong> - 共${funds.length}只基金, 回测周期: ${data.period}年
                </div>
                
                <h6 class="mb-3"><i class="bi bi-pie-chart me-2"></i>组合表现</h6>
                <div class="row text-center mb-4">
                    <div class="col-md-3">
                        <div class="metric-card">
                            <div class="metric-value">¥${portfolio.initial_amount.toLocaleString()}</div>
                            <div class="metric-label">初始金额</div>
                        </div>
                    </div>
                    <div class="col-md-3">
                        <div class="metric-card">
                            <div class="metric-value">¥${(portfolio.final_value || portfolio.total_value || 0).toLocaleString()}</div>
                            <div class="metric-label">最终价值</div>
                        </div>
                    </div>
                    <div class="col-md-3">
                        <div class="metric-card">
                            <div class="metric-value ${portfolioReturnClass}">${portfolioReturnSign}${portfolio.total_return.toFixed(2)}%</div>
                            <div class="metric-label">总收益率</div>
                        </div>
                    </div>
                    <div class="col-md-3">
                        <div class="metric-card">
                            <div class="metric-value">${portfolio.trades_count || 0}</div>
                            <div class="metric-label">总交易次数</div>
                        </div>
                    </div>
                </div>
                
                <h6 class="mb-3"><i class="bi bi-list-check me-2"></i>各基金表现</h6>
                <div class="table-responsive mb-3">
                    <table class="comparison-table table table-bordered">
                        <thead>
                            <tr>
                                <th>基金代码</th>
                                <th>基金名称</th>
                                <th>初始金额</th>
                                <th>最终价值</th>
                                <th>总收益率</th>
                                <th>年化收益</th>
                                <th>最大回撤</th>
                                <th>夏普比率</th>
                                <th>交易次数</th>
                            </tr>
                        </thead>
                        <tbody>
                            ${funds.map(fund => {
                                // 修复：使用基金代码进行比较
                                const bestFundCode = typeof bestFund === 'object' ? bestFund.fund_code || bestFund.code : bestFund;
                                const worstFundCode = typeof worstFund === 'object' ? worstFund.fund_code || worstFund.code : worstFund;
                                const isBest = fund.fund_code === bestFundCode;
                                const isWorst = fund.fund_code === worstFundCode;
                                const returnClass = fund.total_return >= 0 ? 'metric-positive' : 'metric-negative';
                                const returnSign = fund.total_return >= 0 ? '+' : '';
                                const rowClass = isBest ? 'best-strategy' : '';
                                
                                // 获取基金名称
                                const fundName = fund.name || fund.fund_name || '';
                                
                                return `
                                    <tr class="${rowClass}">
                                        <td>
                                            <strong>${fund.fund_code}</strong>
                                            ${isBest ? '<span class="best-badge">最佳</span>' : ''}
                                            ${isWorst ? '<span class="badge bg-secondary">最差</span>' : ''}
                                        </td>
                                        <td>${fundName || '-'}</td>
                                        <td>¥${fund.initial_amount.toLocaleString()}</td>
                                        <td>¥${(fund.final_value || fund.total_value || 0).toLocaleString()}</td>
                                        <td class="${returnClass}">${returnSign}${fund.total_return.toFixed(2)}%</td>
                                        <td>${returnSign}${fund.annualized_return.toFixed(2)}%</td>
                                        <td class="metric-negative">${fund.max_drawdown.toFixed(2)}%</td>
                                        <td>${fund.sharpe_ratio.toFixed(2)}</td>
                                        <td>${fund.trades_count || 0}</td>
                                    </tr>
                                `;
                            }).join('')}
                        </tbody>
                    </table>
                </div>
                

                
                <div class="mt-4 text-center">
                    <button id="portfolio-analyze-btn" class="btn btn-primary btn-lg">
                        <i class="bi bi-graph-up-arrow me-2"></i>查看投资组合深度分析
                    </button>
                </div>
            `;
            
            // Display in results area
            document.getElementById('backtest-result').style.display = 'block';
            document.getElementById('backtest-result-content').innerHTML = html;
            
            // 重新绑定投资组合分析按钮事件（因为按钮是动态生成的）
            setTimeout(() => {
                if (typeof PortfolioAnalysis !== 'undefined' && PortfolioAnalysis.bindEvents) {
                    PortfolioAnalysis.bindEvents();

                } else {
                    console.warn('⚠️ PortfolioAnalysis 对象不可用，无法重新绑定事件');
                }
            }, 100);
            
            // Add animation class
            const resultsDiv = document.getElementById('backtest-result');
            resultsDiv.classList.add('results-animate');
            
            // Remove animation class after animation completes
            setTimeout(() => {
                resultsDiv.classList.remove('results-animate');
            }, 500);
            
            // Scroll to results section with smooth animation
            const resultsSection = document.getElementById('results-section');
            if (resultsSection) {
                resultsSection.scrollIntoView({ behavior: 'smooth', block: 'start' });
            } else {
                // Fallback to scrolling to results div if section not found
                resultsDiv.scrollIntoView({ behavior: 'smooth', block: 'start' });
            }
        }
    </script>
    
</body>
</html>
