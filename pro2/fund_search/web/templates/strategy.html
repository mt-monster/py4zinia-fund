<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>策略分析 - 基金分析系统</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.0/font/bootstrap-icons.css" rel="stylesheet">
    <style>
        :root { 
            --primary-color: #4361ee; 
            --primary-dark: #3a56d4;
            --primary-light: #edf2ff;
            --secondary-color: #6c757d;
            --success-color: #06d6a0; 
            --success-dark: #05b38a;
            --success-light: #e8fcf3;
            --danger-color: #ef476f; 
            --danger-dark: #d4355d;
            --danger-light: #fceced;
            --warning-color: #ffd166;
            --warning-dark: #e6bc5c;
            --warning-light: #fff9e6;
            --info-color: #118ab2;
            --info-dark: #0f7aa0;
            --info-light: #e6f7ff;
            --light-bg: #f8f9fa;
            --dark-bg: #343a40;
            --border-color: #e0e0e0;
            --text-primary: #212529;
            --text-secondary: #6c757d;
            --card-shadow: 0 6px 20px rgba(0, 0, 0, 0.08);
            --card-shadow-hover: 0 12px 30px rgba(67, 97, 238, 0.15);
            --transition: all 0.3s cubic-bezier(0.25, 0.8, 0.25, 1);
            --border-radius: 12px;
            --spacing-xs: 0.25rem;
            --spacing-sm: 0.5rem;
            --spacing-md: 1rem;
            --spacing-lg: 1.5rem;
            --spacing-xl: 2rem;
        }
        
        body { 
            background-color: #f5f7ff; 
            font-family: 'Inter', 'Segoe UI', system-ui, -apple-system, sans-serif; 
            color: var(--text-primary);
            line-height: 1.6;
        }
        
        /* Improved Navbar */
        .navbar { 
            background: linear-gradient(135deg, #4361ee 0%, #3a0ca3 100%); 
            box-shadow: 0 4px 12px rgba(67, 97, 238, 0.15);
            padding: 1rem 0;
        }
        
        .navbar-brand {
            font-weight: 700;
            letter-spacing: 0.5px;
        }
        
        .nav-link {
            font-weight: 500;
            transition: var(--transition);
            border-radius: 8px;
            padding: 0.5rem 1rem !important;
        }
        
        .nav-link:hover {
            background: rgba(255, 255, 255, 0.15);
        }
        
        .nav-link.active {
            background: rgba(255, 255, 255, 0.25);
        }
        
        /* Enhanced Card Styling */
        .card { 
            border: none; 
            border-radius: var(--border-radius); 
            box-shadow: var(--card-shadow); 
            margin-bottom: var(--spacing-xl);
            transition: var(--transition);
            overflow: hidden;
            background: white;
        }
        
        .card:hover {
            box-shadow: var(--card-shadow-hover);
            transform: translateY(-5px);
        }
        
        .card-header { 
            background: transparent; 
            border-bottom: 1px solid var(--border-color); 
            font-weight: 700;
            font-size: 1.1rem;
            padding: 1.25rem 1.5rem;
        }
        
        /* Enhanced section headers */
        .section-header {
            margin-bottom: var(--spacing-xl);
            padding: var(--spacing-lg) var(--spacing-xl);
            background: white;
            border-radius: var(--border-radius);
            border-left: 4px solid var(--primary-color);
            box-shadow: var(--card-shadow);
            position: relative;
            overflow: hidden;
        }
        
        .section-header::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 2px;
            background: linear-gradient(90deg, var(--primary-color), var(--success-color));
        }
        
        .section-title {
            font-size: 1.4rem;
            font-weight: 700;
            color: var(--text-primary);
            margin-bottom: var(--spacing-xs);
            position: relative;
            z-index: 1;
        }
        
        .section-description {
            font-size: 0.95rem;
            color: var(--text-secondary);
            margin-bottom: 0;
            position: relative;
            z-index: 1;
        }
        
        /* Enhanced typography */
        h1, h2, h3, h4, h5, h6 {
            font-weight: 700;
            line-height: 1.3;
            color: var(--text-primary);
        }
        
        .metric-value { 
            font-size: 1.7rem; 
            font-weight: 800; 
            line-height: 1.2;
        }
        
        .metric-label { 
            font-size: 0.9rem; 
            color: var(--text-secondary); 
            font-weight: 500;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }
        
        /* Enhanced metric cards */
        .metric-card { 
            text-align: center; 
            padding: var(--spacing-lg); 
            border-radius: var(--border-radius); 
            background: white;
            border: 1px solid var(--border-color);
            transition: var(--transition);
            height: 100%;
        }
        
        .metric-card:hover {
            transform: translateY(-3px);
            box-shadow: 0 8px 20px rgba(0, 0, 0, 0.08);
            border-color: var(--primary-color);
        }
        
        /* Enhanced strategy cards */
        .strategy-card { 
            border-left: 4px solid var(--primary-color); 
            transition: var(--transition); 
            background: white;
            border: 1px solid var(--border-color);
        }
        
        .strategy-card:hover { 
            transform: translateX(5px); 
            box-shadow: var(--card-shadow-hover);
            border-left-color: var(--primary-dark);
        }
        
        .strategy-card.buy { 
            border-left-color: var(--success-color); 
        }
        
        .strategy-card.sell { 
            border-left-color: var(--danger-color); 
        }
        
        /* Enhanced result box */
        .result-box { 
            background: white; 
            border-radius: var(--border-radius); 
            padding: var(--spacing-xl); 
            margin-top: var(--spacing-lg);
            border: 1px solid var(--border-color);
            box-shadow: var(--card-shadow);
        }
        
        /* Enhanced positive/negative indicators */
        .positive { 
            color: var(--success-color); 
            font-weight: 700;
        }
        
        .negative { 
            color: var(--danger-color); 
            font-weight: 700;
        }
        
        /* Enhanced button styling */
        .btn-analyze { 
            border-radius: 30px; 
            padding: 12px 35px; 
            font-weight: 600;
            letter-spacing: 0.5px;
            box-shadow: 0 4px 15px rgba(67, 97, 238, 0.2);
            transition: var(--transition);
        }
        
        .btn-analyze:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(67, 97, 238, 0.3);
        }
        
        .btn-success {
            background: linear-gradient(135deg, var(--success-color), var(--success-dark));
            border: none;
        }
        
        .btn-primary {
            background: linear-gradient(135deg, var(--primary-color), var(--primary-dark));
            border: none;
        }
        
        .btn-danger {
            background: linear-gradient(135deg, var(--danger-color), var(--danger-dark));
            border: none;
        }
        
        /* Enhanced evaluation grid */
        .evaluation-grid { 
            display: grid; 
            grid-template-columns: repeat(auto-fit, minmax(160px, 1fr)); 
            gap: var(--spacing-md); 
            margin-top: var(--spacing-md);
        }
        
        .eval-item { 
            background: white; 
            padding: var(--spacing-md); 
            border-radius: var(--border-radius); 
            text-align: center; 
            border: 1px solid var(--border-color);
            transition: var(--transition);
        }
        
        .eval-item:hover {
            transform: translateY(-3px);
            box-shadow: 0 6px 15px rgba(0, 0, 0, 0.1);
        }
        
        .eval-value { 
            font-size: 1.3rem; 
            font-weight: 800; 
            color: var(--primary-color); 
            margin-bottom: var(--spacing-xs);
        }
        
        .eval-label { 
            font-size: 0.85rem; 
            color: var(--text-secondary); 
            font-weight: 500;
        }
        
        /* Enhanced form controls */
        .form-control, .form-select {
            border: 1px solid var(--border-color);
            border-radius: 8px;
            padding: 0.75rem 1rem;
            transition: var(--transition);
        }
        
        .form-control:focus, .form-select:focus {
            border-color: var(--primary-color);
            box-shadow: 0 0 0 0.2rem rgba(67, 97, 238, 0.25);
        }
        
        /* Enhanced Fund Selector Styles */
        .holdings-item { 
            padding: var(--spacing-md); 
            border-bottom: 1px solid var(--border-color); 
            display: flex; 
            align-items: center; 
            cursor: pointer;
            transition: var(--transition);
            border-radius: 8px;
            margin-bottom: var(--spacing-xs);
        }
        
        .holdings-item:hover { 
            background: var(--primary-light); 
            transform: translateX(3px);
        }
        
        .holdings-item:last-child { 
            border-bottom: none; 
        }
        
        .holdings-checkbox { 
            margin-right: var(--spacing-md); 
            cursor: pointer; 
            width: 18px;
            height: 18px;
        }
        
        .holdings-info { 
            flex: 1; 
        }
        
        .holdings-code { 
            font-weight: 700; 
            color: var(--primary-color); 
            font-size: 0.95rem; 
        }
        
        .holdings-name { 
            font-size: 0.9rem; 
            color: var(--text-secondary); 
            margin-top: var(--spacing-xs); 
        }
        
        .holdings-amount { 
            font-weight: 700; 
            color: var(--text-primary); 
            font-size: 0.95rem; 
        }
        
        .empty-holdings { 
            text-align: center; 
            padding: var(--spacing-xl) var(--spacing-md); 
            color: var(--text-secondary); 
        }
        
        .empty-holdings i { 
            font-size: 2.5rem; 
            margin-bottom: var(--spacing-md); 
            display: block; 
            color: var(--secondary-color);
        }
        
        /* Enhanced Strategy Selector Styles */
        .strategy-selector-card {
            border: 1px solid var(--border-color);
            border-radius: var(--border-radius);
            padding: var(--spacing-lg);
            margin-bottom: var(--spacing-md);
            cursor: pointer;
            transition: var(--transition);
            background: white;
            position: relative;
            overflow: hidden;
        }
        
        .strategy-selector-card::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 3px;
            background: var(--primary-color);
            transform: scaleX(0);
            transform-origin: left;
            transition: var(--transition);
        }
        
        .strategy-selector-card:hover {
            border-color: var(--primary-color);
            box-shadow: var(--card-shadow-hover);
            transform: translateY(-3px);
        }
        
        .strategy-selector-card:hover::before {
            transform: scaleX(1);
        }
        
        .strategy-selector-card.selected {
            border-color: var(--primary-color);
            background: var(--primary-light);
            box-shadow: 0 6px 20px rgba(67, 97, 238, 0.15);
        }
        
        .strategy-selector-card.selected .strategy-name {
            color: var(--primary-color);
            font-weight: 800;
        }
        
        .strategy-name {
            font-size: 1.15rem;
            font-weight: 700;
            margin-bottom: var(--spacing-sm);
            color: var(--text-primary);
        }
        
        .strategy-description {
            font-size: 0.9rem;
            color: var(--text-secondary);
            margin-bottom: var(--spacing-md);
            line-height: 1.5;
        }
        
        .strategy-metrics {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: var(--spacing-sm);
        }
        
        .strategy-metric {
            display: flex;
            justify-content: space-between;
            font-size: 0.85rem;
            padding: var(--spacing-xs) 0;
        }
        
        .strategy-metric-label {
            color: var(--text-secondary);
        }
        
        .strategy-metric-value {
            font-weight: 600;
            color: var(--text-primary);
        }
        
        .strategy-metric-value.positive {
            color: var(--success-color);
        }
        
        .strategy-metric-value.negative {
            color: var(--danger-color);
        }
        
        .strategy-selector-empty {
            text-align: center;
            padding: var(--spacing-xl) var(--spacing-md);
            color: var(--text-secondary);
        }
        
        .strategy-selector-empty i {
            font-size: 2.5rem;
            margin-bottom: var(--spacing-md);
            display: block;
            color: var(--secondary-color);
        }
        
        /* Enhanced Strategy Comparison Styles */
        .comparison-table {
            width: 100%;
            margin-top: var(--spacing-lg);
            border-radius: var(--border-radius);
            overflow: hidden;
            border: 1px solid var(--border-color);
        }
        
        .comparison-table th {
            background: linear-gradient(to bottom, var(--primary-light), #ffffff);
            font-weight: 700;
            padding: var(--spacing-md);
            border: none;
            position: sticky;
            top: 0;
            z-index: 10;
        }
        
        .comparison-table td {
            padding: var(--spacing-sm) var(--spacing-md);
            border-bottom: 1px solid var(--border-color);
            vertical-align: middle;
        }
        
        .comparison-table tr:last-child td {
            border-bottom: none;
        }
        
        .comparison-table .best-strategy {
            background: linear-gradient(135deg, var(--success-light) 0%, #d4edda 100%);
            font-weight: 700;
        }
        
        .comparison-table .metric-positive {
            color: var(--success-color);
            font-weight: 700;
        }
        
        .comparison-table .metric-negative {
            color: var(--danger-color);
            font-weight: 700;
        }
        
        .best-badge {
            background: var(--success-color);
            color: white;
            padding: 3px 10px;
            border-radius: 20px;
            font-size: 0.75rem;
            margin-left: var(--spacing-sm);
            font-weight: 600;
        }
        
        .strategy-selector-card.comparison-mode {
            border-color: var(--info-color);
        }
        
        .strategy-selector-card.comparison-mode.selected {
            border-color: var(--info-color);
            background: var(--info-light);
        }
        
        /* Enhanced Loading and Message Styles */
        .alert {
            border-radius: var(--border-radius);
            animation: fadeIn 0.3s ease-in;
            border: none;
            font-weight: 500;
        }
        
        .alert-success {
            background: var(--success-light);
            border-left: 4px solid var(--success-color);
            color: var(--success-dark);
        }
        
        .alert-info {
            background: var(--primary-light);
            border-left: 4px solid var(--primary-color);
            color: var(--primary-dark);
        }
        
        .alert-warning {
            background: var(--warning-light);
            border-left: 4px solid var(--warning-color);
            color: var(--warning-dark);
        }
        
        .alert-danger {
            background: var(--danger-light);
            border-left: 4px solid var(--danger-color);
            color: var(--danger-dark);
        }
        
        @keyframes fadeIn {
            from {
                opacity: 0;
                transform: translateY(-10px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }
        
        .spinner-border-sm {
            width: 1rem;
            height: 1rem;
            border-width: 0.15em;
        }
        
        .btn:disabled {
            cursor: not-allowed;
            opacity: 0.65;
        }
        
        /* Enhanced Page Section Styles */
        .page-section {
            margin-bottom: calc(var(--spacing-xl) * 1.5);
            padding-bottom: var(--spacing-xl);
            border-bottom: 1px solid var(--border-color);
            position: relative;
        }
        
        .page-section:last-child {
            border-bottom: none;
        }
        
        /* Enhanced Responsive adjustments */
        @media (max-width: 768px) {
            .page-section {
                margin-bottom: var(--spacing-xl);
                padding-bottom: var(--spacing-lg);
            }
            
            .section-header {
                padding: var(--spacing-md);
                margin-bottom: var(--spacing-lg);
            }
            
            .section-title {
                font-size: 1.2rem;
            }
            
            .section-description {
                font-size: 0.9rem;
            }
            
            .card {
                margin-bottom: var(--spacing-lg);
            }
            
            .strategy-metrics {
                grid-template-columns: 1fr;
            }
            
            .evaluation-grid {
                grid-template-columns: repeat(2, 1fr);
            }
            
            .metric-value {
                font-size: 1.4rem;
            }
        }
        
        @media (max-width: 576px) {
            .section-title {
                font-size: 1.1rem;
            }
            
            .metric-card {
                padding: var(--spacing-md);
            }
            
            .metric-value {
                font-size: 1.3rem;
            }
            
            .evaluation-grid {
                grid-template-columns: 1fr;
            }
            
            .strategy-selector-card {
                padding: var(--spacing-md);
            }
        }
        
        /* Enhanced Smooth scroll animation */
        html {
            scroll-behavior: smooth;
        }
        
        /* Enhanced Scroll animation for results */
        @keyframes slideInUp {
            from {
                opacity: 0;
                transform: translateY(30px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }
        
        .results-animate {
            animation: slideInUp 0.5s ease-out;
        }
        
        /* Enhanced button and form styling */
        .form-check-input:checked {
            background-color: var(--primary-color);
            border-color: var(--primary-color);
        }
        
        .form-switch .form-check-input:checked {
            background-position: right center;
            background-color: var(--success-color);
            border-color: var(--success-color);
        }
        
        /* Table enhancements */
        .table {
            margin-bottom: 0;
        }
        
        .table th {
            border-top: none;
            border-bottom-width: 2px;
            font-weight: 700;
            text-transform: uppercase;
            font-size: 0.8rem;
            letter-spacing: 0.5px;
            color: var(--text-secondary);
        }
        
        .table td {
            vertical-align: middle;
        }
        
        .table-hover tbody tr:hover {
            background-color: rgba(67, 97, 238, 0.05);
        }
        
        .table-striped tbody tr:nth-of-type(odd) {
            background-color: rgba(0, 0, 0, 0.02);
        }
    </style>
</head>
<body>
    <nav class="navbar navbar-expand-lg navbar-dark mb-4">
        <div class="container">
            <a class="navbar-brand" href="/"><i class="bi bi-graph-up-arrow me-2"></i>基金分析系统</a>
            <div class="navbar-nav ms-auto">
                <a class="nav-link" href="/"><i class="bi bi-house me-1"></i>首页</a>
                <a class="nav-link" href="/etf"><i class="bi bi-bar-chart me-1"></i>ETF市场</a>
                <a class="nav-link active" href="/strategy"><i class="bi bi-lightbulb me-1"></i>策略分析</a>
                <a class="nav-link" href="/strategy-editor"><i class="bi bi-pencil-square me-1"></i>编写策略</a>
            </div>
        </div>
    </nav>

    <div class="container">
        <!-- Section 1: Fund Selection -->
        <section id="fund-selection-section" class="page-section">
            <div class="section-header">
                <h5 class="section-title">
                    <i class="bi bi-wallet2 me-2"></i>第一步：选择基金
                </h5>
                <p class="section-description text-muted">从您的持仓中选择要进行回测的基金</p>
            </div>
            
            <div class="row">
                <div class="col-lg-6 col-md-12">
                    <!-- Fund Selector Component -->
                    <div class="card" id="fund-selector-card">
                        <div class="card-header d-flex justify-content-between align-items-center">
                            <h6 class="mb-0"><i class="bi bi-wallet2 me-2"></i>我的持仓</h6>
                            <div class="select-all-container">
                                <input type="checkbox" id="select-all-holdings" class="form-check-input">
                                <label for="select-all-holdings" class="form-check-label ms-1">全选</label>
                            </div>
                        </div>
                        <div class="card-body">
                            <div id="holdings-list">
                                <div class="text-center text-muted py-3">
                                    <div class="spinner-border spinner-border-sm me-2"></div>加载中...
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </section>

        <!-- Section 2: Strategy Selection -->
        <section id="strategy-selection-section" class="page-section">
            <div class="section-header">
                <h5 class="section-title">
                    <i class="bi bi-graph-up me-2"></i>第二步：选择策略
                </h5>
                <p class="section-description text-muted">选择一个或多个策略进行回测分析</p>
            </div>
            
            <div class="row">
                <div class="col-lg-8 col-md-12">
                    <!-- Strategy Selector Component -->
                    <div class="card" id="strategy-selector-card">
                        <div class="card-header">
                            <div class="d-flex justify-content-between align-items-center">
                                <h6 class="mb-0"><i class="bi bi-graph-up me-2"></i>选择策略</h6>
                                <div class="form-check form-switch">
                                    <input class="form-check-input" type="checkbox" id="comparison-mode-toggle" onchange="toggleComparisonMode()">
                                    <label class="form-check-label" for="comparison-mode-toggle">
                                        <small>对比模式</small>
                                    </label>
                                </div>
                            </div>
                        </div>
                        <div class="card-body">
                            <div id="comparison-mode-info" class="alert alert-info py-2 px-3 mb-3" style="display:none;">
                                <small><i class="bi bi-info-circle me-1"></i>对比模式：选择多个策略进行比较</small>
                            </div>
                            <div id="strategy-cards">
                                <div class="text-center text-muted py-3">
                                    <div class="spinner-border spinner-border-sm me-2"></div>加载中...
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                
                <div class="col-lg-4 col-md-12">
                    <!-- 策略配置 -->
                    <div class="card">
                        <div class="card-header"><h6 class="mb-0"><i class="bi bi-gear me-2"></i>策略配置</h6></div>
                        <div class="card-body" id="strategy-config">
                            <div class="text-center text-muted py-3">
                                <div class="spinner-border spinner-border-sm me-2"></div>加载中...
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </section>

        <!-- Section 3: Backtest Execution and Results -->
        <section id="results-section" class="page-section">
            <div class="section-header">
                <h5 class="section-title">
                    <i class="bi bi-play-circle me-2"></i>第三步：执行回测
                </h5>
                <p class="section-description text-muted">配置回测参数并查看结果</p>
            </div>
            
            <div class="row">
                <div class="col-12">
                    <!-- 统一策略分析 - 已隐藏，使用三步流程代替 -->
                    <div class="card" style="display:none;">
                        <div class="card-header">
                            <h6 class="mb-0"><i class="bi bi-calculator me-2"></i>统一策略分析</h6>
                        </div>
                        <div class="card-body">
                            <div class="row g-3">
                                <div class="col-lg-3 col-md-6">
                                    <label class="form-label">基金代码</label>
                                    <input type="text" class="form-control" id="analyze-fund-code" placeholder="如: 000001">
                                </div>
                                <div class="col-lg-3 col-md-6">
                                    <label class="form-label">今日收益率 (%)</label>
                                    <input type="number" class="form-control" id="today-return" step="0.01" value="0.5">
                                </div>
                                <div class="col-lg-3 col-md-6">
                                    <label class="form-label">昨日收益率 (%)</label>
                                    <input type="number" class="form-control" id="prev-day-return" step="0.01" value="-0.3">
                                </div>
                                <div class="col-lg-3 col-md-6">
                                    <label class="form-label">累计盈亏 (%)</label>
                                    <input type="number" class="form-control" id="cumulative-pnl" step="0.01" placeholder="可选">
                                </div>
                            </div>
                            <div class="mt-3">
                                <button class="btn btn-primary btn-analyze" onclick="analyzeUnifiedStrategy()">
                                    <i class="bi bi-play-fill me-1"></i>分析策略
                                </button>
                            </div>
                            
                            <!-- 分析结果 -->
                            <div class="result-box" id="analyze-result" style="display:none;">
                                <div id="analyze-result-content"></div>
                            </div>
                        </div>
                    </div>

                    <!-- 策略回测 -->
                    <div class="card">
                        <div class="card-header"><h6 class="mb-0"><i class="bi bi-clock-history me-2"></i>策略回测</h6></div>
                        <div class="card-body">
                            <div class="alert alert-info py-2 px-3 mb-3">
                                <small><i class="bi bi-info-circle me-1"></i>从上方选择基金和策略，配置回测参数后点击开始回测</small>
                            </div>
                            <div class="row g-3 mb-3">
                                <div class="col-lg-4 col-md-6">
                                    <label class="form-label">初始金额 (元)</label>
                                    <input type="number" class="form-control" id="initial-amount" value="10000" min="100">
                                    <div class="invalid-feedback" id="initial-amount-error"></div>
                                </div>
                                <div class="col-lg-4 col-md-6">
                                    <label class="form-label">基准定投 (元)</label>
                                    <input type="number" class="form-control" id="base-invest" value="100" min="10">
                                    <div class="invalid-feedback" id="base-invest-error"></div>
                                </div>
                                <div class="col-lg-4 col-md-6">
                                    <label class="form-label">回测天数</label>
                                    <select class="form-select" id="backtest-days">
                                        <option value="30">近30天</option>
                                        <option value="60">近60天</option>
                                        <option value="90" selected>近90天</option>
                                        <option value="180">近180天</option>
                                        <option value="365">近365天</option>
                                    </select>
                                    <div class="invalid-feedback" id="backtest-days-error"></div>
                                </div>
                            </div>
                            <button class="btn btn-success btn-analyze" onclick="runBacktest()" disabled>
                                <i class="bi bi-play-circle me-1"></i>开始回测
                            </button>
                            <div class="result-box" id="backtest-result" style="display:none;">
                                <div id="backtest-result-content"></div>
                            </div>
                        </div>
                    </div>

                    <!-- Results Visualizer Component -->
                    <div class="card" id="results-card" style="display:none;">
                        <div class="card-header">
                            <h6 class="mb-0"><i class="bi bi-bar-chart-line me-2"></i>回测结果</h6>
                        </div>
                        <div class="card-body">
                            <div id="results-summary"></div>
                            <div id="results-metrics"></div>
                            <div id="results-trades"></div>
                        </div>
                    </div>
                </div>
            </div>
        </section>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        // ==================== Fund Selector Component ====================
        class FundSelector {
            constructor(containerId) {
                this.container = document.getElementById(containerId);
                this.selectedFunds = new Set();
                this.selectionChangeCallbacks = [];
                this.initSelectAll();
            }
            
            /**
             * Initialize select all functionality
             */
            initSelectAll() {
                const selectAllCheckbox = document.getElementById('select-all-holdings');
                if (selectAllCheckbox) {
                    selectAllCheckbox.addEventListener('change', (e) => {
                        this.toggleSelectAll(e.target.checked);
                    });
                }
            }
            
            /**
             * Toggle select all functionality
             * @param {boolean} checked - Whether to select all or deselect all
             */
            toggleSelectAll(checked) {
                const checkboxes = this.container.querySelectorAll('.holdings-checkbox');
                checkboxes.forEach(checkbox => {
                    checkbox.checked = checked;
                    this.handleSelectionChange(checkbox.value, checked);
                });
                this.updateSelectAllStatus();
            }
            
            /**
             * Update select all checkbox status
             */
            updateSelectAllStatus() {
                const selectAllCheckbox = document.getElementById('select-all-holdings');
                if (!selectAllCheckbox) return;
                
                const checkboxes = this.container.querySelectorAll('.holdings-checkbox');
                if (checkboxes.length === 0) {
                    selectAllCheckbox.checked = false;
                    selectAllCheckbox.indeterminate = false;
                    return;
                }
                
                const checkedBoxes = this.container.querySelectorAll('.holdings-checkbox:checked');
                if (checkedBoxes.length === 0) {
                    selectAllCheckbox.checked = false;
                    selectAllCheckbox.indeterminate = false;
                } else if (checkedBoxes.length === checkboxes.length) {
                    selectAllCheckbox.checked = true;
                    selectAllCheckbox.indeterminate = false;
                } else {
                    selectAllCheckbox.checked = false;
                    selectAllCheckbox.indeterminate = true;
                }
            }

            /**
             * Load holdings from API and render the list
             * @param {string} userId - User ID to load holdings for (default: 'default_user')
             */
            async loadHoldings(userId = 'default_user') {
                try {
                    const response = await fetch(`/api/user-holdings?user_id=${userId}`);
                    const result = await response.json();
                    
                    if (result.success && result.data) {
                        this.renderHoldings(result.data);
                    } else {
                        this.renderEmpty('加载持仓失败');
                    }
                } catch (error) {
                    console.error('加载持仓失败:', error);
                    this.renderEmpty('加载持仓失败，请刷新重试');
                }
            }

            /**
             * Render holdings list with checkboxes
             * @param {Array} holdings - Array of holding objects
             */
            renderHoldings(holdings) {
                if (!holdings || holdings.length === 0) {
                    this.renderEmpty('暂无持仓数据，请先添加持仓');
                    this.updateSelectAllStatus();
                    return;
                }

                const html = holdings.map(holding => `
                    <div class="holdings-item" data-fund-code="${holding.fund_code}">
                        <input type="checkbox" 
                               class="holdings-checkbox form-check-input" 
                               id="fund-${holding.fund_code}"
                               value="${holding.fund_code}"
                               onchange="fundSelector.handleSelectionChange('${holding.fund_code}', this.checked)">
                        <div class="holdings-info">
                            <div class="holdings-code">${holding.fund_code}</div>
                            <div class="holdings-name">${holding.fund_name}</div>
                        </div>
                        <div class="holdings-amount">¥${holding.holding_amount.toLocaleString()}</div>
                    </div>
                `).join('');

                this.container.innerHTML = html;
                this.updateSelectAllStatus();
            }

            /**
             * Render empty state with message
             * @param {string} message - Message to display
             */
            renderEmpty(message) {
                this.container.innerHTML = `
                    <div class="empty-holdings">
                        <i class="bi bi-inbox"></i>
                        <div>${message}</div>
                    </div>
                `;
            }

            /**
             * Handle checkbox selection change
             * @param {string} fundCode - Fund code that was selected/deselected
             * @param {boolean} checked - Whether the checkbox is checked
             */
            handleSelectionChange(fundCode, checked) {
                if (checked) {
                    this.selectedFunds.add(fundCode);
                } else {
                    this.selectedFunds.delete(fundCode);
                }
                
                // Update select all status
                this.updateSelectAllStatus();
                
                // Notify all registered callbacks
                this.selectionChangeCallbacks.forEach(callback => {
                    callback(this.getSelectedFunds());
                });
            }

            /**
             * Get array of selected fund codes
             * @returns {Array<string>} Array of selected fund codes
             */
            getSelectedFunds() {
                return Array.from(this.selectedFunds);
            }

            /**
             * Register a callback for selection changes
             * @param {Function} callback - Callback function to call when selection changes
             */
            onSelectionChange(callback) {
                if (typeof callback === 'function') {
                    this.selectionChangeCallbacks.push(callback);
                }
            }

            /**
             * Clear all selections
             */
            clearSelection() {
                this.selectedFunds.clear();
                const checkboxes = this.container.querySelectorAll('.holdings-checkbox');
                checkboxes.forEach(cb => cb.checked = false);
                
                // Update select all status
                this.updateSelectAllStatus();
                
                // Notify callbacks
                this.selectionChangeCallbacks.forEach(callback => {
                    callback(this.getSelectedFunds());
                });
            }
        }

        // Initialize Fund Selector
        const fundSelector = new FundSelector('holdings-list');

        // ==================== Strategy Selector Component ====================
        class StrategySelector {
            constructor(containerId) {
                this.container = document.getElementById(containerId);
                this.selectedStrategy = null;
                this.selectedStrategies = new Set(); // For comparison mode
                this.comparisonMode = false;
                this.strategies = [];
                this.selectionChangeCallbacks = [];
            }

            /**
             * Load strategies from API and render the cards
             */
            async loadStrategies() {
                try {
                    const response = await fetch('/api/strategies/metadata');
                    const result = await response.json();
                    
                    if (result.success && result.data) {
                        this.strategies = result.data;
                        this.renderStrategies(result.data);
                        
                        // Set default to enhanced_rule_based strategy (only in single mode)
                        if (!this.comparisonMode) {
                            const defaultStrategy = result.data.find(s => s.strategy_id === 'enhanced_rule_based');
                            if (defaultStrategy) {
                                this.selectStrategy(defaultStrategy.strategy_id);
                            }
                        }
                    } else {
                        this.renderEmpty('加载策略失败');
                    }
                } catch (error) {
                    console.error('加载策略失败:', error);
                    this.renderEmpty('加载策略失败，请刷新重试');
                }
            }

            /**
             * Render strategy cards with metrics display
             * @param {Array} strategies - Array of strategy objects
             */
            renderStrategies(strategies) {
                if (!strategies || strategies.length === 0) {
                    this.renderEmpty('暂无可用策略');
                    return;
                }

                const html = strategies.map(strategy => {
                    const totalReturnClass = strategy.total_return >= 0 ? 'positive' : 'negative';
                    const annualizedReturnClass = strategy.annualized_return >= 0 ? 'positive' : 'negative';
                    const maxDrawdownClass = 'negative'; // Drawdown is always negative context
                    
                    const comparisonClass = this.comparisonMode ? 'comparison-mode' : '';
                    
                    return `
                        <div class="strategy-selector-card ${comparisonClass}" 
                             data-strategy-id="${strategy.strategy_id}"
                             onclick="strategySelector.${this.comparisonMode ? 'toggleStrategy' : 'selectStrategy'}('${strategy.strategy_id}')">
                            <div class="strategy-name">${strategy.name}</div>
                            <div class="strategy-description">${strategy.description}</div>
                            <div class="strategy-metrics">
                                <div class="strategy-metric">
                                    <span class="strategy-metric-label">总收益率</span>
                                    <span class="strategy-metric-value ${totalReturnClass}">
                                        ${strategy.total_return >= 0 ? '+' : ''}${strategy.total_return.toFixed(2)}%
                                    </span>
                                </div>
                                <div class="strategy-metric">
                                    <span class="strategy-metric-label">年化收益</span>
                                    <span class="strategy-metric-value ${annualizedReturnClass}">
                                        ${strategy.annualized_return >= 0 ? '+' : ''}${strategy.annualized_return.toFixed(2)}%
                                    </span>
                                </div>
                                <div class="strategy-metric">
                                    <span class="strategy-metric-label">最大回撤</span>
                                    <span class="strategy-metric-value ${maxDrawdownClass}">
                                        ${strategy.max_drawdown.toFixed(2)}%
                                    </span>
                                </div>
                                <div class="strategy-metric">
                                    <span class="strategy-metric-label">夏普比率</span>
                                    <span class="strategy-metric-value">
                                        ${strategy.sharpe_ratio.toFixed(2)}
                                    </span>
                                </div>
                                <div class="strategy-metric">
                                    <span class="strategy-metric-label">胜率</span>
                                    <span class="strategy-metric-value">
                                        ${strategy.win_rate.toFixed(2)}%
                                    </span>
                                </div>
                                <div class="strategy-metric">
                                    <span class="strategy-metric-label">盈亏比</span>
                                    <span class="strategy-metric-value">
                                        ${strategy.profit_loss_ratio.toFixed(2)}
                                    </span>
                                </div>
                            </div>
                        </div>
                    `;
                }).join('');

                this.container.innerHTML = html;
                
                // Restore selections after re-render
                if (this.comparisonMode) {
                    this.selectedStrategies.forEach(strategyId => {
                        const card = this.container.querySelector(`[data-strategy-id="${strategyId}"]`);
                        if (card) {
                            card.classList.add('selected');
                        }
                    });
                } else if (this.selectedStrategy) {
                    const card = this.container.querySelector(`[data-strategy-id="${this.selectedStrategy}"]`);
                    if (card) {
                        card.classList.add('selected');
                    }
                }
            }

            /**
             * Render empty state with message
             * @param {string} message - Message to display
             */
            renderEmpty(message) {
                this.container.innerHTML = `
                    <div class="strategy-selector-empty">
                        <i class="bi bi-inbox"></i>
                        <div>${message}</div>
                    </div>
                `;
            }

            /**
             * Select a strategy by ID (single selection with highlighting)
             * @param {string} strategyId - Strategy ID to select
             */
            selectStrategy(strategyId) {
                if (this.comparisonMode) {
                    // In comparison mode, use toggleStrategy instead
                    return;
                }
                
                // Remove previous selection
                const previousSelected = this.container.querySelector('.strategy-selector-card.selected');
                if (previousSelected) {
                    previousSelected.classList.remove('selected');
                }

                // Add selection to new card
                const card = this.container.querySelector(`[data-strategy-id="${strategyId}"]`);
                if (card) {
                    card.classList.add('selected');
                    this.selectedStrategy = strategyId;
                    
                    // Notify all registered callbacks
                    this.selectionChangeCallbacks.forEach(callback => {
                        callback(this.getSelectedStrategy());
                    });
                }
            }

            /**
             * Toggle strategy selection in comparison mode
             * @param {string} strategyId - Strategy ID to toggle
             */
            toggleStrategy(strategyId) {
                if (!this.comparisonMode) {
                    // In single mode, use selectStrategy instead
                    return;
                }
                
                const card = this.container.querySelector(`[data-strategy-id="${strategyId}"]`);
                if (!card) return;
                
                if (this.selectedStrategies.has(strategyId)) {
                    // Deselect
                    this.selectedStrategies.delete(strategyId);
                    card.classList.remove('selected');
                } else {
                    // Select
                    this.selectedStrategies.add(strategyId);
                    card.classList.add('selected');
                }
                
                // Notify all registered callbacks
                this.selectionChangeCallbacks.forEach(callback => {
                    callback(this.getSelectedStrategies());
                });
            }

            /**
             * Enable or disable comparison mode
             * @param {boolean} enabled - Whether comparison mode is enabled
             */
            setComparisonMode(enabled) {
                this.comparisonMode = enabled;
                
                if (enabled) {
                    // Switching to comparison mode
                    this.selectedStrategies.clear();
                    if (this.selectedStrategy) {
                        this.selectedStrategies.add(this.selectedStrategy);
                    }
                    this.selectedStrategy = null;
                } else {
                    // Switching to single mode
                    if (this.selectedStrategies.size > 0) {
                        this.selectedStrategy = Array.from(this.selectedStrategies)[0];
                    }
                    this.selectedStrategies.clear();
                }
                
                // Re-render strategies with appropriate mode
                this.renderStrategies(this.strategies);
            }

            /**
             * Get the currently selected strategy ID (single mode)
             * @returns {string|null} Selected strategy ID or null
             */
            getSelectedStrategy() {
                return this.selectedStrategy;
            }

            /**
             * Get array of selected strategy IDs (comparison mode)
             * @returns {Array<string>} Array of selected strategy IDs
             */
            getSelectedStrategies() {
                return Array.from(this.selectedStrategies);
            }

            /**
             * Get the full strategy object for the selected strategy
             * @returns {Object|null} Selected strategy object or null
             */
            getSelectedStrategyData() {
                if (!this.selectedStrategy) return null;
                return this.strategies.find(s => s.strategy_id === this.selectedStrategy);
            }

            /**
             * Register a callback for selection changes
             * @param {Function} callback - Callback function to call when selection changes
             */
            onSelectionChange(callback) {
                if (typeof callback === 'function') {
                    this.selectionChangeCallbacks.push(callback);
                }
            }

            /**
             * Clear selection
             */
            clearSelection() {
                const selected = this.container.querySelectorAll('.strategy-selector-card.selected');
                selected.forEach(card => card.classList.remove('selected'));
                
                this.selectedStrategy = null;
                this.selectedStrategies.clear();
                
                // Notify callbacks
                this.selectionChangeCallbacks.forEach(callback => {
                    callback(this.comparisonMode ? this.getSelectedStrategies() : this.getSelectedStrategy());
                });
            }
        }

        // Initialize Strategy Selector
        const strategySelector = new StrategySelector('strategy-cards');

        // ==================== Results Visualizer Component ====================
        class ResultsVisualizer {
            constructor(containerId) {
                this.container = document.getElementById(containerId);
                this.summaryContainer = document.getElementById('results-summary');
                this.metricsContainer = document.getElementById('results-metrics');
                this.tradesContainer = document.getElementById('results-trades');
            }

            /**
             * Display backtest results with summary, metrics, and trade history
             * @param {Object} backtestData - Backtest result data
             */
            displayResults(backtestData) {
                if (!backtestData) {
                    console.error('No backtest data provided');
                    return;
                }

                // Show the results card
                this.container.style.display = 'block';

                // Render summary metrics
                this.renderSummary(backtestData);

                // Render evaluation metrics
                this.renderMetrics(backtestData);

                // Render trade history
                this.renderTrades(backtestData);

                // Add animation class
                this.container.classList.add('results-animate');
                
                // Remove animation class after animation completes
                setTimeout(() => {
                    this.container.classList.remove('results-animate');
                }, 500);

                // Scroll to results section with smooth animation
                const resultsSection = document.getElementById('results-section');
                if (resultsSection) {
                    resultsSection.scrollIntoView({ behavior: 'smooth', block: 'start' });
                } else {
                    // Fallback to scrolling to results card if section not found
                    this.container.scrollIntoView({ behavior: 'smooth', block: 'start' });
                }
            }

            /**
             * Render summary metrics (initial amount, final value, total return)
             * @param {Object} data - Backtest result data
             */
            renderSummary(data) {
                const returnClass = data.total_return >= 0 ? 'positive' : 'negative';
                const returnSign = data.total_return >= 0 ? '+' : '';

                this.summaryContainer.innerHTML = `
                    <div class="row text-center mb-4">
                        <div class="col-md-3">
                            <div class="metric-card">
                                <div class="metric-value">¥${data.initial_amount.toLocaleString()}</div>
                                <div class="metric-label">初始金额</div>
                            </div>
                        </div>
                        <div class="col-md-3">
                            <div class="metric-card">
                                <div class="metric-value">¥${(data.final_value || data.total_value || 0).toLocaleString()}</div>
                                <div class="metric-label">最终价值</div>
                            </div>
                        </div>
                        <div class="col-md-3">
                            <div class="metric-card">
                                <div class="metric-value ${returnClass}">${returnSign}${data.total_return.toFixed(2)}%</div>
                                <div class="metric-label">总收益率</div>
                            </div>
                        </div>
                        <div class="col-md-3">
                            <div class="metric-card">
                                <div class="metric-value">${data.trades_count || 0}</div>
                                <div class="metric-label">交易次数</div>
                            </div>
                        </div>
                    </div>
                `;
            }

            /**
             * Render evaluation metrics
             * @param {Object} data - Backtest result data
             */
            renderMetrics(data) {
                const evaluation = data.evaluation || {};
                
                // Additional key metrics
                const annualizedReturn = data.annualized_return || 0;
                const maxDrawdown = data.max_drawdown || 0;
                const sharpeRatio = data.sharpe_ratio || 0;

                const annualizedClass = annualizedReturn >= 0 ? 'positive' : 'negative';
                const annualizedSign = annualizedReturn >= 0 ? '+' : '';

                this.metricsContainer.innerHTML = `
                    <h6 class="mb-3"><i class="bi bi-graph-up me-2"></i>关键指标</h6>
                    <div class="row mb-3">
                        <div class="col-md-4">
                            <div class="metric-card">
                                <div class="metric-value ${annualizedClass}">${annualizedSign}${annualizedReturn.toFixed(2)}%</div>
                                <div class="metric-label">年化收益率</div>
                            </div>
                        </div>
                        <div class="col-md-4">
                            <div class="metric-card">
                                <div class="metric-value negative">${maxDrawdown.toFixed(2)}%</div>
                                <div class="metric-label">最大回撤</div>
                            </div>
                        </div>
                        <div class="col-md-4">
                            <div class="metric-card">
                                <div class="metric-value">${sharpeRatio.toFixed(2)}</div>
                                <div class="metric-label">夏普比率</div>
                            </div>
                        </div>
                    </div>

                    <h6 class="mb-3"><i class="bi bi-bar-chart me-2"></i>策略评估指标</h6>
                    <div class="evaluation-grid mb-3">
                        <div class="eval-item">
                            <div class="eval-value">${((evaluation.hit_rate || 0) * 100).toFixed(1)}%</div>
                            <div class="eval-label">命中率</div>
                        </div>
                        <div class="eval-item">
                            <div class="eval-value">${(evaluation.profit_factor || 0).toFixed(2)}</div>
                            <div class="eval-label">盈亏比</div>
                        </div>
                        <div class="eval-item">
                            <div class="eval-value">${evaluation.max_consecutive_losses || 0}</div>
                            <div class="eval-label">最大连亏</div>
                        </div>
                        <div class="eval-item">
                            <div class="eval-value">${evaluation.max_consecutive_wins || 0}</div>
                            <div class="eval-label">最大连赢</div>
                        </div>
                        <div class="eval-item">
                            <div class="eval-value">¥${(evaluation.avg_profit_per_trade || 0).toFixed(2)}</div>
                            <div class="eval-label">平均每笔收益</div>
                        </div>
                        <div class="eval-item">
                            <div class="eval-value">¥${(evaluation.expectancy || 0).toFixed(2)}</div>
                            <div class="eval-label">期望值</div>
                        </div>
                    </div>
                `;
            }

            /**
             * Render trade history table
             * @param {Object} data - Backtest result data
             */
            renderTrades(data) {
                const trades = data.trades || [];

                if (trades.length === 0) {
                    this.tradesContainer.innerHTML = `
                        <hr>
                        <p class="text-muted text-center py-3">
                            <i class="bi bi-inbox me-2"></i>回测期间无交易记录
                        </p>
                    `;
                    return;
                }

                const tradesHtml = trades.map(trade => {
                    const actionClass = trade.action === 'buy' ? 'positive' : 
                                       trade.action === 'stop_loss' ? 'text-danger fw-bold' : 
                                       'negative';
                    const actionText = trade.action === 'buy' ? '买入' : 
                                      trade.action === 'stop_loss' ? '止损' : 
                                      '卖出';
                    const trendIcon = trade.trend === 'uptrend' ? '📈' : 
                                     trade.trend === 'downtrend' ? '📉' : 
                                     trade.trend ? '➡️' : '-';

                    return `
                        <tr>
                            <td>${trade.date}</td>
                            <td class="${actionClass}">${actionText}</td>
                            <td>¥${trade.amount.toFixed(2)}</td>
                            <td>¥${trade.balance.toFixed(2)}</td>
                            <td>¥${trade.holdings.toFixed(2)}</td>
                            <td>${trade.multiplier ? trade.multiplier.toFixed(1) + '×' : '-'}</td>
                            <td>${trendIcon}</td>
                        </tr>
                    `;
                }).join('');

                this.tradesContainer.innerHTML = `
                    <hr>
                    <h6 class="mb-3"><i class="bi bi-list-ul me-2"></i>交易记录 (${trades.length}条)</h6>
                    <div class="table-responsive">
                        <table class="table table-sm table-striped table-hover">
                            <thead class="table-light">
                                <tr>
                                    <th>日期</th>
                                    <th>操作</th>
                                    <th>金额</th>
                                    <th>余额</th>
                                    <th>持仓</th>
                                    <th>倍数</th>
                                    <th>趋势</th>
                                </tr>
                            </thead>
                            <tbody>
                                ${tradesHtml}
                            </tbody>
                        </table>
                    </div>
                `;
            }

            /**
             * Clear all results and hide the container
             */
            clear() {
                this.summaryContainer.innerHTML = '';
                this.metricsContainer.innerHTML = '';
                this.tradesContainer.innerHTML = '';
                this.container.style.display = 'none';
            }
        }

        // Initialize Results Visualizer
        const resultsVisualizer = new ResultsVisualizer('results-card');

        // ==================== Loading State and Message Management ====================
        
        /**
         * Show loading state with spinner and progress message
         * @param {string} message - Progress message to display
         */
        function showLoadingState(message = '处理中...') {
            // Disable backtest button and show spinner
            const btn = document.querySelector('.btn-success');
            if (btn) {
                btn.dataset.originalText = btn.innerHTML;
                btn.innerHTML = `<span class="spinner-border spinner-border-sm me-1"></span>${message}`;
                btn.disabled = true;
            }
            
            // Show progress message in results area
            const resultsDiv = document.getElementById('backtest-result');
            const resultsContent = document.getElementById('backtest-result-content');
            if (resultsDiv && resultsContent) {
                resultsDiv.style.display = 'block';
                resultsContent.innerHTML = `
                    <div class="alert alert-info mb-0">
                        <div class="d-flex align-items-center">
                            <div class="spinner-border spinner-border-sm me-3" role="status">
                                <span class="visually-hidden">Loading...</span>
                            </div>
                            <div>
                                <i class="bi bi-hourglass-split me-2"></i>${message}
                            </div>
                        </div>
                    </div>
                `;
            }
        }
        
        /**
         * Clear loading state and restore button
         */
        function clearLoadingState() {
            const btn = document.querySelector('.btn-success');
            if (btn && btn.dataset.originalText) {
                btn.innerHTML = btn.dataset.originalText;
                btn.disabled = false;
                delete btn.dataset.originalText;
            }
        }
        
        /**
         * Show success message
         * @param {string} message - Success message to display
         */
        function showSuccessMessage(message) {
            const resultsDiv = document.getElementById('backtest-result');
            const resultsContent = document.getElementById('backtest-result-content');
            if (resultsDiv && resultsContent) {
                resultsDiv.style.display = 'block';
                resultsContent.innerHTML = `
                    <div class="alert alert-success mb-3">
                        <i class="bi bi-check-circle me-2"></i>${message}
                    </div>
                ` + resultsContent.innerHTML;
            }
        }
        
        /**
         * Show error message with appropriate styling based on error type
         * @param {string} message - Error message to display
         * @param {string} errorType - Type of error: 'validation', 'missing_data', 'network', 'server', 'backtest'
         */
        function showErrorMessage(message, errorType = 'backtest') {
            const resultsDiv = document.getElementById('backtest-result');
            const resultsContent = document.getElementById('backtest-result-content');
            
            // Determine alert class and icon based on error type
            let alertClass = 'alert-warning';
            let icon = 'exclamation-triangle';
            
            switch (errorType) {
                case 'validation':
                    alertClass = 'alert-warning';
                    icon = 'exclamation-triangle';
                    break;
                case 'missing_data':
                    alertClass = 'alert-info';
                    icon = 'info-circle';
                    break;
                case 'network':
                    alertClass = 'alert-danger';
                    icon = 'wifi-off';
                    break;
                case 'server':
                    alertClass = 'alert-danger';
                    icon = 'x-circle';
                    break;
                case 'backtest':
                default:
                    alertClass = 'alert-warning';
                    icon = 'exclamation-triangle';
                    break;
            }
            
            if (resultsDiv && resultsContent) {
                resultsDiv.style.display = 'block';
                resultsContent.innerHTML = `
                    <div class="alert ${alertClass} mb-0">
                        <i class="bi bi-${icon} me-2"></i>${message}
                    </div>
                `;
            }
        }

        // ==================== Comparison Mode Toggle ====================
        
        /**
         * Toggle comparison mode on/off
         */
        function toggleComparisonMode() {
            const toggle = document.getElementById('comparison-mode-toggle');
            const infoDiv = document.getElementById('comparison-mode-info');
            const isEnabled = toggle.checked;
            
            // Update strategy selector mode
            strategySelector.setComparisonMode(isEnabled);
            
            // Show/hide info message
            if (isEnabled) {
                infoDiv.style.display = 'block';
            } else {
                infoDiv.style.display = 'none';
            }
            
            // Update backtest button state based on new mode
            updateBacktestButtonState();
        }

        /**
         * Run strategy comparison
         */
        async function runStrategyComparison() {
            const selectedFunds = fundSelector.getSelectedFunds();
            const selectedStrategies = strategySelector.getSelectedStrategies();
            const initialAmount = parseFloat(document.getElementById('initial-amount').value);
            const baseInvest = parseFloat(document.getElementById('base-invest').value);
            const backtestDays = parseInt(document.getElementById('backtest-days').value);
            
            // Validate fund selection (must be exactly one fund)
            if (selectedFunds.length === 0) {
                showErrorMessage('请选择一个基金进行策略对比', 'validation');
                return;
            }
            if (selectedFunds.length > 1) {
                showErrorMessage('策略对比模式只支持单个基金，请选择一个基金', 'validation');
                return;
            }
            
            // Validate strategy selection (must be at least 2)
            if (selectedStrategies.length < 2) {
                showErrorMessage('请至少选择两个策略进行对比', 'validation');
                return;
            }
            
            // Validate parameters
            if (!validateBacktestParameters(initialAmount, baseInvest, backtestDays)) {
                return;
            }
            
            // Show loading state
            showLoadingState('正在执行策略对比，请稍候...');
            
            try {
                const response = await fetch('/api/strategy/compare', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        fund_code: selectedFunds[0],
                        strategy_ids: selectedStrategies,
                        initial_amount: initialAmount,
                        base_invest: baseInvest,
                        days: backtestDays
                    })
                });
                
                const result = await response.json();
                
                if (result.success && result.data) {
                    showSuccessMessage('策略对比完成！');
                    displayComparisonResults(result.data);
                } else {
                    showErrorMessage(result.error || '策略对比失败', 'backtest');
                }
            } catch (error) {
                console.error('策略对比失败:', error);
                if (error.message.includes('Failed to fetch') || error.message.includes('NetworkError')) {
                    showErrorMessage('网络连接失败，请检查网络后重试', 'network');
                } else {
                    showErrorMessage(`策略对比请求失败: ${error.message}`, 'server');
                }
            } finally {
                clearLoadingState();
            }
        }

        /**
         * Display strategy comparison results in a side-by-side table
         * @param {Object} data - Comparison result data
         */
        function displayComparisonResults(data) {
            const strategies = data.strategies;
            const bestStrategyId = data.best_strategy_id;
            
            // Build comparison table
            let tableHtml = `
                <div class="alert alert-success mb-3">
                    <i class="bi bi-check-circle me-2"></i>
                    <strong>策略对比完成</strong> - 基金: ${data.fund_code}, 回测天数: ${data.days}天
                </div>
                <div class="table-responsive">
                    <table class="comparison-table table table-bordered">
                        <thead>
                            <tr>
                                <th>指标</th>
                                ${strategies.map(s => {
                                    const strategyData = strategySelector.strategies.find(st => st.strategy_id === s.strategy_id);
                                    const isBest = s.strategy_id === bestStrategyId;
                                    return `<th class="${isBest ? 'best-strategy' : ''}">
                                        ${strategyData ? strategyData.name : s.strategy_id}
                                        ${isBest ? '<span class="best-badge">最佳</span>' : ''}
                                    </th>`;
                                }).join('')}
                            </tr>
                        </thead>
                        <tbody>
                            <tr>
                                <td><strong>初始金额</strong></td>
                                ${strategies.map(s => `<td>¥${s.initial_amount.toLocaleString()}</td>`).join('')}
                            </tr>
                            <tr>
                                <td><strong>最终价值</strong></td>
                                ${strategies.map(s => {
                                    const isBest = s.strategy_id === bestStrategyId;
                                    return `<td class="${isBest ? 'best-strategy' : ''}">¥${(s.final_value || s.total_value || 0).toLocaleString()}</td>`;
                                }).join('')}
                            </tr>
                            <tr>
                                <td><strong>总收益率</strong></td>
                                ${strategies.map(s => {
                                    const isBest = s.strategy_id === bestStrategyId;
                                    const totalReturn = s.total_return || 0;
                                    const returnClass = totalReturn >= 0 ? 'metric-positive' : 'metric-negative';
                                    const returnSign = totalReturn >= 0 ? '+' : '';
                                    return `<td class="${isBest ? 'best-strategy' : ''} ${returnClass}">
                                        ${returnSign}${totalReturn.toFixed(2)}%
                                    </td>`;
                                }).join('')}
                            </tr>
                            <tr>
                                <td><strong>年化收益率</strong></td>
                                ${strategies.map(s => {
                                    const annualizedReturn = s.annualized_return || 0;
                                    const returnClass = annualizedReturn >= 0 ? 'metric-positive' : 'metric-negative';
                                    const returnSign = annualizedReturn >= 0 ? '+' : '';
                                    return `<td class="${returnClass}">${returnSign}${annualizedReturn.toFixed(2)}%</td>`;
                                }).join('')}
                            </tr>
                            <tr>
                                <td><strong>最大回撤</strong></td>
                                ${strategies.map(s => {
                                    const maxDrawdown = s.max_drawdown || 0;
                                    return `<td class="metric-negative">${maxDrawdown.toFixed(2)}%</td>`;
                                }).join('')}
                            </tr>
                            <tr>
                                <td><strong>夏普比率</strong></td>
                                ${strategies.map(s => {
                                    const sharpeRatio = s.sharpe_ratio || 0;
                                    return `<td>${sharpeRatio.toFixed(2)}</td>`;
                                }).join('')}
                            </tr>
                            <tr>
                                <td><strong>交易次数</strong></td>
                                ${strategies.map(s => `<td>${s.trades_count || 0}</td>`).join('')}
                            </tr>
                            <tr>
                                <td><strong>命中率</strong></td>
                                ${strategies.map(s => {
                                    const hitRate = s.evaluation && s.evaluation.hit_rate !== null ? s.evaluation.hit_rate * 100 : 0;
                                    return `<td>${hitRate.toFixed(1)}%</td>`;
                                }).join('')}
                            </tr>
                            <tr>
                                <td><strong>盈亏比</strong></td>
                                ${strategies.map(s => {
                                    const profitFactor = s.evaluation && s.evaluation.profit_factor !== null ? s.evaluation.profit_factor : 0;
                                    return `<td>${profitFactor.toFixed(2)}</td>`;
                                }).join('')}
                            </tr>
                        </tbody>
                    </table>
                </div>
            `;
            
            // Display in results area
            document.getElementById('backtest-result').style.display = 'block';
            document.getElementById('backtest-result-content').innerHTML = tableHtml;
            
            // Add animation class
            const resultsDiv = document.getElementById('backtest-result');
            resultsDiv.classList.add('results-animate');
            
            // Remove animation class after animation completes
            setTimeout(() => {
                resultsDiv.classList.remove('results-animate');
            }, 500);
            
            // Scroll to results section with smooth animation
            const resultsSection = document.getElementById('results-section');
            if (resultsSection) {
                resultsSection.scrollIntoView({ behavior: 'smooth', block: 'start' });
            } else {
                // Fallback to scrolling to results div if section not found
                resultsDiv.scrollIntoView({ behavior: 'smooth', block: 'start' });
            }
        }

        // ==================== Backtest Parameter Validation ====================
        
        /**
         * Validation configuration for backtest parameters
         */
        const VALIDATION_RULES = {
            initial_amount: {
                min: 100,
                errorMessage: '初始金额必须大于等于100元'
            },
            base_invest: {
                min: 10,
                errorMessage: '基准定投金额必须大于等于10元'
            },
            days: {
                validValues: [30, 60, 90, 180, 365],
                errorMessage: '回测天数必须是30、60、90、180或365天'
            }
        };

        /**
         * Validate initial amount parameter
         * @param {number} value - Initial amount value
         * @returns {Object} Validation result with isValid and error properties
         */
        function validateInitialAmount(value) {
            const numValue = parseFloat(value);
            
            if (isNaN(numValue)) {
                return {
                    isValid: false,
                    error: '初始金额必须是有效数字'
                };
            }
            
            if (numValue < VALIDATION_RULES.initial_amount.min) {
                return {
                    isValid: false,
                    error: VALIDATION_RULES.initial_amount.errorMessage
                };
            }
            
            return { isValid: true, error: null };
        }

        /**
         * Validate base invest parameter
         * @param {number} value - Base invest value
         * @returns {Object} Validation result with isValid and error properties
         */
        function validateBaseInvest(value) {
            const numValue = parseFloat(value);
            
            if (isNaN(numValue)) {
                return {
                    isValid: false,
                    error: '基准定投金额必须是有效数字'
                };
            }
            
            if (numValue < VALIDATION_RULES.base_invest.min) {
                return {
                    isValid: false,
                    error: VALIDATION_RULES.base_invest.errorMessage
                };
            }
            
            return { isValid: true, error: null };
        }

        /**
         * Validate days parameter
         * @param {number} value - Days value
         * @returns {Object} Validation result with isValid and error properties
         */
        function validateDays(value) {
            const numValue = parseInt(value);
            
            if (isNaN(numValue)) {
                return {
                    isValid: false,
                    error: '回测天数必须是有效数字'
                };
            }
            
            if (!VALIDATION_RULES.days.validValues.includes(numValue)) {
                return {
                    isValid: false,
                    error: VALIDATION_RULES.days.errorMessage
                };
            }
            
            return { isValid: true, error: null };
        }

        /**
         * Display inline validation error for a field
         * @param {string} fieldId - ID of the input field
         * @param {string} errorMessage - Error message to display
         */
        function showValidationError(fieldId, errorMessage) {
            const field = document.getElementById(fieldId);
            const errorDiv = document.getElementById(`${fieldId}-error`);
            
            if (field && errorDiv) {
                field.classList.add('is-invalid');
                errorDiv.textContent = errorMessage;
                errorDiv.style.display = 'block';
            }
        }

        /**
         * Clear validation error for a field
         * @param {string} fieldId - ID of the input field
         */
        function clearValidationError(fieldId) {
            const field = document.getElementById(fieldId);
            const errorDiv = document.getElementById(`${fieldId}-error`);
            
            if (field && errorDiv) {
                field.classList.remove('is-invalid');
                errorDiv.textContent = '';
                errorDiv.style.display = 'none';
            }
        }

        /**
         * Clear all validation errors
         */
        function clearAllValidationErrors() {
            clearValidationError('initial-amount');
            clearValidationError('base-invest');
            clearValidationError('backtest-days');
        }

        /**
         * Validate all backtest parameters
         * @param {number} initialAmount - Initial amount value
         * @param {number} baseInvest - Base invest value
         * @param {number} days - Days value
         * @returns {boolean} True if all parameters are valid, false otherwise
         */
        function validateBacktestParameters(initialAmount, baseInvest, days) {
            clearAllValidationErrors();
            let isValid = true;

            // Validate initial amount
            const initialAmountResult = validateInitialAmount(initialAmount);
            if (!initialAmountResult.isValid) {
                showValidationError('initial-amount', initialAmountResult.error);
                isValid = false;
            }

            // Validate base invest
            const baseInvestResult = validateBaseInvest(baseInvest);
            if (!baseInvestResult.isValid) {
                showValidationError('base-invest', baseInvestResult.error);
                isValid = false;
            }

            // Validate days
            const daysResult = validateDays(days);
            if (!daysResult.isValid) {
                showValidationError('backtest-days', daysResult.error);
                isValid = false;
            }

            return isValid;
        }

        // Add real-time validation on input change
        document.addEventListener('DOMContentLoaded', () => {
            // Initial amount validation on blur
            const initialAmountField = document.getElementById('initial-amount');
            if (initialAmountField) {
                initialAmountField.addEventListener('blur', function() {
                    const result = validateInitialAmount(this.value);
                    if (!result.isValid) {
                        showValidationError('initial-amount', result.error);
                    } else {
                        clearValidationError('initial-amount');
                    }
                });
                
                initialAmountField.addEventListener('input', function() {
                    // Clear error on input to give immediate feedback
                    if (this.classList.contains('is-invalid')) {
                        const result = validateInitialAmount(this.value);
                        if (result.isValid) {
                            clearValidationError('initial-amount');
                        }
                    }
                });
            }

            // Base invest validation on blur
            const baseInvestField = document.getElementById('base-invest');
            if (baseInvestField) {
                baseInvestField.addEventListener('blur', function() {
                    const result = validateBaseInvest(this.value);
                    if (!result.isValid) {
                        showValidationError('base-invest', result.error);
                    } else {
                        clearValidationError('base-invest');
                    }
                });
                
                baseInvestField.addEventListener('input', function() {
                    // Clear error on input to give immediate feedback
                    if (this.classList.contains('is-invalid')) {
                        const result = validateBaseInvest(this.value);
                        if (result.isValid) {
                            clearValidationError('base-invest');
                        }
                    }
                });
            }

            // Days validation on change
            const daysField = document.getElementById('backtest-days');
            if (daysField) {
                daysField.addEventListener('change', function() {
                    const result = validateDays(this.value);
                    if (!result.isValid) {
                        showValidationError('backtest-days', result.error);
                    } else {
                        clearValidationError('backtest-days');
                    }
                });
            }
        });

        // ==================== Button Enable/Disable Logic ====================
        
        /**
         * Update backtest button state based on fund and strategy selection
         */
        function updateBacktestButtonState() {
            const backtestBtn = document.querySelector('.btn-success');
            if (!backtestBtn) return;
            
            const selectedFunds = fundSelector.getSelectedFunds();
            const selectedStrategy = strategySelector.getSelectedStrategy();
            const comparisonMode = document.getElementById('comparison-mode-toggle').checked;
            
            // In comparison mode, need at least one fund and multiple strategies
            if (comparisonMode) {
                const selectedStrategies = strategySelector.getSelectedStrategies();
                const shouldEnable = selectedFunds.length > 0 && selectedStrategies.length >= 2;
                backtestBtn.disabled = !shouldEnable;
                
                if (!shouldEnable) {
                    backtestBtn.title = selectedFunds.length === 0 ? 
                        '请先选择基金' : 
                        '请至少选择两个策略进行对比';
                } else {
                    backtestBtn.title = '';
                }
            } else {
                // In single mode, need at least one fund and one strategy
                const shouldEnable = selectedFunds.length > 0 && selectedStrategy !== null;
                backtestBtn.disabled = !shouldEnable;
                
                if (!shouldEnable) {
                    backtestBtn.title = selectedFunds.length === 0 ? 
                        '请先选择基金' : 
                        '请先选择策略';
                } else {
                    backtestBtn.title = '';
                }
            }
        }
        
        // ==================== Existing Code ====================
        document.addEventListener('DOMContentLoaded', () => {
            loadStrategies();
            loadStrategyConfig();
            fundSelector.loadHoldings();
            strategySelector.loadStrategies();
            
            // ==================== WIRING: Register callbacks for button state updates ====================
            // Wire fund selector to backtest button enable/disable logic
            fundSelector.onSelectionChange((selectedFunds) => {
                console.log('Fund selection changed:', selectedFunds);
                updateBacktestButtonState();
            });
            
            // Wire strategy selector to backtest button enable/disable logic
            strategySelector.onSelectionChange((selectedStrategy) => {
                console.log('Strategy selection changed:', selectedStrategy);
                updateBacktestButtonState();
            });
            
            // Initial button state update
            setTimeout(() => {
                updateBacktestButtonState();
            }, 500); // Wait for components to load
        });

        async function loadStrategies() {
            try {
                const response = await fetch('/api/strategies');
                const result = await response.json();
                if (result.success && result.data) {
                    const list = document.getElementById('strategy-list');
                    if (list) {
                        list.innerHTML = result.data.map(s => `
                            <div class="list-group-item strategy-card ${s.action.includes('buy') ? 'buy' : s.action.includes('sell') ? 'sell' : ''}">
                                <div class="d-flex justify-content-between align-items-center">
                                    <strong>${s.label}</strong>
                                    <span class="badge ${s.action.includes('buy') ? 'bg-success' : s.action.includes('sell') ? 'bg-danger' : 'bg-secondary'}">${s.action}</span>
                                </div>
                                <small class="text-muted">${s.description}</small>
                            </div>
                        `).join('');
                    }
                }
            } catch (error) { console.error('加载策略失败:', error); }
        }

        async function loadStrategyConfig() {
            try {
                const response = await fetch('/api/strategy/config');
                const result = await response.json();
                if (result.success && result.data) {
                    const config = result.data;
                    document.getElementById('strategy-config').innerHTML = `
                        <div class="mb-3">
                            <h6 class="text-danger"><i class="bi bi-shield-exclamation me-1"></i>止损配置</h6>
                            <div class="config-item"><span>警告阈值</span><span class="text-warning">${(config.stop_loss.warning_threshold * 100).toFixed(0)}%</span></div>
                            <div class="config-item"><span>止损阈值</span><span class="text-danger">${(config.stop_loss.stop_loss_threshold * 100).toFixed(0)}%</span></div>
                        </div>
                        <div class="mb-3">
                            <h6 class="text-info"><i class="bi bi-activity me-1"></i>波动率配置</h6>
                            <div class="config-item"><span>高波动阈值</span><span>${(config.volatility.high_threshold * 100).toFixed(0)}%</span></div>
                            <div class="config-item"><span>低波动阈值</span><span>${(config.volatility.low_threshold * 100).toFixed(0)}%</span></div>
                            <div class="config-item"><span>高波动调整</span><span class="text-danger">×${config.volatility.high_adjustment}</span></div>
                            <div class="config-item"><span>低波动调整</span><span class="text-success">×${config.volatility.low_adjustment}</span></div>
                        </div>
                        <div>
                            <h6 class="text-primary"><i class="bi bi-graph-up me-1"></i>趋势配置</h6>
                            <div class="config-item"><span>短期均线</span><span>${config.trend.ma_short_period}日</span></div>
                            <div class="config-item"><span>长期均线</span><span>${config.trend.ma_long_period}日</span></div>
                            <div class="config-item"><span>上涨调整</span><span class="text-success">×${config.trend.uptrend_adjustment}</span></div>
                            <div class="config-item"><span>下跌调整</span><span class="text-danger">×${config.trend.downtrend_adjustment}</span></div>
                        </div>
                    `;
                }
            } catch (error) { 
                console.error('加载配置失败:', error);
                document.getElementById('strategy-config').innerHTML = '<div class="text-danger">加载配置失败</div>';
            }
        }

        async function analyzeUnifiedStrategy() {
            const fundCode = document.getElementById('analyze-fund-code').value.trim();
            const todayReturn = parseFloat(document.getElementById('today-return').value);
            const prevDayReturn = parseFloat(document.getElementById('prev-day-return').value);
            const cumulativePnl = document.getElementById('cumulative-pnl').value;
            
            try {
                const response = await fetch('/api/strategy/unified-analyze', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ 
                        fund_code: fundCode || null,
                        today_return: todayReturn, 
                        prev_day_return: prevDayReturn,
                        cumulative_pnl: cumulativePnl ? parseFloat(cumulativePnl) / 100 : null
                    })
                });
                const result = await response.json();
                
                if (result.success && result.data) {
                    const d = result.data;
                    document.getElementById('analyze-result').style.display = 'block';
                    
                    // 趋势徽章
                    const trendBadge = d.trend === 'uptrend' ? '<span class="trend-badge trend-up">📈 上涨趋势</span>' :
                                       d.trend === 'downtrend' ? '<span class="trend-badge trend-down">📉 下跌趋势</span>' :
                                       '<span class="trend-badge trend-sideways">➡️ 横盘整理</span>';
                    
                    // 波动率样式
                    const volClass = d.volatility_level === 'high' ? 'volatility-high' :
                                     d.volatility_level === 'low' ? 'volatility-low' : 'volatility-normal';
                    
                    // 止损状态
                    let stopLossHtml = '';
                    if (d.stop_loss_triggered) {
                        stopLossHtml = `<div class="stop-loss-triggered mb-3"><i class="bi bi-exclamation-triangle-fill me-2"></i>${d.stop_loss_label}</div>`;
                    } else if (d.stop_loss_level === 'warning') {
                        stopLossHtml = `<div class="stop-loss-warning mb-3"><i class="bi bi-exclamation-triangle me-2"></i>${d.stop_loss_label}</div>`;
                    }
                    
                    document.getElementById('analyze-result-content').innerHTML = `
                        ${stopLossHtml}
                        <div class="row mb-3">
                            <div class="col-md-4">
                                <div class="metric-card">
                                    <div class="metric-value ${d.action.includes('buy') ? 'text-success' : d.action.includes('sell') ? 'text-danger' : ''}">${d.final_buy_multiplier.toFixed(1)}×</div>
                                    <div class="metric-label">最终买入倍数</div>
                                </div>
                            </div>
                            <div class="col-md-4">
                                <div class="metric-card">
                                    <div class="metric-value">${trendBadge}</div>
                                    <div class="metric-label">趋势判断</div>
                                </div>
                            </div>
                            <div class="col-md-4">
                                <div class="metric-card">
                                    <div class="metric-value ${volClass}">${(d.volatility * 100).toFixed(1)}%</div>
                                    <div class="metric-label">波动率 (${d.volatility_level})</div>
                                </div>
                            </div>
                        </div>
                        <table class="table table-sm mb-3">
                            <tr><td width="30%">策略名称</td><td><strong>${d.strategy_name}</strong></td></tr>
                            <tr><td>状态标签</td><td>${d.status_label}</td></tr>
                            <tr><td>操作建议</td><td>${d.operation_suggestion}</td></tr>
                            <tr><td>基础倍数</td><td>${d.base_buy_multiplier}×</td></tr>
                            <tr><td>趋势调整</td><td>×${d.trend_adjustment.toFixed(2)}</td></tr>
                            <tr><td>波动率调整</td><td>×${d.volatility_adjustment.toFixed(2)}</td></tr>
                            <tr><td>赎回金额</td><td>¥${d.redeem_amount}</td></tr>
                            <tr><td>执行金额</td><td>${d.execution_amount}</td></tr>
                        </table>
                        <div class="alert alert-info mb-0">
                            <i class="bi bi-lightbulb me-2"></i><strong>综合建议：</strong>${d.final_suggestion}
                        </div>
                    `;
                }
            } catch (error) { 
                console.error('策略分析失败:', error); 
                alert('分析失败: ' + error.message); 
            }
        }

        async function runBacktest() {
            // Check if we're in comparison mode
            const comparisonMode = document.getElementById('comparison-mode-toggle').checked;
            
            if (comparisonMode) {
                // Run strategy comparison
                await runStrategyComparison();
                return;
            }
            
            // ==================== WIRING: Get data from components ====================
            // Wire fund selector to get selected funds
            const selectedFunds = fundSelector.getSelectedFunds();
            
            // Wire strategy selector to get selected strategy
            const selectedStrategy = strategySelector.getSelectedStrategy();
            
            // Get backtest parameters from form
            const initialAmount = parseFloat(document.getElementById('initial-amount').value);
            const baseInvest = parseFloat(document.getElementById('base-invest').value);
            const backtestDays = parseInt(document.getElementById('backtest-days').value);
            
            // ==================== VALIDATION ====================
            // Validate fund selection
            if (selectedFunds.length === 0) { 
                showErrorMessage('请从持仓中选择至少一个基金', 'validation');
                return; 
            }
            
            // Validate strategy selection
            if (!selectedStrategy) {
                showErrorMessage('请选择一个策略', 'validation');
                return;
            }
            
            // Validate all parameters before proceeding
            if (!validateBacktestParameters(initialAmount, baseInvest, backtestDays)) {
                // Validation errors are already displayed inline
                return;
            }
            
            // ==================== EXECUTE BACKTEST ====================
            // Show loading state
            showLoadingState('正在执行回测，请稍候...');
            
            try {
                // Wire backtest button to API endpoint with selected parameters
                const response = await fetch('/api/strategy/backtest-holdings', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ 
                        fund_codes: selectedFunds,
                        strategy_id: selectedStrategy,
                        initial_amount: initialAmount,
                        base_invest: baseInvest,
                        days: backtestDays
                    })
                });
                const result = await response.json();
                
                // ==================== DISPLAY RESULTS ====================                
                if (result.success && result.data) {
                    // Show success message
                    showSuccessMessage('回测完成！');
                    
                    // Check if this is a multi-fund backtest
                    if (result.data.portfolio) {
                        // Multi-fund backtest: display portfolio results
                        if (result.data.funds && result.data.funds.length > 0) {
                            displayMultiFundResults(result.data);
                        } else {
                            showErrorMessage('回测结果中缺少基金数据', 'backtest');
                        }
                    } else {
                        // Single-fund backtest: wire API response to results visualizer
                        resultsVisualizer.displayResults(result.data);
                    }
                } else { 
                    // Determine error type and show appropriate message
                    const errorMsg = result.error || '回测失败，请检查基金代码是否正确';
                    if (errorMsg.includes('数据') || errorMsg.includes('data')) {
                        showErrorMessage(errorMsg, 'missing_data');
                    } else if (errorMsg.includes('参数') || errorMsg.includes('parameter')) {
                        showErrorMessage(errorMsg, 'validation');
                    } else {
                        showErrorMessage(errorMsg, 'backtest');
                    }
                }
            } catch (error) { 
                console.error('回测失败:', error); 
                // Determine error type based on error message
                if (error.message.includes('Failed to fetch') || error.message.includes('NetworkError')) {
                    showErrorMessage('网络连接失败，请检查网络后重试', 'network');
                } else {
                    showErrorMessage(`回测请求失败: ${error.message}`, 'server');
                }
            } finally {
                clearLoadingState();
            }
        }
        
        /**
         * Display multi-fund backtest results
         * @param {Object} data - Multi-fund backtest result data
         */
        function displayMultiFundResults(data) {
            const portfolio = data.portfolio;
            const funds = data.funds || [];
            const bestFund = data.best_fund;
            const worstFund = data.worst_fund;
            
            // 防御性检查
            if (!funds || funds.length === 0) {
                showErrorMessage('回测结果中没有基金数据', 'backtest');
                return;
            }
            
            // Build portfolio summary
            const portfolioReturnClass = portfolio.total_return >= 0 ? 'positive' : 'negative';
            const portfolioReturnSign = portfolio.total_return >= 0 ? '+' : '';
            
            let html = `
                <div class="alert alert-success mb-3">
                    <i class="bi bi-check-circle me-2"></i>
                    <strong>多基金回测完成</strong> - 共${funds.length}只基金, 回测天数: ${data.days}天
                </div>
                
                <h6 class="mb-3"><i class="bi bi-pie-chart me-2"></i>组合表现</h6>
                <div class="row text-center mb-4">
                    <div class="col-md-3">
                        <div class="metric-card">
                            <div class="metric-value">¥${portfolio.initial_amount.toLocaleString()}</div>
                            <div class="metric-label">初始金额</div>
                        </div>
                    </div>
                    <div class="col-md-3">
                        <div class="metric-card">
                            <div class="metric-value">¥${(portfolio.final_value || portfolio.total_value || 0).toLocaleString()}</div>
                            <div class="metric-label">最终价值</div>
                        </div>
                    </div>
                    <div class="col-md-3">
                        <div class="metric-card">
                            <div class="metric-value ${portfolioReturnClass}">${portfolioReturnSign}${portfolio.total_return.toFixed(2)}%</div>
                            <div class="metric-label">总收益率</div>
                        </div>
                    </div>
                    <div class="col-md-3">
                        <div class="metric-card">
                            <div class="metric-value">${portfolio.trades_count || 0}</div>
                            <div class="metric-label">总交易次数</div>
                        </div>
                    </div>
                </div>
                
                <h6 class="mb-3"><i class="bi bi-list-check me-2"></i>各基金表现</h6>
                <div class="table-responsive mb-3">
                    <table class="comparison-table table table-bordered">
                        <thead>
                            <tr>
                                <th>基金代码</th>
                                <th>初始金额</th>
                                <th>最终价值</th>
                                <th>总收益率</th>
                                <th>年化收益</th>
                                <th>最大回撤</th>
                                <th>夏普比率</th>
                                <th>交易次数</th>
                            </tr>
                        </thead>
                        <tbody>
                            ${funds.map(fund => {
                                const isBest = fund.fund_code === bestFund;
                                const isWorst = fund.fund_code === worstFund;
                                const returnClass = fund.total_return >= 0 ? 'metric-positive' : 'metric-negative';
                                const returnSign = fund.total_return >= 0 ? '+' : '';
                                const rowClass = isBest ? 'best-strategy' : '';
                                
                                return `
                                    <tr class="${rowClass}">
                                        <td>
                                            <strong>${fund.fund_code}</strong>
                                            ${isBest ? '<span class="best-badge">最佳</span>' : ''}
                                            ${isWorst ? '<span class="badge bg-secondary">最差</span>' : ''}
                                        </td>
                                        <td>¥${fund.initial_amount.toLocaleString()}</td>
                                        <td>¥${(fund.final_value || fund.total_value || 0).toLocaleString()}</td>
                                        <td class="${returnClass}">${returnSign}${fund.total_return.toFixed(2)}%</td>
                                        <td>${returnSign}${fund.annualized_return.toFixed(2)}%</td>
                                        <td class="metric-negative">${fund.max_drawdown.toFixed(2)}%</td>
                                        <td>${fund.sharpe_ratio.toFixed(2)}</td>
                                        <td>${fund.trades_count || 0}</td>
                                    </tr>
                                `;
                            }).join('')}
                        </tbody>
                    </table>
                </div>
                
                <div class="alert alert-info mb-0">
                    <i class="bi bi-info-circle me-2"></i>
                    <strong>表现最佳:</strong> ${bestFund} | 
                    <strong>表现最差:</strong> ${worstFund}
                </div>
            `;
            
            // Display in results area
            document.getElementById('backtest-result').style.display = 'block';
            document.getElementById('backtest-result-content').innerHTML = html;
            
            // Add animation class
            const resultsDiv = document.getElementById('backtest-result');
            resultsDiv.classList.add('results-animate');
            
            // Remove animation class after animation completes
            setTimeout(() => {
                resultsDiv.classList.remove('results-animate');
            }, 500);
            
            // Scroll to results section with smooth animation
            const resultsSection = document.getElementById('results-section');
            if (resultsSection) {
                resultsSection.scrollIntoView({ behavior: 'smooth', block: 'start' });
            } else {
                // Fallback to scrolling to results div if section not found
                resultsDiv.scrollIntoView({ behavior: 'smooth', block: 'start' });
            }
        }
    </script>
</body>
</html>
