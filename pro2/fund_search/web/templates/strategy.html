<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ç­–ç•¥åˆ†æ - åŸºé‡‘åˆ†æç³»ç»Ÿ</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.0/font/bootstrap-icons.css" rel="stylesheet">
    <style>
        :root { 
            --primary-color: #3498db; 
            --success-color: #27ae60; 
            --danger-color: #e74c3c; 
            --warning-color: #f39c12;
            --info-color: #17a2b8;
        }
        body { background-color: #f5f6fa; font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; }
        .navbar { background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); }
        .card { border: none; border-radius: 12px; box-shadow: 0 2px 12px rgba(0,0,0,0.08); margin-bottom: 20px; }
        .card-header { background: white; border-bottom: 1px solid #eee; font-weight: 600; }
        .strategy-card { border-left: 4px solid var(--primary-color); transition: all 0.3s; }
        .strategy-card:hover { transform: translateX(5px); }
        .strategy-card.buy { border-left-color: var(--success-color); }
        .strategy-card.sell { border-left-color: var(--danger-color); }
        .result-box { background: #f8f9fa; border-radius: 8px; padding: 20px; margin-top: 15px; }
        .positive { color: #e74c3c; }
        .negative { color: #27ae60; }
        .btn-analyze { border-radius: 20px; padding: 10px 30px; }
        .metric-card { text-align: center; padding: 15px; border-radius: 8px; background: linear-gradient(135deg, #f5f7fa 0%, #c3cfe2 100%); }
        .metric-value { font-size: 1.5rem; font-weight: bold; }
        .metric-label { font-size: 0.85rem; color: #666; }
        .trend-badge { padding: 5px 12px; border-radius: 20px; font-size: 0.85rem; }
        .trend-up { background: #d4edda; color: #155724; }
        .trend-down { background: #f8d7da; color: #721c24; }
        .trend-sideways { background: #fff3cd; color: #856404; }
        .stop-loss-warning { background: #fff3cd; border-left: 4px solid #ffc107; padding: 10px 15px; border-radius: 4px; }
        .stop-loss-triggered { background: #f8d7da; border-left: 4px solid #dc3545; padding: 10px 15px; border-radius: 4px; }
        .volatility-high { color: #dc3545; }
        .volatility-low { color: #28a745; }
        .volatility-normal { color: #6c757d; }
        .config-item { display: flex; justify-content: space-between; padding: 8px 0; border-bottom: 1px solid #eee; }
        .config-item:last-child { border-bottom: none; }
        .evaluation-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); gap: 15px; }
        .eval-item { background: #f8f9fa; padding: 12px; border-radius: 8px; text-align: center; }
        .eval-value { font-size: 1.2rem; font-weight: bold; color: #333; }
        .eval-label { font-size: 0.8rem; color: #666; }
    </style>
</head>
<body>
    <nav class="navbar navbar-expand-lg navbar-dark mb-4">
        <div class="container">
            <a class="navbar-brand" href="/"><i class="bi bi-graph-up-arrow me-2"></i>åŸºé‡‘åˆ†æç³»ç»Ÿ</a>
            <div class="navbar-nav ms-auto">
                <a class="nav-link" href="/"><i class="bi bi-house me-1"></i>é¦–é¡µ</a>
                <a class="nav-link active" href="/strategy"><i class="bi bi-lightbulb me-1"></i>ç­–ç•¥åˆ†æ</a>
            </div>
        </div>
    </nav>

    <div class="container">
        <div class="row">
            <!-- å·¦ä¾§ï¼šç­–ç•¥åˆ—è¡¨å’Œé…ç½® -->
            <div class="col-md-4">
                <!-- ç­–ç•¥åˆ—è¡¨ -->
                <div class="card">
                    <div class="card-header"><h6 class="mb-0"><i class="bi bi-list-check me-2"></i>å¯ç”¨ç­–ç•¥</h6></div>
                    <div class="card-body p-0">
                        <div class="list-group list-group-flush" id="strategy-list" style="max-height: 300px; overflow-y: auto;"></div>
                    </div>
                </div>

                <!-- ç­–ç•¥é…ç½® -->
                <div class="card">
                    <div class="card-header"><h6 class="mb-0"><i class="bi bi-gear me-2"></i>ç­–ç•¥é…ç½®</h6></div>
                    <div class="card-body" id="strategy-config">
                        <div class="text-center text-muted py-3">
                            <div class="spinner-border spinner-border-sm me-2"></div>åŠ è½½ä¸­...
                        </div>
                    </div>
                </div>
            </div>

            <!-- å³ä¾§ï¼šç­–ç•¥æµ‹è¯•å’Œå›æµ‹ -->
            <div class="col-md-8">
                <!-- ç»Ÿä¸€ç­–ç•¥æµ‹è¯• -->
                <div class="card">
                    <div class="card-header">
                        <h6 class="mb-0"><i class="bi bi-calculator me-2"></i>ç»Ÿä¸€ç­–ç•¥åˆ†æ</h6>
                    </div>
                    <div class="card-body">
                        <div class="row g-3">
                            <div class="col-md-3">
                                <label class="form-label">åŸºé‡‘ä»£ç </label>
                                <input type="text" class="form-control" id="analyze-fund-code" placeholder="å¦‚: 000001">
                            </div>
                            <div class="col-md-3">
                                <label class="form-label">ä»Šæ—¥æ”¶ç›Šç‡ (%)</label>
                                <input type="number" class="form-control" id="today-return" step="0.01" value="0.5">
                            </div>
                            <div class="col-md-3">
                                <label class="form-label">æ˜¨æ—¥æ”¶ç›Šç‡ (%)</label>
                                <input type="number" class="form-control" id="prev-day-return" step="0.01" value="-0.3">
                            </div>
                            <div class="col-md-3">
                                <label class="form-label">ç´¯è®¡ç›ˆäº (%)</label>
                                <input type="number" class="form-control" id="cumulative-pnl" step="0.01" placeholder="å¯é€‰">
                            </div>
                        </div>
                        <div class="mt-3">
                            <button class="btn btn-primary btn-analyze" onclick="analyzeUnifiedStrategy()">
                                <i class="bi bi-play-fill me-1"></i>åˆ†æç­–ç•¥
                            </button>
                        </div>
                        
                        <!-- åˆ†æç»“æœ -->
                        <div class="result-box" id="analyze-result" style="display:none;">
                            <div id="analyze-result-content"></div>
                        </div>
                    </div>
                </div>

                <!-- ç­–ç•¥å›æµ‹ -->
                <div class="card">
                    <div class="card-header"><h6 class="mb-0"><i class="bi bi-clock-history me-2"></i>ç­–ç•¥å›æµ‹</h6></div>
                    <div class="card-body">
                        <div class="row g-3 mb-3">
                            <div class="col-md-3">
                                <label class="form-label">åŸºé‡‘ä»£ç </label>
                                <input type="text" class="form-control" id="backtest-fund" placeholder="å¦‚: 000001">
                            </div>
                            <div class="col-md-3">
                                <label class="form-label">åˆå§‹é‡‘é¢ (å…ƒ)</label>
                                <input type="number" class="form-control" id="initial-amount" value="10000">
                            </div>
                            <div class="col-md-3">
                                <label class="form-label">åŸºå‡†å®šæŠ• (å…ƒ)</label>
                                <input type="number" class="form-control" id="base-invest" value="100">
                            </div>
                            <div class="col-md-3">
                                <label class="form-label">å›æµ‹å¤©æ•°</label>
                                <select class="form-select" id="backtest-days">
                                    <option value="30">è¿‘30å¤©</option>
                                    <option value="60">è¿‘60å¤©</option>
                                    <option value="90" selected>è¿‘90å¤©</option>
                                    <option value="180">è¿‘180å¤©</option>
                                </select>
                            </div>
                        </div>
                        <button class="btn btn-success btn-analyze" onclick="runBacktest()">
                            <i class="bi bi-play-circle me-1"></i>å¼€å§‹å›æµ‹
                        </button>
                        <div class="result-box" id="backtest-result" style="display:none;">
                            <div id="backtest-result-content"></div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        document.addEventListener('DOMContentLoaded', () => {
            loadStrategies();
            loadStrategyConfig();
        });

        async function loadStrategies() {
            try {
                const response = await fetch('/api/strategies');
                const result = await response.json();
                if (result.success && result.data) {
                    const list = document.getElementById('strategy-list');
                    list.innerHTML = result.data.map(s => `
                        <div class="list-group-item strategy-card ${s.action.includes('buy') ? 'buy' : s.action.includes('sell') ? 'sell' : ''}">
                            <div class="d-flex justify-content-between align-items-center">
                                <strong>${s.label}</strong>
                                <span class="badge ${s.action.includes('buy') ? 'bg-success' : s.action.includes('sell') ? 'bg-danger' : 'bg-secondary'}">${s.action}</span>
                            </div>
                            <small class="text-muted">${s.description}</small>
                        </div>
                    `).join('');
                }
            } catch (error) { console.error('åŠ è½½ç­–ç•¥å¤±è´¥:', error); }
        }

        async function loadStrategyConfig() {
            try {
                const response = await fetch('/api/strategy/config');
                const result = await response.json();
                if (result.success && result.data) {
                    const config = result.data;
                    document.getElementById('strategy-config').innerHTML = `
                        <div class="mb-3">
                            <h6 class="text-danger"><i class="bi bi-shield-exclamation me-1"></i>æ­¢æŸé…ç½®</h6>
                            <div class="config-item"><span>è­¦å‘Šé˜ˆå€¼</span><span class="text-warning">${(config.stop_loss.warning_threshold * 100).toFixed(0)}%</span></div>
                            <div class="config-item"><span>æ­¢æŸé˜ˆå€¼</span><span class="text-danger">${(config.stop_loss.stop_loss_threshold * 100).toFixed(0)}%</span></div>
                        </div>
                        <div class="mb-3">
                            <h6 class="text-info"><i class="bi bi-activity me-1"></i>æ³¢åŠ¨ç‡é…ç½®</h6>
                            <div class="config-item"><span>é«˜æ³¢åŠ¨é˜ˆå€¼</span><span>${(config.volatility.high_threshold * 100).toFixed(0)}%</span></div>
                            <div class="config-item"><span>ä½æ³¢åŠ¨é˜ˆå€¼</span><span>${(config.volatility.low_threshold * 100).toFixed(0)}%</span></div>
                            <div class="config-item"><span>é«˜æ³¢åŠ¨è°ƒæ•´</span><span class="text-danger">Ã—${config.volatility.high_adjustment}</span></div>
                            <div class="config-item"><span>ä½æ³¢åŠ¨è°ƒæ•´</span><span class="text-success">Ã—${config.volatility.low_adjustment}</span></div>
                        </div>
                        <div>
                            <h6 class="text-primary"><i class="bi bi-graph-up me-1"></i>è¶‹åŠ¿é…ç½®</h6>
                            <div class="config-item"><span>çŸ­æœŸå‡çº¿</span><span>${config.trend.ma_short_period}æ—¥</span></div>
                            <div class="config-item"><span>é•¿æœŸå‡çº¿</span><span>${config.trend.ma_long_period}æ—¥</span></div>
                            <div class="config-item"><span>ä¸Šæ¶¨è°ƒæ•´</span><span class="text-success">Ã—${config.trend.uptrend_adjustment}</span></div>
                            <div class="config-item"><span>ä¸‹è·Œè°ƒæ•´</span><span class="text-danger">Ã—${config.trend.downtrend_adjustment}</span></div>
                        </div>
                    `;
                }
            } catch (error) { 
                console.error('åŠ è½½é…ç½®å¤±è´¥:', error);
                document.getElementById('strategy-config').innerHTML = '<div class="text-danger">åŠ è½½é…ç½®å¤±è´¥</div>';
            }
        }

        async function analyzeUnifiedStrategy() {
            const fundCode = document.getElementById('analyze-fund-code').value.trim();
            const todayReturn = parseFloat(document.getElementById('today-return').value);
            const prevDayReturn = parseFloat(document.getElementById('prev-day-return').value);
            const cumulativePnl = document.getElementById('cumulative-pnl').value;
            
            try {
                const response = await fetch('/api/strategy/unified-analyze', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ 
                        fund_code: fundCode || null,
                        today_return: todayReturn, 
                        prev_day_return: prevDayReturn,
                        cumulative_pnl: cumulativePnl ? parseFloat(cumulativePnl) / 100 : null
                    })
                });
                const result = await response.json();
                
                if (result.success && result.data) {
                    const d = result.data;
                    document.getElementById('analyze-result').style.display = 'block';
                    
                    // è¶‹åŠ¿å¾½ç« 
                    const trendBadge = d.trend === 'uptrend' ? '<span class="trend-badge trend-up">ğŸ“ˆ ä¸Šæ¶¨è¶‹åŠ¿</span>' :
                                       d.trend === 'downtrend' ? '<span class="trend-badge trend-down">ğŸ“‰ ä¸‹è·Œè¶‹åŠ¿</span>' :
                                       '<span class="trend-badge trend-sideways">â¡ï¸ æ¨ªç›˜æ•´ç†</span>';
                    
                    // æ³¢åŠ¨ç‡æ ·å¼
                    const volClass = d.volatility_level === 'high' ? 'volatility-high' :
                                     d.volatility_level === 'low' ? 'volatility-low' : 'volatility-normal';
                    
                    // æ­¢æŸçŠ¶æ€
                    let stopLossHtml = '';
                    if (d.stop_loss_triggered) {
                        stopLossHtml = `<div class="stop-loss-triggered mb-3"><i class="bi bi-exclamation-triangle-fill me-2"></i>${d.stop_loss_label}</div>`;
                    } else if (d.stop_loss_level === 'warning') {
                        stopLossHtml = `<div class="stop-loss-warning mb-3"><i class="bi bi-exclamation-triangle me-2"></i>${d.stop_loss_label}</div>`;
                    }
                    
                    document.getElementById('analyze-result-content').innerHTML = `
                        ${stopLossHtml}
                        <div class="row mb-3">
                            <div class="col-md-4">
                                <div class="metric-card">
                                    <div class="metric-value ${d.action.includes('buy') ? 'text-success' : d.action.includes('sell') ? 'text-danger' : ''}">${d.final_buy_multiplier.toFixed(1)}Ã—</div>
                                    <div class="metric-label">æœ€ç»ˆä¹°å…¥å€æ•°</div>
                                </div>
                            </div>
                            <div class="col-md-4">
                                <div class="metric-card">
                                    <div class="metric-value">${trendBadge}</div>
                                    <div class="metric-label">è¶‹åŠ¿åˆ¤æ–­</div>
                                </div>
                            </div>
                            <div class="col-md-4">
                                <div class="metric-card">
                                    <div class="metric-value ${volClass}">${(d.volatility * 100).toFixed(1)}%</div>
                                    <div class="metric-label">æ³¢åŠ¨ç‡ (${d.volatility_level})</div>
                                </div>
                            </div>
                        </div>
                        <table class="table table-sm mb-3">
                            <tr><td width="30%">ç­–ç•¥åç§°</td><td><strong>${d.strategy_name}</strong></td></tr>
                            <tr><td>çŠ¶æ€æ ‡ç­¾</td><td>${d.status_label}</td></tr>
                            <tr><td>æ“ä½œå»ºè®®</td><td>${d.operation_suggestion}</td></tr>
                            <tr><td>åŸºç¡€å€æ•°</td><td>${d.base_buy_multiplier}Ã—</td></tr>
                            <tr><td>è¶‹åŠ¿è°ƒæ•´</td><td>Ã—${d.trend_adjustment.toFixed(2)}</td></tr>
                            <tr><td>æ³¢åŠ¨ç‡è°ƒæ•´</td><td>Ã—${d.volatility_adjustment.toFixed(2)}</td></tr>
                            <tr><td>èµå›é‡‘é¢</td><td>Â¥${d.redeem_amount}</td></tr>
                            <tr><td>æ‰§è¡Œé‡‘é¢</td><td>${d.execution_amount}</td></tr>
                        </table>
                        <div class="alert alert-info mb-0">
                            <i class="bi bi-lightbulb me-2"></i><strong>ç»¼åˆå»ºè®®ï¼š</strong>${d.final_suggestion}
                        </div>
                    `;
                }
            } catch (error) { 
                console.error('ç­–ç•¥åˆ†æå¤±è´¥:', error); 
                alert('åˆ†æå¤±è´¥: ' + error.message); 
            }
        }

        async function runBacktest() {
            const fundCode = document.getElementById('backtest-fund').value.trim();
            const initialAmount = parseFloat(document.getElementById('initial-amount').value);
            const baseInvest = parseFloat(document.getElementById('base-invest').value);
            const backtestDays = parseInt(document.getElementById('backtest-days').value);
            
            if (!fundCode) { alert('è¯·è¾“å…¥åŸºé‡‘ä»£ç '); return; }
            if (isNaN(initialAmount) || initialAmount <= 0) { alert('è¯·è¾“å…¥æœ‰æ•ˆçš„åˆå§‹é‡‘é¢'); return; }
            
            const btn = document.querySelector('.btn-success');
            const originalText = btn.innerHTML;
            btn.innerHTML = '<span class="spinner-border spinner-border-sm me-1"></span>å›æµ‹ä¸­...';
            btn.disabled = true;
            
            try {
                const response = await fetch('/api/strategy/backtest', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ 
                        fund_code: fundCode, 
                        initial_amount: initialAmount,
                        base_invest: baseInvest,
                        days: backtestDays
                    })
                });
                const result = await response.json();
                
                if (result.success && result.data) {
                    const d = result.data;
                    const e = d.evaluation || {};
                    const returnClass = d.total_return >= 0 ? 'positive' : 'negative';
                    
                    document.getElementById('backtest-result').style.display = 'block';
                    document.getElementById('backtest-result-content').innerHTML = `
                        <div class="row text-center mb-3">
                            <div class="col-md-3">
                                <div class="h4">Â¥${d.initial_amount.toLocaleString()}</div>
                                <small class="text-muted">åˆå§‹é‡‘é¢</small>
                            </div>
                            <div class="col-md-3">
                                <div class="h4">Â¥${d.total_value.toLocaleString()}</div>
                                <small class="text-muted">æœ€ç»ˆä»·å€¼</small>
                            </div>
                            <div class="col-md-3">
                                <div class="h4 ${returnClass}">${d.total_return >= 0 ? '+' : ''}${d.total_return.toFixed(2)}%</div>
                                <small class="text-muted">æ€»æ”¶ç›Šç‡</small>
                            </div>
                            <div class="col-md-3">
                                <div class="h4">${d.trades_count}</div>
                                <small class="text-muted">äº¤æ˜“æ¬¡æ•°</small>
                            </div>
                        </div>
                        
                        <hr>
                        <h6><i class="bi bi-bar-chart me-2"></i>ç­–ç•¥è¯„ä¼°æŒ‡æ ‡</h6>
                        <div class="evaluation-grid mb-3">
                            <div class="eval-item">
                                <div class="eval-value">${(e.hit_rate * 100 || 0).toFixed(1)}%</div>
                                <div class="eval-label">å‘½ä¸­ç‡</div>
                            </div>
                            <div class="eval-item">
                                <div class="eval-value">${(e.profit_factor || 0).toFixed(2)}</div>
                                <div class="eval-label">ç›ˆäºæ¯”</div>
                            </div>
                            <div class="eval-item">
                                <div class="eval-value">${e.max_consecutive_losses || 0}</div>
                                <div class="eval-label">æœ€å¤§è¿äº</div>
                            </div>
                            <div class="eval-item">
                                <div class="eval-value">${e.max_consecutive_wins || 0}</div>
                                <div class="eval-label">æœ€å¤§è¿èµ¢</div>
                            </div>
                            <div class="eval-item">
                                <div class="eval-value">Â¥${(e.avg_profit_per_trade || 0).toFixed(2)}</div>
                                <div class="eval-label">å¹³å‡æ¯ç¬”æ”¶ç›Š</div>
                            </div>
                            <div class="eval-item">
                                <div class="eval-value">Â¥${(e.expectancy || 0).toFixed(2)}</div>
                                <div class="eval-label">æœŸæœ›å€¼</div>
                            </div>
                        </div>
                        
                        <hr>
                        <div class="row">
                            <div class="col-md-6">
                                <p><strong>è´¦æˆ·ä½™é¢:</strong> Â¥${d.final_balance.toFixed(2)}</p>
                                <p><strong>æŒä»“ä»·å€¼:</strong> Â¥${d.final_holdings.toFixed(2)}</p>
                            </div>
                            <div class="col-md-6">
                                <p><strong>å›æµ‹å¤©æ•°:</strong> ${d.backtest_days}å¤©</p>
                                <p><strong>æ•°æ®æ¡æ•°:</strong> ${d.data_count}æ¡</p>
                            </div>
                        </div>
                        
                        ${d.trades && d.trades.length > 0 ? `
                            <hr>
                            <details>
                                <summary class="mb-2"><strong>äº¤æ˜“è®°å½• (${d.trades.length}æ¡)</strong></summary>
                                <div class="table-responsive mt-2">
                                    <table class="table table-sm table-striped">
                                        <thead>
                                            <tr>
                                                <th>æ—¥æœŸ</th>
                                                <th>æ“ä½œ</th>
                                                <th>é‡‘é¢</th>
                                                <th>å€æ•°</th>
                                                <th>è¶‹åŠ¿</th>
                                                <th>ä½™é¢</th>
                                                <th>æŒä»“</th>
                                            </tr>
                                        </thead>
                                        <tbody>
                                            ${d.trades.map(t => `
                                                <tr>
                                                    <td>${t.date}</td>
                                                    <td class="${t.action === 'buy' ? 'positive' : t.action === 'stop_loss' ? 'text-danger fw-bold' : 'negative'}">
                                                        ${t.action === 'buy' ? 'ä¹°å…¥' : t.action === 'stop_loss' ? 'æ­¢æŸ' : 'å–å‡º'}
                                                    </td>
                                                    <td>Â¥${t.amount.toFixed(2)}</td>
                                                    <td>${t.multiplier ? t.multiplier.toFixed(1) + 'Ã—' : '-'}</td>
                                                    <td>${t.trend === 'uptrend' ? 'ğŸ“ˆ' : t.trend === 'downtrend' ? 'ğŸ“‰' : t.trend ? 'â¡ï¸' : '-'}</td>
                                                    <td>Â¥${t.balance.toFixed(2)}</td>
                                                    <td>Â¥${t.holdings.toFixed(2)}</td>
                                                </tr>
                                            `).join('')}
                                        </tbody>
                                    </table>
                                </div>
                            </details>
                        ` : '<p class="text-muted mt-3">å›æµ‹æœŸé—´æ— äº¤æ˜“è®°å½•</p>'}
                    `;
                } else { 
                    document.getElementById('backtest-result').style.display = 'block';
                    document.getElementById('backtest-result-content').innerHTML = `
                        <div class="alert alert-warning mb-0">
                            <i class="bi bi-exclamation-triangle me-2"></i>${result.error || 'å›æµ‹å¤±è´¥ï¼Œè¯·æ£€æŸ¥åŸºé‡‘ä»£ç æ˜¯å¦æ­£ç¡®'}
                        </div>
                    `;
                }
            } catch (error) { 
                console.error('å›æµ‹å¤±è´¥:', error); 
                document.getElementById('backtest-result').style.display = 'block';
                document.getElementById('backtest-result-content').innerHTML = `
                    <div class="alert alert-danger mb-0">
                        <i class="bi bi-x-circle me-2"></i>å›æµ‹è¯·æ±‚å¤±è´¥: ${error.message}
                    </div>
                `;
            } finally {
                btn.innerHTML = originalText;
                btn.disabled = false;
            }
        }
    </script>
</body>
</html>
