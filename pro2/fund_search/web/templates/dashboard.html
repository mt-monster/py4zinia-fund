<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>投资仪表盘 - 基金分析系统</title>

    <!-- DNS 预解析 + 预连接（减少 CDN 首字节延迟） -->
    <link rel="preconnect" href="https://cdn.jsdelivr.net" crossorigin>
    <link rel="dns-prefetch" href="https://cdn.jsdelivr.net">

    <!-- 关键 CSS 优先加载（Bootstrap 较大，异步加载） -->
    <link href="/static/css/financial-color-convention.css" rel="stylesheet">

    <!-- Bootstrap 异步非阻塞加载 -->
    <link rel="preload" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" as="style" onload="this.onload=null;this.rel='stylesheet'">
    <noscript><link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet"></noscript>

    <link rel="preload" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.0/font/bootstrap-icons.css" as="style" onload="this.onload=null;this.rel='stylesheet'">
    <noscript><link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.0/font/bootstrap-icons.css" rel="stylesheet"></noscript>

    <!-- Chart.js 延迟加载（非首屏关键资源） -->
    <script>
    (function(){
        var s = document.createElement('script');
        s.src = 'https://cdn.jsdelivr.net/npm/chart.js';
        s.defer = true;
        s.onload = function(){ window._chartJsReady = true; if(window._chartJsReadyCb) window._chartJsReadyCb(); };
        document.head.appendChild(s);
    })();
    </script>
    <style>
        :root {
            --primary: #e74c3c;
            --primary-dark: #c0392b;
            --success: #27ae60;
            --warning: #f39c12;
            --info: #3498db;
            --danger: #e74c3c;
            --dark: #2c3e50;
            --gray: #7f8c8d;
            --light: #ecf0f1;
            --bg: #f8f9fa;
            --card-bg: #ffffff;
            --border: #e0e0e0;
            --shadow: 0 2px 12px rgba(0,0,0,0.08);
            --shadow-hover: 0 8px 24px rgba(0,0,0,0.12);
            --radius: 12px;
            --transition: all 0.3s ease;
        }

        * { margin: 0; padding: 0; box-sizing: border-box; }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', 'Microsoft YaHei', sans-serif;
            background: var(--bg);
            color: var(--dark);
            line-height: 1.6;
        }

        /* 顶部导航 */
        .top-nav {
            background: linear-gradient(135deg, var(--primary) 0%, var(--primary-dark) 100%);
            padding: 12px 24px;
            display: flex;
            align-items: center;
            justify-content: space-between;
            box-shadow: 0 2px 8px rgba(231, 76, 60, 0.3);
        }

        .top-nav .brand {
            color: white;
            font-size: 20px;
            font-weight: 700;
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .top-nav .nav-links {
            display: flex;
            gap: 8px;
        }

        .top-nav .nav-links a {
            color: rgba(255,255,255,0.9);
            text-decoration: none;
            font-size: 14px;
            padding: 8px 16px;
            border-radius: 8px;
            transition: var(--transition);
            display: flex;
            align-items: center;
            gap: 6px;
        }

        .top-nav .nav-links a:hover,
        .top-nav .nav-links a.active {
            background: rgba(255,255,255,0.15);
            color: white;
        }

        /* 主容器 */
        .dashboard-container {
            padding: 24px;
            max-width: 1600px;
            margin: 0 auto;
        }

        /* 页面标题 */
        .page-header {
            margin-bottom: 24px;
        }

        .page-header h1 {
            font-size: 28px;
            font-weight: 700;
            color: var(--dark);
            margin-bottom: 8px;
        }

        .page-header p {
            color: var(--gray);
            font-size: 14px;
        }

        /* 统计卡片网格 */
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(240px, 1fr));
            gap: 20px;
            margin-bottom: 24px;
        }

        .stat-card {
            background: var(--card-bg);
            border-radius: var(--radius);
            padding: 24px;
            box-shadow: var(--shadow);
            transition: var(--transition);
            position: relative;
            overflow: hidden;
        }

        .stat-card:hover {
            transform: translateY(-4px);
            box-shadow: var(--shadow-hover);
        }

        .stat-card::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            width: 4px;
            height: 100%;
            background: var(--primary);
        }

        .stat-card.success::before { background: var(--success); }
        .stat-card.warning::before { background: var(--warning); }
        .stat-card.info::before { background: var(--info); }
        .stat-card.danger::before { background: var(--danger); }

        .stat-card .icon {
            width: 48px;
            height: 48px;
            border-radius: 12px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 24px;
            margin-bottom: 16px;
            background: rgba(231, 76, 60, 0.1);
            color: var(--primary);
        }

        .stat-card.success .icon { background: rgba(39, 174, 96, 0.1); color: var(--success); }
        .stat-card.warning .icon { background: rgba(243, 156, 18, 0.1); color: var(--warning); }
        .stat-card.info .icon { background: rgba(52, 152, 219, 0.1); color: var(--info); }
        .stat-card.danger .icon { background: rgba(231, 76, 60, 0.1); color: var(--danger); }

        .stat-card .label {
            font-size: 13px;
            color: var(--gray);
            margin-bottom: 8px;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .stat-card .value {
            font-size: 32px;
            font-weight: 700;
            color: var(--dark);
            margin-bottom: 8px;
        }

        .stat-card .change {
            font-size: 13px;
            display: flex;
            align-items: center;
            gap: 4px;
        }

        .stat-card .change.positive { color: var(--success); }
        .stat-card .change.negative { color: var(--danger); }
        
        /* 基金涨跌状态描述样式 */
        .change-description {
            font-size: 11px;
            color: #7f8c8d;
            margin-top: 2px;
            transition: all 0.3s ease;
        }
        
        /* 实时更新动画效果 */
        @keyframes pulseUpdate {
            0% { opacity: 1; transform: scale(1); }
            50% { opacity: 0.7; transform: scale(1.05); }
            100% { opacity: 1; transform: scale(1); }
        }
        
        .change.updated {
            animation: pulseUpdate 0.5s ease;
        }
        .stat-card .change.negative { color: var(--danger); }

        /* 图表区域 */
        .charts-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(400px, 1fr));
            gap: 20px;
            margin-bottom: 24px;
        }

        .chart-card {
            background: var(--card-bg);
            border-radius: var(--radius);
            padding: 24px;
            box-shadow: var(--shadow);
        }

        .chart-card .header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin-bottom: 20px;
        }

        .chart-card .header h3 {
            font-size: 16px;
            font-weight: 600;
            color: var(--dark);
        }

        .chart-card .header .actions {
            display: flex;
            gap: 8px;
        }

        .chart-card .header .btn-icon {
            width: 32px;
            height: 32px;
            border: none;
            background: var(--bg);
            border-radius: 8px;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            color: var(--gray);
            transition: var(--transition);
        }

        .chart-card .header .btn-icon:hover {
            background: var(--primary);
            color: white;
        }

        .chart-container {
            position: relative;
            height: 300px;
            width: 100%;
        }
        
        /* 确保Canvas元素正确显示 */
        canvas {
            display: block !important;
            width: 100% !important;
            height: 100% !important;
        }

        /* 系统状态监控 */
        .status-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 20px;
        }

        .status-card {
            background: var(--card-bg);
            border-radius: var(--radius);
            padding: 24px;
            box-shadow: var(--shadow);
        }

        .status-card .header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin-bottom: 20px;
        }

        .status-card .header h3 {
            font-size: 16px;
            font-weight: 600;
            color: var(--dark);
        }

        .status-item {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 12px 0;
            border-bottom: 1px solid var(--border);
        }

        .status-item:last-child {
            border-bottom: none;
        }

        .status-item .info {
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .status-item .info .icon {
            width: 36px;
            height: 36px;
            border-radius: 8px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 16px;
        }

        .status-item .info .icon.success {
            background: rgba(39, 174, 96, 0.1);
            color: var(--success);
        }

        .status-item .info .icon.warning {
            background: rgba(243, 156, 18, 0.1);
            color: var(--warning);
        }

        .status-item .info .icon.danger {
            background: rgba(231, 76, 60, 0.1);
            color: var(--danger);
        }

        .status-item .info .details h4 {
            font-size: 14px;
            font-weight: 600;
            color: var(--dark);
            margin-bottom: 2px;
        }

        .status-item .info .details p {
            font-size: 12px;
            color: var(--gray);
        }

        .status-item .badge {
            padding: 4px 12px;
            border-radius: 20px;
            font-size: 12px;
            font-weight: 500;
        }

        .status-item .badge.success {
            background: rgba(39, 174, 96, 0.1);
            color: var(--success);
        }

        .status-item .badge.warning {
            background: rgba(243, 156, 18, 0.1);
            color: var(--warning);
        }

        .status-item .badge.danger {
            background: rgba(231, 76, 60, 0.1);
            color: var(--danger);
        }

        /* 进度条 */
        .progress-bar-container {
            margin-top: 16px;
        }

        .progress-bar-container .label {
            display: flex;
            justify-content: space-between;
            font-size: 12px;
            color: var(--gray);
            margin-bottom: 8px;
        }

        .progress-bar {
            height: 8px;
            background: var(--light);
            border-radius: 4px;
            overflow: hidden;
        }

        .progress-bar .fill {
            height: 100%;
            border-radius: 4px;
            transition: width 0.6s ease;
        }

        .progress-bar .fill.success { background: var(--success); }
        .progress-bar .fill.warning { background: var(--warning); }
        .progress-bar .fill.danger { background: var(--danger); }

        /* 最近活动 */
        .activity-list {
            max-height: 320px;
            overflow-y: auto;
        }

        .activity-item {
            display: flex;
            gap: 12px;
            padding: 12px 0;
            border-bottom: 1px solid var(--border);
        }

        .activity-item:last-child {
            border-bottom: none;
        }

        .activity-item .avatar {
            width: 36px;
            height: 36px;
            border-radius: 50%;
            background: linear-gradient(135deg, var(--primary), var(--primary-dark));
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-size: 14px;
            font-weight: 600;
            flex-shrink: 0;
        }

        .activity-item .content {
            flex: 1;
        }

        .activity-item .content p {
            font-size: 13px;
            color: var(--dark);
            margin-bottom: 4px;
        }

        .activity-item .content .time {
            font-size: 12px;
            color: var(--gray);
        }

        /* 骨架屏 */
        .skeleton {
            background: linear-gradient(90deg, #f0f0f0 25%, #e0e0e0 50%, #f0f0f0 75%);
            background-size: 200% 100%;
            animation: skeleton-shimmer 1.4s ease infinite;
            border-radius: 6px;
            color: transparent !important;
            pointer-events: none;
        }
        .skeleton * { visibility: hidden; }

        @keyframes skeleton-shimmer {
            0%   { background-position: 200% 0; }
            100% { background-position: -200% 0; }
        }

        /* 加载动画 */
        .loading-skeleton {
            background: linear-gradient(90deg, var(--light) 25%, #f0f0f0 50%, var(--light) 75%);
            background-size: 200% 100%;
            animation: loading 1.5s infinite;
            border-radius: 4px;
        }

        @keyframes loading {
            0% { background-position: 200% 0; }
            100% { background-position: -200% 0; }
        }

        /* 响应式 */
        @media (max-width: 768px) {
            .dashboard-container {
                padding: 16px;
            }

            .stats-grid {
                grid-template-columns: 1fr;
            }

            .charts-grid {
                grid-template-columns: 1fr;
            }

            .top-nav .nav-links {
                display: none;
            }
        }

        /* 动画 */
        @keyframes fadeInUp {
            from {
                opacity: 0;
                transform: translateY(20px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .stat-card,
        .chart-card,
        .status-card {
            animation: fadeInUp 0.5s ease forwards;
        }

        .stat-card:nth-child(1) { animation-delay: 0.1s; }
        .stat-card:nth-child(2) { animation-delay: 0.2s; }
        .stat-card:nth-child(3) { animation-delay: 0.3s; }
        .stat-card:nth-child(4) { animation-delay: 0.4s; }
    </style>
</head>
<body>
    <!-- 顶部导航 -->
    <nav class="top-nav">
        <div class="brand">
            <i class="bi bi-graph-up-arrow"></i>
            <span>基金分析系统</span>
        </div>
        <div class="nav-links">
            <a href="/dashboard" class="active"><i class="bi bi-speedometer2"></i> 仪表盘</a>
            <a href="/my-holdings-new"><i class="bi bi-briefcase"></i> 我的持仓</a>
            <a href="/etf"><i class="bi bi-bar-chart"></i> ETF市场</a>
            <a href="/strategy-management"><i class="bi bi-gear"></i> 策略管理</a>
        </div>
    </nav>

    <!-- 仪表盘主容器 -->
    <div class="dashboard-container">
        <!-- 页面标题 -->
        <div class="page-header">
            <h1>投资仪表盘</h1>
            <p>实时监控您的投资组合表现和系统状态</p>
        </div>

        <!-- 关键指标卡片 -->
        <div class="stats-grid">
            <div class="stat-card success">
                <div class="icon"><i class="bi bi-wallet2"></i></div>
                <div class="label">持仓金额</div>
                <div class="value skeleton" id="totalAssets" style="min-height:40px;min-width:120px;">--</div>
                <div class="change positive skeleton" id="assetsChange" style="min-height:20px;">
                    <i class="bi bi-arrow-up"></i> --%
                </div>
            </div>

            <div class="stat-card info">
                <div class="icon"><i class="bi bi-graph-up"></i></div>
                <div class="label">今日收益</div>
                <div class="value skeleton" id="todayProfit" style="min-height:40px;min-width:100px;">--</div>
                <div class="change skeleton" id="profitChange" style="min-height:20px;">
                    <i class="bi bi-arrow-up"></i> --%
                </div>
            </div>

            <div class="stat-card warning">
                <div class="icon"><i class="bi bi-pie-chart"></i></div>
                <div class="label">持仓基金数</div>
                <div class="value skeleton" id="holdingCount" style="min-height:40px;min-width:60px;">--</div>
                <div class="change positive skeleton" id="newFundChange" style="min-height:20px;">
                    <i class="bi bi-plus-circle"></i> 新增 -- 只
                </div>
            </div>

            <div class="stat-card danger">
                <div class="icon"><i class="bi bi-activity"></i></div>
                <div class="label">夏普比率</div>
                <div class="value skeleton" id="sharpeRatio" style="min-height:40px;min-width:60px;">--</div>
                <div class="change skeleton" style="min-height:20px;">
                    风险调整后收益
                </div>
            </div>
        </div>

        <!-- 图表区域 -->
        <div class="charts-grid">
            <!-- 收益趋势图 -->
            <div class="chart-card">
                <div class="header">
                    <h3><i class="bi bi-graph-up-arrow"></i> 收益趋势</h3>
                    <div class="actions">
                        <button class="btn-icon" onclick="refreshChart('profit')" title="刷新">
                            <i class="bi bi-arrow-clockwise"></i>
                        </button>
                    </div>
                </div>
                <div class="chart-container">
                    <canvas id="profitChart"></canvas>
                </div>
            </div>

            <!-- 市场恐贪指数 -->
            <div class="chart-card" id="fear-greed-card">
                <div class="header">
                    <h3><i class="bi bi-speedometer2"></i> 市场恐贪指数</h3>
                    <div class="actions">
                        <button class="btn-icon" onclick="refreshChart('fear-greed')" title="刷新">
                            <i class="bi bi-arrow-clockwise"></i>
                        </button>
                    </div>
                </div>
                <div class="chart-container" id="fearGreedContainer" style="display:flex; flex-direction:column; align-items:center; justify-content:center;">
                    <div id="fearGreedGauge" style="width:100%; max-width:320px; position:relative;">
                        <!-- 仪表盘由JS渲染 -->
                    </div>
                    <div id="fearGreedInfo" style="margin-top:12px; text-align:center;">
                        <div id="fearGreedValue" style="font-size:2rem; font-weight:700; color:#aaa;">--</div>
                        <div id="fearGreedLabel" style="font-size:1rem; color:#666; margin-top:4px;">加载中...</div>
                        <div id="fearGreedDate" style="font-size:0.75rem; color:#aaa; margin-top:4px;"></div>
                    </div>
                    <div id="fearGreedHistory" style="width:100%; margin-top:16px;"></div>
                </div>
            </div>
        </div>

        <!-- 基金类型分布组件 -->
        <div class="charts-grid" style="margin-top: 20px;">
            <div class="chart-card">
                <div class="header">
                    <h3><i class="bi bi-grid-3x3"></i> 基金类型分布</h3>
                    <div class="actions">
                        <button class="btn-icon" onclick="loadAllocationData()" title="刷新">
                            <i class="bi bi-arrow-clockwise"></i>
                        </button>
                    </div>
                </div>
                <div id="fundTypeDistribution" style="padding: 10px;">
                    <!-- 动态加载 -->
                </div>
            </div>
        </div>

        <!-- 系统状态和用户活动 -->
        <div class="status-grid" style="margin-top: 20px;">
            <!-- 系统状态监控 -->
            <div class="status-card">
                <div class="header">
                    <h3><i class="bi bi-server"></i> 系统状态</h3>
                </div>
                <div class="status-list">
                    <div class="status-item">
                        <div class="info">
                            <div class="icon success"><i class="bi bi-check-circle"></i></div>
                            <div class="details">
                                <h4>数据库连接</h4>
                                <p>MySQL 运行正常</p>
                            </div>
                        </div>
                        <span class="badge success">正常</span>
                    </div>
                    <div class="status-item">
                        <div class="info">
                            <div class="icon success"><i class="bi bi-check-circle"></i></div>
                            <div class="details">
                                <h4>数据更新服务</h4>
                                <p>上次更新: <span id="lastUpdate">--</span></p>
                            </div>
                        </div>
                        <span class="badge success">正常</span>
                    </div>
                    <div class="status-item">
                        <div class="info">
                            <div class="icon warning"><i class="bi bi-exclamation-triangle"></i></div>
                            <div class="details">
                                <h4>API 接口</h4>
                                <p>响应时间: <span id="apiResponseTime">--</span>ms</p>
                            </div>
                        </div>
                        <span class="badge warning">较慢</span>
                    </div>
                </div>
                <div class="progress-bar-container">
                    <div class="label">
                        <span>系统负载</span>
                        <span id="systemLoad">--%</span>
                    </div>
                    <div class="progress-bar">
                        <div class="fill success" id="loadBar" style="width: 0%"></div>
                    </div>
                </div>
            </div>

            <!-- 最近活动 -->
            <div class="status-card">
                <div class="header">
                    <h3><i class="bi bi-clock-history"></i> 最近活动</h3>
                </div>
                <div class="activity-list" id="activityList">
                    <!-- 动态加载 -->
                </div>
            </div>

            <!-- 重仓股统计 -->
            <div class="status-card">
                <div class="header">
                    <h3><i class="bi bi-building"></i> 重仓股统计</h3>
                    <span id="holdingStocksSummary" style="font-size: 12px; color: #7f8c8d;"></span>
                </div>
                <div id="holdingStocks" style="max-height: 400px; overflow-y: auto;">
                    <!-- 动态加载 -->
                </div>
            </div>
        </div>
    </div>

    <script>
        // ==================== 性能计时工具 ====================
        const Perf = {
            marks: {},
            start(name) { this.marks[name] = performance.now(); },
            end(name) {
                const dur = performance.now() - (this.marks[name] || 0);
                console.log(`[Perf] ${name}: ${dur.toFixed(1)}ms`);
                return dur;
            }
        };

        // 全局图表实例
        let profitChart = null;
        let isInitialLoad = true;

        // ==================== 骨架屏工具 ====================
        function removeSkeleton(el) { if (el) el.classList.remove('skeleton'); }
        function removeAllSkeletons() { document.querySelectorAll('.skeleton').forEach(el => el.classList.remove('skeleton')); }

        // Chart.js 就绪回调
        function _whenChartJsReady(cb) {
            if (window._chartJsReady) { cb(); }
            else { window._chartJsReadyCb = cb; }
        }

        // 颜色处理辅助函数
        function adjustColorBrightness(hexColor, percent) {
            hexColor = hexColor.replace('#', '');
            let r = parseInt(hexColor.substr(0, 2), 16);
            let g = parseInt(hexColor.substr(2, 2), 16);
            let b = parseInt(hexColor.substr(4, 2), 16);
            r = Math.min(255, Math.max(0, r + (percent * 2.55)));
            g = Math.min(255, Math.max(0, g + (percent * 2.55)));
            b = Math.min(255, Math.max(0, b + (percent * 2.55)));
            return '#' + ((1 << 24) + (r << 16) + (g << 8) + b).toString(16).slice(1);
        }

        // ==================== 前端缓存工具 ====================
        const DashboardCache = {
            cache: new Map(),
            get(key) {
                const item = this.cache.get(key);
                if (!item) return null;
                if (Date.now() > item.expireTime) { this.cache.delete(key); return null; }
                return item.data;
            },
            set(key, data, ttlSeconds = 60) {
                this.cache.set(key, { data, expireTime: Date.now() + ttlSeconds * 1000 });
            },
            clear() { this.cache.clear(); }
        };

        // 带缓存的 fetch 请求（含超时控制）
        async function cachedFetch(url, cacheKey, ttlSeconds = 60, timeoutMs = 15000) {
            const cached = DashboardCache.get(cacheKey);
            if (cached) { console.log(`[缓存命中] ${cacheKey}`); return { success: true, data: cached, fromCache: true }; }
            const controller = new AbortController();
            const timer = setTimeout(() => controller.abort(), timeoutMs);
            try {
                const response = await fetch(url, { signal: controller.signal });
                const result = await response.json();
                if (result.success && result.data) DashboardCache.set(cacheKey, result.data, ttlSeconds);
                return result;
            } finally { clearTimeout(timer); }
        }

        // ==================== 初始化入口 ====================
        document.addEventListener('DOMContentLoaded', async function () {
            Perf.start('total_load');
            Perf.start('dom_to_data');

            // 非阻塞：Chart.js 就绪后初始化图表
            _whenChartJsReady(initProfitChart);

            // 并行加载首屏关键数据
            await loadAllDashboardData();

            // 移除骨架屏
            removeAllSkeletons();
            isInitialLoad = false;
            console.log(`[Perf] 首屏加载完成: ${Perf.end('dom_to_data').toFixed(0)}ms`);

            // 懒加载非关键：恐贪指数（可见时再加载）
            _lazyLoadFearGreed();

            startAutoRefresh();
            Perf.end('total_load');
        });

        // ==================== 懒加载：恐贪指数 ====================
        function _lazyLoadFearGreed() {
            const card = document.getElementById('fear-greed-card');
            if (!card) { loadFearGreedIndex(); return; }
            if ('IntersectionObserver' in window) {
                const obs = new IntersectionObserver((entries, observer) => {
                    if (entries[0].isIntersecting) { loadFearGreedIndex(); observer.disconnect(); }
                }, { threshold: 0.1 });
                obs.observe(card);
            } else { loadFearGreedIndex(); }
        }

        // ==================== 统一数据加载（优化版） ====================
        async function loadAllDashboardData(forceRefresh = false) {
            try {
                if (forceRefresh) DashboardCache.clear();
                console.log('[统一加载] 开始并行加载...');
                Perf.start('parallel_fetch');

                // 聚合接口（stats+allocation=1请求）+ profit-trend + holding-stocks 三路并行
                const [summaryResult, profitResult, holdingStocksResult] = await Promise.all([
                    cachedFetch('/api/dashboard/summary', 'dashboard_summary', 60, 20000)
                        .catch(e => ({ success: false, error: String(e) })),
                    cachedFetch('/api/dashboard/profit-trend?days=90&user_id=default_user', 'profit_trend_90', 300, 30000)
                        .catch(e => ({ success: false, error: String(e) })),
                    cachedFetch('/api/dashboard/holding-stocks?top=10', 'holding_stocks', 300, 20000)
                        .catch(e => ({ success: false, error: String(e) }))
                ]);

                Perf.end('parallel_fetch');
                console.log('[统一加载] 数据获取完成，渲染中...');

                // 渲染 summary（stats + allocation）
                if (summaryResult.success && summaryResult.data) {
                    const d = summaryResult.data;
                    if (d.stats) {
                        updateStatsCards(d.stats);
                        updateSystemStatus(d.stats.system);
                        updateActivityList(d.stats.activities);
                    }
                    if (d.allocation) updateFundTypeDistribution(d.allocation);
                } else {
                    // 降级：分别请求
                    const statsResult = await cachedFetch('/api/dashboard/stats', 'dashboard_stats', 60).catch(() => ({ success: false }));
                    if (statsResult.success) {
                        updateStatsCards(statsResult.data);
                        updateSystemStatus(statsResult.data.system);
                        updateActivityList(statsResult.data.activities);
                    }
                    loadAllocationData();
                }

                // 渲染收益趋势
                if (profitResult.success) {
                    _whenChartJsReady(() => updateProfitChart(profitResult.data));
                }

                // 渲染重仓股
                if (holdingStocksResult.success) updateHoldingStocks(holdingStocksResult.data);

                // 基金涨跌（批量，非阻塞）
                loadFundListChanges();

                console.log('[统一加载] 渲染完成');
            } catch (error) {
                console.error('加载仪表盘数据失败:', error);
                if (isInitialLoad) showNotification('数据加载失败，请刷新页面重试', 'error');
            }
        }

        // 资产配置独立加载（供刷新按钮）
        async function loadAllocationData(forceRefresh = false) {
            try {
                const cacheKey = 'allocation_data';
                if (forceRefresh) DashboardCache.cache.delete(cacheKey);
                const result = await cachedFetch('/api/dashboard/allocation', cacheKey, 120);
                if (result.success && result.data) updateFundTypeDistribution(result.data);
            } catch (e) { console.warn('[allocation] 加载失败:', e); }
        }

        // 更新收益趋势图表
        function updateProfitChart(data) {
            if (!data) return;
            if (data.data_source === 'no_holdings') { showNoHoldingsMessage(); return; }
            if (!profitChart) { _whenChartJsReady(() => { initProfitChart(); updateProfitChart(data); }); return; }
            profitChart.data.labels = data.labels || [];
            profitChart.data.datasets[0].data = data.profit || [];
            profitChart.data.datasets[1].data = data.benchmark || [];
            if (data.benchmark_name) profitChart.data.datasets[1].label = data.benchmark_name;
            profitChart.update('none');
            const chartTitle = document.querySelector('.chart-card .header h3');
            if (chartTitle && data.labels) {
                const benchmarkInfo = data.benchmark_name ? `(${data.benchmark_name}基准)` : '';
                chartTitle.innerHTML = `<i class="bi bi-graph-up-arrow"></i> 近三个月收益趋势 ${benchmarkInfo} (${data.labels.length}个交易日)`;
            }
        }

        // 更新统计卡片
        function updateStatsCards(data) {
            const totalAssetsEl = document.getElementById('totalAssets');
            const assetsChangeEl = document.getElementById('assetsChange');
            const todayProfitEl = document.getElementById('todayProfit');
            const profitChangeEl = document.getElementById('profitChange');
            const holdingCountEl = document.getElementById('holdingCount');
            const newFundChangeEl = document.getElementById('newFundChange');
            const sharpeRatioEl = document.getElementById('sharpeRatio');

            if (totalAssetsEl) { totalAssetsEl.textContent = formatCurrency(data.totalAssets); removeSkeleton(totalAssetsEl); }
            if (assetsChangeEl) {
                const v = data.assetsChange !== undefined ? data.assetsChange : 0;
                assetsChangeEl.innerHTML = `<i class="bi bi-arrow-${v >= 0 ? 'up' : 'down'}"></i> ${Math.abs(v).toFixed(2)}%`;
                assetsChangeEl.className = `change ${v >= 0 ? 'positive' : 'negative'}`;
                removeSkeleton(assetsChangeEl);
            }
            if (todayProfitEl) { todayProfitEl.textContent = formatCurrency(data.todayProfit); removeSkeleton(todayProfitEl); }
            if (profitChangeEl) {
                const v = data.profitChange !== undefined ? data.profitChange : 0;
                profitChangeEl.innerHTML = `<i class="bi bi-arrow-${v >= 0 ? 'up' : 'down'}"></i> ${Math.abs(v).toFixed(2)}%`;
                profitChangeEl.className = `change ${v >= 0 ? 'positive' : 'negative'}`;
                removeSkeleton(profitChangeEl);
            }
            if (holdingCountEl) { holdingCountEl.textContent = data.holdingCount; removeSkeleton(holdingCountEl); }
            if (newFundChangeEl && data.newFundCount !== undefined) {
                newFundChangeEl.innerHTML = `<i class="bi bi-plus-circle"></i> 新增 ${data.newFundCount} 只`;
                removeSkeleton(newFundChangeEl);
            }
            if (sharpeRatioEl) { sharpeRatioEl.textContent = data.sharpeRatio.toFixed(2); removeSkeleton(sharpeRatioEl); }
        }
        // 初始化图表
        function initProfitChart() {
            const canvasEl = document.getElementById('profitChart');
            if (!canvasEl || typeof Chart === 'undefined' || profitChart) return;
            const ctx = canvasEl.getContext('2d');
            profitChart = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: [],
                    datasets: [{
                        label: '累计收益',
                        data: [],
                        borderColor: '#e74c3c',
                        backgroundColor: 'rgba(231, 76, 60, 0.1)',
                        borderWidth: 2, fill: true, tension: 0.4
                    }, {
                        label: '沪深300',
                        data: [],
                        borderColor: '#3498db',
                        backgroundColor: 'rgba(52, 152, 219, 0.1)',
                        borderWidth: 2, fill: true, tension: 0.4
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    animation: { duration: 400 },
                    plugins: { legend: { position: 'top', align: 'end', labels: { usePointStyle: true, padding: 20 } } },
                    scales: {
                        y: { beginAtZero: true, grid: { color: 'rgba(0,0,0,0.05)' } },
                        x: { grid: { display: false } }
                    }
                }
            });
        }

        // ==================== 市场恐贪指数（懒加载） ====================
        async function loadFearGreedIndex() {
            const colorMap = { 'Extreme Fear': '#e74c3c', 'Fear': '#e67e22', 'Neutral': '#f1c40f', 'Greed': '#2ecc71', 'Extreme Greed': '#27ae60' };
            const labelMap = { 'Extreme Fear': '极度恐慌', 'Fear': '恐慌', 'Neutral': '中性', 'Greed': '贪婪', 'Extreme Greed': '极度贪婪' };
            try {
                const result = await cachedFetch('/api/market/fear-greed', 'fear_greed', 3600, 15000);
                if (!result.success || !result.data) throw new Error(result.error || '接口返回异常');
                const data = result.data;
                const color = colorMap[data.classification] || '#aaa';
                const label = labelMap[data.classification] || data.classification;
                renderFearGreedGauge(data.value, color);
                const valueEl = document.getElementById('fearGreedValue');
                const labelEl = document.getElementById('fearGreedLabel');
                const dateEl = document.getElementById('fearGreedDate');
                if (valueEl) { valueEl.textContent = data.value; valueEl.style.color = color; }
                if (labelEl) { labelEl.textContent = label; labelEl.style.color = color; }
                if (dateEl) dateEl.textContent = `更新于 ${data.date || new Date().toLocaleDateString('zh-CN')}`;
                const histList = (data.history || []).slice(0, 7);
                renderFearGreedHistory([...histList].reverse(), colorMap, labelMap);
            } catch (e) {
                const labelEl = document.getElementById('fearGreedLabel');
                if (labelEl) labelEl.textContent = '数据加载失败';
                console.warn('A股恐贪指数加载失败:', e);
            }
        }

        function renderFearGreedGauge(value, color) {
            const container = document.getElementById('fearGreedGauge');
            if (!container) return;
            const angle = -180 + (value / 100) * 180;
            const rad = (angle * Math.PI) / 180;
            const cx = 160, cy = 130, r = 110;
            const nx = cx + r * Math.cos(rad);
            const ny = cy + r * Math.sin(rad);
            const stops = [
                { offset: '0%',   color: '#e74c3c' },
                { offset: '25%',  color: '#e67e22' },
                { offset: '50%',  color: '#f1c40f' },
                { offset: '75%',  color: '#2ecc71' },
                { offset: '100%', color: '#27ae60' }
            ];
            container.innerHTML = `<svg viewBox="0 0 320 150" xmlns="http://www.w3.org/2000/svg" style="width:100%;overflow:visible;">
                <defs><linearGradient id="fgGrad" x1="0%" y1="0%" x2="100%" y2="0%">${stops.map(s => `<stop offset="${s.offset}" stop-color="${s.color}"/>`).join('')}</linearGradient></defs>
                <path d="M 50 130 A 110 110 0 0 1 270 130" fill="none" stroke="#f0f0f0" stroke-width="18" stroke-linecap="round"/>
                <path d="M 50 130 A 110 110 0 0 1 270 130" fill="none" stroke="url(#fgGrad)" stroke-width="18" stroke-linecap="round" opacity="0.85"/>
                <line x1="${cx}" y1="${cy}" x2="${nx.toFixed(1)}" y2="${ny.toFixed(1)}" stroke="${color}" stroke-width="3" stroke-linecap="round"/>
                <circle cx="${cx}" cy="${cy}" r="6" fill="${color}"/>
                <text x="44" y="148" font-size="11" fill="#e74c3c" text-anchor="middle">0</text>
                <text x="160" y="20" font-size="11" fill="#f1c40f" text-anchor="middle">50</text>
                <text x="276" y="148" font-size="11" fill="#27ae60" text-anchor="middle">100</text>
            </svg>`;
        }

        function renderFearGreedHistory(list, colorMap, labelMap) {
            const container = document.getElementById('fearGreedHistory');
            if (!container || !list.length) return;


            const max = 100;
            container.innerHTML = `<div style="font-size:11px;color:#999;margin-bottom:6px;text-align:center;">近7日走势</div>
                <div style="display:flex;gap:4px;align-items:flex-end;justify-content:center;height:50px;">
                    ${list.map(item => {
                        const v = parseInt(item.value);
                        const c = colorMap[item.classification] || '#aaa';
                        const l = labelMap[item.classification] || item.classification;
                        const parts = (item.date || '').split('-');
                        const d = parts.length >= 3 ? `${parseInt(parts[1])}/${parseInt(parts[2])}` : item.date;
                        const h = Math.max(8, (v / max) * 44);
                        return `<div style="flex:1;display:flex;flex-direction:column;align-items:center;gap:2px;" title="${d}: ${v} ${l}">
                            <div style="font-size:9px;color:${c};font-weight:600;">${v}</div>
                            <div style="width:100%;height:${h}px;background:${c};border-radius:3px 3px 0 0;opacity:0.85;"></div>
                            <div style="font-size:9px;color:#bbb;">${d}</div>
                        </div>`;
                    }).join('')}
                </div>`;
        }

        // 显示无持仓数据提示
        function showNoHoldingsMessage() {
            const chartContainer = document.getElementById('profitChart').parentElement;
            chartContainer.innerHTML = `<div style="display:flex;flex-direction:column;align-items:center;justify-content:center;height:300px;background:linear-gradient(135deg,#f8f9fa 0%,#e9ecef 100%);border-radius:12px;border:2px dashed #ced4da;text-align:center;padding:20px;">
                <div style="width:80px;height:80px;background:#e9ecef;border-radius:50%;display:flex;align-items:center;justify-content:center;margin-bottom:20px;"><i class="bi bi-bar-chart" style="font-size:32px;color:#6c757d;"></i></div>
                <h4 style="color:#495057;margin-bottom:10px;">暂无收益数据</h4>
                <p style="color:#6c757d;margin-bottom:20px;max-width:300px;">您还没有添加任何基金持仓，无法生成收益趋势图表</p>
                <a href="/my-holdings-new" class="btn btn-primary" style="background:linear-gradient(135deg,#e74c3c 0%,#c0392b 100%);border:none;padding:10px 20px;border-radius:8px;text-decoration:none;color:white;font-weight:500;">
                    <i class="bi bi-plus-circle me-2"></i>添加基金持仓
                </a></div>`;
        }

        // 更新基金类型分布组件
        function updateFundTypeDistribution(data) {
            const container = document.getElementById('fundTypeDistribution');
            if (!container) return;
            if (!data.distribution || data.distribution.length === 0) {
                container.innerHTML = `<div style="text-align:center;padding:30px 20px;color:#7f8c8d;">
                    <i class="bi bi-grid-3x3" style="font-size:32px;display:block;margin-bottom:10px;opacity:0.5;"></i>
                        <p>暂无基金类型数据</p><p style="font-size:12px;margin-top:8px;">请先导入基金持仓</p>
                </div>`;
                return;
            }
            let html = `<div style="display:grid;grid-template-columns:repeat(auto-fill,minmax(200px,1fr));gap:12px;">`;
            html += data.distribution.map(item => `
                <div style="padding:16px;background:linear-gradient(135deg,${item.color}25 0%,${item.color}20 100%);border-radius:12px;border:1px solid ${item.color}40;position:relative;overflow:hidden;box-shadow:0 4px 15px ${item.color}25;transition:all 0.3s ease;">
                    <div style="position:absolute;top:-10px;right:-10px;width:60px;height:60px;border-radius:50%;background:${item.color}25;display:flex;align-items:center;justify-content:center;">
                        <i class="bi bi-wallet2" style="font-size:24px;color:${item.color};filter:brightness(1.1);"></i>
                    </div>
                    <div style="font-size:13px;color:#555;margin-bottom:4px;font-weight:500;">${item.name}</div>
                    <div style="font-size:24px;font-weight:700;color:${item.color};margin-bottom:8px;">${item.percentage}%</div>
                    <div style="display:flex;justify-content:space-between;align-items:center;font-size:12px;color:#666;">
                        <span><i class="bi bi-collection"></i> ${item.count} 只</span>
                        <span style="font-weight:600;color:#333;">${formatCurrency(item.amount)}</span>
                    </div>
                    <div style="margin-top:10px;height:6px;background:rgba(255,255,255,0.7);border-radius:3px;overflow:hidden;">
                        <div style="width:${item.percentage}%;height:100%;background:linear-gradient(90deg,${item.color},${adjustColorBrightness(item.color, 20)});border-radius:3px;transition:width 0.6s cubic-bezier(0.4,0,0.2,1);"></div>
                    </div>
                </div>`).join('');
            container.innerHTML = html;
        }

        // 更新系统状态
        function updateSystemStatus(system) {
            const lu = document.getElementById('lastUpdate');
            const art = document.getElementById('apiResponseTime');
            const sl = document.getElementById('systemLoad');
            const lb = document.getElementById('loadBar');
            if (lu) lu.textContent = system.lastUpdate;
            if (art) art.textContent = system.apiResponseTime;
            if (sl) sl.textContent = system.load + '%';
            if (lb) { lb.style.width = system.load + '%'; lb.className = 'fill ' + (system.load < 50 ? 'success' : system.load < 80 ? 'warning' : 'danger'); }
        }

        // 更新活动列表
        function updateActivityList(activities) {
            const container = document.getElementById('activityList');
            if (!container) return;
            if (!activities || activities.length === 0) {
                container.innerHTML = `<div class="activity-item"><div class="avatar"><i class="bi bi-info-circle"></i></div><div class="content"><p>暂无活动记录</p><span class="time">开始导入持仓数据以查看活动</span></div></div>`;
                return;
            }
            container.innerHTML = activities.map(a => `
                <div class="activity-item">
                    <div class="avatar"><i class="bi ${a.icon || 'bi-clock'}"></i></div>
                    <div class="content"><p>${a.description || a.detail || ''}</p><span class="time">${a.time || a.date || ''}</span></div>
                </div>`).join('');
        }

        // 更新重仓股显示
        function updateHoldingStocks(data) {
            const container = document.getElementById('holdingStocks');
            const summaryEl = document.getElementById('holdingStocksSummary');
            if (!container) return;
            if (summaryEl) summaryEl.textContent = data.stocks && data.stocks.length > 0 ? `共 ${data.totalFunds} 只基金持仓` : '';
            if (!data.stocks || data.stocks.length === 0) {
                container.innerHTML = `<div style="text-align:center;padding:30px 20px;color:#7f8c8d;"><i class="bi bi-building" style="font-size:32px;display:block;margin-bottom:10px;opacity:0.5;"></i><p>暂无重仓股数据</p></div>`;
                return;
            }
            let html = `<div style="display:flex;justify-content:space-between;align-items:center;padding:8px 12px;background:#f8f9fa;border-radius:6px;margin-bottom:8px;font-size:12px;color:#7f8c8d;font-weight:500;"><span style="flex:1;">股票名称</span><span style="width:80px;text-align:center;">持有基金</span><span style="width:70px;text-align:right;">平均占比</span></div>`;
            html += data.stocks.map((stock, i) => `
                <div style="display:flex;justify-content:space-between;align-items:center;padding:12px;border-bottom:1px solid #f0f0f0;transition:background 0.2s;cursor:pointer;"
                     onmouseover="this.style.background='#f8f9fa'" onmouseout="this.style.background='transparent'"
                     title="所属基金: ${stock.funds.join(', ')}">
                    <div style="flex:1;display:flex;align-items:center;gap:8px;">
                        <span style="width:18px;height:18px;border-radius:4px;background:${i < 3 ? '#e74c3c' : '#3498db'};color:white;display:flex;align-items:center;justify-content:center;font-size:10px;font-weight:600;">${i + 1}</span>
                        <div><div style="font-weight:500;color:#2c3e50;font-size:13px;">${stock.stock_name}</div><div style="font-size:11px;color:#95a5a6;">${stock.stock_code}</div></div>
                    </div>
                    <div style="width:80px;text-align:center;"><span style="background:#e8f4f8;color:#17a2b8;padding:2px 8px;border-radius:12px;font-size:11px;font-weight:500;">${stock.fund_count}只</span></div>
                    <div style="width:70px;text-align:right;"><span style="font-weight:600;color:#2c3e50;font-size:13px;">${stock.avg_ratio}%</span></div>
                </div>`).join('');
            html += `<div style="padding:12px;text-align:center;color:#7f8c8d;font-size:12px;border-top:1px solid #f0f0f0;margin-top:8px;">共 ${data.totalStocks} 只重仓股，显示前 ${data.stocks.length} 只</div>`;
            container.innerHTML = html;
        }

        // 刷新图表
        async function refreshChart(type) {
            DashboardCache.clear();
            showNotification('正在刷新...', 'info');
            try {
                if (type === 'profit') {
                    const data = await cachedFetch('/api/dashboard/profit-trend?days=90&user_id=default_user', 'profit_trend_90', 0);
                    if (data.success) updateProfitChart(data.data);
                } else if (type === 'fear-greed') {
                    await loadFearGreedIndex();
                }
                showNotification('图表已刷新', 'success');
            } catch (error) { showNotification('刷新失败', 'error'); }
        }

        // 格式化货币
        function formatCurrency(value) {
            if (value === null || value === undefined) return '--';
            if (Math.abs(value) >= 100000000) return '¥' + (value / 100000000).toFixed(2) + '亿';
            if (Math.abs(value) >= 10000) return '¥' + (value / 10000).toFixed(2) + '万';
            return '¥' + value.toFixed(2);
        }

        // 显示通知
        function showNotification(message, type = 'info') {
            const n = document.createElement('div');
            n.innerHTML = `<i class="bi bi-${type === 'success' ? 'check-circle' : type === 'error' ? 'exclamation-circle' : 'info-circle'}"></i><span>${message}</span>`;
            n.style.cssText = `position:fixed;top:20px;right:20px;background:${type === 'success' ? '#27ae60' : type === 'error' ? '#e74c3c' : '#3498db'};color:white;padding:12px 20px;border-radius:8px;display:flex;align-items:center;gap:8px;box-shadow:0 4px 12px rgba(0,0,0,0.15);z-index:9999;`;
            document.body.appendChild(n);
            setTimeout(() => { n.style.transition = 'opacity 0.3s'; n.style.opacity = '0'; setTimeout(() => n.remove(), 300); }, 3000);
        }

        // ==================== 基金涨跌（批量优化：N+1→1次请求） ====================
        async function loadFundListChanges() {
            try {
                let fundCodes = null;
                const summaryCache = DashboardCache.get('dashboard_summary');
                if (summaryCache && summaryCache.stats && summaryCache.stats.distribution) {
                    fundCodes = summaryCache.stats.distribution.map(d => d.name).filter(Boolean);
                }
                if (!fundCodes) {
                    const res = await fetch('/api/holdings/list?user_id=default_user');
                    const r = await res.json();
                    if (!r.success || !r.data || r.data.length === 0) { updateFundListChangeDisplay(0, 0, '无持仓'); return; }
                    fundCodes = r.data.map(f => f.fund_code);
                }
                if (!fundCodes || fundCodes.length === 0) { updateFundListChangeDisplay(0, 0, '无持仓'); return; }

                let fundDataResults = [];
                try {
                    const batchResponse = await fetch('/api/funds/realtime-estimates', {
                        method: 'POST', headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ fund_codes: fundCodes.slice(0, 100) })
                    });
                    const batchResult = await batchResponse.json();
                    if (batchResult.success && batchResult.data) fundDataResults = Object.values(batchResult.data);
                } catch (batchErr) {
                    // 降级：分块并行（限制5并发）
                    const CONCURRENCY = 5;
                    for (let i = 0; i < fundCodes.length; i += CONCURRENCY) {
                        const chunk = fundCodes.slice(i, i + CONCURRENCY);
                        const results = await Promise.all(chunk.map(code =>
                            fetch(`/api/fund/${code}/latest`).then(r => r.json()).catch(() => ({ success: false }))
                        ));
                        fundDataResults.push(...results);
                    }
                }

                let totalChange = 0, validFunds = 0, positiveFunds = 0, negativeFunds = 0;
                fundDataResults.forEach(result => {
                    const d = result.data || result;
                    if (d && d.today_return !== undefined) {
                        const change = parseFloat(d.today_return) || 0;
                        totalChange += change; validFunds++;
                        if (change > 0) positiveFunds++; else if (change < 0) negativeFunds++;
                    }
                });
                const avgChange = validFunds > 0 ? totalChange / validFunds : 0;
                updateFundListChangeDisplay(avgChange, validFunds, `${positiveFunds}涨${negativeFunds}跌`);
            } catch (error) {
                console.error('[实时更新] 失败:', error);
                updateFundListChangeDisplay(0, 0, '数据获取失败');
            }
        }

        function updateFundListChangeDisplay(changePercent, fundCount, statusText) {
            const changeElement = document.querySelector('.stat-card.info .change');
            if (!changeElement) return;
            changeElement.classList.add('updated');
            setTimeout(() => changeElement.classList.remove('updated'), 500);
            const icon = changePercent >= 0 ? 'bi-arrow-up' : 'bi-arrow-down';
            changeElement.innerHTML = `<i class="bi ${icon}"></i> ${changePercent >= 0 ? '+' : ''}${Math.abs(changePercent).toFixed(2)}%`;
            changeElement.className = `change ${changePercent >= 0 ? 'positive' : 'negative'}`;
            if (fundCount > 0) {
                let statusEl = changeElement.parentElement.querySelector('.change-description');
                if (!statusEl) {
                    statusEl = document.createElement('div');
                    statusEl.className = 'change-description';
                    statusEl.style.cssText = 'font-size:11px;color:#7f8c8d;margin-top:2px;opacity:0;';
                    changeElement.parentElement.appendChild(statusEl);
                }
                statusEl.textContent = statusText;
                statusEl.style.opacity = '0';
                setTimeout(() => { statusEl.style.transition = 'opacity 0.3s ease'; statusEl.style.opacity = '1'; }, 100);
            }
        }

        // ==================== 自动刷新 ====================
        function startAutoRefresh() {
            setInterval(() => loadAllDashboardData(), 60000);
            setInterval(() => loadFundListChanges(), 30000);
        }

    </script>
</body>
</html>
