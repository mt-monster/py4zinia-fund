<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>编写策略 - 基金分析系统</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.0/font/bootstrap-icons.css" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/echarts@5.4.3/dist/echarts.min.js"></script>
    <style>
        :root {
            --primary-red: #e74c3c;
            --light-red: #fadbd8;
            --success-green: #27ae60;
            --danger-red: #e74c3c;
            --text-dark: #2c3e50;
            --text-muted: #7f8c8d;
            --border-color: #ecf0f1;
            --bg-light: #f8f9fa;
        }
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', 'Microsoft YaHei', sans-serif;
            font-size: 13px;
            background-color: #f5f5f5;
            color: var(--text-dark);
        }
        /* 顶部导航 */
        .top-nav {
            background: linear-gradient(135deg, #e74c3c 0%, #c0392b 100%);
            padding: 8px 20px;
            display: flex;
            align-items: center;
            justify-content: space-between;
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            z-index: 1000;
            height: 50px;
        }
        .top-nav .brand {
            color: white;
            font-size: 18px;
            font-weight: bold;
            display: flex;
            align-items: center;
            gap: 10px;
            text-decoration: none;
        }
        .top-nav .nav-links { display: flex; gap: 20px; }
        .top-nav .nav-links a {
            color: rgba(255,255,255,0.9);
            text-decoration: none;
            font-size: 14px;
            padding: 5px 10px;
            border-radius: 4px;
        }
        .top-nav .nav-links a:hover { background: rgba(255,255,255,0.1); }
        .top-nav .nav-links a.active { background: rgba(255,255,255,0.2); }

        /* 主容器三栏布局 */
        .main-container {
            display: flex;
            height: calc(100vh - 50px);
            margin-top: 50px;
        }

        /* 左侧边栏 - 策略列表 */
        .sidebar-left {
            width: 220px;
            min-width: 180px;
            background: white;
            border-right: 1px solid var(--border-color);
            display: flex;
            flex-direction: column;
            overflow: hidden;
        }
        .sidebar-header {
            padding: 15px;
            border-bottom: 1px solid var(--border-color);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        .sidebar-header h6 {
            margin: 0;
            font-size: 14px;
            font-weight: 600;
        }
        .btn-new-strategy {
            background: var(--primary-red);
            color: white;
            border: none;
            padding: 5px 10px;
            border-radius: 4px;
            font-size: 12px;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 4px;
        }
        .btn-new-strategy:hover { background: #c0392b; }
        .strategy-list {
            flex: 1;
            overflow-y: auto;
            padding: 10px;
        }
        .strategy-item {
            padding: 10px 12px;
            border-radius: 6px;
            cursor: pointer;
            margin-bottom: 5px;
            border: 1px solid transparent;
            transition: all 0.2s;
        }
        .strategy-item:hover { background: var(--bg-light); }
        .strategy-item.active {
            background: var(--light-red);
            border-color: var(--primary-red);
        }
        .strategy-item .strategy-name {
            font-weight: 500;
            font-size: 13px;
            margin-bottom: 3px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        .strategy-item .strategy-desc {
            font-size: 11px;
            color: var(--text-muted);
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
        }
        .strategy-item .strategy-actions {
            display: none;
            gap: 5px;
        }
        .strategy-item:hover .strategy-actions { display: flex; }
        .strategy-item .strategy-actions button {
            background: none;
            border: none;
            padding: 2px 5px;
            cursor: pointer;
            color: var(--text-muted);
            font-size: 12px;
        }
        .strategy-item .strategy-actions button:hover { color: var(--primary-red); }

        /* 中间区域 - 策略配置 */
        .config-panel {
            flex: 1;
            min-width: 400px;
            background: white;
            border-right: 1px solid var(--border-color);
            display: flex;
            flex-direction: column;
            overflow: hidden;
        }
        .config-header {
            padding: 15px 20px;
            border-bottom: 1px solid var(--border-color);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        .config-header h5 {
            margin: 0;
            font-size: 16px;
            font-weight: 600;
        }
        .config-actions {
            display: flex;
            gap: 10px;
        }
        .btn-save {
            background: var(--success-green);
            color: white;
            border: none;
            padding: 6px 15px;
            border-radius: 4px;
            font-size: 13px;
            cursor: pointer;
        }
        .btn-save:hover { background: #219a52; }
        .btn-run {
            background: var(--primary-red);
            color: white;
            border: none;
            padding: 6px 15px;
            border-radius: 4px;
            font-size: 13px;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 5px;
        }
        .btn-run:hover { background: #c0392b; }
        .config-body {
            flex: 1;
            overflow-y: auto;
            padding: 20px;
        }

        /* 配置区块 */
        .config-section {
            margin-bottom: 25px;
        }
        .config-section-title {
            font-size: 14px;
            font-weight: 600;
            margin-bottom: 12px;
            color: var(--text-dark);
            display: flex;
            align-items: center;
            gap: 8px;
            cursor: pointer;
        }
        .config-section-title i { color: var(--primary-red); }
        .config-section-title .collapse-icon {
            margin-left: auto;
            transition: transform 0.2s;
        }
        .config-section-title.collapsed .collapse-icon { transform: rotate(-90deg); }
        .config-section-content {
            background: var(--bg-light);
            border-radius: 8px;
            padding: 15px;
        }
        .config-section-content.collapsed { display: none; }

        /* 表单样式 */
        .form-group {
            margin-bottom: 15px;
        }
        .form-group:last-child { margin-bottom: 0; }
        .form-label {
            display: block;
            font-size: 12px;
            font-weight: 500;
            margin-bottom: 5px;
            color: var(--text-dark);
        }
        .form-control {
            width: 100%;
            padding: 8px 12px;
            border: 1px solid #ddd;
            border-radius: 4px;
            font-size: 13px;
            transition: border-color 0.2s;
        }
        .form-control:focus {
            outline: none;
            border-color: var(--primary-red);
        }
        .form-control-sm {
            padding: 5px 10px;
            font-size: 12px;
        }
        .form-select {
            width: 100%;
            padding: 8px 12px;
            border: 1px solid #ddd;
            border-radius: 4px;
            font-size: 13px;
            background: white;
        }
        .form-row {
            display: flex;
            gap: 15px;
        }
        .form-row .form-group { flex: 1; }
        .form-check {
            display: flex;
            align-items: center;
            gap: 8px;
        }
        .form-check-input {
            width: 16px;
            height: 16px;
        }
        .form-check-label {
            font-size: 13px;
        }
        .form-help {
            font-size: 11px;
            color: #999;
            margin-top: 4px;
        }
        .form-hint {
            display: inline-block;
            width: 14px;
            height: 14px;
            line-height: 14px;
            text-align: center;
            background: #ddd;
            border-radius: 50%;
            font-size: 10px;
            color: #666;
            cursor: help;
            margin-left: 4px;
        }

        /* 筛选条件列表 */
        .filter-list {
            margin-bottom: 10px;
        }
        .filter-item {
            display: flex;
            align-items: center;
            gap: 10px;
            padding: 8px 10px;
            background: white;
            border-radius: 4px;
            margin-bottom: 8px;
            border: 1px solid #eee;
            transition: border-color 0.2s;
        }
        .filter-item:hover {
            border-color: var(--primary-red);
        }
        .filter-item select, .filter-item input {
            padding: 5px 8px;
            border: 1px solid #ddd;
            border-radius: 4px;
            font-size: 12px;
        }
        .filter-item select:focus, .filter-item input:focus {
            outline: none;
            border-color: var(--primary-red);
        }
        .filter-item .filter-field { width: 130px; }
        .filter-item .filter-operator { width: 80px; }
        .filter-item .filter-value { flex: 1; min-width: 80px; }
        .filter-item .btn-remove {
            background: none;
            border: none;
            color: var(--danger-red);
            cursor: pointer;
            padding: 5px;
            opacity: 0.6;
            transition: opacity 0.2s;
        }
        .filter-item .btn-remove:hover {
            opacity: 1;
        }
        .filter-hint {
            font-size: 10px;
            color: #999;
            margin: -5px 0 8px 10px;
        }
        .btn-add-filter {
            background: white;
            border: 1px dashed #ddd;
            padding: 8px 15px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 12px;
            color: var(--text-muted);
            width: 100%;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 5px;
        }
        .btn-add-filter:hover {
            border-color: var(--primary-red);
            color: var(--primary-red);
        }

        /* 右侧区域 - 回测结果 */
        .result-panel {
            flex: 1;
            min-width: 400px;
            background: var(--bg-light);
            display: flex;
            flex-direction: column;
            overflow: hidden;
        }
        .result-header {
            padding: 15px 20px;
            background: white;
            border-bottom: 1px solid var(--border-color);
        }
        .result-header h5 {
            margin: 0;
            font-size: 16px;
            font-weight: 600;
        }
        .result-body {
            flex: 1;
            overflow-y: auto;
            padding: 20px;
        }
        .result-empty {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            height: 100%;
            color: var(--text-muted);
        }
        .result-empty i {
            font-size: 48px;
            margin-bottom: 15px;
            color: #ddd;
        }

        /* 收益概况卡片 */
        .metrics-cards {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 15px;
            margin-bottom: 20px;
        }
        .metric-card {
            background: white;
            border-radius: 8px;
            padding: 15px;
            text-align: center;
            box-shadow: 0 1px 3px rgba(0,0,0,0.1);
        }
        .metric-card .metric-value {
            font-size: 24px;
            font-weight: bold;
            margin-bottom: 5px;
        }
        .metric-card .metric-label {
            font-size: 12px;
            color: var(--text-muted);
        }
        .positive { color: var(--danger-red); }
        .negative { color: var(--success-green); }

        /* 图表区域 */
        .chart-section {
            background: white;
            border-radius: 8px;
            padding: 15px;
            margin-bottom: 20px;
            box-shadow: 0 1px 3px rgba(0,0,0,0.1);
        }
        .chart-section .chart-title {
            font-size: 14px;
            font-weight: 600;
            margin-bottom: 15px;
            display: flex;
            align-items: center;
            gap: 8px;
        }
        .chart-section .chart-title i { color: var(--primary-red); }
        .chart-container {
            height: 300px;
        }
        .period-tabs {
            display: flex;
            gap: 5px;
            margin-left: auto;
        }
        .period-tabs .tab {
            padding: 4px 10px;
            border: 1px solid #ddd;
            border-radius: 4px;
            cursor: pointer;
            font-size: 11px;
            background: white;
        }
        .period-tabs .tab:hover { background: var(--bg-light); }
        .period-tabs .tab.active {
            background: var(--primary-red);
            color: white;
            border-color: var(--primary-red);
        }

        /* 交易记录表格 */
        .trades-section {
            background: white;
            border-radius: 8px;
            padding: 15px;
            box-shadow: 0 1px 3px rgba(0,0,0,0.1);
        }
        .trades-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
        }
        .trades-header h6 {
            margin: 0;
            font-size: 14px;
            font-weight: 600;
        }
        .trades-filters {
            display: flex;
            gap: 10px;
            align-items: center;
        }
        .trades-filters input, .trades-filters select {
            padding: 5px 10px;
            border: 1px solid #ddd;
            border-radius: 4px;
            font-size: 12px;
        }
        .btn-export {
            background: white;
            border: 1px solid #ddd;
            padding: 5px 12px;
            border-radius: 4px;
            font-size: 12px;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 5px;
        }
        .btn-export:hover { background: var(--bg-light); }
        .trades-table {
            width: 100%;
            border-collapse: collapse;
            font-size: 12px;
        }
        .trades-table th {
            background: var(--bg-light);
            padding: 10px 8px;
            text-align: left;
            font-weight: 500;
            border-bottom: 1px solid var(--border-color);
        }
        .trades-table td {
            padding: 10px 8px;
            border-bottom: 1px solid #f0f0f0;
        }
        .trades-table tr:hover { background: #fafafa; }
        .badge-buy {
            background: #d4edda;
            color: #155724;
            padding: 2px 8px;
            border-radius: 10px;
            font-size: 11px;
        }
        .badge-sell {
            background: #f8d7da;
            color: #721c24;
            padding: 2px 8px;
            border-radius: 10px;
            font-size: 11px;
        }
        .badge-stop-loss {
            background: #fff3cd;
            color: #856404;
            padding: 2px 8px;
            border-radius: 10px;
            font-size: 11px;
        }
        .badge-take-profit {
            background: #d4edda;
            color: #155724;
            padding: 2px 8px;
            border-radius: 10px;
            font-size: 11px;
        }

        /* 收益卡片增强样式 */
        .metric-card .metric-desc {
            font-size: 10px;
            color: #aaa;
            margin-top: 3px;
        }

        /* 图表图例样式 */
        .chart-legend {
            display: flex;
            justify-content: center;
            gap: 20px;
            margin-top: 10px;
            font-size: 12px;
        }
        .legend-item {
            display: flex;
            align-items: center;
            gap: 5px;
        }
        .legend-color {
            width: 12px;
            height: 3px;
            border-radius: 2px;
        }

        /* 风险指标评级样式 */
        .risk-item .risk-rating {
            font-size: 10px;
            padding: 2px 6px;
            border-radius: 3px;
            margin-top: 3px;
            display: inline-block;
        }
        .risk-item .risk-benchmark {
            font-size: 9px;
            color: #999;
            margin-top: 3px;
        }
        .risk-item.rating-excellent .risk-rating {
            background: #d4edda;
            color: #155724;
        }
        .risk-item.rating-good .risk-rating {
            background: #cce5ff;
            color: #004085;
        }
        .risk-item.rating-fair .risk-rating {
            background: #fff3cd;
            color: #856404;
        }
        .risk-item.rating-poor .risk-rating {
            background: #f8d7da;
            color: #721c24;
        }

        /* 风险帮助面板 */
        .risk-help-btn {
            cursor: pointer;
            color: var(--text-muted);
            margin-left: 10px;
        }
        .risk-help-btn:hover {
            color: var(--primary-red);
        }
        .risk-help-panel {
            background: #f8f9fa;
            border-radius: 6px;
            padding: 15px;
            margin-bottom: 15px;
            font-size: 12px;
            line-height: 1.8;
        }
        .risk-help-content p {
            margin-bottom: 8px;
        }
        .risk-help-content p:last-child {
            margin-bottom: 0;
        }

        /* 交易表格增强样式 */
        .trades-table th {
            background: var(--bg-light);
            padding: 10px 8px;
            text-align: left;
            font-weight: 500;
            border-bottom: 1px solid var(--border-color);
            position: sticky;
            top: 0;
            z-index: 1;
        }
        .trades-table .fund-code {
            font-family: monospace;
            background: #f0f0f0;
            padding: 2px 5px;
            border-radius: 3px;
            font-size: 11px;
        }
        .trades-table .trade-reason {
            max-width: 150px;
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
            font-size: 11px;
            color: var(--text-muted);
        }
        .trades-table .text-danger {
            color: var(--danger-red);
        }
        .trades-table .text-success {
            color: var(--success-green);
        }

        /* 筛选清除按钮 */
        .btn-filter-clear {
            background: none;
            border: 1px solid #ddd;
            padding: 5px 8px;
            border-radius: 4px;
            cursor: pointer;
            color: var(--text-muted);
        }
        .btn-filter-clear:hover {
            background: var(--bg-light);
            color: var(--danger-red);
        }

        /* 交易筛选输入框样式 */
        .trades-filters input[type="text"] {
            padding: 5px 10px;
            border: 1px solid #ddd;
            border-radius: 4px;
            font-size: 12px;
        }

        /* 风险指标面板 */
        .risk-section {
            background: white;
            border-radius: 8px;
            padding: 15px;
            margin-bottom: 20px;
            box-shadow: 0 1px 3px rgba(0,0,0,0.1);
        }
        .risk-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(120px, 1fr));
            gap: 15px;
        }
        .risk-item {
            text-align: center;
            padding: 10px;
            background: var(--bg-light);
            border-radius: 6px;
        }
        .risk-item .risk-value {
            font-size: 18px;
            font-weight: 600;
            margin-bottom: 3px;
        }
        .risk-item .risk-label {
            font-size: 11px;
            color: var(--text-muted);
        }
        .risk-item .risk-hint {
            font-size: 10px;
            color: #aaa;
            margin-top: 3px;
        }

        /* 加载状态 */
        .loading-overlay {
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(255,255,255,0.8);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 100;
        }
        .spinner {
            width: 30px;
            height: 30px;
            border: 3px solid #f3f3f3;
            border-top: 3px solid var(--primary-red);
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        /* 内置策略按钮行样式 */
        .builtin-strategies {
            padding: 10px 15px;
            border-bottom: 1px solid var(--border-color);
            background: var(--bg-light);
        }
        .builtin-strategies-title {
            font-size: 11px;
            color: var(--text-muted);
            margin-bottom: 8px;
            display: flex;
            align-items: center;
            gap: 5px;
        }
        .builtin-strategies-list {
            display: flex;
            flex-wrap: wrap;
            gap: 6px;
        }
        .builtin-btn {
            background: white;
            border: 1px solid #ddd;
            padding: 5px 10px;
            border-radius: 4px;
            font-size: 11px;
            cursor: pointer;
            color: var(--text-dark);
            transition: all 0.2s;
            display: flex;
            align-items: center;
            gap: 4px;
            white-space: nowrap;
        }
        .builtin-btn:hover {
            border-color: var(--primary-red);
            color: var(--primary-red);
            background: var(--light-red);
        }
        .builtin-btn:disabled {
            opacity: 0.6;
            cursor: not-allowed;
        }
        .builtin-btn .spinner-small {
            width: 12px;
            height: 12px;
            border: 2px solid #f3f3f3;
            border-top: 2px solid var(--primary-red);
            border-radius: 50%;
            animation: spin 0.8s linear infinite;
        }
        .builtin-strategies-loading {
            text-align: center;
            padding: 10px;
            color: var(--text-muted);
            font-size: 11px;
        }

        /* 响应式设计 */
        @media (max-width: 1200px) {
            .main-container { flex-wrap: wrap; }
            .sidebar-left { width: 100%; min-height: 200px; border-right: none; border-bottom: 1px solid var(--border-color); }
            .config-panel, .result-panel { min-width: 100%; }
        }

        /* Toast动画 */
        @keyframes slideIn {
            from { transform: translateX(100%); opacity: 0; }
            to { transform: translateX(0); opacity: 1; }
        }
        @keyframes slideOut {
            from { transform: translateX(0); opacity: 1; }
            to { transform: translateX(100%); opacity: 0; }
        }

        /* 表单验证样式 */
        .form-control.is-invalid,
        .form-select.is-invalid {
            border-color: var(--danger-red);
            background-image: url("data:image/svg+xml,%3csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 12 12' width='12' height='12' fill='none' stroke='%23e74c3c'%3e%3ccircle cx='6' cy='6' r='4.5'/%3e%3cpath stroke-linejoin='round' d='M5.8 3.6h.4L6 6.5z'/%3e%3ccircle cx='6' cy='8.2' r='.6' fill='%23e74c3c' stroke='none'/%3e%3c/svg%3e");
            background-repeat: no-repeat;
            background-position: right 10px center;
            background-size: 16px 16px;
            padding-right: 35px;
        }
        .form-control.is-valid,
        .form-select.is-valid {
            border-color: var(--success-green);
        }
        .invalid-feedback {
            display: none;
            color: var(--danger-red);
            font-size: 11px;
            margin-top: 4px;
        }
        .form-control.is-invalid ~ .invalid-feedback,
        .form-select.is-invalid ~ .invalid-feedback {
            display: block;
        }

        /* 保存按钮状态 */
        .btn-save.saving {
            opacity: 0.7;
            pointer-events: none;
        }
        .btn-save.saving::after {
            content: '';
            display: inline-block;
            width: 12px;
            height: 12px;
            border: 2px solid white;
            border-top-color: transparent;
            border-radius: 50%;
            animation: spin 0.8s linear infinite;
            margin-left: 8px;
        }

        /* 回测进度条 */
        .backtest-progress {
            background: white;
            border-radius: 8px;
            padding: 30px;
            text-align: center;
        }
        .progress-bar-container {
            width: 100%;
            height: 8px;
            background: #eee;
            border-radius: 4px;
            margin: 20px 0;
            overflow: hidden;
        }
        .progress-bar-fill {
            height: 100%;
            background: linear-gradient(90deg, var(--primary-red), #c0392b);
            border-radius: 4px;
            transition: width 0.3s ease;
        }
        .progress-text {
            font-size: 14px;
            color: var(--text-muted);
            margin-top: 10px;
        }
        .progress-percentage {
            font-size: 24px;
            font-weight: bold;
            color: var(--primary-red);
        }

        /* 模态框 */
        .modal-backdrop {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0,0,0,0.5);
            z-index: 2000;
            display: none;
        }
        .modal-backdrop.show { display: flex; align-items: center; justify-content: center; }
        .modal-dialog {
            background: white;
            border-radius: 8px;
            width: 400px;
            max-width: 90%;
            box-shadow: 0 4px 20px rgba(0,0,0,0.2);
        }
        .modal-header {
            padding: 15px 20px;
            border-bottom: 1px solid var(--border-color);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        .modal-header h5 { margin: 0; font-size: 16px; }
        .modal-close {
            background: none;
            border: none;
            font-size: 20px;
            cursor: pointer;
            color: var(--text-muted);
        }
        .modal-body { padding: 20px; }
        .modal-footer {
            padding: 15px 20px;
            border-top: 1px solid var(--border-color);
            display: flex;
            justify-content: flex-end;
            gap: 10px;
        }
        .btn-secondary {
            background: #6c757d;
            color: white;
            border: none;
            padding: 8px 16px;
            border-radius: 4px;
            cursor: pointer;
        }
        .btn-primary {
            background: var(--primary-red);
            color: white;
            border: none;
            padding: 8px 16px;
            border-radius: 4px;
            cursor: pointer;
        }
    </style>
</head>
<body>

    <!-- 顶部导航 -->
    <div class="top-nav">
        <a href="/" class="brand">
            <i class="bi bi-graph-up-arrow"></i>
            <span>投资账本</span>
        </a>
        <div class="nav-links">
            <a href="/"><i class="bi bi-house"></i> 首页</a>
            <a href="/etf"><i class="bi bi-bar-chart"></i> ETF市场</a>
            <a href="/strategy"><i class="bi bi-lightbulb"></i> 策略分析</a>
            <a href="/strategy-editor" class="active"><i class="bi bi-pencil-square"></i> 编写策略</a>
        </div>
    </div>

    <!-- 主容器 -->
    <div class="main-container">
        <!-- 左侧边栏 - 策略列表 -->
        <div class="sidebar-left">
            <div class="sidebar-header">
                <h6><i class="bi bi-folder2-open"></i> 我的策略</h6>
                <button class="btn-new-strategy" onclick="createNewStrategy()">
                    <i class="bi bi-plus"></i> 新建
                </button>
            </div>
            <!-- 内置策略按钮行 -->
            <div class="builtin-strategies" id="builtin-strategies-container">
                <div class="builtin-strategies-title">
                    <i class="bi bi-lightning"></i> 快速应用内置策略
                </div>
                <div class="builtin-strategies-list" id="builtin-strategies-list">
                    <div class="builtin-strategies-loading">
                        <div class="spinner" style="width:16px;height:16px;margin:0 auto;"></div>
                        <div style="margin-top:5px;">加载中...</div>
                    </div>
                </div>
            </div>
            <div class="strategy-list" id="strategy-list">
                <!-- 策略列表将通过JS动态加载 -->
                <div class="text-center text-muted py-4">
                    <div class="spinner"></div>
                    <div class="mt-2">加载中...</div>
                </div>
            </div>
        </div>

        <!-- 中间区域 - 策略配置 -->
        <div class="config-panel">
            <div class="config-header">
                <h5><i class="bi bi-gear"></i> 策略配置</h5>
                <div class="config-actions">
                    <button class="btn-save" onclick="saveStrategy()">
                        <i class="bi bi-save"></i> 保存
                    </button>
                    <button class="btn-run" onclick="runBacktest()">
                        <i class="bi bi-play-fill"></i> 运行回测
                    </button>
                </div>
            </div>
            <div class="config-body">
                <!-- 基本信息 -->
                <div class="config-section">
                    <div class="config-section-title" onclick="toggleSection(this)">
                        <i class="bi bi-info-circle"></i> 基本信息
                        <i class="bi bi-chevron-down collapse-icon"></i>
                    </div>
                    <div class="config-section-content">
                        <div class="form-group">
                            <label class="form-label">策略名称 *</label>
                            <input type="text" class="form-control" id="strategy-name" placeholder="输入策略名称">
                        </div>
                        <div class="form-group">
                            <label class="form-label">策略描述</label>
                            <textarea class="form-control" id="strategy-desc" rows="2" placeholder="描述策略的投资逻辑"></textarea>
                        </div>
                    </div>
                </div>

                <!-- 筛选条件 -->
                <div class="config-section">
                    <div class="config-section-title" onclick="toggleSection(this)">
                        <i class="bi bi-funnel"></i> 筛选条件
                        <i class="bi bi-chevron-down collapse-icon"></i>
                    </div>
                    <div class="config-section-content">
                        <div class="form-row" style="margin-bottom: 15px;">
                            <div class="form-group">
                                <label class="form-label">条件组合逻辑</label>
                                <select class="form-select" id="filter-logic" style="width: 140px;">
                                    <option value="AND">全部满足 (AND)</option>
                                    <option value="OR">满足任一 (OR)</option>
                                </select>
                            </div>
                            <div class="form-group">
                                <label class="form-label">快速添加预设</label>
                                <select class="form-select" id="filter-preset" style="width: 160px;" onchange="addPresetFilter(this.value)">
                                    <option value="">选择预设条件...</option>
                                    <option value="quality">优质基金筛选</option>
                                    <option value="growth">成长型筛选</option>
                                    <option value="value">价值型筛选</option>
                                    <option value="low_risk">低风险筛选</option>
                                    <option value="exclude_st">排除ST/停牌</option>
                                </select>
                            </div>
                        </div>
                        <div class="filter-list" id="filter-list">
                            <!-- 筛选条件将通过JS动态添加 -->
                        </div>
                        <div style="display: flex; gap: 10px;">
                            <button class="btn-add-filter" onclick="addFilterCondition()" style="flex: 1;">
                                <i class="bi bi-plus-circle"></i> 添加筛选条件
                            </button>
                            <button class="btn-add-filter" onclick="clearAllFilters()" style="width: auto; color: var(--danger-red);" title="清空所有筛选条件">
                                <i class="bi bi-trash"></i> 清空
                            </button>
                        </div>
                    </div>
                </div>

                <!-- 排序选股 -->
                <div class="config-section">
                    <div class="config-section-title" onclick="toggleSection(this)">
                        <i class="bi bi-sort-down"></i> 排序选股
                        <i class="bi bi-chevron-down collapse-icon"></i>
                    </div>
                    <div class="config-section-content">
                        <div class="form-row">
                            <div class="form-group">
                                <label class="form-label">排序字段</label>
                                <select class="form-select" id="sort-field">
                                    <option value="composite_score">综合评分</option>
                                    <option value="sharpe_ratio">夏普比率</option>
                                    <option value="annualized_return">年化收益率</option>
                                    <option value="max_drawdown">最大回撤</option>
                                    <option value="volatility">波动率</option>
                                    <option value="market_cap">市值</option>
                                    <option value="pe_ttm">市盈率TTM</option>
                                    <option value="pb">市净率</option>
                                </select>
                                <div class="form-help">按此字段对筛选后的基金进行排序</div>
                            </div>
                            <div class="form-group">
                                <label class="form-label">排序方向</label>
                                <select class="form-select" id="sort-order">
                                    <option value="DESC">降序 (高到低)</option>
                                    <option value="ASC">升序 (低到高)</option>
                                </select>
                            </div>
                        </div>
                        <div class="form-row">
                            <div class="form-group">
                                <label class="form-label">选股数量</label>
                                <input type="number" class="form-control" id="select-count" value="10" min="1" max="100">
                                <div class="form-help">从排序结果中选取前N只基金</div>
                            </div>
                            <div class="form-group">
                                <label class="form-label">权重模式</label>
                                <select class="form-select" id="weight-mode">
                                    <option value="equal">等权重</option>
                                    <option value="custom">自定义权重</option>
                                </select>
                                <div class="form-help">等权重：每只基金分配相同比例资金</div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- 交易规则 -->
                <div class="config-section">
                    <div class="config-section-title" onclick="toggleSection(this)">
                        <i class="bi bi-arrow-left-right"></i> 交易规则
                        <i class="bi bi-chevron-down collapse-icon"></i>
                    </div>
                    <div class="config-section-content">
                        <div class="form-group">
                            <label class="form-label">最大持仓数 <span class="form-hint" title="同时持有的最大基金数量">?</span></label>
                            <input type="number" class="form-control" id="max-positions" value="10" min="1" max="100">
                            <div class="form-help">同时持有的最大基金数量，超出时按排序优先级保留</div>
                        </div>
                        <div class="form-group">
                            <div class="form-check">
                                <input type="checkbox" class="form-check-input" id="trade-on-hold-day">
                                <label class="form-check-label" for="trade-on-hold-day">持仓当日允许交易</label>
                            </div>
                            <div class="form-help">勾选后，当日买入的基金可以在当日卖出</div>
                        </div>
                        <div class="form-group">
                            <label class="form-label">买入条件</label>
                            <input type="text" class="form-control" id="buy-condition" placeholder="如: 不在持仓中的基金">
                            <div class="form-help">满足此条件时执行买入操作</div>
                        </div>
                        <div class="form-group">
                            <label class="form-label">卖出条件</label>
                            <input type="text" class="form-control" id="sell-condition" placeholder="如: 不在目标持仓中的基金">
                            <div class="form-help">满足此条件时执行卖出操作</div>
                        </div>
                    </div>
                </div>

                <!-- 风险控制 -->
                <div class="config-section">
                    <div class="config-section-title" onclick="toggleSection(this)">
                        <i class="bi bi-shield-check"></i> 风险控制
                        <i class="bi bi-chevron-down collapse-icon"></i>
                    </div>
                    <div class="config-section-content">
                        <div class="form-row">
                            <div class="form-group">
                                <label class="form-label">每日止损 (%)</label>
                                <input type="number" class="form-control" id="daily-stop-loss" value="-5" step="0.1">
                                <div class="form-help">单日亏损达到此比例时触发止损</div>
                            </div>
                            <div class="form-group">
                                <label class="form-label">每日止盈 (%)</label>
                                <input type="number" class="form-control" id="daily-take-profit" value="10" step="0.1">
                                <div class="form-help">单日盈利达到此比例时触发止盈</div>
                            </div>
                        </div>
                        <div class="form-row">
                            <div class="form-group">
                                <label class="form-label">累计止损 (%)</label>
                                <input type="number" class="form-control" id="total-stop-loss" value="-15" step="0.1">
                                <div class="form-help">累计亏损达到此比例时清仓止损</div>
                            </div>
                            <div class="form-group">
                                <label class="form-label">追踪止损 (%)</label>
                                <input type="number" class="form-control" id="trailing-stop" value="0" step="0.1" min="0">
                                <div class="form-help">从最高点回撤此比例时触发止损，0表示不启用</div>
                            </div>
                        </div>
                        <div class="form-group">
                            <div class="form-check">
                                <input type="checkbox" class="form-check-input" id="volatility-adjustment">
                                <label class="form-check-label" for="volatility-adjustment">启用波动率调整</label>
                            </div>
                            <div class="form-help">根据市场波动率动态调整仓位大小</div>
                        </div>
                    </div>
                </div>

                <!-- 回测参数 -->
                <div class="config-section">
                    <div class="config-section-title" onclick="toggleSection(this)">
                        <i class="bi bi-calendar-range"></i> 回测参数
                        <i class="bi bi-chevron-down collapse-icon"></i>
                    </div>
                    <div class="config-section-content">
                        <div class="form-row">
                            <div class="form-group">
                                <label class="form-label">开始日期</label>
                                <input type="date" class="form-control" id="backtest-start">
                            </div>
                            <div class="form-group">
                                <label class="form-label">结束日期</label>
                                <input type="date" class="form-control" id="backtest-end">
                            </div>
                        </div>
                        <div class="form-row">
                            <div class="form-group">
                                <label class="form-label">初始资金</label>
                                <input type="number" class="form-control" id="initial-capital" value="100000" min="1000">
                            </div>
                            <div class="form-group">
                                <label class="form-label">调仓频率</label>
                                <select class="form-select" id="rebalance-freq">
                                    <option value="daily">每日</option>
                                    <option value="weekly">每周</option>
                                    <option value="monthly" selected>每月</option>
                                </select>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- 右侧区域 - 回测结果 -->
        <div class="result-panel">
            <div class="result-header">
                <h5><i class="bi bi-graph-up"></i> 回测结果</h5>
            </div>
            <div class="result-body" id="result-body">
                <div class="result-empty">
                    <i class="bi bi-bar-chart-line"></i>
                    <p>配置策略后点击"运行回测"查看结果</p>
                </div>
            </div>
        </div>
    </div>

    <!-- 重命名模态框 -->
    <div class="modal-backdrop" id="rename-modal">
        <div class="modal-dialog">
            <div class="modal-header">
                <h5>重命名策略</h5>
                <button class="modal-close" onclick="closeRenameModal()">&times;</button>
            </div>
            <div class="modal-body">
                <div class="form-group">
                    <label class="form-label">新名称</label>
                    <input type="text" class="form-control" id="rename-input">
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn-secondary" onclick="closeRenameModal()">取消</button>
                <button class="btn-primary" onclick="confirmRename()">确定</button>
            </div>
        </div>
    </div>

    <!-- 删除确认模态框 -->
    <div class="modal-backdrop" id="delete-modal">
        <div class="modal-dialog">
            <div class="modal-header">
                <h5>删除策略</h5>
                <button class="modal-close" onclick="closeDeleteModal()">&times;</button>
            </div>
            <div class="modal-body">
                <p>确定要删除策略 "<span id="delete-strategy-name"></span>" 吗？此操作不可恢复。</p>
            </div>
            <div class="modal-footer">
                <button class="btn-secondary" onclick="closeDeleteModal()">取消</button>
                <button class="btn-primary" style="background: var(--danger-red);" onclick="confirmDelete()">删除</button>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        // ==================== 全局状态 ====================
        let strategies = [];
        let currentStrategyId = null;
        let backtestResult = null;
        let equityChart = null;
        let renameStrategyId = null;
        let deleteStrategyId = null;

        // 支持的筛选字段 - 与后端 SUPPORTED_FILTER_FIELDS 保持一致
        const FILTER_FIELDS = {
            'list_days': { label: '上市天数', type: 'numeric', hint: '基金上市交易天数' },
            'pe_ttm': { label: '市盈率TTM', type: 'numeric', hint: '滚动市盈率' },
            'pb': { label: '市净率', type: 'numeric', hint: '市净率' },
            'market_cap': { label: '市值(亿)', type: 'numeric', hint: '基金市值，单位亿元' },
            'market_cap_rank': { label: '市值排名%', type: 'numeric', hint: '市值排名百分比，0-100' },
            'volatility': { label: '波动率', type: 'numeric', hint: '年化波动率，如0.2表示20%' },
            'sharpe_ratio': { label: '夏普比率', type: 'numeric', hint: '风险调整后收益' },
            'max_drawdown': { label: '最大回撤', type: 'numeric', hint: '最大回撤，如-0.15表示-15%' },
            'annualized_return': { label: '年化收益率', type: 'numeric', hint: '年化收益率，如0.2表示20%' },
            'composite_score': { label: '综合评分', type: 'numeric', hint: '综合评分，0-100' },
            'is_st': { label: '是否ST', type: 'boolean', hint: '是否为ST股票' },
            'is_suspended': { label: '是否停牌', type: 'boolean', hint: '是否处于停牌状态' },
            'fund_type': { label: '基金类型', type: 'string', hint: '基金类型，如ETF、LOF等' }
        };

        const FILTER_OPERATORS = {
            '>': '大于',
            '<': '小于',
            '>=': '大于等于',
            '<=': '小于等于',
            '==': '等于',
            '!=': '不等于'
        };
        
        // 布尔类型字段的值选项
        const BOOLEAN_VALUES = {
            'true': '是',
            'false': '否'
        };

        // ==================== 初始化 ====================
        document.addEventListener('DOMContentLoaded', () => {
            initDateInputs();
            loadStrategies();
            loadBuiltinStrategies();
        });

        function initDateInputs() {
            const today = new Date();
            const oneYearAgo = new Date(today);
            oneYearAgo.setFullYear(today.getFullYear() - 1);
            
            document.getElementById('backtest-end').value = today.toISOString().split('T')[0];
            document.getElementById('backtest-start').value = oneYearAgo.toISOString().split('T')[0];
        }

        // ==================== 内置策略管理 ====================
        async function loadBuiltinStrategies() {
            const container = document.getElementById('builtin-strategies-list');
            
            try {
                const response = await fetch('/api/builtin-strategies');
                const result = await response.json();
                
                if (result.success && result.data && result.data.length > 0) {
                    container.innerHTML = result.data.map(strategy => `
                        <button class="builtin-btn" 
                                data-key="${escapeHtml(strategy.key)}" 
                                onclick="applyBuiltinStrategy('${escapeHtml(strategy.key)}')"
                                title="${escapeHtml(strategy.description || strategy.name)}">
                            <i class="bi bi-lightning-charge"></i>
                            ${escapeHtml(strategy.name)}
                        </button>
                    `).join('');
                } else {
                    container.innerHTML = '<div class="builtin-strategies-loading">暂无内置策略</div>';
                }
            } catch (error) {
                console.error('加载内置策略失败:', error);
                container.innerHTML = '<div class="builtin-strategies-loading">加载失败</div>';
            }
        }

        async function applyBuiltinStrategy(key) {
            // 获取按钮元素
            const btn = document.querySelector(`.builtin-btn[data-key="${key}"]`);
            if (!btn) return;
            
            // 保存原始内容
            const originalContent = btn.innerHTML;
            
            // 显示加载状态
            btn.disabled = true;
            btn.innerHTML = '<span class="spinner-small"></span> 应用中...';
            
            try {
                const response = await fetch(`/api/builtin-strategies/${key}/apply`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({})
                });
                
                const result = await response.json();
                
                if (result.success) {
                    showSuccess(`已创建策略: ${result.data.name}`);
                    
                    // 刷新策略列表
                    await loadStrategies();
                    
                    // 选中新创建的策略
                    if (result.data.id) {
                        await selectStrategy(result.data.id);
                    }
                } else {
                    showError('应用策略失败: ' + (result.error || '未知错误'));
                }
            } catch (error) {
                console.error('应用内置策略失败:', error);
                showError('应用策略失败: ' + error.message);
            } finally {
                // 恢复按钮状态
                btn.disabled = false;
                btn.innerHTML = originalContent;
            }
        }

        // ==================== 策略列表管理 ====================
        async function loadStrategies() {
            try {
                const response = await fetch('/api/user-strategies');
                const result = await response.json();
                
                if (result.success) {
                    strategies = result.data || [];
                    renderStrategyList();
                } else {
                    showError('加载策略列表失败: ' + result.error);
                }
            } catch (error) {
                console.error('加载策略失败:', error);
                document.getElementById('strategy-list').innerHTML = `
                    <div class="text-center text-muted py-4">
                        <i class="bi bi-exclamation-circle" style="font-size: 24px;"></i>
                        <div class="mt-2">加载失败</div>
                    </div>
                `;
            }
        }

        function renderStrategyList() {
            const container = document.getElementById('strategy-list');
            
            if (strategies.length === 0) {
                container.innerHTML = `
                    <div class="text-center text-muted py-4">
                        <i class="bi bi-folder-x" style="font-size: 24px;"></i>
                        <div class="mt-2">暂无策略</div>
                        <div class="mt-1" style="font-size: 11px;">点击"新建"创建第一个策略</div>
                    </div>
                `;
                return;
            }
            
            container.innerHTML = strategies.map(s => `
                <div class="strategy-item ${s.id === currentStrategyId ? 'active' : ''}" 
                     onclick="selectStrategy(${s.id})" data-id="${s.id}">
                    <div class="strategy-name">
                        <span>${escapeHtml(s.name)}</span>
                        <div class="strategy-actions" onclick="event.stopPropagation()">
                            <button title="复制" onclick="copyStrategy(${s.id})"><i class="bi bi-copy"></i></button>
                            <button title="重命名" onclick="openRenameModal(${s.id}, '${escapeHtml(s.name)}')"><i class="bi bi-pencil"></i></button>
                            <button title="删除" onclick="openDeleteModal(${s.id}, '${escapeHtml(s.name)}')"><i class="bi bi-trash"></i></button>
                        </div>
                    </div>
                    <div class="strategy-desc">${escapeHtml(s.description || '暂无描述')}</div>
                </div>
            `).join('');
        }

        async function selectStrategy(id) {
            currentStrategyId = id;
            renderStrategyList();
            
            try {
                const response = await fetch(`/api/user-strategies/${id}`);
                const result = await response.json();
                
                if (result.success) {
                    loadStrategyConfig(result.data);
                } else {
                    showError('加载策略详情失败: ' + result.error);
                }
            } catch (error) {
                console.error('加载策略详情失败:', error);
                showError('加载策略详情失败');
            }
        }

        function loadStrategyConfig(strategy) {
            const config = strategy.config || {};
            
            // 清除验证错误
            clearValidationErrors();
            
            // 基本信息
            document.getElementById('strategy-name').value = strategy.name || '';
            document.getElementById('strategy-desc').value = strategy.description || '';
            
            // 筛选条件
            document.getElementById('filter-logic').value = config.filter_logic || 'AND';
            renderFilterConditions(config.filter_conditions || []);
            
            // 排序选股
            document.getElementById('sort-field').value = config.sort_field || 'composite_score';
            document.getElementById('sort-order').value = config.sort_order || 'DESC';
            document.getElementById('select-count').value = config.select_count || 10;
            document.getElementById('weight-mode').value = config.weight_mode || 'equal';
            
            // 交易规则
            document.getElementById('max-positions').value = config.max_positions || 10;
            document.getElementById('trade-on-hold-day').checked = config.trade_on_hold_day || false;
            document.getElementById('buy-condition').value = config.buy_condition || '';
            document.getElementById('sell-condition').value = config.sell_condition || '';
            
            // 风险控制 - 处理百分比转换
            const dailyStopLoss = config.daily_stop_loss;
            const dailyTakeProfit = config.daily_take_profit;
            const totalStopLoss = config.total_stop_loss;
            const trailingStop = config.trailing_stop;
            
            // 判断值是否已经是百分比形式（绝对值大于1）还是小数形式
            document.getElementById('daily-stop-loss').value = formatRiskValue(dailyStopLoss, -5);
            document.getElementById('daily-take-profit').value = formatRiskValue(dailyTakeProfit, 10);
            document.getElementById('total-stop-loss').value = formatRiskValue(totalStopLoss, -15);
            document.getElementById('trailing-stop').value = formatRiskValue(trailingStop, 0);
            document.getElementById('volatility-adjustment').checked = config.volatility_adjustment || false;
            
            showSuccess('策略配置已加载');
        }
        
        // 格式化风险控制值（处理小数和百分比的转换）
        function formatRiskValue(value, defaultValue) {
            if (value === null || value === undefined || isNaN(value)) {
                return defaultValue;
            }
            // 如果绝对值小于1，认为是小数形式，需要乘以100
            if (Math.abs(value) < 1) {
                return (value * 100).toFixed(1);
            }
            // 否则认为已经是百分比形式
            return value;
        }

        function renderFilterConditions(conditions) {
            const container = document.getElementById('filter-list');
            container.innerHTML = '';
            conditions.forEach((c, i) => {
                const html = createFilterItemHtml(i, c);
                container.insertAdjacentHTML('beforeend', html);
            });
        }

        function createFilterItemHtml(index, condition = {}) {
            const fieldOptions = Object.entries(FILTER_FIELDS).map(([k, v]) => 
                `<option value="${k}" ${condition.field === k ? 'selected' : ''}>${v.label}</option>`
            ).join('');
            
            const operatorOptions = Object.entries(FILTER_OPERATORS).map(([k, v]) => 
                `<option value="${k}" ${condition.operator === k ? 'selected' : ''}>${k}</option>`
            ).join('');
            
            // 根据字段类型生成不同的值输入控件
            const fieldType = condition.field ? (FILTER_FIELDS[condition.field]?.type || 'numeric') : 'numeric';
            let valueInput = '';
            
            if (fieldType === 'boolean') {
                const boolOptions = Object.entries(BOOLEAN_VALUES).map(([k, v]) => 
                    `<option value="${k}" ${String(condition.value) === k ? 'selected' : ''}>${v}</option>`
                ).join('');
                valueInput = `<select class="filter-value" onchange="updateFilterCondition(${index})">${boolOptions}</select>`;
            } else if (fieldType === 'string') {
                valueInput = `<input type="text" class="filter-value" value="${condition.value || ''}" 
                               placeholder="值" onchange="updateFilterCondition(${index})">`;
            } else {
                valueInput = `<input type="number" class="filter-value" value="${condition.value || ''}" 
                               placeholder="值" step="any" onchange="updateFilterCondition(${index})">`;
            }
            
            const fieldHint = condition.field ? (FILTER_FIELDS[condition.field]?.hint || '') : '';
            
            return `
                <div class="filter-item" data-index="${index}">
                    <select class="filter-field" onchange="onFilterFieldChange(${index}, this.value)">${fieldOptions}</select>
                    <select class="filter-operator" onchange="updateFilterCondition(${index})">${operatorOptions}</select>
                    ${valueInput}
                    <button class="btn-remove" onclick="removeFilterCondition(${index})" title="删除条件">
                        <i class="bi bi-x-lg"></i>
                    </button>
                </div>
                ${fieldHint ? `<div class="filter-hint" style="font-size:10px;color:#999;margin:-5px 0 8px 10px;">${fieldHint}</div>` : ''}
            `;
        }
        
        // 当筛选字段改变时，更新值输入控件类型
        function onFilterFieldChange(index, fieldName) {
            const container = document.getElementById('filter-list');
            const item = container.querySelector(`[data-index="${index}"]`);
            if (!item) return;
            
            const fieldType = FILTER_FIELDS[fieldName]?.type || 'numeric';
            const valueContainer = item.querySelector('.filter-value');
            
            let newValueInput;
            if (fieldType === 'boolean') {
                const boolOptions = Object.entries(BOOLEAN_VALUES).map(([k, v]) => 
                    `<option value="${k}">${v}</option>`
                ).join('');
                newValueInput = document.createElement('select');
                newValueInput.className = 'filter-value';
                newValueInput.innerHTML = boolOptions;
                newValueInput.onchange = () => updateFilterCondition(index);
            } else if (fieldType === 'string') {
                newValueInput = document.createElement('input');
                newValueInput.type = 'text';
                newValueInput.className = 'filter-value';
                newValueInput.placeholder = '值';
                newValueInput.onchange = () => updateFilterCondition(index);
            } else {
                newValueInput = document.createElement('input');
                newValueInput.type = 'number';
                newValueInput.className = 'filter-value';
                newValueInput.placeholder = '值';
                newValueInput.step = 'any';
                newValueInput.onchange = () => updateFilterCondition(index);
            }
            
            valueContainer.replaceWith(newValueInput);
            
            // 更新提示文字
            const hintEl = item.nextElementSibling;
            const fieldHint = FILTER_FIELDS[fieldName]?.hint || '';
            if (hintEl && hintEl.classList.contains('filter-hint')) {
                if (fieldHint) {
                    hintEl.textContent = fieldHint;
                } else {
                    hintEl.remove();
                }
            } else if (fieldHint) {
                const newHint = document.createElement('div');
                newHint.className = 'filter-hint';
                newHint.style.cssText = 'font-size:10px;color:#999;margin:-5px 0 8px 10px;';
                newHint.textContent = fieldHint;
                item.after(newHint);
            }
        }

        function addFilterCondition() {
            const container = document.getElementById('filter-list');
            const index = container.querySelectorAll('.filter-item').length;
            const html = createFilterItemHtml(index, {
                field: 'list_days',
                operator: '>',
                value: ''
            });
            container.insertAdjacentHTML('beforeend', html);
        }
        
        // 预设筛选条件模板
        const FILTER_PRESETS = {
            'quality': {
                name: '优质基金筛选',
                conditions: [
                    { field: 'list_days', operator: '>', value: 365 },
                    { field: 'sharpe_ratio', operator: '>', value: 1 },
                    { field: 'composite_score', operator: '>', value: 60 }
                ]
            },
            'growth': {
                name: '成长型筛选',
                conditions: [
                    { field: 'annualized_return', operator: '>', value: 0.15 },
                    { field: 'list_days', operator: '>', value: 180 }
                ]
            },
            'value': {
                name: '价值型筛选',
                conditions: [
                    { field: 'pe_ttm', operator: '<', value: 20 },
                    { field: 'pb', operator: '<', value: 3 },
                    { field: 'list_days', operator: '>', value: 365 }
                ]
            },
            'low_risk': {
                name: '低风险筛选',
                conditions: [
                    { field: 'volatility', operator: '<', value: 0.15 },
                    { field: 'max_drawdown', operator: '>', value: -0.1 },
                    { field: 'sharpe_ratio', operator: '>', value: 0.5 }
                ]
            },
            'exclude_st': {
                name: '排除ST/停牌',
                conditions: [
                    { field: 'is_st', operator: '==', value: false },
                    { field: 'is_suspended', operator: '==', value: false }
                ]
            }
        };
        
        // 添加预设筛选条件
        function addPresetFilter(presetKey) {
            if (!presetKey) return;
            
            const preset = FILTER_PRESETS[presetKey];
            if (!preset) return;
            
            const container = document.getElementById('filter-list');
            
            // 添加预设条件
            preset.conditions.forEach(condition => {
                const index = container.querySelectorAll('.filter-item').length;
                const html = createFilterItemHtml(index, condition);
                container.insertAdjacentHTML('beforeend', html);
            });
            
            // 重置下拉框
            document.getElementById('filter-preset').value = '';
            
            showSuccess(`已添加"${preset.name}"预设条件`);
        }
        
        // 清空所有筛选条件
        function clearAllFilters() {
            const container = document.getElementById('filter-list');
            // 移除所有筛选条件和提示
            container.innerHTML = '';
            showSuccess('已清空所有筛选条件');
        }

        function removeFilterCondition(index) {
            const container = document.getElementById('filter-list');
            const item = container.querySelector(`[data-index="${index}"]`);
            if (item) {
                // 同时移除提示文字
                const hintEl = item.nextElementSibling;
                if (hintEl && hintEl.classList.contains('filter-hint')) {
                    hintEl.remove();
                }
                item.remove();
            }
            // 重新编号
            let newIndex = 0;
            container.querySelectorAll('.filter-item').forEach((el) => {
                el.dataset.index = newIndex;
                // 更新事件处理器中的索引
                const fieldSelect = el.querySelector('.filter-field');
                const operatorSelect = el.querySelector('.filter-operator');
                const valueInput = el.querySelector('.filter-value');
                const removeBtn = el.querySelector('.btn-remove');
                
                if (fieldSelect) {
                    fieldSelect.setAttribute('onchange', `onFilterFieldChange(${newIndex}, this.value)`);
                }
                if (operatorSelect) {
                    operatorSelect.setAttribute('onchange', `updateFilterCondition(${newIndex})`);
                }
                if (valueInput) {
                    valueInput.setAttribute('onchange', `updateFilterCondition(${newIndex})`);
                }
                if (removeBtn) {
                    removeBtn.setAttribute('onclick', `removeFilterCondition(${newIndex})`);
                }
                
                newIndex++;
            });
        }

        function getFilterConditions() {
            const container = document.getElementById('filter-list');
            const conditions = [];
            container.querySelectorAll('.filter-item').forEach(item => {
                const field = item.querySelector('.filter-field').value;
                const operator = item.querySelector('.filter-operator').value;
                const valueEl = item.querySelector('.filter-value');
                
                // 根据字段类型解析值
                const fieldType = FILTER_FIELDS[field]?.type || 'numeric';
                let value;
                
                if (fieldType === 'boolean') {
                    value = valueEl.value === 'true';
                } else if (fieldType === 'string') {
                    value = valueEl.value;
                } else {
                    value = parseFloat(valueEl.value);
                }
                
                // 验证值是否有效
                if (field && operator) {
                    if (fieldType === 'numeric' && isNaN(value)) {
                        // 跳过无效的数值条件
                        return;
                    }
                    if (fieldType === 'string' && !value) {
                        // 跳过空字符串条件
                        return;
                    }
                    conditions.push({ field, operator, value });
                }
            });
            return conditions;
        }

        // ==================== 策略CRUD操作 ====================
        async function createNewStrategy() {
            const name = '新策略 ' + (strategies.length + 1);
            
            // 显示创建中状态
            const newBtn = document.querySelector('.btn-new-strategy');
            const originalContent = newBtn.innerHTML;
            newBtn.disabled = true;
            newBtn.innerHTML = '<i class="bi bi-hourglass-split"></i>';
            
            try {
                const response = await fetch('/api/user-strategies', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        name: name,
                        description: '',
                        config: getDefaultConfig()
                    })
                });
                
                const result = await response.json();
                if (result.success) {
                    showSuccess('策略创建成功');
                    await loadStrategies();
                    selectStrategy(result.data.id);
                } else {
                    showError('创建策略失败: ' + result.error);
                }
            } catch (error) {
                console.error('创建策略失败:', error);
                showError('创建策略失败: 网络错误');
            } finally {
                newBtn.disabled = false;
                newBtn.innerHTML = originalContent;
            }
        }

        async function saveStrategy() {
            if (!currentStrategyId) {
                showError('请先选择或创建一个策略');
                return;
            }
            
            // 清除之前的验证状态
            clearValidationErrors();
            
            // 表单验证
            const validationResult = validateStrategyForm();
            if (!validationResult.valid) {
                showValidationErrors(validationResult.errors);
                showError(validationResult.errors[0].message);
                return;
            }
            
            const name = document.getElementById('strategy-name').value.trim();
            const config = collectStrategyConfig();
            
            // 显示保存中状态
            const saveBtn = document.querySelector('.btn-save');
            saveBtn.classList.add('saving');
            saveBtn.innerHTML = '<i class="bi bi-save"></i> 保存中';
            
            try {
                const response = await fetch(`/api/user-strategies/${currentStrategyId}`, {
                    method: 'PUT',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        name: name,
                        description: document.getElementById('strategy-desc').value,
                        config: config
                    })
                });
                
                const result = await response.json();
                if (result.success) {
                    showSuccess('策略保存成功');
                    await loadStrategies();
                } else {
                    // 处理验证错误
                    if (result.validation_errors) {
                        showValidationErrors(result.validation_errors);
                        showError('策略配置验证失败，请检查输入');
                    } else {
                        showError('保存失败: ' + result.error);
                    }
                }
            } catch (error) {
                console.error('保存策略失败:', error);
                showError('保存策略失败: 网络错误');
            } finally {
                // 恢复按钮状态
                saveBtn.classList.remove('saving');
                saveBtn.innerHTML = '<i class="bi bi-save"></i> 保存';
            }
        }
        
        // 表单验证函数
        function validateStrategyForm() {
            const errors = [];
            
            // 验证策略名称
            const name = document.getElementById('strategy-name').value.trim();
            if (!name) {
                errors.push({ field: 'strategy-name', message: '策略名称不能为空' });
            } else if (name.length > 100) {
                errors.push({ field: 'strategy-name', message: '策略名称不能超过100个字符' });
            }
            
            // 验证选股数量
            const selectCount = parseInt(document.getElementById('select-count').value);
            if (isNaN(selectCount) || selectCount < 1) {
                errors.push({ field: 'select-count', message: '选股数量必须大于0' });
            } else if (selectCount > 100) {
                errors.push({ field: 'select-count', message: '选股数量不能超过100' });
            }
            
            // 验证最大持仓数
            const maxPositions = parseInt(document.getElementById('max-positions').value);
            if (isNaN(maxPositions) || maxPositions < 1) {
                errors.push({ field: 'max-positions', message: '最大持仓数必须大于0' });
            }
            
            // 验证止损止盈参数
            const dailyStopLoss = parseFloat(document.getElementById('daily-stop-loss').value);
            if (!isNaN(dailyStopLoss) && dailyStopLoss > 0) {
                errors.push({ field: 'daily-stop-loss', message: '每日止损应为负数或0' });
            }
            
            const dailyTakeProfit = parseFloat(document.getElementById('daily-take-profit').value);
            if (!isNaN(dailyTakeProfit) && dailyTakeProfit < 0) {
                errors.push({ field: 'daily-take-profit', message: '每日止盈应为正数或0' });
            }
            
            const totalStopLoss = parseFloat(document.getElementById('total-stop-loss').value);
            if (!isNaN(totalStopLoss) && totalStopLoss > 0) {
                errors.push({ field: 'total-stop-loss', message: '累计止损应为负数或0' });
            }
            
            // 验证筛选条件
            const filterConditions = getFilterConditions();
            for (let i = 0; i < filterConditions.length; i++) {
                const cond = filterConditions[i];
                if (!cond.field || !cond.operator || cond.value === '' || isNaN(cond.value)) {
                    errors.push({ field: `filter-${i}`, message: `筛选条件 ${i + 1} 不完整` });
                }
            }
            
            // 验证回测日期
            const startDate = document.getElementById('backtest-start').value;
            const endDate = document.getElementById('backtest-end').value;
            if (startDate && endDate && startDate > endDate) {
                errors.push({ field: 'backtest-start', message: '开始日期不能晚于结束日期' });
            }
            
            // 验证初始资金
            const initialCapital = parseFloat(document.getElementById('initial-capital').value);
            if (isNaN(initialCapital) || initialCapital < 1000) {
                errors.push({ field: 'initial-capital', message: '初始资金不能少于1000' });
            }
            
            return {
                valid: errors.length === 0,
                errors: errors
            };
        }
        
        // 显示验证错误
        function showValidationErrors(errors) {
            errors.forEach(err => {
                const field = document.getElementById(err.field);
                if (field) {
                    field.classList.add('is-invalid');
                    
                    // 添加错误提示
                    let feedback = field.nextElementSibling;
                    if (!feedback || !feedback.classList.contains('invalid-feedback')) {
                        feedback = document.createElement('div');
                        feedback.className = 'invalid-feedback';
                        field.parentNode.insertBefore(feedback, field.nextSibling);
                    }
                    feedback.textContent = err.message;
                }
            });
        }
        
        // 清除验证错误
        function clearValidationErrors() {
            document.querySelectorAll('.is-invalid').forEach(el => {
                el.classList.remove('is-invalid');
            });
            document.querySelectorAll('.invalid-feedback').forEach(el => {
                el.remove();
            });
        }
        
        // 输入时清除单个字段的验证错误
        document.addEventListener('input', function(e) {
            if (e.target.classList.contains('is-invalid')) {
                e.target.classList.remove('is-invalid');
                const feedback = e.target.nextElementSibling;
                if (feedback && feedback.classList.contains('invalid-feedback')) {
                    feedback.remove();
                }
            }
        });

        async function copyStrategy(id) {
            try {
                const response = await fetch(`/api/user-strategies/${id}/copy`, {
                    method: 'POST'
                });
                
                const result = await response.json();
                if (result.success) {
                    showSuccess('策略复制成功');
                    await loadStrategies();
                    selectStrategy(result.data.id);
                } else {
                    showError('复制失败: ' + result.error);
                }
            } catch (error) {
                console.error('复制策略失败:', error);
                showError('复制策略失败');
            }
        }

        function openRenameModal(id, name) {
            renameStrategyId = id;
            document.getElementById('rename-input').value = name;
            document.getElementById('rename-modal').classList.add('show');
        }

        function closeRenameModal() {
            renameStrategyId = null;
            document.getElementById('rename-modal').classList.remove('show');
        }

        async function confirmRename() {
            const newName = document.getElementById('rename-input').value.trim();
            if (!newName) {
                showError('名称不能为空');
                return;
            }
            
            try {
                const response = await fetch(`/api/user-strategies/${renameStrategyId}`, {
                    method: 'PUT',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ name: newName })
                });
                
                const result = await response.json();
                if (result.success) {
                    closeRenameModal();
                    await loadStrategies();
                    if (currentStrategyId === renameStrategyId) {
                        document.getElementById('strategy-name').value = newName;
                    }
                } else {
                    showError('重命名失败: ' + result.error);
                }
            } catch (error) {
                console.error('重命名失败:', error);
                showError('重命名失败');
            }
        }

        function openDeleteModal(id, name) {
            deleteStrategyId = id;
            document.getElementById('delete-strategy-name').textContent = name;
            document.getElementById('delete-modal').classList.add('show');
        }

        function closeDeleteModal() {
            deleteStrategyId = null;
            document.getElementById('delete-modal').classList.remove('show');
        }

        async function confirmDelete() {
            try {
                const response = await fetch(`/api/user-strategies/${deleteStrategyId}`, {
                    method: 'DELETE'
                });
                
                const result = await response.json();
                if (result.success) {
                    closeDeleteModal();
                    if (currentStrategyId === deleteStrategyId) {
                        currentStrategyId = null;
                        clearStrategyForm();
                    }
                    await loadStrategies();
                } else {
                    showError('删除失败: ' + result.error);
                }
            } catch (error) {
                console.error('删除失败:', error);
                showError('删除失败');
            }
        }

        function clearStrategyForm() {
            document.getElementById('strategy-name').value = '';
            document.getElementById('strategy-desc').value = '';
            document.getElementById('filter-list').innerHTML = '';
            // 重置其他字段为默认值
        }

        function collectStrategyConfig() {
            return {
                filter_conditions: getFilterConditions(),
                filter_logic: document.getElementById('filter-logic').value,
                sort_field: document.getElementById('sort-field').value,
                sort_order: document.getElementById('sort-order').value,
                select_count: parseInt(document.getElementById('select-count').value) || 10,
                weight_mode: document.getElementById('weight-mode').value,
                max_positions: parseInt(document.getElementById('max-positions').value) || 10,
                trade_on_hold_day: document.getElementById('trade-on-hold-day').checked,
                buy_condition: document.getElementById('buy-condition').value,
                sell_condition: document.getElementById('sell-condition').value,
                daily_stop_loss: parseFloat(document.getElementById('daily-stop-loss').value) / 100 || -0.05,
                daily_take_profit: parseFloat(document.getElementById('daily-take-profit').value) / 100 || 0.10,
                total_stop_loss: parseFloat(document.getElementById('total-stop-loss').value) / 100 || -0.15,
                trailing_stop: parseFloat(document.getElementById('trailing-stop').value) / 100 || 0,
                volatility_adjustment: document.getElementById('volatility-adjustment').checked
            };
        }

        function getDefaultConfig() {
            return {
                filter_conditions: [],
                filter_logic: 'AND',
                sort_field: 'composite_score',
                sort_order: 'DESC',
                select_count: 10,
                weight_mode: 'equal',
                max_positions: 10,
                trade_on_hold_day: false,
                buy_condition: '',
                sell_condition: '',
                daily_stop_loss: -0.05,
                daily_take_profit: 0.10,
                total_stop_loss: -0.15,
                trailing_stop: 0,
                volatility_adjustment: false
            };
        }

        // ==================== 回测执行 ====================
        let backtestPollingInterval = null;
        
        async function runBacktest() {
            if (!currentStrategyId) {
                showError('请先选择或创建一个策略');
                return;
            }
            
            // 清除验证错误
            clearValidationErrors();
            
            // 验证表单
            const validationResult = validateStrategyForm();
            if (!validationResult.valid) {
                showValidationErrors(validationResult.errors);
                showError('请先修正配置错误');
                return;
            }
            
            // 先保存策略
            const saveBtn = document.querySelector('.btn-save');
            const runBtn = document.querySelector('.btn-run');
            
            // 禁用按钮
            runBtn.disabled = true;
            runBtn.innerHTML = '<i class="bi bi-hourglass-split"></i> 保存中...';
            
            try {
                // 保存策略
                const name = document.getElementById('strategy-name').value.trim();
                const config = collectStrategyConfig();
                
                const saveResponse = await fetch(`/api/user-strategies/${currentStrategyId}`, {
                    method: 'PUT',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        name: name,
                        description: document.getElementById('strategy-desc').value,
                        config: config
                    })
                });
                
                const saveResult = await saveResponse.json();
                if (!saveResult.success) {
                    if (saveResult.validation_errors) {
                        showValidationErrors(saveResult.validation_errors);
                    }
                    showError('保存策略失败: ' + (saveResult.error || '未知错误'));
                    return;
                }
                
                // 更新策略列表
                await loadStrategies();
            
                const startDate = document.getElementById('backtest-start').value;
                const endDate = document.getElementById('backtest-end').value;
                const initialCapital = parseFloat(document.getElementById('initial-capital').value) || 100000;
                const rebalanceFreq = document.getElementById('rebalance-freq').value;
                
                // 显示加载状态
                showBacktestProgress(0, '正在初始化回测...');
                runBtn.innerHTML = '<i class="bi bi-hourglass-split"></i> 回测中...';
                
                const response = await fetch('/api/strategy-backtest/run', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        strategy_id: currentStrategyId,
                        start_date: startDate,
                        end_date: endDate,
                        initial_capital: initialCapital,
                        rebalance_freq: rebalanceFreq
                    })
                });
                
                const result = await response.json();
                if (result.success) {
                    const data = result.data || result;
                    
                    // 检查是否有task_id需要轮询
                    if (data.task_id && data.status !== 'completed') {
                        // 开始轮询回测状态
                        startBacktestPolling(data.task_id);
                    } else if (data.result) {
                        // 直接返回了结果
                        backtestResult = data.result;
                        backtestResult.task_id = data.task_id;
                        showSuccess('回测完成');
                        renderBacktestResult(backtestResult);
                    } else {
                        showBacktestError('回测返回数据格式错误');
                    }
                } else {
                    showBacktestError(result.error || '回测执行失败');
                }
            } catch (error) {
                console.error('回测失败:', error);
                showBacktestError('回测请求失败: ' + error.message);
            } finally {
                // 恢复按钮状态
                runBtn.disabled = false;
                runBtn.innerHTML = '<i class="bi bi-play-fill"></i> 运行回测';
            }
        }
        
        // 开始轮询回测状态
        function startBacktestPolling(taskId) {
            // 清除之前的轮询
            if (backtestPollingInterval) {
                clearInterval(backtestPollingInterval);
            }
            
            let pollCount = 0;
            const maxPolls = 120; // 最多轮询2分钟 (120 * 1秒)
            
            backtestPollingInterval = setInterval(async () => {
                pollCount++;
                
                if (pollCount > maxPolls) {
                    clearInterval(backtestPollingInterval);
                    showBacktestError('回测超时，请稍后重试');
                    return;
                }
                
                try {
                    const response = await fetch(`/api/strategy-backtest/status/${taskId}`);
                    const result = await response.json();
                    
                    if (result.success) {
                        const status = result.data;
                        
                        // 更新进度
                        showBacktestProgress(status.progress || 0, getProgressMessage(status.status, status.progress));
                        
                        if (status.status === 'completed') {
                            clearInterval(backtestPollingInterval);
                            // 获取完整结果
                            await fetchBacktestResult(taskId);
                        } else if (status.status === 'failed') {
                            clearInterval(backtestPollingInterval);
                            showBacktestError(status.error_message || '回测执行失败');
                        }
                    }
                } catch (error) {
                    console.error('轮询回测状态失败:', error);
                }
            }, 1000);
        }
        
        // 获取回测结果
        async function fetchBacktestResult(taskId) {
            try {
                const response = await fetch(`/api/strategy-backtest/result/${taskId}`);
                const result = await response.json();
                
                if (result.success) {
                    backtestResult = result.data;
                    backtestResult.task_id = taskId;
                    showSuccess('回测完成');
                    renderBacktestResult(backtestResult);
                } else {
                    showBacktestError(result.error || '获取回测结果失败');
                }
            } catch (error) {
                console.error('获取回测结果失败:', error);
                showBacktestError('获取回测结果失败: ' + error.message);
            }
        }
        
        // 获取进度消息
        function getProgressMessage(status, progress) {
            if (status === 'pending') return '等待执行...';
            if (status === 'running') {
                if (progress < 30) return '正在加载基金数据...';
                if (progress < 50) return '正在执行策略筛选...';
                if (progress < 70) return '正在计算交易信号...';
                if (progress < 90) return '正在计算绩效指标...';
                return '正在生成报告...';
            }
            if (status === 'completed') return '回测完成';
            if (status === 'failed') return '回测失败';
            return '处理中...';
        }
        
        // 显示回测进度
        function showBacktestProgress(progress, message) {
            document.getElementById('result-body').innerHTML = `
                <div class="backtest-progress">
                    <div class="spinner" style="margin: 0 auto 20px;"></div>
                    <div class="progress-percentage">${Math.round(progress)}%</div>
                    <div class="progress-bar-container">
                        <div class="progress-bar-fill" style="width: ${progress}%"></div>
                    </div>
                    <div class="progress-text">${escapeHtml(message)}</div>
                </div>
            `;
        }

        function showBacktestError(message) {
            document.getElementById('result-body').innerHTML = `
                <div class="result-empty">
                    <i class="bi bi-exclamation-triangle" style="color: var(--danger-red);"></i>
                    <p class="mt-2">${escapeHtml(message)}</p>
                    <button class="btn-primary mt-3" onclick="runBacktest()">重试</button>
                </div>
            `;
        }

        function renderBacktestResult(result) {
            const container = document.getElementById('result-body');
            
            // 计算收益率颜色
            const totalReturnClass = result.total_return >= 0 ? 'positive' : 'negative';
            const annualReturnClass = result.annual_return >= 0 ? 'positive' : 'negative';
            const excessReturnClass = result.excess_return >= 0 ? 'positive' : 'negative';
            const benchmarkReturnClass = result.benchmark_return >= 0 ? 'positive' : 'negative';
            
            // 计算风险指标评级
            const sharpeRating = getRiskRating(result.sharpe_ratio, 'sharpe');
            const sortinoRating = getRiskRating(result.sortino_ratio, 'sortino');
            const calmarRating = getRiskRating(result.calmar_ratio, 'calmar');
            const volatilityRating = getRiskRating(result.volatility, 'volatility');
            const winRateRating = getRiskRating(result.win_rate, 'win_rate');
            const plRatioRating = getRiskRating(result.profit_loss_ratio, 'pl_ratio');
            
            container.innerHTML = `
                <!-- 收益概况卡片 - 增强版 -->
                <div class="metrics-cards">
                    <div class="metric-card">
                        <div class="metric-value ${totalReturnClass}">${formatPercent(result.total_return)}</div>
                        <div class="metric-label">策略收益率</div>
                        <div class="metric-desc">回测期间总收益</div>
                    </div>
                    <div class="metric-card">
                        <div class="metric-value ${annualReturnClass}">${formatPercent(result.annual_return)}</div>
                        <div class="metric-label">年化收益率</div>
                        <div class="metric-desc">折算年化收益</div>
                    </div>
                    <div class="metric-card">
                        <div class="metric-value ${benchmarkReturnClass}">${formatPercent(result.benchmark_return)}</div>
                        <div class="metric-label">基准收益率</div>
                        <div class="metric-desc">沪深300指数</div>
                    </div>
                    <div class="metric-card">
                        <div class="metric-value ${excessReturnClass}">${formatPercent(result.excess_return)}</div>
                        <div class="metric-label">超额收益</div>
                        <div class="metric-desc">相对基准超额</div>
                    </div>
                    <div class="metric-card">
                        <div class="metric-value negative">${formatPercent(result.max_drawdown)}</div>
                        <div class="metric-label">最大回撤</div>
                        <div class="metric-desc">最大亏损幅度</div>
                    </div>
                </div>

                <!-- 收益曲线图表 - 增强版 -->
                <div class="chart-section">
                    <div class="chart-title">
                        <i class="bi bi-graph-up"></i> 收益曲线
                        <div class="period-tabs">
                            <span class="tab active" data-period="all" onclick="switchPeriod('all', this)">全部</span>
                            <span class="tab" data-period="1y" onclick="switchPeriod('1y', this)">近1年</span>
                            <span class="tab" data-period="6m" onclick="switchPeriod('6m', this)">近6月</span>
                            <span class="tab" data-period="3m" onclick="switchPeriod('3m', this)">近3月</span>
                            <span class="tab" data-period="1m" onclick="switchPeriod('1m', this)">近1月</span>
                        </div>
                    </div>
                    <div class="chart-container" id="equity-chart"></div>
                    <div class="chart-legend">
                        <span class="legend-item"><span class="legend-color" style="background:#e74c3c;"></span>策略净值</span>
                        <span class="legend-item"><span class="legend-color" style="background:#3498db;"></span>基准净值</span>
                    </div>
                </div>

                <!-- 风险指标面板 - 增强版 -->
                <div class="risk-section">
                    <div class="chart-title">
                        <i class="bi bi-shield-check"></i> 风险指标分析
                        <span class="risk-help-btn" onclick="toggleRiskHelp()" title="查看指标说明">
                            <i class="bi bi-question-circle"></i>
                        </span>
                    </div>
                    <div class="risk-help-panel" id="risk-help-panel" style="display:none;">
                        <div class="risk-help-content">
                            <p><strong>夏普比率</strong>: 衡量每承担一单位风险所获得的超额收益，>1为良好，>2为优秀</p>
                            <p><strong>索提诺比率</strong>: 只考虑下行风险的夏普比率，更关注亏损风险</p>
                            <p><strong>卡玛比率</strong>: 年化收益与最大回撤的比值，衡量收益风险比</p>
                            <p><strong>波动率</strong>: 收益率的标准差，衡量价格波动程度</p>
                            <p><strong>胜率</strong>: 盈利交易占总交易的比例</p>
                            <p><strong>盈亏比</strong>: 平均盈利金额与平均亏损金额的比值</p>
                        </div>
                    </div>
                    <div class="risk-grid">
                        <div class="risk-item ${sharpeRating.class}">
                            <div class="risk-value">${formatNumber(result.sharpe_ratio)}</div>
                            <div class="risk-label">夏普比率</div>
                            <div class="risk-rating">${sharpeRating.text}</div>
                            <div class="risk-benchmark">基准: ${formatNumber(result.benchmark_sharpe || 0)}</div>
                        </div>
                        <div class="risk-item ${sortinoRating.class}">
                            <div class="risk-value">${formatNumber(result.sortino_ratio)}</div>
                            <div class="risk-label">索提诺比率</div>
                            <div class="risk-rating">${sortinoRating.text}</div>
                            <div class="risk-benchmark">基准: ${formatNumber(result.benchmark_sortino || 0)}</div>
                        </div>
                        <div class="risk-item ${calmarRating.class}">
                            <div class="risk-value">${formatNumber(result.calmar_ratio)}</div>
                            <div class="risk-label">卡玛比率</div>
                            <div class="risk-rating">${calmarRating.text}</div>
                            <div class="risk-benchmark">基准: ${formatNumber(result.benchmark_calmar || 0)}</div>
                        </div>
                        <div class="risk-item ${volatilityRating.class}">
                            <div class="risk-value">${formatPercent(result.volatility)}</div>
                            <div class="risk-label">波动率</div>
                            <div class="risk-rating">${volatilityRating.text}</div>
                            <div class="risk-benchmark">基准: ${formatPercent(result.benchmark_volatility || 0)}</div>
                        </div>
                        <div class="risk-item ${winRateRating.class}">
                            <div class="risk-value">${formatPercent(result.win_rate)}</div>
                            <div class="risk-label">胜率</div>
                            <div class="risk-rating">${winRateRating.text}</div>
                            <div class="risk-hint">盈利${result.winning_trades || 0}笔 / 亏损${result.losing_trades || 0}笔</div>
                        </div>
                        <div class="risk-item ${plRatioRating.class}">
                            <div class="risk-value">${formatNumber(result.profit_loss_ratio)}</div>
                            <div class="risk-label">盈亏比</div>
                            <div class="risk-rating">${plRatioRating.text}</div>
                            <div class="risk-hint">平均盈利/亏损</div>
                        </div>
                    </div>
                </div>

                <!-- 交易详情表格 - 增强版 -->
                <div class="trades-section">
                    <div class="trades-header">
                        <h6><i class="bi bi-list-ul"></i> 交易详情 (<span id="trades-count">${result.total_trades || 0}</span>笔)</h6>
                        <div class="trades-filters">
                            <input type="date" id="trade-start-date" placeholder="开始日期" onchange="filterTrades()">
                            <input type="date" id="trade-end-date" placeholder="结束日期" onchange="filterTrades()">
                            <input type="text" id="trade-fund-filter" placeholder="基金代码" style="width:100px;" onkeyup="filterTrades()">
                            <select id="trade-action-filter" onchange="filterTrades()">
                                <option value="">全部方向</option>
                                <option value="buy">买入</option>
                                <option value="sell">卖出</option>
                                <option value="stop_loss">止损</option>
                                <option value="take_profit">止盈</option>
                            </select>
                            <button class="btn-filter-clear" onclick="clearTradeFilters()" title="清除筛选">
                                <i class="bi bi-x-circle"></i>
                            </button>
                            <button class="btn-export" onclick="exportTrades()">
                                <i class="bi bi-download"></i> 导出CSV
                            </button>
                        </div>
                    </div>
                    <div class="trades-table-wrapper" style="max-height: 300px; overflow-y: auto;">
                        <table class="trades-table">
                            <thead>
                                <tr>
                                    <th>日期</th>
                                    <th>基金代码</th>
                                    <th>基金名称</th>
                                    <th>方向</th>
                                    <th>金额</th>
                                    <th>价格</th>
                                    <th>份额</th>
                                    <th>账户余额</th>
                                    <th>原因</th>
                                </tr>
                            </thead>
                            <tbody id="trades-tbody">
                                ${renderTradesTable(result.trades || [])}
                            </tbody>
                        </table>
                    </div>
                    <div class="trades-pagination" id="trades-pagination"></div>
                </div>
            `;
            
            // 保存原始交易数据用于筛选
            window.originalTrades = result.trades || [];
            window.filteredTrades = [...window.originalTrades];
            
            // 渲染图表
            renderEquityChart(result.equity_curve, result.benchmark_curve);
        }

        // 风险指标评级函数
        function getRiskRating(value, type) {
            if (value === null || value === undefined || isNaN(value)) {
                return { class: '', text: '--' };
            }
            
            let rating = { class: '', text: '' };
            
            switch(type) {
                case 'sharpe':
                    if (value >= 2) rating = { class: 'rating-excellent', text: '优秀' };
                    else if (value >= 1) rating = { class: 'rating-good', text: '良好' };
                    else if (value >= 0.5) rating = { class: 'rating-fair', text: '一般' };
                    else rating = { class: 'rating-poor', text: '较差' };
                    break;
                case 'sortino':
                    if (value >= 2) rating = { class: 'rating-excellent', text: '优秀' };
                    else if (value >= 1) rating = { class: 'rating-good', text: '良好' };
                    else if (value >= 0.5) rating = { class: 'rating-fair', text: '一般' };
                    else rating = { class: 'rating-poor', text: '较差' };
                    break;
                case 'calmar':
                    if (value >= 3) rating = { class: 'rating-excellent', text: '优秀' };
                    else if (value >= 1.5) rating = { class: 'rating-good', text: '良好' };
                    else if (value >= 0.5) rating = { class: 'rating-fair', text: '一般' };
                    else rating = { class: 'rating-poor', text: '较差' };
                    break;
                case 'volatility':
                    if (value <= 0.1) rating = { class: 'rating-excellent', text: '低波动' };
                    else if (value <= 0.2) rating = { class: 'rating-good', text: '中等' };
                    else if (value <= 0.3) rating = { class: 'rating-fair', text: '较高' };
                    else rating = { class: 'rating-poor', text: '高波动' };
                    break;
                case 'win_rate':
                    if (value >= 0.6) rating = { class: 'rating-excellent', text: '优秀' };
                    else if (value >= 0.5) rating = { class: 'rating-good', text: '良好' };
                    else if (value >= 0.4) rating = { class: 'rating-fair', text: '一般' };
                    else rating = { class: 'rating-poor', text: '较低' };
                    break;
                case 'pl_ratio':
                    if (value >= 2) rating = { class: 'rating-excellent', text: '优秀' };
                    else if (value >= 1.5) rating = { class: 'rating-good', text: '良好' };
                    else if (value >= 1) rating = { class: 'rating-fair', text: '一般' };
                    else rating = { class: 'rating-poor', text: '较差' };
                    break;
                default:
                    rating = { class: '', text: '' };
            }
            
            return rating;
        }

        // 切换风险指标帮助面板
        function toggleRiskHelp() {
            const panel = document.getElementById('risk-help-panel');
            panel.style.display = panel.style.display === 'none' ? 'block' : 'none';
        }

        // 交易记录筛选函数
        function filterTrades() {
            if (!window.originalTrades) return;
            
            const startDate = document.getElementById('trade-start-date').value;
            const endDate = document.getElementById('trade-end-date').value;
            const fundCode = document.getElementById('trade-fund-filter').value.toLowerCase();
            const action = document.getElementById('trade-action-filter').value;
            
            window.filteredTrades = window.originalTrades.filter(trade => {
                // 日期筛选
                if (startDate && trade.date < startDate) return false;
                if (endDate && trade.date > endDate) return false;
                
                // 基金代码筛选
                if (fundCode && !trade.fund_code.toLowerCase().includes(fundCode)) return false;
                
                // 交易方向筛选
                if (action && trade.action !== action) return false;
                
                return true;
            });
            
            // 更新表格
            document.getElementById('trades-tbody').innerHTML = renderTradesTable(window.filteredTrades);
            document.getElementById('trades-count').textContent = window.filteredTrades.length;
        }

        // 清除交易筛选
        function clearTradeFilters() {
            document.getElementById('trade-start-date').value = '';
            document.getElementById('trade-end-date').value = '';
            document.getElementById('trade-fund-filter').value = '';
            document.getElementById('trade-action-filter').value = '';
            
            window.filteredTrades = [...window.originalTrades];
            document.getElementById('trades-tbody').innerHTML = renderTradesTable(window.filteredTrades);
            document.getElementById('trades-count').textContent = window.filteredTrades.length;
        }

        function renderTradesTable(trades) {
            if (!trades || trades.length === 0) {
                return '<tr><td colspan="9" class="text-center text-muted py-3">暂无交易记录</td></tr>';
            }
            
            // 交易方向映射
            const actionMap = {
                'buy': { text: '买入', class: 'badge-buy' },
                'sell': { text: '卖出', class: 'badge-sell' },
                'stop_loss': { text: '止损', class: 'badge-stop-loss' },
                'take_profit': { text: '止盈', class: 'badge-take-profit' },
                'daily_stop_loss': { text: '每日止损', class: 'badge-stop-loss' },
                'daily_take_profit': { text: '每日止盈', class: 'badge-take-profit' },
                'total_stop_loss': { text: '累计止损', class: 'badge-stop-loss' },
                'trailing_stop': { text: '追踪止损', class: 'badge-stop-loss' }
            };
            
            return trades.slice(0, 100).map(t => {
                const actionInfo = actionMap[t.action] || { text: t.action, class: 'badge-sell' };
                return `
                    <tr>
                        <td>${t.date || '--'}</td>
                        <td><span class="fund-code">${t.fund_code || '--'}</span></td>
                        <td>${escapeHtml(t.fund_name || '--')}</td>
                        <td><span class="${actionInfo.class}">${actionInfo.text}</span></td>
                        <td class="${t.action === 'buy' ? 'text-danger' : 'text-success'}">¥${formatNumber(t.amount)}</td>
                        <td>${formatNumber(t.price)}</td>
                        <td>${formatNumber(t.shares)}</td>
                        <td>¥${formatNumber(t.balance)}</td>
                        <td class="trade-reason">${escapeHtml(t.reason || '--')}</td>
                    </tr>
                `;
            }).join('');
        }

        function renderEquityChart(equityCurve, benchmarkCurve) {
            const chartDom = document.getElementById('equity-chart');
            if (!chartDom) return;
            
            if (equityChart) {
                equityChart.dispose();
            }
            
            equityChart = echarts.init(chartDom);
            
            // 保存原始数据用于时间范围切换
            window.originalEquityCurve = equityCurve || [];
            window.originalBenchmarkCurve = benchmarkCurve || [];
            
            updateEquityChart('all');
        }

        function updateEquityChart(period) {
            if (!equityChart) return;
            
            let equityCurve = window.originalEquityCurve || [];
            let benchmarkCurve = window.originalBenchmarkCurve || [];
            
            // 根据时间范围筛选数据
            if (period !== 'all' && equityCurve.length > 0) {
                const endDate = new Date(equityCurve[equityCurve.length - 1].date);
                let startDate = new Date(endDate);
                
                switch(period) {
                    case '1m':
                        startDate.setMonth(startDate.getMonth() - 1);
                        break;
                    case '3m':
                        startDate.setMonth(startDate.getMonth() - 3);
                        break;
                    case '6m':
                        startDate.setMonth(startDate.getMonth() - 6);
                        break;
                    case '1y':
                        startDate.setFullYear(startDate.getFullYear() - 1);
                        break;
                }
                
                const startDateStr = startDate.toISOString().split('T')[0];
                equityCurve = equityCurve.filter(d => d.date >= startDateStr);
                benchmarkCurve = benchmarkCurve.filter(d => d.date >= startDateStr);
            }
            
            // 归一化净值（从1开始）
            const normalizeData = (data) => {
                if (!data || data.length === 0) return [];
                const firstValue = data[0].value;
                if (firstValue === 0) return data.map(d => ({ ...d, value: 1 }));
                return data.map(d => ({ ...d, value: d.value / firstValue }));
            };
            
            const normalizedEquity = normalizeData(equityCurve);
            const normalizedBenchmark = normalizeData(benchmarkCurve);
            
            const dates = normalizedEquity.map(d => d.date);
            const strategyValues = normalizedEquity.map(d => d.value);
            const benchmarkValues = normalizedBenchmark.map(d => d.value);
            
            const option = {
                tooltip: {
                    trigger: 'axis',
                    backgroundColor: 'rgba(255,255,255,0.95)',
                    borderColor: '#ddd',
                    borderWidth: 1,
                    textStyle: { color: '#333', fontSize: 12 },
                    formatter: function(params) {
                        let result = `<div style="font-weight:600;margin-bottom:5px;">${params[0].axisValue}</div>`;
                        params.forEach(p => {
                            const returnRate = ((p.value - 1) * 100).toFixed(2);
                            const color = returnRate >= 0 ? '#e74c3c' : '#27ae60';
                            result += `<div style="display:flex;justify-content:space-between;gap:20px;">
                                <span>${p.marker} ${p.seriesName}</span>
                                <span style="font-weight:600;color:${color}">${returnRate >= 0 ? '+' : ''}${returnRate}%</span>
                            </div>`;
                        });
                        return result;
                    }
                },
                legend: {
                    show: false
                },
                grid: {
                    left: '3%',
                    right: '4%',
                    bottom: '10%',
                    top: '10%',
                    containLabel: true
                },
                xAxis: {
                    type: 'category',
                    data: dates,
                    axisLabel: {
                        rotate: 0,
                        fontSize: 10,
                        formatter: function(value) {
                            return value.substring(5); // 只显示月-日
                        }
                    },
                    axisLine: { lineStyle: { color: '#ddd' } },
                    axisTick: { show: false }
                },
                yAxis: {
                    type: 'value',
                    axisLabel: {
                        formatter: function(value) {
                            return ((value - 1) * 100).toFixed(0) + '%';
                        },
                        fontSize: 10
                    },
                    axisLine: { show: false },
                    splitLine: { lineStyle: { color: '#f0f0f0', type: 'dashed' } }
                },
                series: [
                    {
                        name: '策略净值',
                        type: 'line',
                        data: strategyValues,
                        smooth: true,
                        lineStyle: { color: '#e74c3c', width: 2 },
                        itemStyle: { color: '#e74c3c' },
                        showSymbol: false,
                        areaStyle: {
                            color: {
                                type: 'linear',
                                x: 0, y: 0, x2: 0, y2: 1,
                                colorStops: [
                                    { offset: 0, color: 'rgba(231,76,60,0.3)' },
                                    { offset: 1, color: 'rgba(231,76,60,0.05)' }
                                ]
                            }
                        }
                    },
                    {
                        name: '基准净值',
                        type: 'line',
                        data: benchmarkValues,
                        smooth: true,
                        lineStyle: { color: '#3498db', width: 2 },
                        itemStyle: { color: '#3498db' },
                        showSymbol: false
                    }
                ]
            };
            
            equityChart.setOption(option);
        }

        function switchPeriod(period, element) {
            // 更新标签状态
            document.querySelectorAll('.period-tabs .tab').forEach(t => t.classList.remove('active'));
            element.classList.add('active');
            
            // 更新图表
            updateEquityChart(period);
        }

        // 响应窗口大小变化
        window.addEventListener('resize', () => {
            if (equityChart) equityChart.resize();
        });

        async function exportTrades() {
            if (!backtestResult) {
                showError('没有可导出的回测结果');
                return;
            }
            
            // 获取筛选参数
            const startDate = document.getElementById('trade-start-date').value;
            const endDate = document.getElementById('trade-end-date').value;
            const fundCode = document.getElementById('trade-fund-filter').value;
            const action = document.getElementById('trade-action-filter').value;
            
            // 如果有task_id，使用后端导出
            if (backtestResult.task_id) {
                let url = `/api/strategy-backtest/export/${backtestResult.task_id}?`;
                if (startDate) url += `start_date=${startDate}&`;
                if (endDate) url += `end_date=${endDate}&`;
                if (fundCode) url += `fund_code=${fundCode}&`;
                if (action) url += `action=${action}&`;
                
                window.open(url, '_blank');
            } else {
                // 前端导出
                exportTradesToCSV(window.filteredTrades || window.originalTrades || []);
            }
        }

        // 前端CSV导出函数
        function exportTradesToCSV(trades) {
            if (!trades || trades.length === 0) {
                showError('没有可导出的交易记录');
                return;
            }
            
            // CSV表头
            const headers = ['交易日期', '基金代码', '基金名称', '交易方向', '交易金额', '成交价格', '交易份额', '账户余额', '持仓价值', '交易原因'];
            
            // 交易方向映射
            const actionMap = {
                'buy': '买入',
                'sell': '卖出',
                'stop_loss': '止损',
                'take_profit': '止盈',
                'daily_stop_loss': '每日止损',
                'daily_take_profit': '每日止盈',
                'total_stop_loss': '累计止损',
                'trailing_stop': '追踪止损'
            };
            
            // 构建CSV内容
            let csvContent = '\uFEFF'; // BOM for UTF-8
            csvContent += headers.join(',') + '\n';
            
            trades.forEach(t => {
                const row = [
                    t.date || '',
                    t.fund_code || '',
                    `"${(t.fund_name || '').replace(/"/g, '""')}"`,
                    actionMap[t.action] || t.action,
                    (t.amount || 0).toFixed(2),
                    (t.price || 0).toFixed(4),
                    (t.shares || 0).toFixed(4),
                    (t.balance || 0).toFixed(2),
                    (t.holdings_value || 0).toFixed(2),
                    `"${(t.reason || '').replace(/"/g, '""')}"`
                ];
                csvContent += row.join(',') + '\n';
            });
            
            // 创建下载链接
            const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
            const link = document.createElement('a');
            const url = URL.createObjectURL(blob);
            link.setAttribute('href', url);
            link.setAttribute('download', `交易记录_${new Date().toISOString().split('T')[0]}.csv`);
            link.style.visibility = 'hidden';
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
        }

        // ==================== UI辅助函数 ====================
        function toggleSection(titleElement) {
            titleElement.classList.toggle('collapsed');
            const content = titleElement.nextElementSibling;
            content.classList.toggle('collapsed');
        }

        function showError(message) {
            showToast(message, 'error');
        }

        function showSuccess(message) {
            showToast(message, 'success');
        }
        
        // Toast提示组件
        function showToast(message, type = 'info') {
            // 移除已存在的toast
            const existingToast = document.querySelector('.toast-notification');
            if (existingToast) {
                existingToast.remove();
            }
            
            const toast = document.createElement('div');
            toast.className = 'toast-notification';
            
            const bgColor = type === 'error' ? 'var(--danger-red)' : 
                           type === 'success' ? 'var(--success-green)' : '#3498db';
            const icon = type === 'error' ? 'bi-exclamation-circle' : 
                        type === 'success' ? 'bi-check-circle' : 'bi-info-circle';
            
            toast.innerHTML = `
                <i class="bi ${icon}"></i>
                <span>${escapeHtml(message)}</span>
            `;
            
            toast.style.cssText = `
                position: fixed;
                top: 70px;
                right: 20px;
                background: ${bgColor};
                color: white;
                padding: 12px 20px;
                border-radius: 6px;
                display: flex;
                align-items: center;
                gap: 10px;
                z-index: 3000;
                box-shadow: 0 4px 12px rgba(0,0,0,0.15);
                animation: slideIn 0.3s ease;
                font-size: 13px;
            `;
            
            document.body.appendChild(toast);
            
            // 3秒后自动消失
            setTimeout(() => {
                toast.style.animation = 'slideOut 0.3s ease';
                setTimeout(() => toast.remove(), 300);
            }, 3000);
        }

        function escapeHtml(text) {
            if (!text) return '';
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }

        function formatPercent(value) {
            if (value === null || value === undefined || isNaN(value)) return '--';
            return (value * 100).toFixed(2) + '%';
        }

        function formatNumber(value) {
            if (value === null || value === undefined || isNaN(value)) return '--';
            return parseFloat(value).toFixed(2);
        }
    </script>
</body>
</html>
