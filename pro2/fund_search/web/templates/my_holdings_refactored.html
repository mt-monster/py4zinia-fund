<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>投资账本 - 基金分析系统</title>
    
    <!-- 外部资源 -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.8/dist/chart.umd.min.js"></script>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.0/font/bootstrap-icons.css">
    <link rel="stylesheet" href="{{ url_for('static', filename='css/my-holdings-refactored.css') }}">
</head>
<body>
    <!-- 顶部导航 -->
    <nav class="top-nav">
        <a href="/dashboard" class="brand">投资账本</a>
        <div class="nav-links">
            <a href="/dashboard"><i class="bi bi-speedometer2"></i> 仪表盘</a>
            <a href="/my-holdings-new" class="active"><i class="bi bi-wallet2"></i> 我的持仓</a>
            <a href="/etf"><i class="bi bi-currency-exchange"></i> ETF市场</a>
            <a href="/strategy"><i class="bi bi-lightbulb"></i> 策略分析</a>
            <a href="/strategy-editor"><i class="bi bi-pencil-square"></i> 编写策略</a>
        </div>
        <div class="search-global">
            <span>沪深主板指数 <span id="index-value">--</span></span>
        </div>
    </nav>

    <!-- 主内容区 -->
    <main class="main-content">
        <!-- 工具栏 -->
        <header class="toolbar">
            <div class="search-box">
                <i class="bi bi-search"></i>
                <input type="text" id="search-input" placeholder="搜索基金代码/名称" 
                       onkeyup="handleSearchKeyup(event)">
            </div>
            
            <div class="quick-actions">
                <button class="btn btn-primary" onclick="openFilterModal()">
                    <i class="bi bi-funnel"></i> 高级筛选
                </button>
                <button class="btn btn-primary" onclick="openScreenshotModal()">
                    <i class="bi bi-camera"></i> 截图导入
                </button>
                <button class="btn btn-primary" onclick="openManualImportModal()">
                    <i class="bi bi-plus-circle"></i> 手工导入
                </button>
                <button class="btn btn-primary" id="analysis-btn" onclick="startAnalysis()">
                    <i class="bi bi-chart-line"></i> 相关性分析
                </button>
                <button class="btn btn-primary" id="investment-advice-btn" onclick="startInvestmentAdvice()">
                    <i class="bi bi-lightbulb"></i> 投资建议
                </button>
                <button class="btn btn-secondary" onclick="clearFundList()">
                    <i class="bi bi-trash"></i> 清空列表
                </button>
            </div>
            
            <div class="toolbar-right">
                <span class="fund-count">共 <span id="total-count">0</span> 只基金</span>
                <button class="btn btn-ghost" onclick="openSettingsModal()">
                    <i class="bi bi-gear"></i> 表头管理
                </button>
            </div>
        </header>

        <!-- 筛选标签展示 -->
        <div class="filter-tags" id="active-filters" style="display: none;"></div>

        <!-- 表格区域 -->
        <div class="table-container">
            <div class="table-wrapper">
                <table class="fund-table" id="fund-table">
                    <thead>
                        <tr id="table-header">
                            <th class="checkbox-cell">
                                <input type="checkbox" id="select-all" onchange="toggleSelectAll()">
                            </th>
                            <!-- 动态表头 -->
                        </tr>
                    </thead>
                    <tbody id="table-body">
                        <tr>
                            <td colspan="20" class="loading-state">加载中...</td>
                        </tr>
                    </tbody>
                </table>
            </div>
        </div>
    </main>

    <!-- 筛选模态框 -->
    <div class="modal-overlay" id="filter-modal" onclick="handleModalBackdrop(event)">
        <div class="modal" onclick="event.stopPropagation()">
            <header class="modal-header">
                <h3 class="modal-title">基金筛选</h3>
                <button class="modal-close" onclick="closeFilterModal()">
                    <i class="bi bi-x-lg"></i>
                </button>
            </header>
            
            <div class="modal-body">
                <nav class="tabs">
                    <button class="tab-btn active" data-tab="basic" onclick="switchTab('basic')">基本信息</button>
                    <button class="tab-btn" data-tab="performance" onclick="switchTab('performance')">业绩指标</button>
                    <button class="tab-btn" data-tab="risk" onclick="switchTab('risk')">风险指标</button>
                    <button class="tab-btn" data-tab="type" onclick="switchTab('type')">基金类型</button>
                </nav>
                
                <!-- 基本信息 -->
                <div class="tab-content active" id="tab-basic">
                    <div class="form-group">
                        <label class="form-label">基金代码</label>
                        <input type="text" class="form-control" id="filter-code" placeholder="输入基金代码">
                    </div>
                    <div class="form-group">
                        <label class="form-label">基金名称</label>
                        <input type="text" class="form-control" id="filter-name" placeholder="输入基金名称">
                    </div>
                    <div class="form-group">
                        <label class="form-label">购买日期范围</label>
                        <div class="form-row">
                            <input type="date" class="form-control" id="filter-date-start">
                            <input type="date" class="form-control" id="filter-date-end">
                        </div>
                    </div>
                </div>
                
                <!-- 业绩指标 -->
                <div class="tab-content" id="tab-performance">
                    <div class="form-group">
                        <label class="form-label">今日收益范围 (%)</label>
                        <div class="form-row">
                            <input type="number" class="form-control" id="filter-today-min" placeholder="最小值" step="0.01">
                            <input type="number" class="form-control" id="filter-today-max" placeholder="最大值" step="0.01">
                        </div>
                    </div>
                    <div class="form-group">
                        <label class="form-label">年化收益范围 (%)</label>
                        <div class="form-row">
                            <input type="number" class="form-control" id="filter-annual-min" placeholder="最小值" step="0.01">
                            <input type="number" class="form-control" id="filter-annual-max" placeholder="最大值" step="0.01">
                        </div>
                    </div>
                    <div class="form-group">
                        <label class="form-label">持有金额范围 (元)</label>
                        <div class="form-row">
                            <input type="number" class="form-control" id="filter-amount-min" placeholder="最小值">
                            <input type="number" class="form-control" id="filter-amount-max" placeholder="最大值">
                        </div>
                    </div>
                </div>
                
                <!-- 风险指标 -->
                <div class="tab-content" id="tab-risk">
                    <div class="form-group">
                        <label class="form-label">最大回撤范围 (%)</label>
                        <div class="form-row">
                            <input type="number" class="form-control" id="filter-drawdown-min" placeholder="最小值" step="0.01">
                            <input type="number" class="form-control" id="filter-drawdown-max" placeholder="最大值" step="0.01">
                        </div>
                    </div>
                    <div class="form-group">
                        <label class="form-label">夏普比率范围</label>
                        <div class="form-row">
                            <input type="number" class="form-control" id="filter-sharpe-min" placeholder="最小值" step="0.01">
                            <input type="number" class="form-control" id="filter-sharpe-max" placeholder="最大值" step="0.01">
                        </div>
                    </div>
                </div>
                
                <!-- 基金类型 -->
                <div class="tab-content" id="tab-type">
                    <div class="form-group">
                        <label class="form-label">基金类型</label>
                        <div class="form-check">
                            <input type="checkbox" class="form-check-input" id="filter-odii" value="odii">
                            <label class="form-check-label" for="filter-odii">QDII/海外基金</label>
                        </div>
                        <div class="form-check">
                            <input type="checkbox" class="form-check-input" id="filter-etf" value="etf">
                            <label class="form-check-label" for="filter-etf">ETF基金</label>
                        </div>
                        <div class="form-check">
                            <input type="checkbox" class="form-check-input" id="filter-index" value="index">
                            <label class="form-check-label" for="filter-index">指数基金</label>
                        </div>
                        <div class="form-check">
                            <input type="checkbox" class="form-check-input" id="filter-active" value="active">
                            <label class="form-check-label" for="filter-active">主动基金</label>
                        </div>
                    </div>
                </div>
            </div>
            
            <footer class="modal-footer">
                <button class="btn btn-secondary" onclick="resetFilters()">重置</button>
                <button class="btn btn-primary" onclick="applyFilters()">应用筛选</button>
            </footer>
        </div>
    </div>

    <!-- 截图导入模态框 -->
    <div class="modal-overlay" id="screenshot-modal" onclick="handleModalBackdrop(event)">
        <div class="modal" onclick="event.stopPropagation()">
            <header class="modal-header">
                <h3 class="modal-title"><i class="bi bi-camera"></i> 上传基金持仓截图</h3>
                <button class="modal-close" onclick="closeScreenshotModal()">
                    <i class="bi bi-x-lg"></i>
                </button>
            </header>
            
            <div class="modal-body">
                <div class="upload-area" id="upload-area" onclick="document.getElementById('screenshot-input').click()">
                    <i class="bi bi-cloud-upload"></i>
                    <p>点击选择图片或拖拽图片到此处</p>
                    <p class="hint">支持 JPG、PNG 格式，建议上传清晰的基金持仓截图</p>
                    <input type="file" id="screenshot-input" accept="image/*" style="display: none;" onchange="handleFileSelect(event)">
                </div>
                
                <div id="preview-section" style="display: none; margin-top: var(--space-4);">
                    <img id="image-preview" style="max-width: 100%; border-radius: var(--border-radius-md);">
                    <div id="recognition-result" style="margin-top: var(--space-4);"></div>
                </div>
            </div>
            
            <footer class="modal-footer">
                <button class="btn btn-secondary" onclick="closeScreenshotModal()">取消</button>
                <button class="btn btn-primary" id="import-btn" onclick="importFunds()" disabled>确认导入</button>
            </footer>
        </div>
    </div>

    <!-- 设置面板 -->
    <aside class="settings-panel" id="settings-panel">
        <header class="settings-header">
            <h3 class="modal-title">表头管理</h3>
            <button class="modal-close" onclick="closeSettingsModal()">
                    <i class="bi bi-x-lg"></i>
                </button>
        </header>
        <div class="settings-body" id="settings-body">
            <!-- 动态生成列设置 -->
        </div>
        <footer class="settings-footer">
            <button class="btn btn-secondary" onclick="resetColumns()">恢复默认</button>
            <button class="btn btn-primary" onclick="saveColumnSettings()">保存设置</button>
        </footer>
    </aside>

    <!-- 编辑模态框 -->
    <div class="modal-overlay" id="edit-modal" onclick="handleModalBackdrop(event)">
        <div class="modal" onclick="event.stopPropagation()">
            <header class="modal-header">
                <h3 class="modal-title"><i class="bi bi-pencil-square"></i> 编辑基金</h3>
                <button class="modal-close" onclick="FundEdit.closeModal()">
                    <i class="bi bi-x-lg"></i>
                </button>
            </header>
            <div class="modal-body">
                <div id="edit-form-body">
                    <!-- 动态生成编辑表单 -->
                </div>
            </div>
            <footer class="modal-footer">
                <button class="btn btn-secondary" onclick="FundEdit.closeModal()">取消</button>
                <button class="btn btn-primary" onclick="FundEdit.save()">保存</button>
            </footer>
        </div>
    </div>

    <!-- 详情侧边面板 -->
    <aside class="detail-panel" id="detail-panel">
        <header class="detail-panel-header">
            <h3 class="detail-panel-title">基金详情</h3>
            <button class="modal-close" onclick="FundDetail.closePanel()">
                <i class="bi bi-x-lg"></i>
            </button>
        </header>
        <div class="detail-panel-body" id="detail-panel-body">
            <!-- 动态生成详情内容 -->
        </div>
    </aside>

    <!-- 手工导入模态框 -->
    <div class="modal-overlay" id="manual-import-modal" onclick="handleModalBackdrop(event)">
        <div class="modal" onclick="event.stopPropagation()" style="max-width: 600px;">
            <header class="modal-header">
                <h3 class="modal-title"><i class="bi bi-plus-circle"></i> 手工导入基金</h3>
                <button class="modal-close" onclick="closeManualImportModal()">
                    <i class="bi bi-x-lg"></i>
                </button>
            </header>
            
            <div class="modal-body">
                <nav class="tabs">
                    <button class="tab-btn active" data-tab="import" onclick="switchManualImportTab('import')">导入基金</button>
                    <button class="tab-btn" data-tab="history" onclick="switchManualImportTab('history')">导入历史</button>
                </nav>
                
                <!-- 导入基金标签页 -->
                <div class="tab-content active" id="tab-import">
                    <div class="form-group">
                        <label class="form-label">基金代码或名称</label>
                        <div style="position: relative;">
                            <input type="text" class="form-control" id="fund-search-input" 
                                   placeholder="输入基金代码或名称" onkeyup="handleFundSearch(event)">
                            <div id="fund-search-results" class="search-results" style="display: none; position: absolute; top: 100%; left: 0; right: 0; background: white; border: 1px solid #ddd; border-radius: 4px; max-height: 200px; overflow-y: auto; z-index: 1000;"></div>
                        </div>
                    </div>
                    
                    <div class="form-group">
                        <label class="form-label">持有金额 (元)</label>
                        <input type="number" class="form-control" id="holding-amount" 
                               placeholder="输入持有金额" step="0.01" min="0">
                    </div>
                    
                    <div class="form-group">
                        <label class="form-label">购买日期</label>
                        <input type="date" class="form-control" id="buy-date" 
                               value="{{ today | default('', true) }}">
                    </div>
                    
                    <div id="fund-info" style="margin-top: 20px; padding: 15px; background: #f8f9fa; border-radius: 8px; display: none;">
                        <h4 style="margin-bottom: 10px;">基金信息</h4>
                        <div id="fund-info-content"></div>
                    </div>
                </div>
                
                <!-- 导入历史标签页 -->
                <div class="tab-content" id="tab-history">
                    <div id="import-history-list" style="max-height: 300px; overflow-y: auto;">
                        <!-- 动态生成导入历史 -->
                        <div class="empty-state" style="text-align: center; padding: 40px 0; color: #6c757d;">
                            <i class="bi bi-clock-history" style="font-size: 48px; margin-bottom: 15px;"></i>
                            <p>暂无导入历史</p>
                        </div>
                    </div>
                </div>
            </div>
            
            <footer class="modal-footer">
                <button class="btn btn-secondary" onclick="closeManualImportModal()">取消</button>
                <button class="btn btn-primary" id="confirm-import-btn" onclick="confirmManualImport()" disabled>
                    确认导入
                </button>
            </footer>
        </div>
    </div>

    <!-- 投资建议模态框 -->
    <div class="modal-overlay" id="investment-advice-modal" onclick="handleInvestmentAdviceBackdrop(event)">
        <div class="modal modal-large" onclick="event.stopPropagation()">
            <header class="modal-header">
                <h3 class="modal-title"><i class="bi bi-lightbulb"></i> 投资建议 - 综合分析结果</h3>
                <button class="modal-close" onclick="closeInvestmentAdviceModal()">
                    <i class="bi bi-x-lg"></i>
                </button>
            </header>
            
            <div class="modal-body" id="investment-advice-body">
                <div class="investment-advice-container">
                    <!-- 加载状态 -->
                    <div id="advice-loading" class="loading-state">
                        <i class="bi bi-arrow-repeat spinning"></i>
                        <p>正在分析您的持仓基金...</p>
                    </div>
                    
                    <!-- 错误状态 -->
                    <div id="advice-error" class="error-message" style="display: none;">
                        <i class="bi bi-exclamation-triangle"></i>
                        <p>分析失败，请稍后重试</p>
                    </div>
                    
                    <!-- 分析结果内容 -->
                    <div id="advice-content" style="display: none;">
                        <!-- 综合分析结果区域 -->
                        <div id="comprehensive-analysis-section" class="analysis-section">
                            <h2><i class="bi bi-graph-up-arrow"></i> 综合分析结果</h2>
                            <div id="comprehensive-content">
                                <div id="fund-analysis-dashboard"></div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            
            <footer class="modal-footer">
                <button class="btn btn-secondary" onclick="closeInvestmentAdviceModal()">关闭</button>
                <button class="btn btn-primary" onclick="refreshInvestmentAdvice()">
                    <i class="bi bi-arrow-clockwise"></i> 刷新分析
                </button>
            </footer>
        </div>
    </div>

    <!-- JavaScript 模块 -->
    <script src="{{ url_for('static', filename='js/my-holdings/config.js') }}"></script>
    <script src="{{ url_for('static', filename='js/my-holdings/utils.js') }}"></script>
    <script src="{{ url_for('static', filename='js/my-holdings/api.js') }}"></script>
    <script src="{{ url_for('static', filename='js/my-holdings/table.js') }}"></script>
    <script src="{{ url_for('static', filename='js/my-holdings/filters.js') }}"></script>
    <script src="{{ url_for('static', filename='js/my-holdings/screenshot.js') }}"></script>
    <script src="{{ url_for('static', filename='js/my-holdings/settings.js') }}"></script>
    <script src="{{ url_for('static', filename='js/my-holdings/edit.js') }}"></script>
    <script src="{{ url_for('static', filename='js/my-holdings/detail.js') }}"></script>
    <!-- 投资建议功能所需的外部脚本 -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/4.4.0/chart.umd.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-annotation@3.0.1/dist/chartjs-plugin-annotation.min.js"></script>
    <script src="{{ url_for('static', filename='js/heavyweight-stocks.js') }}"></script>
    <script src="{{ url_for('static', filename='js/realtime-data-tables.js') }}"></script>
    <script src="{{ url_for('static', filename='js/fund-analysis-dashboard.js') }}"></script>
    
    <script src="{{ url_for('static', filename='js/my-holdings/main.js') }}"></script>
    
    <!-- 投资建议模态框功能 -->
    <script>
        // 打开投资建议模态框
        function openInvestmentAdviceModal() {
            const modal = document.getElementById('investment-advice-modal');
            modal.classList.add('active');
            document.body.style.overflow = 'hidden';
            
            // 加载分析数据
            loadInvestmentAdviceData();
        }
        
        // 关闭投资建议模态框
        function closeInvestmentAdviceModal() {
            const modal = document.getElementById('investment-advice-modal');
            modal.classList.remove('active');
            document.body.style.overflow = '';
        }
        
        // 点击背景关闭模态框
        function handleInvestmentAdviceBackdrop(event) {
            if (event.target === event.currentTarget) {
                closeInvestmentAdviceModal();
            }
        }
        
        // 刷新投资建议
        function refreshInvestmentAdvice() {
            loadInvestmentAdviceData();
        }
        
        // 加载投资建议数据
        async function loadInvestmentAdviceData() {
            const loadingEl = document.getElementById('advice-loading');
            const errorEl = document.getElementById('advice-error');
            const contentEl = document.getElementById('advice-content');
            
            // 显示加载状态
            loadingEl.style.display = 'flex';
            errorEl.style.display = 'none';
            contentEl.style.display = 'none';
            
            try {
                // 获取当前选中的基金代码
                const fundCodes = getSelectedFundCodes();
                
                if (fundCodes.length === 0) {
                    // 如果没有选中基金，获取所有持仓基金
                    const allFunds = await fetchUserHoldings();
                    fundCodes.push(...allFunds.map(f => f.fund_code));
                }
                
                if (fundCodes.length === 0) {
                    throw new Error('请先添加基金持仓');
                }
                
                // 调用综合分析API
                const response = await fetch('/api/holdings/analyze/comprehensive', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ fund_codes: fundCodes })
                });
                
                const result = await response.json();
                
                if (result.success) {
                    renderInvestmentAdvice(result.data, fundCodes);
                    loadingEl.style.display = 'none';
                    contentEl.style.display = 'block';
                } else {
                    throw new Error(result.error || '分析失败');
                }
            } catch (error) {
                console.error('加载投资建议失败:', error);
                loadingEl.style.display = 'none';
                errorEl.style.display = 'flex';
                errorEl.querySelector('p').textContent = error.message || '分析失败，请稍后重试';
            }
        }
        
        // 渲染投资建议
        function renderInvestmentAdvice(data, fundCodes) {
            const contentDiv = document.getElementById('comprehensive-content');
            
            // 保存基金代码列表供后续使用
            data.fund_codes = fundCodes;
            
            // 清空并重新创建仪表盘容器（添加最小高度避免负半径错误）
            contentDiv.innerHTML = '<div id="fund-analysis-dashboard" style="min-height: 500px;"></div>';
            
            // 延迟初始化，确保模态框已完全显示并且容器有正确尺寸
            setTimeout(() => {
                // 初始化基金分析仪表盘
                if (typeof initFundAnalysisDashboard === 'function') {
                    initFundAnalysisDashboard('fund-analysis-dashboard', data);
                } else {
                    console.error('initFundAnalysisDashboard 函数未定义');
                    contentDiv.innerHTML = '<div class="error-message"><p>仪表盘组件加载失败</p></div>';
                }
            }, 100);
        }
        
        // 获取选中的基金代码
        function getSelectedFundCodes() {
            const checkboxes = document.querySelectorAll('#fund-table tbody input[type="checkbox"]:checked');
            const fundCodes = [];
            checkboxes.forEach(checkbox => {
                const row = checkbox.closest('tr');
                if (row) {
                    const fundCode = row.dataset.fundCode;
                    if (fundCode) {
                        fundCodes.push(fundCode);
                    }
                }
            });
            return fundCodes;
        }
        
        // 获取用户持仓基金列表
        async function fetchUserHoldings() {
            try {
                const response = await fetch('/api/holdings?page=1&per_page=1000');
                const result = await response.json();
                if (result.success) {
                    return result.data || [];
                }
                return [];
            } catch (error) {
                console.error('获取持仓失败:', error);
                return [];
            }
        }
        
        // ESC键关闭模态框
        document.addEventListener('keydown', function(event) {
            if (event.key === 'Escape') {
                const modal = document.getElementById('investment-advice-modal');
                if (modal.classList.contains('active')) {
                    closeInvestmentAdviceModal();
                }
            }
        });
    </script>
    
    <!-- 应用初始化 -->
    <script>
        // 页面加载完成后初始化应用
        document.addEventListener('DOMContentLoaded', async function() {
            try {
                await FundApp.init();
                // 添加调试信息
                console.log('FundScreenshot object:', window.FundScreenshot);
                console.log('FundScreenshot.recognizedFunds:', window.FundScreenshot ? window.FundScreenshot.recognizedFunds : 'FundScreenshot not available');
            } catch (error) {
                console.error('应用初始化失败:', error);
            }
        });
    </script>
</body>
</html>
