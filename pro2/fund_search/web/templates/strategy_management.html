<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>策略管理系统 - 基金分析系统</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.0/font/bootstrap-icons.css" rel="stylesheet">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/4.4.0/chart.umd.min.js"></script>
    <link rel="stylesheet" href="{{ url_for('static', filename='css/fund-analysis-dashboard.css') }}">
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', 'PingFang SC', 'Hiragino Sans GB', 'Microsoft YaHei', sans-serif;
            background-color: #f5f7fa;
            color: #333;
            line-height: 1.6;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
            padding: 20px;
        }

        /* 页面头部 */
        .page-header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 30px;
            border-radius: 12px;
            margin-bottom: 30px;
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.1);
        }

        .page-header h1 {
            font-size: 28px;
            margin-bottom: 10px;
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .page-header p {
            font-size: 14px;
            opacity: 0.9;
        }

        /* 导航标签 */
        .nav-tabs {
            display: flex;
            gap: 10px;
            margin-bottom: 20px;
            background: white;
            padding: 10px;
            border-radius: 12px;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.08);
        }

        .nav-tab {
            padding: 12px 24px;
            border: none;
            background: transparent;
            cursor: pointer;
            border-radius: 8px;
            font-size: 14px;
            font-weight: 500;
            color: #666;
            transition: all 0.3s;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .nav-tab:hover {
            background: #f0f2f5;
            color: #333;
        }

        .nav-tab.active {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
        }

        /* 内容区域 */
        .tab-content {
            display: none;
        }

        .tab-content.active {
            display: block;
        }

        .content-section {
            background: white;
            padding: 24px;
            border-radius: 12px;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.08);
            margin-bottom: 20px;
        }

        .section-title {
            font-size: 18px;
            font-weight: 600;
            margin-bottom: 20px;
            display: flex;
            align-items: center;
            gap: 10px;
            color: #2c3e50;
        }

        /* 统计卡片 */
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }

        .stat-card {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 24px;
            border-radius: 12px;
            box-shadow: 0 4px 12px rgba(102, 126, 234, 0.3);
        }

        .stat-card.success {
            background: linear-gradient(135deg, #11998e 0%, #38ef7d 100%);
            box-shadow: 0 4px 12px rgba(17, 153, 142, 0.3);
        }

        .stat-card.warning {
            background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);
            box-shadow: 0 4px 12px rgba(240, 147, 251, 0.3);
        }

        .stat-card.info {
            background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%);
            box-shadow: 0 4px 12px rgba(79, 172, 254, 0.3);
        }

        .stat-label {
            font-size: 14px;
            opacity: 0.9;
            margin-bottom: 8px;
        }

        .stat-value {
            font-size: 32px;
            font-weight: 700;
        }

        .stat-change {
            font-size: 12px;
            margin-top: 8px;
            opacity: 0.8;
        }

        /* 表格样式 */
        .data-table {
            width: 100%;
            border-collapse: collapse;
        }

        .data-table th,
        .data-table td {
            padding: 12px;
            text-align: left;
            border-bottom: 1px solid #e8ecf1;
        }

        .data-table th {
            font-weight: 600;
            color: #666;
            background: #f8f9fa;
        }

        .data-table tr:hover {
            background: #f8f9fa;
        }

        /* 按钮样式 */
        .btn {
            padding: 10px 20px;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-size: 14px;
            font-weight: 500;
            transition: all 0.3s;
            display: inline-flex;
            align-items: center;
            gap: 8px;
        }

        .btn-primary {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
        }

        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(102, 126, 234, 0.4);
        }

        .btn-secondary {
            background: #f0f2f5;
            color: #333;
        }

        .btn-secondary:hover {
            background: #e4e6e9;
        }

        .btn-success {
            background: linear-gradient(135deg, #11998e 0%, #38ef7d 100%);
            color: white;
        }

        /* 表单样式 */
        .form-group {
            margin-bottom: 20px;
        }

        .form-label {
            display: block;
            margin-bottom: 8px;
            font-weight: 500;
            color: #333;
        }

        .form-control {
            width: 100%;
            padding: 10px 14px;
            border: 1px solid #ddd;
            border-radius: 8px;
            font-size: 14px;
            transition: border-color 0.3s;
        }

        .form-control:focus {
            outline: none;
            border-color: #667eea;
        }

        select.form-control {
            appearance: none;
            background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='12' height='12' viewBox='0 0 12 12'%3E%3Cpath fill='%23666' d='M6 8L1 3h10z'/%3E%3C/svg%3E");
            background-repeat: no-repeat;
            background-position: right 12px center;
            padding-right: 36px;
        }

        /* 进度条 */
        .progress-bar {
            height: 8px;
            background: #e8ecf1;
            border-radius: 4px;
            overflow: hidden;
        }

        .progress-fill {
            height: 100%;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            border-radius: 4px;
            transition: width 0.5s ease;
        }

        /* 加载状态 */
        .loading-state {
            text-align: center;
            padding: 60px 20px;
            color: #666;
        }

        .loading-state i {
            font-size: 48px;
            margin-bottom: 20px;
            color: #667eea;
            animation: spin 1s linear infinite;
            display: inline-block;
        }

        @keyframes spin {
            from { transform: rotate(0deg); }
            to { transform: rotate(360deg); }
        }

        /* 网格布局 */
        .grid-2 {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 20px;
        }

        .grid-3 {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 20px;
        }

        @media (max-width: 768px) {
            .grid-2,
            .grid-3 {
                grid-template-columns: 1fr;
            }
        }

        /* 响应式 */
        @media (max-width: 768px) {
            .nav-tabs {
                flex-wrap: wrap;
            }
            
            .nav-tab {
                flex: 1;
                min-width: 120px;
                justify-content: center;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <!-- 页面头部 -->
        <div class="page-header">
            <h1>
                <i class="bi bi-gear-wide-connected"></i>
                策略管理系统
            </h1>
            <p>策略回测验证、参数调优、用户反馈和学习机制管理</p>
        </div>

        <!-- 导航标签 -->
        <div class="nav-tabs">
            <button class="nav-tab active" data-tab="overview">
                <i class="bi bi-grid-3x3-gap"></i>
                概览
            </button>
            <button class="nav-tab" data-tab="backtest">
                <i class="bi bi-graph-up-arrow"></i>
                回测验证
            </button>
            <button class="nav-tab" data-tab="optimization">
                <i class="bi bi-sliders"></i>
                参数调优
            </button>
            <button class="nav-tab" data-tab="feedback">
                <i class="bi bi-chat-square-text"></i>
                用户反馈
            </button>
            <button class="nav-tab" data-tab="ml-strategy">
                <i class="bi bi-cpu"></i>
                ML策略
            </button>
        </div>

        <!-- 概览标签页 -->
        <div class="tab-content active" id="overview">
            <!-- 统计卡片 -->
            <div class="stats-grid">
                <div class="stat-card">
                    <div class="stat-label">策略选择准确率</div>
                    <div class="stat-value" id="accuracy-rate">--%</div>
                    <div class="stat-change">基于最近回测数据</div>
                </div>
                <div class="stat-card success">
                    <div class="stat-label">平均超额收益</div>
                    <div class="stat-value" id="excess-return">--%</div>
                    <div class="stat-change">相比默认策略</div>
                </div>
                <div class="stat-card warning">
                    <div class="stat-label">用户反馈评分</div>
                    <div class="stat-value" id="user-rating">--</div>
                    <div class="stat-change">平均评分（满分5分）</div>
                </div>
                <div class="stat-card info">
                    <div class="stat-label">策略优化次数</div>
                    <div class="stat-value" id="optimize-count">--</div>
                    <div class="stat-change">累计参数调优次数</div>
                </div>
            </div>

            <!-- 策略表现概览 -->
            <div class="content-section">
                <div class="section-title">
                    <i class="bi bi-bar-chart-line"></i>
                    策略表现概览
                </div>
                <canvas id="performance-chart" height="100"></canvas>
            </div>

            <!-- 最近活动 -->
            <div class="content-section">
                <div class="section-title">
                    <i class="bi bi-clock-history"></i>
                    最近活动
                </div>
                <table class="data-table" id="activity-table">
                    <thead>
                        <tr>
                            <th>时间</th>
                            <th>活动类型</th>
                            <th>基金代码</th>
                            <th>策略类型</th>
                            <th>结果</th>
                        </tr>
                    </thead>
                    <tbody>
                        <tr>
                            <td colspan="5" style="text-align: center; color: #999;">暂无数据</td>
                        </tr>
                    </tbody>
                </table>
            </div>
        </div>

        <!-- 回测验证标签页 -->
        <div class="tab-content" id="backtest">
            <div class="content-section">
                <div class="section-title">
                    <i class="bi bi-graph-up-arrow"></i>
                    策略回测验证
                </div>
                <div class="grid-2">
                    <div>
                        <div class="form-group">
                            <label class="form-label">选择基金</label>
                            <select class="form-control" id="backtest-fund">
                                <option value="">全部持仓基金</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label class="form-label">回测周期</label>
                            <select class="form-control" id="backtest-period">
                                <option value="monthly">每月再平衡</option>
                                <option value="weekly">每周再平衡</option>
                                <option value="quarterly">每季度再平衡</option>
                                <option value="daily">每日再平衡</option>
                            </select>
                        </div>
                    </div>
                    <div>
                        <div class="form-group">
                            <label class="form-label">开始日期</label>
                            <input type="date" class="form-control" id="backtest-start">
                        </div>
                        <div class="form-group">
                            <label class="form-label">结束日期</label>
                            <input type="date" class="form-control" id="backtest-end">
                        </div>
                    </div>
                </div>
                <div style="margin-top: 20px;">
                    <button class="btn btn-primary" onclick="runBacktest()">
                        <i class="bi bi-play-circle"></i>
                        开始回测
                    </button>
                    <button class="btn btn-secondary" onclick="compareStrategies()">
                        <i class="bi bi-arrow-left-right"></i>
                        策略对比
                    </button>
                </div>
            </div>

            <!-- 回测结果 -->
            <div class="content-section" id="backtest-result" style="display: none;">
                <div class="section-title">
                    <i class="bi bi-clipboard-data"></i>
                    回测结果
                </div>
                <div id="backtest-result-content"></div>
            </div>
        </div>

        <!-- 参数调优标签页 -->
        <div class="tab-content" id="optimization">
            <div class="content-section">
                <div class="section-title">
                    <i class="bi bi-sliders"></i>
                    策略参数优化
                </div>
                <div class="grid-3">
                    <div class="form-group">
                        <label class="form-label">优化目标</label>
                        <select class="form-control" id="optimize-target">
                            <option value="sharpe">夏普比率</option>
                            <option value="return">收益率</option>
                            <option value="risk_adjusted">风险调整收益</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label class="form-label">优化方法</label>
                        <select class="form-control" id="optimize-method">
                            <option value="grid">网格搜索</option>
                            <option value="bayesian">贝叶斯优化</option>
                            <option value="random">随机搜索</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label class="form-label">迭代次数</label>
                        <input type="number" class="form-control" id="optimize-iterations" value="100" min="10" max="1000">
                    </div>
                </div>
                <div style="margin-top: 20px;">
                    <button class="btn btn-primary" onclick="runOptimization()">
                        <i class="bi bi-magic"></i>
                        开始优化
                    </button>
                    <button class="btn btn-secondary" onclick="viewAdaptiveScore()">
                        <i class="bi bi-activity"></i>
                        查看自适应分数
                    </button>
                </div>
            </div>

            <!-- 优化结果 -->
            <div class="content-section" id="optimization-result" style="display: none;">
                <div class="section-title">
                    <i class="bi bi-trophy"></i>
                    优化结果
                </div>
                <div id="optimization-result-content"></div>
            </div>
        </div>

        <!-- 用户反馈标签页 -->
        <div class="tab-content" id="feedback">
            <div class="grid-2">
                <div class="content-section">
                    <div class="section-title">
                        <i class="bi bi-chat-square-text"></i>
                        提交反馈
                    </div>
                    <div class="form-group">
                        <label class="form-label">基金代码</label>
                        <input type="text" class="form-control" id="feedback-fund" placeholder="输入基金代码">
                    </div>
                    <div class="form-group">
                        <label class="form-label">策略类型</label>
                        <select class="form-control" id="feedback-strategy">
                            <option value="dual_ma">双均线动量策略</option>
                            <option value="mean_reversion">均值回归策略</option>
                            <option value="grid_trading">网格交易策略</option>
                            <option value="target_value">目标市值策略</option>
                            <option value="enhanced_rule">增强规则策略</option>
                            <option value="ml_prediction">机器学习预测策略</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label class="form-label">评分（1-5星）</label>
                        <div style="display: flex; gap: 10px; font-size: 24px;">
                            <i class="bi bi-star" onclick="setRating(1)" style="cursor: pointer; color: #ffc107;" data-rating="1"></i>
                            <i class="bi bi-star" onclick="setRating(2)" style="cursor: pointer; color: #ffc107;" data-rating="2"></i>
                            <i class="bi bi-star" onclick="setRating(3)" style="cursor: pointer; color: #ffc107;" data-rating="3"></i>
                            <i class="bi bi-star" onclick="setRating(4)" style="cursor: pointer; color: #ffc107;" data-rating="4"></i>
                            <i class="bi bi-star" onclick="setRating(5)" style="cursor: pointer; color: #ffc107;" data-rating="5"></i>
                        </div>
                    </div>
                    <div class="form-group">
                        <label class="form-label">评论</label>
                        <textarea class="form-control" id="feedback-comment" rows="3" placeholder="请输入您的反馈..."></textarea>
                    </div>
                    <button class="btn btn-primary" onclick="submitFeedback()">
                        <i class="bi bi-send"></i>
                        提交反馈
                    </button>
                </div>

                <div class="content-section">
                    <div class="section-title">
                        <i class="bi bi-graph-up"></i>
                        策略有效性分析
                    </div>
                    <div id="effectiveness-content">
                        <p style="color: #999; text-align: center; padding: 40px;">
                            点击"加载数据"查看策略有效性分析
                        </p>
                    </div>
                    <button class="btn btn-secondary" onclick="loadEffectiveness()" style="margin-top: 10px;">
                        <i class="bi bi-arrow-clockwise"></i>
                        加载数据
                    </button>
                </div>
            </div>
        </div>

        <!-- ML策略标签页 -->
        <div class="tab-content" id="ml-strategy">
            <div class="content-section">
                <div class="section-title">
                    <i class="bi bi-cpu"></i>
                    机器学习预测策略
                </div>
                <div class="grid-2">
                    <div>
                        <h4 style="margin-bottom: 15px;">支持的模型</h4>
                        <ul style="list-style: none; padding: 0;">
                            <li style="padding: 8px 0; display: flex; align-items: center; gap: 10px;">
                                <i class="bi bi-check-circle-fill" style="color: #28a745;"></i>
                                Random Forest
                            </li>
                            <li style="padding: 8px 0; display: flex; align-items: center; gap: 10px;">
                                <i class="bi bi-check-circle-fill" style="color: #28a745;"></i>
                                XGBoost
                            </li>
                            <li style="padding: 8px 0; display: flex; align-items: center; gap: 10px;">
                                <i class="bi bi-check-circle-fill" style="color: #28a745;"></i>
                                LSTM (深度学习)
                            </li>
                            <li style="padding: 8px 0; display: flex; align-items: center; gap: 10px;">
                                <i class="bi bi-check-circle-fill" style="color: #28a745;"></i>
                                Ridge/Lasso 回归
                            </li>
                        </ul>
                    </div>
                    <div>
                        <h4 style="margin-bottom: 15px;">特征工程</h4>
                        <ul style="list-style: none; padding: 0;">
                            <li style="padding: 8px 0; display: flex; align-items: center; gap: 10px;">
                                <i class="bi bi-check-circle-fill" style="color: #28a745;"></i>
                                技术指标 (MA, RSI, MACD, 布林带)
                            </li>
                            <li style="padding: 8px 0; display: flex; align-items: center; gap: 10px;">
                                <i class="bi bi-check-circle-fill" style="color: #28a745;"></i>
                                波动率特征
                            </li>
                            <li style="padding: 8px 0; display: flex; align-items: center; gap: 10px;">
                                <i class="bi bi-check-circle-fill" style="color: #28a745;"></i>
                                趋势和动量特征
                            </li>
                            <li style="padding: 8px 0; display: flex; align-items: center; gap: 10px;">
                                <i class="bi bi-check-circle-fill" style="color: #28a745;"></i>
                                量价关系特征
                            </li>
                        </ul>
                    </div>
                </div>
            </div>

            <div class="content-section">
                <div class="section-title">
                    <i class="bi bi-lightning"></i>
                    快速测试
                </div>
                <div class="form-group">
                    <label class="form-label">基金代码</label>
                    <div style="display: flex; gap: 10px;">
                        <input type="text" class="form-control" id="ml-test-fund" placeholder="输入基金代码" style="flex: 1;">
                        <button class="btn btn-primary" onclick="testMLStrategy()">
                            <i class="bi bi-play"></i>
                            测试
                        </button>
                    </div>
                </div>
                <div id="ml-test-result" style="margin-top: 20px;"></div>
            </div>
        </div>
    </div>

    <script>
        // 标签页切换
        document.querySelectorAll('.nav-tab').forEach(tab => {
            tab.addEventListener('click', function() {
                document.querySelectorAll('.nav-tab').forEach(t => t.classList.remove('active'));
                document.querySelectorAll('.tab-content').forEach(t => t.classList.remove('active'));
                
                this.classList.add('active');
                document.getElementById(this.dataset.tab).classList.add('active');
            });
        });

        // 初始化日期
        document.getElementById('backtest-end').valueAsDate = new Date();
        const startDate = new Date();
        startDate.setFullYear(startDate.getFullYear() - 1);
        document.getElementById('backtest-start').valueAsDate = startDate;

        // 加载持仓基金列表
        async function loadHoldings() {
            try {
                const response = await fetch('/api/holdings');
                const result = await response.json();
                
                if (result.success && result.data) {
                    const select = document.getElementById('backtest-fund');
                    result.data.forEach(holding => {
                        const option = document.createElement('option');
                        option.value = holding.fund_code;
                        option.textContent = `${holding.fund_code} - ${holding.fund_name || holding.fund_code}`;
                        select.appendChild(option);
                    });
                }
            } catch (error) {
                console.error('加载持仓失败:', error);
            }
        }

        loadHoldings();

        // 运行回测
        async function runBacktest() {
            const fundCode = document.getElementById('backtest-fund').value;
            const period = document.getElementById('backtest-period').value;
            const startDate = document.getElementById('backtest-start').value;
            const endDate = document.getElementById('backtest-end').value;

            const resultSection = document.getElementById('backtest-result');
            const resultContent = document.getElementById('backtest-result-content');
            
            resultContent.innerHTML = '<div class="loading-state"><i class="bi bi-arrow-repeat"></i><p>正在运行回测...</p></div>';
            resultSection.style.display = 'block';

            try {
                const response = await fetch('/api/strategy/backtest', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        fund_code: fundCode || undefined,
                        period: period,
                        start_date: startDate || undefined,
                        end_date: endDate || undefined
                    })
                });

                const result = await response.json();
                
                if (result.success) {
                    displayBacktestResult(result.data);
                } else {
                    resultContent.innerHTML = `<div style="color: #dc3545;"><i class="bi bi-exclamation-triangle"></i> ${result.error}</div>`;
                }
            } catch (error) {
                resultContent.innerHTML = `<div style="color: #dc3545;"><i class="bi bi-exclamation-triangle"></i> 请求失败: ${error.message}</div>`;
            }
        }

        // 显示回测结果
        function displayBacktestResult(data) {
            const content = document.getElementById('backtest-result-content');
            
            if (!data || data.length === 0) {
                content.innerHTML = '<p style="color: #999;">暂无回测数据</p>';
                return;
            }

            let html = '<div style="overflow-x: auto;"><table class="data-table"><thead><tr>';
            html += '<th>基金代码</th>';
            html += '<th>策略选择准确率</th>';
            html += '<th>超额收益</th>';
            html += '<th>被选策略夏普</th>';
            html += '<th>基准夏普</th>';
            html += '<th>选择次数</th>';
            html += '</tr></thead><tbody>';

            data.forEach(item => {
                const accuracy = (item.selection_accuracy * 100).toFixed(1);
                const excessReturn = item.excess_return ? (item.excess_return * 100).toFixed(2) : '--';
                html += `<tr>
                    <td>${item.fund_code}</td>
                    <td><span style="color: ${item.selection_accuracy >= 0.5 ? '#28a745' : '#dc3545'}; font-weight: 600;">${accuracy}%</span></td>
                    <td>${excessReturn}%</td>
                    <td>${item.selected_sharpe ? item.selected_sharpe.toFixed(2) : '--'}</td>
                    <td>${item.benchmark_sharpe ? item.benchmark_sharpe.toFixed(2) : '--'}</td>
                    <td>${item.total_selections || '--'}</td>
                </tr>`;
            });

            html += '</tbody></table></div>';
            content.innerHTML = html;
        }

        // 策略对比
        async function compareStrategies() {
            const fundCode = document.getElementById('backtest-fund').value;
            
            if (!fundCode) {
                alert('请先选择一只基金进行对比');
                return;
            }

            const resultSection = document.getElementById('backtest-result');
            const resultContent = document.getElementById('backtest-result-content');
            
            resultContent.innerHTML = '<div class="loading-state"><i class="bi bi-arrow-repeat"></i><p>正在对比策略...</p></div>';
            resultSection.style.display = 'block';

            try {
                const response = await fetch('/api/strategy/compare', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        fund_code: fundCode,
                        start_date: document.getElementById('backtest-start').value || undefined,
                        end_date: document.getElementById('backtest-end').value || undefined
                    })
                });

                const result = await response.json();
                
                if (result.success) {
                    displayStrategyComparison(result.data);
                } else {
                    resultContent.innerHTML = `<div style="color: #dc3545;"><i class="bi bi-exclamation-triangle"></i> ${result.error}</div>`;
                }
            } catch (error) {
                resultContent.innerHTML = `<div style="color: #dc3545;"><i class="bi bi-exclamation-triangle"></i> 请求失败: ${error.message}</div>`;
            }
        }

        // 显示策略对比结果
        function displayStrategyComparison(data) {
            const content = document.getElementById('backtest-result-content');
            
            if (!data || !data.all_performances) {
                content.innerHTML = '<p style="color: #999;">暂无对比数据</p>';
                return;
            }

            let html = '<h4 style="margin-bottom: 20px;">策略对比排名</h4>';
            html += '<div style="overflow-x: auto;"><table class="data-table"><thead><tr>';
            html += '<th>排名</th>';
            html += '<th>策略名称</th>';
            html += '<th>总收益率</th>';
            html += '<th>夏普比率</th>';
            html += '<th>最大回撤</th>';
            html += '<th>胜率</th>';
            html += '</tr></thead><tbody>';

            data.all_performances.forEach((perf, index) => {
                const isBest = index === 0;
                html += `<tr style="${isBest ? 'background: #d4edda;' : ''}">
                    <td><strong>#${index + 1}</strong></td>
                    <td>${perf.strategy_name} ${isBest ? '<span style="color: #28a745;">(最优)</span>' : ''}</td>
                    <td>${perf.total_return ? perf.total_return.toFixed(2) : '--'}%</td>
                    <td>${perf.sharpe_ratio ? perf.sharpe_ratio.toFixed(2) : '--'}</td>
                    <td style="color: #dc3545;">${perf.max_drawdown ? perf.max_drawdown.toFixed(2) : '--'}%</td>
                    <td>${perf.win_rate ? perf.win_rate.toFixed(1) : '--'}%</td>
                </tr>`;
            });

            html += '</tbody></table></div>';
            content.innerHTML = html;
        }

        // 运行参数优化
        async function runOptimization() {
            const target = document.getElementById('optimize-target').value;
            const method = document.getElementById('optimize-method').value;
            const iterations = document.getElementById('optimize-iterations').value;

            const resultSection = document.getElementById('optimization-result');
            const resultContent = document.getElementById('optimization-result-content');
            
            resultContent.innerHTML = '<div class="loading-state"><i class="bi bi-arrow-repeat"></i><p>正在优化参数...</p></div>';
            resultSection.style.display = 'block';

            try {
                const response = await fetch('/api/strategy/optimize', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        target_metric: target,
                        method: method,
                        iterations: parseInt(iterations)
                    })
                });

                const result = await response.json();
                
                if (result.success) {
                    displayOptimizationResult(result.data);
                } else {
                    resultContent.innerHTML = `<div style="color: #dc3545;"><i class="bi bi-exclamation-triangle"></i> ${result.error}</div>`;
                }
            } catch (error) {
                resultContent.innerHTML = `<div style="color: #dc3545;"><i class="bi bi-exclamation-triangle"></i> 请求失败: ${error.message}</div>`;
            }
        }

        // 显示优化结果
        function displayOptimizationResult(data) {
            const content = document.getElementById('optimization-result-content');
            
            if (!data) {
                content.innerHTML = '<p style="color: #999;">暂无优化结果</p>';
                return;
            }

            let html = '<div class="grid-2">';
            html += '<div><h4 style="margin-bottom: 15px;">最优参数</h4>';
            html += '<pre style="background: #f8f9fa; padding: 15px; border-radius: 8px; overflow-x: auto;">';
            html += JSON.stringify(data.best_parameters || {}, null, 2);
            html += '</pre></div>';
            
            html += '<div><h4 style="margin-bottom: 15px;">性能指标</h4>';
            html += '<ul style="list-style: none; padding: 0;">';
            if (data.sharpe_ratio !== undefined) {
                html += `<li style="padding: 8px 0; border-bottom: 1px solid #eee;"><strong>夏普比率:</strong> ${data.sharpe_ratio.toFixed(4)}</li>`;
            }
            if (data.annual_return !== undefined) {
                html += `<li style="padding: 8px 0; border-bottom: 1px solid #eee;"><strong>年化收益:</strong> ${(data.annual_return * 100).toFixed(2)}%</li>`;
            }
            if (data.max_drawdown !== undefined) {
                html += `<li style="padding: 8px 0; border-bottom: 1px solid #eee;"><strong>最大回撤:</strong> ${(data.max_drawdown * 100).toFixed(2)}%</li>`;
            }
            html += '</ul></div></div>';
            
            content.innerHTML = html;
        }

        // 查看自适应分数
        async function viewAdaptiveScore() {
            const resultSection = document.getElementById('optimization-result');
            const resultContent = document.getElementById('optimization-result-content');
            
            resultContent.innerHTML = '<div class="loading-state"><i class="bi bi-arrow-repeat"></i><p>正在计算自适应分数...</p></div>';
            resultSection.style.display = 'block';

            try {
                // 使用第一只持仓基金或示例基金
                const fundCode = document.getElementById('backtest-fund').value || '000001';
                
                const response = await fetch('/api/strategy/adaptive-score', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ fund_code: fundCode })
                });

                const result = await response.json();
                
                if (result.success) {
                    displayAdaptiveScore(result.data);
                } else {
                    resultContent.innerHTML = `<div style="color: #dc3545;"><i class="bi bi-exclamation-triangle"></i> ${result.error}</div>`;
                }
            } catch (error) {
                resultContent.innerHTML = `<div style="color: #dc3545;"><i class="bi bi-exclamation-triangle"></i> 请求失败: ${error.message}</div>`;
            }
        }

        // 显示自适应分数
        function displayAdaptiveScore(data) {
            const content = document.getElementById('optimization-result-content');
            
            if (!data || !data.strategy_scores) {
                content.innerHTML = '<p style="color: #999;">暂无数据</p>';
                return;
            }

            let html = `<h4 style="margin-bottom: 15px;">基金: ${data.fund_code} | 市场状态: ${data.market_state}</h4>`;
            html += '<div style="margin-bottom: 20px;">';
            html += '<p><strong>基金特征:</strong> 波动率 ' + (data.fund_profile?.volatility?.toFixed(2) || '--') + 
                   ', 趋势强度 ' + (data.fund_profile?.trend_strength?.toFixed(2) || '--') + '</p>';
            html += '</div>';
            
            html += '<h4 style="margin-bottom: 15px;">策略匹配分数</h4>';
            html += '<div style="overflow-x: auto;"><table class="data-table"><thead><tr>';
            html += '<th>策略类型</th>';
            html += '<th>基础分数</th>';
            html += '<th>自适应分数</th>';
            html += '<th>调整幅度</th>';
            html += '</tr></thead><tbody>';

            data.strategy_scores.forEach(score => {
                const adjustmentColor = score.adjustment > 0 ? '#28a745' : (score.adjustment < 0 ? '#dc3545' : '#666');
                html += `<tr>
                    <td>${score.strategy_type}</td>
                    <td>${score.base_score.toFixed(1)}</td>
                    <td><strong style="color: #667eea;">${score.adaptive_score.toFixed(1)}</strong></td>
                    <td style="color: ${adjustmentColor};">${score.adjustment > 0 ? '+' : ''}${score.adjustment.toFixed(1)}</td>
                </tr>`;
            });

            html += '</tbody></table></div>';
            content.innerHTML = html;
        }

        // 设置评分
        let currentRating = 0;
        function setRating(rating) {
            currentRating = rating;
            document.querySelectorAll('[data-rating]').forEach((star, index) => {
                if (index < rating) {
                    star.classList.remove('bi-star');
                    star.classList.add('bi-star-fill');
                } else {
                    star.classList.remove('bi-star-fill');
                    star.classList.add('bi-star');
                }
            });
        }

        // 提交反馈
        async function submitFeedback() {
            const fundCode = document.getElementById('feedback-fund').value;
            const strategyType = document.getElementById('feedback-strategy').value;
            const comment = document.getElementById('feedback-comment').value;

            if (!fundCode) {
                alert('请输入基金代码');
                return;
            }

            if (currentRating === 0) {
                alert('请选择评分');
                return;
            }

            try {
                const response = await fetch('/api/strategy/feedback', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        fund_code: fundCode,
                        strategy_type: strategyType,
                        rating: currentRating,
                        comment: comment
                    })
                });

                const result = await response.json();
                
                if (result.success) {
                    alert('反馈提交成功！');
                    // 重置表单
                    document.getElementById('feedback-fund').value = '';
                    document.getElementById('feedback-comment').value = '';
                    setRating(0);
                } else {
                    alert('提交失败: ' + result.error);
                }
            } catch (error) {
                alert('请求失败: ' + error.message);
            }
        }

        // 加载策略有效性数据
        async function loadEffectiveness() {
            const content = document.getElementById('effectiveness-content');
            content.innerHTML = '<div class="loading-state"><i class="bi bi-arrow-repeat"></i><p>正在加载...</p></div>';

            try {
                const response = await fetch('/api/strategy/effectiveness');
                const result = await response.json();
                
                if (result.success && result.data) {
                    let html = '<div style="max-height: 400px; overflow-y: auto;">';
                    html += '<table class="data-table"><thead><tr>';
                    html += '<th>策略类型</th>';
                    html += '<th>平均评分</th>';
                    html += '<th>预测准确率</th>';
                    html += '<th>使用次数</th>';
                    html += '</tr></thead><tbody>';

                    result.data.forEach(item => {
                        html += `<tr>
                            <td>${item.strategy_type}</td>
                            <td>${item.avg_rating ? item.avg_rating.toFixed(1) : '--'}</td>
                            <td>${item.accuracy_rate ? (item.accuracy_rate * 100).toFixed(1) + '%' : '--'}</td>
                            <td>${item.usage_count || 0}</td>
                        </tr>`;
                    });

                    html += '</tbody></table></div>';
                    content.innerHTML = html;
                } else {
                    content.innerHTML = `<div style="color: #999; text-align: center; padding: 40px;">${result.error || '暂无数据'}</div>`;
                }
            } catch (error) {
                content.innerHTML = `<div style="color: #dc3545; text-align: center; padding: 40px;">加载失败: ${error.message}</div>`;
            }
        }

        // 测试ML策略
        async function testMLStrategy() {
            const fundCode = document.getElementById('ml-test-fund').value;
            
            if (!fundCode) {
                alert('请输入基金代码');
                return;
            }

            const resultDiv = document.getElementById('ml-test-result');
            resultDiv.innerHTML = '<div class="loading-state"><i class="bi bi-arrow-repeat"></i><p>正在训练模型并预测...</p></div>';

            try {
                // 使用个性化建议API获取ML策略的结果
                const response = await fetch('/api/holdings/analyze/personalized-advice', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ fund_codes: [fundCode] })
                });

                const result = await response.json();
                
                if (result.success && result.funds && result.funds.length > 0) {
                    const fund = result.funds[0];
                    let html = '<div style="background: #f8f9fa; padding: 20px; border-radius: 8px;">';
                    html += `<h4 style="margin-bottom: 15px;">${fund.fund_code} - ${fund.fund_name || fund.fund_code}</h4>`;
                    html += '<div class="grid-2">';
                    html += '<div><strong>推荐策略:</strong> ' + (fund.optimal_strategy?.name || '--') + '</div>';
                    html += '<div><strong>匹配度:</strong> ' + (fund.optimal_strategy?.match_score || '--') + '%</div>';
                    html += '<div><strong>操作建议:</strong> ' + (fund.advice?.operation_suggestion || '--') + '</div>';
                    html += '<div><strong>行动:</strong> ' + (fund.advice?.action || '--') + '</div>';
                    html += '</div>';
                    html += '<div style="margin-top: 15px;"><strong>选择理由:</strong> ' + (fund.optimal_strategy?.selection_reason || '--') + '</div>';
                    html += '</div>';
                    resultDiv.innerHTML = html;
                } else {
                    resultDiv.innerHTML = `<div style="color: #dc3545;"><i class="bi bi-exclamation-triangle"></i> ${result.error || '分析失败'}</div>`;
                }
            } catch (error) {
                resultDiv.innerHTML = `<div style="color: #dc3545;"><i class="bi bi-exclamation-triangle"></i> 请求失败: ${error.message}</div>`;
            }
        }

        // 加载概览数据
        async function loadOverview() {
            try {
                // 加载验证摘要
                const response = await fetch('/api/strategy/validation-summary?days=90');
                const result = await response.json();
                
                if (result.success && result.data) {
                    document.getElementById('accuracy-rate').textContent = 
                        (result.data.avg_selection_accuracy || 0).toFixed(1) + '%';
                    document.getElementById('excess-return').textContent = 
                        (result.data.avg_excess_return || 0).toFixed(2) + '%';
                }
            } catch (error) {
                console.error('加载概览数据失败:', error);
            }
        }

        // 页面加载时获取概览数据
        loadOverview();
    </script>
</body>
</html>
