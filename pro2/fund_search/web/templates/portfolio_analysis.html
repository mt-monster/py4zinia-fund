<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>投资组合分析报告</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.0/font/bootstrap-icons.css" rel="stylesheet">
    <style>
        .analysis-header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 2rem 0;
            margin-bottom: 2rem;
        }
        
        .metric-card {
            background: white;
            border-radius: 10px;
            padding: 1.5rem;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
            transition: transform 0.3s ease;
            height: 100%;
        }
        
        .metric-card:hover {
            transform: translateY(-2px);
        }
        
        .metric-icon {
            font-size: 2rem;
            margin-bottom: 1rem;
        }
        
        .metric-value {
            font-size: 1.8rem;
            font-weight: bold;
            margin-bottom: 0.5rem;
        }
        
        .metric-label {
            color: #6c757d;
            font-size: 0.9rem;
        }
        
        .positive { color: #28a745; }
        .negative { color: #dc3545; }
        .neutral { color: #6c757d; }
        
        .chart-container {
            background: white;
            border-radius: 10px;
            padding: 2rem;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
            margin-bottom: 2rem;
        }
        
        .formula-section {
            background: #f8f9fa;
            border-radius: 10px;
            padding: 2rem;
            margin-top: 2rem;
        }
        
        .formula-card {
            background: white;
            border-radius: 8px;
            padding: 1.5rem;
            margin-bottom: 1rem;
            border-left: 4px solid #007bff;
        }
        
        .formula-title {
            font-weight: bold;
            color: #007bff;
            margin-bottom: 0.5rem;
        }
        
        .formula-text {
            font-family: 'Courier New', monospace;
            background: #e9ecef;
            padding: 0.5rem;
            border-radius: 4px;
            font-size: 0.9rem;
        }
        
        .fund-performance-table {
            background: white;
            border-radius: 10px;
            overflow: hidden;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
        }
        
        .best-performer {
            background-color: #d4edda !important;
        }
        
        .worst-performer {
            background-color: #f8d7da !important;
        }
        
        .chart-canvas {
            max-height: 400px;
        }
        
        .loading-spinner {
            display: flex;
            justify-content: center;
            align-items: center;
            height: 200px;
        }
    </style>
</head>
<body>
    <div class="analysis-header">
        <div class="container">
            <div class="row align-items-center">
                <div class="col-md-8">
                    <h1 class="mb-0"><i class="bi bi-graph-up-arrow me-3"></i>投资组合分析报告</h1>
                    <p class="mb-0 mt-2">基于回测结果的专业绩效评估与风险分析</p>
                </div>
                <div class="col-md-4 text-end">
                    <div class="report-date">报告生成时间: <span id="report-date"></span></div>
                </div>
            </div>
        </div>
    </div>

    <div class="container">
        <!-- 关键绩效指标 -->
        <section class="mb-5">
            <h2 class="mb-4"><i class="bi bi-speedometer2 me-2"></i>关键绩效指标</h2>
            <div class="row g-4" id="metrics-container">
                <!-- 指标卡片将通过JavaScript动态生成 -->
            </div>
        </section>

        <!-- 净值曲线图 -->
        <section class="mb-5">
            <div class="chart-container">
                <div class="d-flex justify-content-between align-items-center mb-4">
                    <h3 class="mb-0"><i class="bi bi-line-chart me-2"></i>净值曲线对比</h3>
                    <div class="btn-group" role="group">
                        <button type="button" class="btn btn-outline-primary btn-sm" onclick="toggleChartType('line')">折线图</button>
                        <button type="button" class="btn btn-outline-primary btn-sm" onclick="toggleChartType('area')">面积图</button>
                        <button type="button" class="btn btn-outline-secondary btn-sm" onclick="exportChart()">
                            <i class="bi bi-download me-1"></i>导出图表
                        </button>
                    </div>
                </div>
                <div class="position-relative">
                    <canvas id="navChart" class="chart-canvas"></canvas>
                </div>
            </div>
        </section>

        <!-- 基金表现详情 -->
        <section class="mb-5">
            <h3 class="mb-4"><i class="bi bi-table me-2"></i>基金表现详情</h3>
            <div class="fund-performance-table">
                <table class="table table-hover mb-0">
                    <thead class="table-dark">
                        <tr>
                            <th>基金代码</th>
                            <th>基金名称</th>
                            <th>初始金额</th>
                            <th>最终价值</th>
                            <th>总收益率</th>
                            <th>年化收益</th>
                            <th>最大回撤</th>
                            <th>夏普比率</th>
                            <th>交易次数</th>
                        </tr>
                    </thead>
                    <tbody id="fund-table-body">
                        <!-- 基金数据将通过JavaScript动态生成 -->
                    </tbody>
                </table>
            </div>
        </section>

        <!-- 指标计算公式 -->
        <section class="mb-5">
            <div class="formula-section">
                <h3 class="mb-4"><i class="bi bi-calculator me-2"></i>绩效指标计算公式</h3>
                <div class="row">
                    <div class="col-md-6">
                        <div class="formula-card">
                            <div class="formula-title">年化收益率</div>
                            <div class="formula-text">年化收益率 = (最终价值/初始金额)^(365/回测天数) - 1</div>
                            <small class="text-muted">反映投资组合的年化收益水平</small>
                        </div>
                        
                        <div class="formula-card">
                            <div class="formula-title">最大回撤</div>
                            <div class="formula-text">最大回撤 = max(峰值-谷值)/峰值</div>
                            <small class="text-muted">衡量投资组合在回测期间的最大亏损幅度</small>
                        </div>
                        
                        <div class="formula-card">
                            <div class="formula-title">夏普比率</div>
                            <div class="formula-text">夏普比率 = (年化收益率 - 无风险利率)/年化波动率</div>
                            <small class="text-muted">衡量单位风险所获得的超额收益</small>
                        </div>
                    </div>
                    <div class="col-md-6">
                        <div class="formula-card">
                            <div class="formula-title">年化波动率</div>
                            <div class="formula-text">年化波动率 = 日波动率 × √252</div>
                            <small class="text-muted">反映投资组合收益的年化波动程度</small>
                        </div>
                        
                        <div class="formula-card">
                            <div class="formula-title">信息比率</div>
                            <div class="formula-text">信息比率 = (组合收益率 - 基准收益率)/跟踪误差</div>
                            <small class="text-muted">衡量主动管理带来的超额收益</small>
                        </div>
                        
                        <div class="formula-card">
                            <div class="formula-title">卡玛比率</div>
                            <div class="formula-text">卡玛比率 = 年化收益率/|最大回撤|</div>
                            <small class="text-muted">衡量单位回撤所获得的收益</small>
                        </div>
                    </div>
                </div>
            </div>
        </section>

        <!-- 数据来源说明 -->
        <section class="mb-5">
            <div class="alert alert-light border" id="data-source-container">
                <i class="bi bi-database me-2"></i>数据来源加载中...
            </div>
        </section>

        <!-- 风险提示 -->
        <section class="mb-5">
            <div class="alert alert-warning">
                <h5 class="alert-heading"><i class="bi bi-exclamation-triangle me-2"></i>风险提示</h5>
                <p class="mb-2">本报告基于历史数据回测，过往表现不代表未来收益。投资有风险，入市需谨慎。</p>
                <ul class="mb-0">
                    <li>本组合最大回撤为 <span id="max-drawdown-warning"></span>%，投资者需评估自身风险承受能力</li>
                    <li>年化波动率为 <span id="volatility-warning"></span>%，存在较大价格波动风险</li>
                    <li>建议在投资前充分了解各基金的投资策略和风险特征</li>
                </ul>
            </div>
        </section>
    </div>

    <footer class="bg-dark text-white py-4 mt-5">
        <div class="container text-center">
            <p class="mb-0">© 2024 投资组合分析系统 - 专业投资分析工具</p>
        </div>
    </footer>

    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script>
        let navChartInstance = null;

        function formatNumber(value) {
            const num = Number(value);
            if (Number.isNaN(num)) return '--';
            return num.toFixed(2);
        }

        function renderDataUnavailable(message) {
            const metricsContainer = document.getElementById('metrics-container');
            if (metricsContainer) {
                metricsContainer.innerHTML = `
                    <div class="col-12">
                        <div class="alert alert-warning mb-0">
                            <i class="bi bi-exclamation-triangle me-2"></i>${message}
                        </div>
                    </div>
                `;
            }

            const fundTableBody = document.getElementById('fund-table-body');
            if (fundTableBody) {
                fundTableBody.innerHTML = '<tr><td colspan="9" class="text-center text-muted">暂无基金明细</td></tr>';
            }

            const navChart = document.getElementById('navChart');
            if (navChart && navChart.parentElement) {
                navChart.parentElement.innerHTML = `
                    <div class="alert alert-warning mb-0">
                        <i class="bi bi-exclamation-triangle me-2"></i>暂无真实净值曲线数据
                    </div>
                `;
            }

            const dataSourceContainer = document.getElementById('data-source-container');
            if (dataSourceContainer) {
                dataSourceContainer.innerHTML = `<i class="bi bi-database me-2"></i>${message}`;
            }

            const maxDrawdownWarning = document.getElementById('max-drawdown-warning');
            const volatilityWarning = document.getElementById('volatility-warning');
            if (maxDrawdownWarning) maxDrawdownWarning.textContent = '--';
            if (volatilityWarning) volatilityWarning.textContent = '--';
        }

        function setReportDate() {
            document.getElementById('report-date').textContent = new Date().toLocaleString('zh-CN');
        }

        function calculateMetrics(portfolioValues, benchmarkValues) {
            const totalDays = Math.max(portfolioValues.length - 1, 1);
            const initialValue = portfolioValues[0] || 0;
            const finalValue = portfolioValues[portfolioValues.length - 1] || 0;
            const totalReturn = initialValue > 0 ? (finalValue / initialValue - 1) * 100 : 0;

            const years = totalDays / 252;
            const annualizedReturn = initialValue > 0 && years > 0
                ? (Math.pow(finalValue / initialValue, 1 / years) - 1) * 100
                : 0;

            const dailyReturns = [];
            for (let i = 1; i < portfolioValues.length; i++) {
                const prev = portfolioValues[i - 1] || 0;
                const curr = portfolioValues[i] || 0;
                dailyReturns.push(prev > 0 ? (curr - prev) / prev : 0);
            }

            const dailyAvg = dailyReturns.reduce((sum, v) => sum + v, 0) / Math.max(dailyReturns.length, 1);
            const variance = dailyReturns.reduce((sum, v) => sum + Math.pow(v - dailyAvg, 2), 0) / Math.max(dailyReturns.length, 1);
            const volatility = Math.sqrt(variance) * Math.sqrt(252) * 100;

            let peak = initialValue;
            let maxDrawdown = 0;
            portfolioValues.forEach(value => {
                if (value > peak) peak = value;
                const drawdown = peak > 0 ? (peak - value) / peak : 0;
                if (drawdown > maxDrawdown) maxDrawdown = drawdown;
            });
            maxDrawdown = maxDrawdown * 100;

            const benchmarkInitial = benchmarkValues[0] || 0;
            const benchmarkFinal = benchmarkValues[benchmarkValues.length - 1] || 0;
            const benchmarkAnnualized = benchmarkInitial > 0 && years > 0
                ? (Math.pow(benchmarkFinal / benchmarkInitial, 1 / years) - 1) * 100
                : 0;

            const benchmarkDailyReturns = [];
            for (let i = 1; i < benchmarkValues.length; i++) {
                const prev = benchmarkValues[i - 1] || 0;
                const curr = benchmarkValues[i] || 0;
                benchmarkDailyReturns.push(prev > 0 ? (curr - prev) / prev : 0);
            }

            const activeReturns = dailyReturns.map((v, idx) => v - (benchmarkDailyReturns[idx] || 0));
            const activeAvg = activeReturns.reduce((sum, v) => sum + v, 0) / Math.max(activeReturns.length, 1);
            const activeVar = activeReturns.reduce((sum, v) => sum + Math.pow(v - activeAvg, 2), 0) / Math.max(activeReturns.length, 1);
            const trackingError = Math.sqrt(activeVar) * Math.sqrt(252) * 100;
            const informationRatio = trackingError !== 0 ? (annualizedReturn - benchmarkAnnualized) / trackingError : 0;

            const riskFreeRate = 0.02;
            const sharpeRatio = volatility !== 0 ? ((annualizedReturn / 100) - riskFreeRate) / (volatility / 100) : 0;
            const calmarRatio = maxDrawdown !== 0 ? annualizedReturn / maxDrawdown : 0;

            return {
                totalReturn,
                annualizedReturn,
                volatility,
                maxDrawdown,
                sharpeRatio,
                informationRatio,
                calmarRatio
            };
        }

        function renderMetrics(metrics) {
            const container = document.getElementById('metrics-container');
            const metricsConfig = [
                { icon: 'bi-cash-stack', title: '总收益率', value: `${formatNumber(metrics.totalReturn)}%`, class: metrics.totalReturn >= 0 ? 'positive' : 'negative' },
                { icon: 'bi-graph-up', title: '年化收益率', value: `${formatNumber(metrics.annualizedReturn)}%`, class: metrics.annualizedReturn >= 0 ? 'positive' : 'negative' },
                { icon: 'bi-activity', title: '年化波动率', value: `${formatNumber(metrics.volatility)}%`, class: 'neutral' },
                { icon: 'bi-arrow-down-up', title: '最大回撤', value: `${formatNumber(metrics.maxDrawdown)}%`, class: 'negative' },
                { icon: 'bi-speedometer2', title: '夏普比率', value: formatNumber(metrics.sharpeRatio), class: metrics.sharpeRatio >= 0 ? 'positive' : 'negative' },
                { icon: 'bi-info-circle', title: '信息比率', value: formatNumber(metrics.informationRatio), class: metrics.informationRatio >= 0 ? 'positive' : 'negative' }
            ];

            container.innerHTML = metricsConfig.map(metric => `
                <div class="col-md-4 col-lg-2">
                    <div class="metric-card text-center">
                        <div class="metric-icon ${metric.class}">
                            <i class="bi ${metric.icon}"></i>
                        </div>
                        <div class="metric-value ${metric.class}">${metric.value}</div>
                        <div class="metric-label">${metric.title}</div>
                    </div>
                </div>
            `).join('');
        }

        function renderFundTablePlaceholder() {
            const tbody = document.getElementById('fund-table-body');
            tbody.innerHTML = '<tr><td colspan="9" class="text-center text-muted">暂无基金明细</td></tr>';
        }

        function updateRiskWarning(metrics) {
            document.getElementById('max-drawdown-warning').textContent = formatNumber(metrics.maxDrawdown);
            document.getElementById('volatility-warning').textContent = formatNumber(metrics.volatility);
        }

        function drawNavChart(labels, portfolioNavs, benchmarkNavs) {
            const canvas = document.getElementById('navChart');
            if (!canvas) return;

            const ctx = canvas.getContext('2d');
            if (navChartInstance) {
                navChartInstance.destroy();
            }

            navChartInstance = new Chart(ctx, {
                type: 'line',
                data: {
                    labels,
                    datasets: [{
                        label: '组合净值',
                        data: portfolioNavs,
                        borderColor: '#007bff',
                        backgroundColor: 'rgba(0, 123, 255, 0.1)',
                        borderWidth: 2,
                        fill: false,
                        tension: 0.1
                    }, {
                        label: '沪深300基准',
                        data: benchmarkNavs,
                        borderColor: '#dc3545',
                        backgroundColor: 'rgba(220, 53, 69, 0.1)',
                        borderWidth: 2,
                        fill: false,
                        tension: 0.1
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        title: {
                            display: true,
                            text: '投资组合净值变化趋势'
                        },
                        legend: {
                            position: 'top'
                        }
                    },
                    scales: {
                        x: {
                            display: true,
                            title: {
                                display: true,
                                text: '日期'
                            }
                        },
                        y: {
                            display: true,
                            title: {
                                display: true,
                                text: '净值 (元)'
                            },
                            ticks: {
                                callback: function(value) {
                                    return '¥' + Number(value).toFixed(2);
                                }
                            }
                        }
                    }
                }
            });
        }

        function renderDataSource(sourceDetail, benchmarkName) {
            const container = document.getElementById('data-source-container');
            if (!container) return;

            if (!sourceDetail) {
                container.innerHTML = '<i class="bi bi-database me-2"></i>数据来源：暂无说明';
                return;
            }

            const portfolioSource = sourceDetail.portfolio_nav || 'akshare:fund_open_fund_info_em';
            const benchmarkSource = sourceDetail.benchmark || 'akshare:stock_zh_index_daily';
            const asOf = sourceDetail.as_of ? `更新至：${sourceDetail.as_of}` : '';

            container.innerHTML = `
                <div><i class="bi bi-database me-2"></i>数据来源</div>
                <div class="text-muted">组合净值：${portfolioSource}</div>
                <div class="text-muted">基准指数（${benchmarkName || '沪深300'}）：${benchmarkSource}</div>
                ${asOf ? `<div class="text-muted">${asOf}</div>` : ''}
            `;
        }

        async function loadReportData() {
            const params = new URLSearchParams(window.location.search);
            const fundCodes = params.get('fund_codes');
            const weights = params.get('weights');
            const days = parseInt(params.get('days') || '90', 10);

            if (!fundCodes) {
                renderDataUnavailable('缺少基金代码参数，请从策略回测或持仓回测进入本页。');
                return;
            }

            const query = new URLSearchParams({
                days: String(days),
                fund_codes: fundCodes
            });
            if (weights) {
                query.set('weights', weights);
            }

            try {
                const response = await fetch(`/api/dashboard/profit-trend?${query.toString()}`);
                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}`);
                }

                const result = await response.json();
                if (!result.success || !result.data) {
                    throw new Error(result.error || '数据加载失败');
                }

                const labels = result.data.labels || [];
                const portfolioNavs = result.data.profit || [];
                const benchmarkNavs = result.data.benchmark || [];

                if (labels.length === 0 || portfolioNavs.length === 0 || benchmarkNavs.length === 0) {
                    renderDataUnavailable('真实历史数据不足，无法生成报告。');
                    return;
                }

                const metrics = calculateMetrics(portfolioNavs, benchmarkNavs);
                renderMetrics(metrics);
                renderFundTablePlaceholder();
                drawNavChart(labels, portfolioNavs, benchmarkNavs);
                updateRiskWarning(metrics);
                renderDataSource(result.data.data_source_detail, result.data.benchmark_name);
            } catch (error) {
                console.error('加载报告失败:', error);
                renderDataUnavailable('加载真实数据失败，请稍后重试。');
            }
        }

        document.addEventListener('DOMContentLoaded', function() {
            setReportDate();
            loadReportData();
        });
    </script>
</body>
</html>