<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>æŠ•èµ„ç»„åˆåˆ†ææŠ¥å‘Š</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.0/font/bootstrap-icons.css" rel="stylesheet">
    <style>
        .analysis-header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 2rem 0;
            margin-bottom: 2rem;
        }
        
        .metric-card {
            background: white;
            border-radius: 10px;
            padding: 1.5rem;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
            transition: transform 0.3s ease;
            height: 100%;
        }
        
        .metric-card:hover {
            transform: translateY(-2px);
        }
        
        .metric-icon {
            font-size: 2rem;
            margin-bottom: 1rem;
        }
        
        .metric-value {
            font-size: 1.8rem;
            font-weight: bold;
            margin-bottom: 0.5rem;
        }
        
        .metric-label {
            color: #6c757d;
            font-size: 0.9rem;
        }
        
        .positive { color: #28a745; }
        .negative { color: #dc3545; }
        .neutral { color: #6c757d; }
        
        .chart-container {
            background: white;
            border-radius: 10px;
            padding: 2rem;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
            margin-bottom: 2rem;
        }
        
        .formula-section {
            background: #f8f9fa;
            border-radius: 10px;
            padding: 2rem;
            margin-top: 2rem;
        }
        
        .formula-card {
            background: white;
            border-radius: 8px;
            padding: 1.5rem;
            margin-bottom: 1rem;
            border-left: 4px solid #007bff;
        }
        
        .formula-title {
            font-weight: bold;
            color: #007bff;
            margin-bottom: 0.5rem;
        }
        
        .formula-text {
            font-family: 'Courier New', monospace;
            background: #e9ecef;
            padding: 0.5rem;
            border-radius: 4px;
            font-size: 0.9rem;
        }
        
        .fund-performance-table {
            background: white;
            border-radius: 10px;
            overflow: hidden;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
        }
        
        .best-performer {
            background-color: #d4edda !important;
        }
        
        .worst-performer {
            background-color: #f8d7da !important;
        }
        
        .chart-canvas {
            max-height: 400px;
        }
        
        .loading-spinner {
            display: flex;
            justify-content: center;
            align-items: center;
            height: 200px;
        }
    </style>
</head>
<body>
    <div class="analysis-header">
        <div class="container">
            <div class="row align-items-center">
                <div class="col-md-8">
                    <h1 class="mb-0"><i class="bi bi-graph-up-arrow me-3"></i>æŠ•èµ„ç»„åˆåˆ†ææŠ¥å‘Š</h1>
                    <p class="mb-0 mt-2">åŸºäºå›æµ‹ç»“æœçš„ä¸“ä¸šç»©æ•ˆè¯„ä¼°ä¸é£é™©åˆ†æ</p>
                </div>
                <div class="col-md-4 text-end">
                    <div class="report-date">æŠ¥å‘Šç”Ÿæˆæ—¶é—´: <span id="report-date"></span></div>
                </div>
            </div>
        </div>
    </div>

    <div class="container">
        <!-- å…³é”®ç»©æ•ˆæŒ‡æ ‡ -->
        <section class="mb-5">
            <h2 class="mb-4"><i class="bi bi-speedometer2 me-2"></i>å…³é”®ç»©æ•ˆæŒ‡æ ‡</h2>
            <div class="row g-4" id="metrics-container">
                <!-- æŒ‡æ ‡å¡ç‰‡å°†é€šè¿‡JavaScriptåŠ¨æ€ç”Ÿæˆ -->
            </div>
        </section>

        <!-- å‡€å€¼æ›²çº¿å›¾ -->
        <section class="mb-5">
            <div class="chart-container">
                <div class="d-flex justify-content-between align-items-center mb-4">
                    <h3 class="mb-0"><i class="bi bi-line-chart me-2"></i>å‡€å€¼æ›²çº¿å¯¹æ¯”</h3>
                    <div class="btn-group" role="group">
                        <button type="button" class="btn btn-outline-primary btn-sm" onclick="toggleChartType('line')">æŠ˜çº¿å›¾</button>
                        <button type="button" class="btn btn-outline-primary btn-sm" onclick="toggleChartType('area')">é¢ç§¯å›¾</button>
                        <button type="button" class="btn btn-outline-secondary btn-sm" onclick="exportChart()">
                            <i class="bi bi-download me-1"></i>å¯¼å‡ºå›¾è¡¨
                        </button>
                    </div>
                </div>
                <div class="position-relative">
                    <canvas id="navChart" class="chart-canvas"></canvas>
                </div>
            </div>
        </section>

        <!-- åŸºé‡‘è¡¨ç°è¯¦æƒ… -->
        <section class="mb-5">
            <h3 class="mb-4"><i class="bi bi-table me-2"></i>åŸºé‡‘è¡¨ç°è¯¦æƒ…</h3>
            <div class="fund-performance-table">
                <table class="table table-hover mb-0">
                    <thead class="table-dark">
                        <tr>
                            <th>åŸºé‡‘ä»£ç </th>
                            <th>åŸºé‡‘åç§°</th>
                            <th>åˆå§‹é‡‘é¢</th>
                            <th>æœ€ç»ˆä»·å€¼</th>
                            <th>æ€»æ”¶ç›Šç‡</th>
                            <th>å¹´åŒ–æ”¶ç›Š</th>
                            <th>æœ€å¤§å›æ’¤</th>
                            <th>å¤æ™®æ¯”ç‡</th>
                            <th>äº¤æ˜“æ¬¡æ•°</th>
                        </tr>
                    </thead>
                    <tbody id="fund-table-body">
                        <!-- åŸºé‡‘æ•°æ®å°†é€šè¿‡JavaScriptåŠ¨æ€ç”Ÿæˆ -->
                    </tbody>
                </table>
            </div>
        </section>

        <!-- æŒ‡æ ‡è®¡ç®—å…¬å¼ -->
        <section class="mb-5">
            <div class="formula-section">
                <h3 class="mb-4"><i class="bi bi-calculator me-2"></i>ç»©æ•ˆæŒ‡æ ‡è®¡ç®—å…¬å¼</h3>
                <div class="row">
                    <div class="col-md-6">
                        <div class="formula-card">
                            <div class="formula-title">å¹´åŒ–æ”¶ç›Šç‡</div>
                            <div class="formula-text">å¹´åŒ–æ”¶ç›Šç‡ = (æœ€ç»ˆä»·å€¼/åˆå§‹é‡‘é¢)^(365/å›æµ‹å¤©æ•°) - 1</div>
                            <small class="text-muted">åæ˜ æŠ•èµ„ç»„åˆçš„å¹´åŒ–æ”¶ç›Šæ°´å¹³</small>
                        </div>
                        
                        <div class="formula-card">
                            <div class="formula-title">æœ€å¤§å›æ’¤</div>
                            <div class="formula-text">æœ€å¤§å›æ’¤ = max(å³°å€¼-è°·å€¼)/å³°å€¼</div>
                            <small class="text-muted">è¡¡é‡æŠ•èµ„ç»„åˆåœ¨å›æµ‹æœŸé—´çš„æœ€å¤§äºæŸå¹…åº¦</small>
                        </div>
                        
                        <div class="formula-card">
                            <div class="formula-title">å¤æ™®æ¯”ç‡</div>
                            <div class="formula-text">å¤æ™®æ¯”ç‡ = (å¹´åŒ–æ”¶ç›Šç‡ - æ— é£é™©åˆ©ç‡)/å¹´åŒ–æ³¢åŠ¨ç‡</div>
                            <small class="text-muted">è¡¡é‡å•ä½é£é™©æ‰€è·å¾—çš„è¶…é¢æ”¶ç›Š</small>
                        </div>
                    </div>
                    <div class="col-md-6">
                        <div class="formula-card">
                            <div class="formula-title">å¹´åŒ–æ³¢åŠ¨ç‡</div>
                            <div class="formula-text">å¹´åŒ–æ³¢åŠ¨ç‡ = æ—¥æ³¢åŠ¨ç‡ Ã— âˆš252</div>
                            <small class="text-muted">åæ˜ æŠ•èµ„ç»„åˆæ”¶ç›Šçš„å¹´åŒ–æ³¢åŠ¨ç¨‹åº¦</small>
                        </div>
                        
                        <div class="formula-card">
                            <div class="formula-title">ä¿¡æ¯æ¯”ç‡</div>
                            <div class="formula-text">ä¿¡æ¯æ¯”ç‡ = (ç»„åˆæ”¶ç›Šç‡ - åŸºå‡†æ”¶ç›Šç‡)/è·Ÿè¸ªè¯¯å·®</div>
                            <small class="text-muted">è¡¡é‡ä¸»åŠ¨ç®¡ç†å¸¦æ¥çš„è¶…é¢æ”¶ç›Š</small>
                        </div>
                        
                        <div class="formula-card">
                            <div class="formula-title">å¡ç›æ¯”ç‡</div>
                            <div class="formula-text">å¡ç›æ¯”ç‡ = å¹´åŒ–æ”¶ç›Šç‡/|æœ€å¤§å›æ’¤|</div>
                            <small class="text-muted">è¡¡é‡å•ä½å›æ’¤æ‰€è·å¾—çš„æ”¶ç›Š</small>
                        </div>
                    </div>
                </div>
            </div>
        </section>

        <!-- æ•°æ®æ¥æºè¯´æ˜ -->
        <section class="mb-5">
            <div class="alert alert-light border" id="data-source-container">
                <i class="bi bi-database me-2"></i>æ•°æ®æ¥æºåŠ è½½ä¸­...
            </div>
        </section>

        <!-- é£é™©æç¤º -->
        <section class="mb-5">
            <div class="alert alert-warning">
                <h5 class="alert-heading"><i class="bi bi-exclamation-triangle me-2"></i>é£é™©æç¤º</h5>
                <p class="mb-2">æœ¬æŠ¥å‘ŠåŸºäºå†å²æ•°æ®å›æµ‹ï¼Œè¿‡å¾€è¡¨ç°ä¸ä»£è¡¨æœªæ¥æ”¶ç›Šã€‚æŠ•èµ„æœ‰é£é™©ï¼Œå…¥å¸‚éœ€è°¨æ…ã€‚</p>
                <ul class="mb-0">
                    <li>æœ¬ç»„åˆæœ€å¤§å›æ’¤ä¸º <span id="max-drawdown-warning"></span>%ï¼ŒæŠ•èµ„è€…éœ€è¯„ä¼°è‡ªèº«é£é™©æ‰¿å—èƒ½åŠ›</li>
                    <li>å¹´åŒ–æ³¢åŠ¨ç‡ä¸º <span id="volatility-warning"></span>%ï¼Œå­˜åœ¨è¾ƒå¤§ä»·æ ¼æ³¢åŠ¨é£é™©</li>
                    <li>å»ºè®®åœ¨æŠ•èµ„å‰å……åˆ†äº†è§£å„åŸºé‡‘çš„æŠ•èµ„ç­–ç•¥å’Œé£é™©ç‰¹å¾</li>
                </ul>
            </div>
        </section>
    </div>

    <footer class="bg-dark text-white py-4 mt-5">
        <div class="container text-center">
            <p class="mb-0">Â© 2024 æŠ•èµ„ç»„åˆåˆ†æç³»ç»Ÿ - ä¸“ä¸šæŠ•èµ„åˆ†æå·¥å…·</p>
        </div>
    </footer>

    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="{{ url_for('static', filename='js/portfolio-analysis-integrated.js') }}"></script>
    <script>
        let navChartInstance = null;

        function formatNumber(value) {
            const num = Number(value);
            if (Number.isNaN(num)) return '--';
            return num.toFixed(2);
        }

        function renderDataUnavailable(message) {
            const metricsContainer = document.getElementById('metrics-container');
            if (metricsContainer) {
                metricsContainer.innerHTML = `
                    <div class="col-12">
                        <div class="alert alert-warning mb-0">
                            <i class="bi bi-exclamation-triangle me-2"></i>${message}
                        </div>
                    </div>
                `;
            }

            const fundTableBody = document.getElementById('fund-table-body');
            if (fundTableBody) {
                fundTableBody.innerHTML = '<tr><td colspan="9" class="text-center text-muted">æš‚æ— åŸºé‡‘æ˜ç»†</td></tr>';
            }

            const navChart = document.getElementById('navChart');
            if (navChart && navChart.parentElement) {
                navChart.parentElement.innerHTML = `
                    <div class="alert alert-warning mb-0">
                        <i class="bi bi-exclamation-triangle me-2"></i>æš‚æ— çœŸå®å‡€å€¼æ›²çº¿æ•°æ®
                    </div>
                `;
            }

            const dataSourceContainer = document.getElementById('data-source-container');
            if (dataSourceContainer) {
                dataSourceContainer.innerHTML = `<i class="bi bi-database me-2"></i>${message}`;
            }

            const maxDrawdownWarning = document.getElementById('max-drawdown-warning');
            const volatilityWarning = document.getElementById('volatility-warning');
            if (maxDrawdownWarning) maxDrawdownWarning.textContent = '--';
            if (volatilityWarning) volatilityWarning.textContent = '--';
        }

        function setReportDate() {
            document.getElementById('report-date').textContent = new Date().toLocaleString('zh-CN');
        }

        function calculateMetrics(portfolioValues, benchmarkValues) {
            const totalDays = Math.max(portfolioValues.length - 1, 1);
            const initialValue = portfolioValues[0] || 0;
            const finalValue = portfolioValues[portfolioValues.length - 1] || 0;
            const totalReturn = initialValue > 0 ? (finalValue / initialValue - 1) * 100 : 0;

            const years = totalDays / 252;
            const annualizedReturn = initialValue > 0 && years > 0
                ? (Math.pow(finalValue / initialValue, 1 / years) - 1) * 100
                : 0;

            const dailyReturns = [];
            for (let i = 1; i < portfolioValues.length; i++) {
                const prev = portfolioValues[i - 1] || 0;
                const curr = portfolioValues[i] || 0;
                dailyReturns.push(prev > 0 ? (curr - prev) / prev : 0);
            }

            const dailyAvg = dailyReturns.reduce((sum, v) => sum + v, 0) / Math.max(dailyReturns.length, 1);
            const variance = dailyReturns.reduce((sum, v) => sum + Math.pow(v - dailyAvg, 2), 0) / Math.max(dailyReturns.length, 1);
            const volatility = Math.sqrt(variance) * Math.sqrt(252) * 100;

            let peak = initialValue;
            let maxDrawdown = 0;
            portfolioValues.forEach(value => {
                if (value > peak) peak = value;
                const drawdown = peak > 0 ? (peak - value) / peak : 0;
                if (drawdown > maxDrawdown) maxDrawdown = drawdown;
            });
            maxDrawdown = maxDrawdown * 100;

            const benchmarkInitial = benchmarkValues[0] || 0;
            const benchmarkFinal = benchmarkValues[benchmarkValues.length - 1] || 0;
            const benchmarkAnnualized = benchmarkInitial > 0 && years > 0
                ? (Math.pow(benchmarkFinal / benchmarkInitial, 1 / years) - 1) * 100
                : 0;

            const benchmarkDailyReturns = [];
            for (let i = 1; i < benchmarkValues.length; i++) {
                const prev = benchmarkValues[i - 1] || 0;
                const curr = benchmarkValues[i] || 0;
                benchmarkDailyReturns.push(prev > 0 ? (curr - prev) / prev : 0);
            }

            const activeReturns = dailyReturns.map((v, idx) => v - (benchmarkDailyReturns[idx] || 0));
            const activeAvg = activeReturns.reduce((sum, v) => sum + v, 0) / Math.max(activeReturns.length, 1);
            const activeVar = activeReturns.reduce((sum, v) => sum + Math.pow(v - activeAvg, 2), 0) / Math.max(activeReturns.length, 1);
            const trackingError = Math.sqrt(activeVar) * Math.sqrt(252) * 100;
            const informationRatio = trackingError !== 0 ? (annualizedReturn - benchmarkAnnualized) / trackingError : 0;

            const riskFreeRate = 0.02;
            const sharpeRatio = volatility !== 0 ? ((annualizedReturn / 100) - riskFreeRate) / (volatility / 100) : 0;
            const calmarRatio = maxDrawdown !== 0 ? annualizedReturn / maxDrawdown : 0;

            return {
                totalReturn,
                annualizedReturn,
                volatility,
                maxDrawdown,
                sharpeRatio,
                informationRatio,
                calmarRatio
            };
        }

        function renderMetrics(metrics) {
            const container = document.getElementById('metrics-container');
            const metricsConfig = [
                { icon: 'bi-cash-stack', title: 'æ€»æ”¶ç›Šç‡', value: `${formatNumber(metrics.totalReturn)}%`, class: metrics.totalReturn >= 0 ? 'positive' : 'negative' },
                { icon: 'bi-graph-up', title: 'å¹´åŒ–æ”¶ç›Šç‡', value: `${formatNumber(metrics.annualizedReturn)}%`, class: metrics.annualizedReturn >= 0 ? 'positive' : 'negative' },
                { icon: 'bi-activity', title: 'å¹´åŒ–æ³¢åŠ¨ç‡', value: `${formatNumber(metrics.volatility)}%`, class: 'neutral' },
                { icon: 'bi-arrow-down-up', title: 'æœ€å¤§å›æ’¤', value: `${formatNumber(metrics.maxDrawdown)}%`, class: 'negative' },
                { icon: 'bi-speedometer2', title: 'å¤æ™®æ¯”ç‡', value: formatNumber(metrics.sharpeRatio), class: metrics.sharpeRatio >= 0 ? 'positive' : 'negative' },
                { icon: 'bi-info-circle', title: 'ä¿¡æ¯æ¯”ç‡', value: formatNumber(metrics.informationRatio), class: metrics.informationRatio >= 0 ? 'positive' : 'negative' }
            ];

            container.innerHTML = metricsConfig.map(metric => `
                <div class="col-md-4 col-lg-2">
                    <div class="metric-card text-center">
                        <div class="metric-icon ${metric.class}">
                            <i class="bi ${metric.icon}"></i>
                        </div>
                        <div class="metric-value ${metric.class}">${metric.value}</div>
                        <div class="metric-label">${metric.title}</div>
                    </div>
                </div>
            `).join('');
        }

        function renderFundTablePlaceholder() {
            const tbody = document.getElementById('fund-table-body');
            tbody.innerHTML = '<tr><td colspan="9" class="text-center text-muted">æš‚æ— åŸºé‡‘æ˜ç»†</td></tr>';
        }

        function updateRiskWarning(metrics) {
            document.getElementById('max-drawdown-warning').textContent = formatNumber(metrics.maxDrawdown);
            document.getElementById('volatility-warning').textContent = formatNumber(metrics.volatility);
        }

        function drawNavChart(labels, portfolioNavs, benchmarkNavs) {
            const canvas = document.getElementById('navChart');
            if (!canvas) return;

            const ctx = canvas.getContext('2d');
            if (navChartInstance) {
                navChartInstance.destroy();
            }

            navChartInstance = new Chart(ctx, {
                type: 'line',
                data: {
                    labels,
                    datasets: [{
                        label: 'ç»„åˆå‡€å€¼',
                        data: portfolioNavs,
                        borderColor: '#007bff',
                        backgroundColor: 'rgba(0, 123, 255, 0.1)',
                        borderWidth: 2,
                        fill: false,
                        tension: 0.1
                    }, {
                        label: 'æ²ªæ·±300åŸºå‡†',
                        data: benchmarkNavs,
                        borderColor: '#dc3545',
                        backgroundColor: 'rgba(220, 53, 69, 0.1)',
                        borderWidth: 2,
                        fill: false,
                        tension: 0.1
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        title: {
                            display: true,
                            text: 'æŠ•èµ„ç»„åˆå‡€å€¼å˜åŒ–è¶‹åŠ¿'
                        },
                        legend: {
                            position: 'top'
                        }
                    },
                    scales: {
                        x: {
                            display: true,
                            title: {
                                display: true,
                                text: 'æ—¥æœŸ'
                            }
                        },
                        y: {
                            display: true,
                            title: {
                                display: true,
                                text: 'å‡€å€¼ (å…ƒ)'
                            },
                            ticks: {
                                callback: function(value) {
                                    return 'Â¥' + Number(value).toFixed(2);
                                }
                            }
                        }
                    }
                }
            });
        }

        function renderDataSource(sourceDetail, benchmarkName) {
            const container = document.getElementById('data-source-container');
            if (!container) return;

            if (!sourceDetail) {
                container.innerHTML = '<i class="bi bi-database me-2"></i>æ•°æ®æ¥æºï¼šæš‚æ— è¯´æ˜';
                return;
            }

            const portfolioSource = sourceDetail.portfolio_nav || 'akshare:fund_open_fund_info_em';
            const benchmarkSource = sourceDetail.benchmark || 'akshare:stock_zh_index_daily';
            const asOf = sourceDetail.as_of ? `æ›´æ–°è‡³ï¼š${sourceDetail.as_of}` : '';

            container.innerHTML = `
                <div><i class="bi bi-database me-2"></i>æ•°æ®æ¥æº</div>
                <div class="text-muted">ç»„åˆå‡€å€¼ï¼š${portfolioSource}</div>
                <div class="text-muted">åŸºå‡†æŒ‡æ•°ï¼ˆ${benchmarkName || 'æ²ªæ·±300'}ï¼‰ï¼š${benchmarkSource}</div>
                ${asOf ? `<div class="text-muted">${asOf}</div>` : ''}
            `;
        }

        async function loadReportData() {
            const params = new URLSearchParams(window.location.search);
            const fundCodes = params.get('fund_codes');
            const weights = params.get('weights');
            const days = parseInt(params.get('days') || '90', 10);

            if (!fundCodes) {
                renderDataUnavailable('ç¼ºå°‘åŸºé‡‘ä»£ç å‚æ•°ï¼Œè¯·ä»ç­–ç•¥å›æµ‹æˆ–æŒä»“å›æµ‹è¿›å…¥æœ¬é¡µã€‚');
                return;
            }

            const query = new URLSearchParams({
                days: String(days),
                fund_codes: fundCodes
            });
            if (weights) {
                query.set('weights', weights);
            }

            try {
                const response = await fetch(`/api/dashboard/profit-trend?${query.toString()}`);
                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}`);
                }

                const result = await response.json();
                if (!result.success || !result.data) {
                    throw new Error(result.error || 'æ•°æ®åŠ è½½å¤±è´¥');
                }

                const labels = result.data.labels || [];
                const portfolioNavs = result.data.profit || [];
                const benchmarkNavs = result.data.benchmark || [];

                if (labels.length === 0 || portfolioNavs.length === 0 || benchmarkNavs.length === 0) {
                    renderDataUnavailable('çœŸå®å†å²æ•°æ®ä¸è¶³ï¼Œæ— æ³•ç”ŸæˆæŠ¥å‘Šã€‚');
                    return;
                }

                const metrics = calculateMetrics(portfolioNavs, benchmarkNavs);
                renderMetrics(metrics);
                renderFundTablePlaceholder();
                drawNavChart(labels, portfolioNavs, benchmarkNavs);
                updateRiskWarning(metrics);
                renderDataSource(result.data.data_source_detail, result.data.benchmark_name);
            } catch (error) {
                console.error('åŠ è½½æŠ¥å‘Šå¤±è´¥:', error);
                renderDataUnavailable('åŠ è½½çœŸå®æ•°æ®å¤±è´¥ï¼Œè¯·ç¨åé‡è¯•ã€‚');
            }
        }

        document.addEventListener('DOMContentLoaded', function() {
            setReportDate();
            
            // è°ƒè¯•ä¿¡æ¯
            console.log('ğŸš€ é¡µé¢DOMåŠ è½½å®Œæˆ');
            console.log('Chart.jså­˜åœ¨:', typeof Chart !== 'undefined');
            console.log('PortfolioAnalysiså­˜åœ¨:', typeof PortfolioAnalysis !== 'undefined');
            
            // åˆå§‹åŒ–å®Œæ•´çš„æŠ•èµ„ç»„åˆåˆ†æåŠŸèƒ½
            if (typeof PortfolioAnalysis !== 'undefined') {
                console.log('ğŸš€ åˆå§‹åŒ–PortfolioAnalysisæ¨¡å—');
                PortfolioAnalysis.init();
                
                // å»¶è¿Ÿæ‰§è¡Œè‡ªåŠ¨åˆ†æï¼Œç¡®ä¿DOMå®Œå…¨åŠ è½½
                setTimeout(() => {
                    PortfolioAnalysis.autoAnalyze()
                        .then(() => {
                            console.log('âœ… PortfolioAnalysisè‡ªåŠ¨åˆ†æå®Œæˆ');
                        })
                        .catch(error => {
                            console.error('âŒ PortfolioAnalysisè‡ªåŠ¨åˆ†æå¤±è´¥:', error);
                        });
                }, 1000);
            } else {
                console.log('âš ï¸ PortfolioAnalysisæ¨¡å—æœªåŠ è½½');
            }
            
            // åŒæ—¶æ‰§è¡ŒåŸæœ‰çš„æ•°æ®åŠ è½½é€»è¾‘
            loadReportData();
        });
    </script>
</body>
</html>