<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ETF详情 - 基金分析系统</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.0/font/bootstrap-icons.css" rel="stylesheet">
    <style>
        :root {
            --primary-red: #e74c3c;
            --success-green: #27ae60;
            --danger-red: #e74c3c;
            --text-dark: #2c3e50;
            --text-muted: #7f8c8d;
            --border-color: #ecf0f1;
            --bg-light: #f8f9fa;
        }
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', 'Microsoft YaHei', sans-serif;
            font-size: 13px;
            background-color: #f5f5f5;
            color: var(--text-dark);
        }
        .top-nav {
            background: linear-gradient(135deg, #e74c3c 0%, #c0392b 100%);
            padding: 8px 20px;
            display: flex;
            align-items: center;
            justify-content: space-between;
        }
        .top-nav .brand { color: white; font-size: 18px; font-weight: bold; display: flex; align-items: center; gap: 10px; }
        .top-nav .nav-links { display: flex; gap: 20px; }
        .top-nav .nav-links a { color: rgba(255,255,255,0.9); text-decoration: none; font-size: 14px; padding: 5px 10px; border-radius: 4px; }
        .top-nav .nav-links a:hover { background: rgba(255,255,255,0.1); }
        
        .etf-header { background: white; padding: 20px; border-bottom: 1px solid var(--border-color); }
        .etf-title-row { display: flex; align-items: center; gap: 15px; margin-bottom: 15px; }
        .etf-name { font-size: 22px; font-weight: bold; color: var(--text-dark); }
        .etf-code { font-size: 14px; color: var(--text-muted); background: #f0f0f0; padding: 2px 8px; border-radius: 4px; }
        .etf-tags { display: flex; gap: 8px; }
        .etf-tag { font-size: 11px; padding: 2px 8px; border-radius: 3px; background: #e8f4fc; color: #1976d2; }
        
        .price-section { display: flex; align-items: flex-end; gap: 40px; flex-wrap: wrap; }
        .main-price { font-size: 36px; font-weight: bold; }
        .price-change { font-size: 14px; margin-top: 5px; }
        .price-positive { color: var(--danger-red); }
        .price-negative { color: var(--success-green); }
        .price-metrics { display: flex; gap: 30px; flex-wrap: wrap; }
        .metric-item { text-align: center; }
        .metric-value { font-size: 16px; font-weight: 600; }
        .metric-label { font-size: 11px; color: var(--text-muted); margin-top: 2px; }
        
        .main-content { display: flex; gap: 20px; padding: 20px; min-height: calc(100vh - 200px); }
        .chart-panel { flex: 1; background: white; border-radius: 8px; padding: 20px; box-shadow: 0 2px 8px rgba(0,0,0,0.05); }
        .nav-panel { width: 450px; background: white; border-radius: 8px; padding: 20px; box-shadow: 0 2px 8px rgba(0,0,0,0.05); }
        
        .toolbar-row { display: flex; align-items: center; justify-content: space-between; margin-bottom: 15px; padding-bottom: 15px; border-bottom: 1px solid var(--border-color); flex-wrap: wrap; gap: 10px; }
        .date-range { display: flex; align-items: center; gap: 10px; font-size: 12px; }
        .date-range input { padding: 6px 10px; border: 1px solid #ddd; border-radius: 4px; font-size: 12px; }
        .btn-apply { padding: 6px 15px; background: var(--primary-red); color: white; border: none; border-radius: 4px; cursor: pointer; font-size: 12px; }
        .btn-apply:hover { background: #c0392b; }
        .period-tabs { display: flex; gap: 5px; }
        .period-tabs .tab { padding: 5px 12px; border: 1px solid #ddd; border-radius: 4px; cursor: pointer; font-size: 12px; background: white; transition: all 0.2s; }
        .period-tabs .tab:hover { background: #f5f5f5; }
        .period-tabs .tab.active { background: var(--primary-red); color: white; border-color: var(--primary-red); }
        
        .chart-type-tabs { display: flex; gap: 0; margin-bottom: 15px; }
        .chart-type-tabs .tab { padding: 10px 25px; border: 1px solid #ddd; cursor: pointer; font-size: 13px; background: white; transition: all 0.2s; }
        .chart-type-tabs .tab:first-child { border-radius: 4px 0 0 4px; }
        .chart-type-tabs .tab:last-child { border-radius: 0 4px 4px 0; }
        .chart-type-tabs .tab:not(:last-child) { border-right: none; }
        .chart-type-tabs .tab:hover { background: #f5f5f5; }
        .chart-type-tabs .tab.active { background: var(--primary-red); color: white; border-color: var(--primary-red); }
        
        .chart-container { position: relative; height: 350px; }
        .chart-legend { display: flex; gap: 20px; margin-bottom: 10px; font-size: 12px; }
        .legend-item { display: flex; align-items: center; gap: 5px; }
        .legend-color { width: 12px; height: 3px; border-radius: 2px; }
        
        .content-section { display: none; }
        .content-section.active { display: block; }
        
        /* 持仓表格 */
        .holdings-table { width: 100%; border-collapse: collapse; font-size: 12px; margin-top: 15px; }
        .holdings-table th { background: #fafafa; padding: 10px 8px; text-align: left; font-weight: 500; color: var(--text-muted); border-bottom: 1px solid var(--border-color); }
        .holdings-table td { padding: 10px 8px; border-bottom: 1px solid #f0f0f0; }
        .holdings-table tr:hover { background: #fafafa; }
        
        /* 信息卡片 */
        .info-card { background: #f8f9fa; border-radius: 8px; padding: 20px; margin-top: 15px; }
        .info-row { display: flex; justify-content: space-between; padding: 10px 0; border-bottom: 1px solid #eee; }
        .info-row:last-child { border-bottom: none; }
        .info-label { color: var(--text-muted); }
        .info-value { font-weight: 500; }
        
        .nav-table-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px; }
        .nav-table-title { font-size: 15px; font-weight: 600; }
        .nav-table { width: 100%; border-collapse: collapse; font-size: 12px; }
        .nav-table th { background: #fafafa; padding: 10px 8px; text-align: right; font-weight: 500; color: var(--text-muted); border-bottom: 1px solid var(--border-color); }
        .nav-table th:first-child { text-align: left; }
        .nav-table td { padding: 10px 8px; text-align: right; border-bottom: 1px solid #f0f0f0; }
        .nav-table td:first-child { text-align: left; }
        .nav-table tr:hover { background: #fafafa; }
        .nav-table-wrapper { max-height: 400px; overflow-y: auto; }
        
        .btn-export { padding: 5px 15px; border: 1px solid #ddd; border-radius: 4px; background: white; cursor: pointer; font-size: 12px; }
        .btn-export:hover { background: #f5f5f5; }
        
        .positive { color: var(--danger-red); }
        .negative { color: var(--success-green); }
        .loading-text { text-align: center; padding: 40px; color: var(--text-muted); }
        
        @media (max-width: 1200px) {
            .main-content { flex-direction: column; }
            .nav-panel { width: 100%; }
        }
    </style>
</head>
<body>
    <div class="top-nav">
        <div class="brand"><i class="bi bi-graph-up-arrow"></i><span>基金分析系统</span></div>
        <div class="nav-links">
            <a href="/"><i class="bi bi-house"></i> 首页</a>
            <a href="/etf"><i class="bi bi-bar-chart"></i> ETF市场</a>
            <a href="/strategy"><i class="bi bi-lightbulb"></i> 策略分析</a>
        </div>
    </div>

    <div class="etf-header">
        <div class="etf-title-row">
            <span class="etf-name" id="etf-name">--</span>
            <span class="etf-code" id="etf-code">--</span>
            <div class="etf-tags">
                <span class="etf-tag">ETF</span>
                <span class="etf-tag" id="etf-market">沪市</span>
            </div>
        </div>
        <div class="price-section">
            <div>
                <div class="main-price" id="main-price">--</div>
                <div class="price-change" id="price-change">
                    <span id="change-amount">--</span>
                    <span id="change-percent">--</span>
                </div>
            </div>
            <div class="price-metrics">
                <div class="metric-item"><div class="metric-value" id="metric-open">--</div><div class="metric-label">今开</div></div>
                <div class="metric-item"><div class="metric-value" id="metric-high">--</div><div class="metric-label">最高</div></div>
                <div class="metric-item"><div class="metric-value" id="metric-low">--</div><div class="metric-label">最低</div></div>
                <div class="metric-item"><div class="metric-value" id="metric-volume">--</div><div class="metric-label">成交量</div></div>
                <div class="metric-item"><div class="metric-value" id="metric-turnover">--</div><div class="metric-label">成交额</div></div>
                <div class="metric-item"><div class="metric-value" id="metric-turnover-rate">--</div><div class="metric-label">换手率</div></div>
                <div class="metric-item"><div class="metric-value" id="metric-amplitude">--</div><div class="metric-label">振幅</div></div>
                <div class="metric-item"><div class="metric-value" id="metric-prev-close">--</div><div class="metric-label">昨收</div></div>
            </div>
        </div>
    </div>

    <div class="main-content">
        <div class="chart-panel">
            <div class="toolbar-row">
                <div class="date-range">
                    <span>时间范围:</span>
                    <input type="date" id="start-date">
                    <span>至</span>
                    <input type="date" id="end-date">
                    <button class="btn-apply" onclick="applyDateRange()">应用</button>
                </div>
                <div class="period-tabs">
                    <span class="tab" data-period="1m">近1月</span>
                    <span class="tab" data-period="3m">近3月</span>
                    <span class="tab" data-period="6m">近半年</span>
                    <span class="tab active" data-period="1y">近1年</span>
                    <span class="tab" data-period="3y">近3年</span>
                    <span class="tab" data-period="all">成立以来</span>
                </div>
            </div>
            
            <div class="chart-type-tabs">
                <span class="tab active" data-type="performance">业绩指标</span>
                <span class="tab" data-type="holdings">基金持仓</span>
                <span class="tab" data-type="company">基金公司</span>
                <span class="tab" data-type="manager">基金经理</span>
            </div>
            
            <!-- 业绩指标内容 -->
            <div class="content-section active" id="section-performance">
                <div class="chart-legend">
                    <div class="legend-item">
                        <span class="legend-color" style="background: #e74c3c;"></span>
                        <span id="legend-etf-name">ETF收益率</span>
                        <span class="positive" id="legend-etf-return">--</span>
                    </div>
                    <div class="legend-item">
                        <span class="legend-color" style="background: #3498db;"></span>
                        <span>沪深300</span>
                        <span id="legend-hs300-return">--</span>
                    </div>
                </div>
                <div class="chart-container">
                    <canvas id="performance-chart"></canvas>
                </div>
            </div>
            
            <!-- 基金持仓内容 -->
            <div class="content-section" id="section-holdings">
                <div class="nav-table-header">
                    <span class="nav-table-title"><i class="bi bi-pie-chart me-2"></i>前十大持仓</span>
                    <span class="text-muted" id="holdings-update-date">--</span>
                </div>
                <table class="holdings-table">
                    <thead>
                        <tr>
                            <th>序号</th>
                            <th>股票代码</th>
                            <th>股票名称</th>
                            <th>占净值比例</th>
                            <th>持股数(万股)</th>
                            <th>持仓市值(万元)</th>
                        </tr>
                    </thead>
                    <tbody id="holdings-table-body">
                        <tr><td colspan="6" class="loading-text">加载中...</td></tr>
                    </tbody>
                </table>
            </div>
            
            <!-- 基金公司内容 -->
            <div class="content-section" id="section-company">
                <div class="info-card">
                    <h5 style="margin-bottom: 15px;"><i class="bi bi-building me-2"></i>基金公司信息</h5>
                    <div class="info-row"><span class="info-label">基金公司</span><span class="info-value" id="info-company">--</span></div>
                    <div class="info-row"><span class="info-label">成立日期</span><span class="info-value" id="info-establish-date">--</span></div>
                    <div class="info-row"><span class="info-label">基金规模</span><span class="info-value" id="info-fund-size">--</span></div>
                    <div class="info-row"><span class="info-label">管理费率</span><span class="info-value" id="info-management-fee">--</span></div>
                    <div class="info-row"><span class="info-label">托管费率</span><span class="info-value" id="info-custody-fee">--</span></div>
                    <div class="info-row"><span class="info-label">业绩比较基准</span><span class="info-value" id="info-benchmark">--</span></div>
                </div>
            </div>
            
            <!-- 基金经理内容 -->
            <div class="content-section" id="section-manager">
                <div class="info-card">
                    <h5 style="margin-bottom: 15px;"><i class="bi bi-person me-2"></i>基金经理信息</h5>
                    <div class="info-row"><span class="info-label">基金经理</span><span class="info-value" id="info-manager">--</span></div>
                    <div class="info-row"><span class="info-label">任职日期</span><span class="info-value" id="info-manager-start">--</span></div>
                    <div class="info-row"><span class="info-label">管理基金数</span><span class="info-value" id="info-manager-funds">--</span></div>
                    <div class="info-row"><span class="info-label">从业年限</span><span class="info-value" id="info-manager-years">--</span></div>
                </div>
            </div>
        </div>

        <div class="nav-panel">
            <div class="nav-table-header">
                <span class="nav-table-title"><i class="bi bi-table me-2"></i>基金净值</span>
                <button class="btn-export" onclick="exportNavData()"><i class="bi bi-download me-1"></i>导出</button>
            </div>
            <div class="nav-table-wrapper">
                <table class="nav-table">
                    <thead>
                        <tr><th>日期</th><th>单位净值</th><th>累计净值</th><th>复权净值</th><th>涨跌幅</th></tr>
                    </thead>
                    <tbody id="nav-table-body">
                        <tr><td colspan="5" class="loading-text">加载中...</td></tr>
                    </tbody>
                </table>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

    <script>
        const etfCode = window.location.pathname.split('/').pop();
        let etfData = null;
        let historyData = [];
        let performanceChart = null;
        let currentPeriod = '1y';

        document.addEventListener('DOMContentLoaded', function() {
            loadETFDetail();
            loadETFHistory('1y');
            loadETFInfo();
            loadETFHoldings();
            
            // 设置默认日期范围
            const today = new Date();
            const oneYearAgo = new Date(today);
            oneYearAgo.setFullYear(today.getFullYear() - 1);
            document.getElementById('end-date').value = today.toISOString().split('T')[0];
            document.getElementById('start-date').value = oneYearAgo.toISOString().split('T')[0];
            
            // 时间段切换
            document.querySelectorAll('.period-tabs .tab').forEach(tab => {
                tab.addEventListener('click', function() {
                    document.querySelectorAll('.period-tabs .tab').forEach(t => t.classList.remove('active'));
                    this.classList.add('active');
                    currentPeriod = this.dataset.period;
                    loadETFHistory(currentPeriod);
                    updateDateRangeFromPeriod(currentPeriod);
                });
            });
            
            // 图表类型切换
            document.querySelectorAll('.chart-type-tabs .tab').forEach(tab => {
                tab.addEventListener('click', function() {
                    document.querySelectorAll('.chart-type-tabs .tab').forEach(t => t.classList.remove('active'));
                    this.classList.add('active');
                    
                    // 切换内容区域
                    document.querySelectorAll('.content-section').forEach(s => s.classList.remove('active'));
                    const sectionId = 'section-' + this.dataset.type;
                    document.getElementById(sectionId).classList.add('active');
                });
            });
        });

        // 根据时间段更新日期选择器
        function updateDateRangeFromPeriod(period) {
            const today = new Date();
            let startDate = new Date(today);
            
            switch(period) {
                case '1m': startDate.setMonth(today.getMonth() - 1); break;
                case '3m': startDate.setMonth(today.getMonth() - 3); break;
                case '6m': startDate.setMonth(today.getMonth() - 6); break;
                case '1y': startDate.setFullYear(today.getFullYear() - 1); break;
                case '3y': startDate.setFullYear(today.getFullYear() - 3); break;
                case 'all': startDate = new Date('2010-01-01'); break;
            }
            
            document.getElementById('end-date').value = today.toISOString().split('T')[0];
            document.getElementById('start-date').value = startDate.toISOString().split('T')[0];
        }

        // 应用自定义日期范围
        function applyDateRange() {
            const startDate = document.getElementById('start-date').value;
            const endDate = document.getElementById('end-date').value;
            
            if (!startDate || !endDate) {
                alert('请选择完整的日期范围');
                return;
            }
            
            if (new Date(startDate) > new Date(endDate)) {
                alert('开始日期不能大于结束日期');
                return;
            }
            
            // 清除时间段选中状态
            document.querySelectorAll('.period-tabs .tab').forEach(t => t.classList.remove('active'));
            
            loadETFHistoryByDateRange(startDate, endDate);
        }

        // 按日期范围加载历史数据
        async function loadETFHistoryByDateRange(startDate, endDate) {
            try {
                const response = await fetch(`/api/etf/${etfCode}/history?start_date=${startDate}&end_date=${endDate}`);
                const result = await response.json();
                
                if (result.success && result.data.length > 0) {
                    historyData = result.data;
                    renderNavTable(historyData);
                    renderPerformanceChart(historyData);
                } else {
                    document.getElementById('nav-table-body').innerHTML = 
                        '<tr><td colspan="5" class="loading-text">暂无数据</td></tr>';
                }
            } catch (error) {
                console.error('获取历史数据失败:', error);
            }
        }

        async function loadETFDetail() {
            try {
                const response = await fetch(`/api/etf/${etfCode}`);
                const result = await response.json();
                if (result.success) {
                    etfData = result.data;
                    renderETFHeader(etfData);
                }
            } catch (error) {
                console.error('请求失败:', error);
            }
        }

        function renderETFHeader(data) {
            document.getElementById('etf-name').textContent = data.etf_name || '--';
            document.getElementById('etf-code').textContent = data.etf_code || '--';
            document.title = `${data.etf_name} - ETF详情`;
            
            const code = data.etf_code || '';
            const market = code.startsWith('5') ? '沪市' : (code.startsWith('1') ? '深市' : '其他');
            document.getElementById('etf-market').textContent = market;
            
            const changePercent = data.change_percent || 0;
            const priceClass = changePercent >= 0 ? 'price-positive' : 'price-negative';
            
            const mainPrice = document.getElementById('main-price');
            mainPrice.textContent = formatPrice(data.current_price);
            mainPrice.className = `main-price ${priceClass}`;
            
            document.getElementById('price-change').className = `price-change ${priceClass}`;
            document.getElementById('change-amount').textContent = formatPriceChange(data.change_amount);
            document.getElementById('change-percent').textContent = `(${formatPercent(changePercent)})`;
            
            document.getElementById('metric-open').textContent = formatPrice(data.open_price);
            document.getElementById('metric-high').textContent = formatPrice(data.high_price);
            document.getElementById('metric-low').textContent = formatPrice(data.low_price);
            document.getElementById('metric-volume').textContent = formatVolume(data.volume);
            document.getElementById('metric-turnover').textContent = formatTurnover(data.turnover);
            document.getElementById('metric-turnover-rate').textContent = formatPercent(data.turnover_rate);
            document.getElementById('metric-amplitude').textContent = formatPercent(data.amplitude);
            document.getElementById('metric-prev-close').textContent = formatPrice(data.prev_close);
            
            document.getElementById('legend-etf-name').textContent = data.etf_name || 'ETF收益率';
        }

        async function loadETFHistory(period) {
            try {
                const response = await fetch(`/api/etf/${etfCode}/history?period=${period}`);
                const result = await response.json();
                
                if (result.success && result.data.length > 0) {
                    historyData = result.data;
                    renderNavTable(historyData);
                    renderPerformanceChart(historyData);
                } else {
                    document.getElementById('nav-table-body').innerHTML = 
                        '<tr><td colspan="5" class="loading-text">暂无数据</td></tr>';
                }
            } catch (error) {
                console.error('获取历史数据失败:', error);
            }
        }

        async function loadETFHoldings() {
            try {
                const response = await fetch(`/api/etf/${etfCode}/holdings`);
                const result = await response.json();
                
                if (result.success && result.data.holdings && result.data.holdings.length > 0) {
                    renderHoldingsTable(result.data.holdings);
                    if (result.data.update_date) {
                        document.getElementById('holdings-update-date').textContent = `更新日期: ${result.data.update_date}`;
                    }
                } else {
                    document.getElementById('holdings-table-body').innerHTML = 
                        '<tr><td colspan="6" class="loading-text">暂无持仓数据</td></tr>';
                }
            } catch (error) {
                console.error('获取持仓数据失败:', error);
                document.getElementById('holdings-table-body').innerHTML = 
                    '<tr><td colspan="6" class="loading-text">获取持仓数据失败</td></tr>';
            }
        }

        async function loadETFInfo() {
            try {
                const response = await fetch(`/api/etf/${etfCode}/info`);
                const result = await response.json();
                
                if (result.success && result.data) {
                    const info = result.data;
                    document.getElementById('info-company').textContent = info.fund_company || '--';
                    document.getElementById('info-establish-date').textContent = info.establish_date || '--';
                    document.getElementById('info-fund-size').textContent = info.fund_size || '--';
                    document.getElementById('info-management-fee').textContent = info.management_fee || '--';
                    document.getElementById('info-custody-fee').textContent = info.custody_fee || '--';
                    document.getElementById('info-benchmark').textContent = info.benchmark || '--';
                    document.getElementById('info-manager').textContent = info.fund_manager || '--';
                }
            } catch (error) {
                console.error('获取基金信息失败:', error);
            }
        }

        function renderHoldingsTable(holdings) {
            const tbody = document.getElementById('holdings-table-body');
            
            let html = '';
            holdings.forEach((item, index) => {
                const stockCode = item.stock_code || item['股票代码'] || '--';
                const stockName = item.stock_name || item['股票名称'] || '--';
                const ratio = item.ratio || item['占净值比例'] || '--';
                const shares = item.shares || item['持股数'] || '--';
                const value = item.value || item['持仓市值'] || '--';
                
                html += `
                    <tr>
                        <td>${index + 1}</td>
                        <td>${stockCode}</td>
                        <td>${stockName}</td>
                        <td>${typeof ratio === 'number' ? ratio.toFixed(2) + '%' : ratio}</td>
                        <td>${formatNumber(shares)}</td>
                        <td>${formatNumber(value)}</td>
                    </tr>
                `;
            });
            
            tbody.innerHTML = html || '<tr><td colspan="6" class="loading-text">暂无持仓数据</td></tr>';
        }

        function renderNavTable(data) {
            const tbody = document.getElementById('nav-table-body');
            if (!data || data.length === 0) {
                tbody.innerHTML = '<tr><td colspan="5" class="loading-text">暂无数据</td></tr>';
                return;
            }
            
            const sortedData = [...data].sort((a, b) => new Date(b.date) - new Date(a.date));
            
            let html = '';
            sortedData.forEach(item => {
                const changePercent = item.change_percent || 0;
                const changeClass = changePercent >= 0 ? 'positive' : 'negative';
                
                // 优先使用净值数据，如果没有则使用收盘价
                const unitNav = item.unit_nav || item.close || item.current_price || '--';
                const accNav = item.acc_nav || unitNav;
                const adjNav = item.adj_nav || accNav;
                
                html += `
                    <tr>
                        <td>${item.date || '--'}</td>
                        <td>${formatPrice(unitNav)}</td>
                        <td>${formatPrice(accNav)}</td>
                        <td>${formatPrice(adjNav)}</td>
                        <td class="${changeClass}">${formatPercent(changePercent)}</td>
                    </tr>
                `;
            });
            
            tbody.innerHTML = html;
        }

        function renderPerformanceChart(data) {
            const ctx = document.getElementById('performance-chart').getContext('2d');
            if (performanceChart) performanceChart.destroy();
            
            const sortedData = [...data].sort((a, b) => new Date(a.date) - new Date(b.date));
            const labels = sortedData.map(d => d.date);
            // 优先使用单位净值，如果没有则使用收盘价
            const prices = sortedData.map(d => d.unit_nav || d.close || d.current_price);
            
            const basePrice = prices[0];
            const returns = prices.map(p => ((p - basePrice) / basePrice * 100).toFixed(2));
            
            const totalReturn = returns[returns.length - 1];
            const returnEl = document.getElementById('legend-etf-return');
            returnEl.textContent = `${totalReturn >= 0 ? '+' : ''}${totalReturn}%`;
            returnEl.className = totalReturn >= 0 ? 'positive' : 'negative';
            
            performanceChart = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: labels,
                    datasets: [{
                        label: 'ETF收益率',
                        data: returns,
                        borderColor: '#e74c3c',
                        backgroundColor: 'rgba(231, 76, 60, 0.1)',
                        borderWidth: 2,
                        fill: true,
                        tension: 0.1,
                        pointRadius: 0,
                        pointHoverRadius: 4
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: { display: false },
                        tooltip: {
                            mode: 'index',
                            intersect: false,
                            callbacks: { label: ctx => `收益率: ${ctx.raw}%` }
                        }
                    },
                    scales: {
                        x: {
                            display: true,
                            grid: { display: false },
                            ticks: { 
                                maxTicksLimit: 8, 
                                font: { size: 11 },
                                callback: function(value) {
                                    const date = this.getLabelForValue(value);
                                    return date ? date.substring(0, 7) : '';
                                }
                            }
                        },
                        y: {
                            display: true,
                            grid: { color: '#f0f0f0' },
                            ticks: { font: { size: 11 }, callback: v => v + '%' }
                        }
                    },
                    interaction: { intersect: false, mode: 'index' }
                }
            });
        }

        function exportNavData() {
            if (!historyData || historyData.length === 0) {
                alert('暂无数据可导出');
                return;
            }
            let csv = '日期,单位净值,累计净值,复权净值,涨跌幅\n';
            historyData.forEach(item => {
                const unitNav = item.unit_nav || item.close || '';
                const accNav = item.acc_nav || unitNav;
                const adjNav = item.adj_nav || accNav;
                csv += `${item.date},${unitNav},${accNav},${adjNav},${item.change_percent || ''}\n`;
            });
            const blob = new Blob(['\ufeff' + csv], { type: 'text/csv;charset=utf-8;' });
            const link = document.createElement('a');
            link.href = URL.createObjectURL(blob);
            link.download = `${etfCode}_净值历史数据.csv`;
            link.click();
        }

        function formatPrice(value) {
            if (value == null || isNaN(value)) return '--';
            return parseFloat(value).toFixed(4);
        }
        function formatPriceChange(value) {
            if (value == null || isNaN(value)) return '--';
            return (value >= 0 ? '+' : '') + parseFloat(value).toFixed(4);
        }
        function formatPercent(value) {
            if (value == null || isNaN(value)) return '--';
            return (value >= 0 ? '+' : '') + parseFloat(value).toFixed(2) + '%';
        }
        function formatVolume(value) {
            if (value == null || isNaN(value)) return '--';
            if (value >= 100000000) return (value / 100000000).toFixed(2) + '亿';
            if (value >= 10000) return (value / 10000).toFixed(2) + '万';
            return value.toString();
        }
        function formatTurnover(value) {
            if (value == null || isNaN(value)) return '--';
            if (value >= 100000000) return (value / 100000000).toFixed(2) + '亿';
            if (value >= 10000) return (value / 10000).toFixed(2) + '万';
            return value.toFixed(2);
        }
        function formatNumber(value) {
            if (value == null || value === '--') return '--';
            if (typeof value === 'string') return value;
            if (value >= 10000) return (value / 10000).toFixed(2) + '万';
            return value.toFixed(2);
        }
    </script>

</body>
</html>
