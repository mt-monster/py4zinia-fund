<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>åŸºé‡‘ç›¸å…³æ€§åˆ†æ</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.0/font/bootstrap-icons.css" rel="stylesheet">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/4.4.0/chart.umd.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-annotation@3.0.1/dist/chartjs-plugin-annotation.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-zoom@2.0.1/dist/chartjs-plugin-zoom.min.js"></script>
    <link rel="stylesheet" href="{{ url_for('static', filename='css/correlation_analysis.css') }}">
</head>
<body>
    <!-- åŠ è½½æŒ‡ç¤ºå™¨ -->
    <div id="loading-indicator" style="display: none; position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(255,255,255,0.9); z-index: 9999; justify-content: center; align-items: center; flex-direction: column;">
        <div class="spinner-border text-primary" style="width: 3rem; height: 3rem; margin-bottom: 1rem;" role="status">
            <span class="visually-hidden">åŠ è½½ä¸­...</span>
        </div>
        <div style="color: #333; font-size: 1rem;">æ­£åœ¨åŠ è½½å¢å¼ºåˆ†ææ•°æ®...</div>
        <div style="color: #666; font-size: 0.85rem; margin-top: 0.5rem;">åŸºé‡‘æ•°é‡è¾ƒå¤šï¼Œè¯·è€å¿ƒç­‰å¾…</div>
    </div>
    
    <div class="page-wrapper">
        <!-- é¡µé¢å¤´éƒ¨ -->
        <header class="page-header">
            <div class="header-content">
                <div class="header-title">
                    <i class="bi bi-diagram-3-fill"></i>
                    <h1>åŸºé‡‘ç›¸å…³æ€§åˆ†æ</h1>
                </div>
                <p class="header-desc">åˆ†æåŸºé‡‘ä¹‹é—´çš„ç›¸å…³æ€§ï¼Œå¸®åŠ©æ‚¨åˆ†æ•£æŠ•èµ„é£é™©ï¼Œä¼˜åŒ–æŠ•èµ„ç»„åˆé…ç½®</p>
            </div>
        </header>

        <main class="main-container">
            <!-- åŸºé‡‘é€‰æ‹©çŠ¶æ€æ  -->
            <section class="status-bar" id="fund-status-bar">
                <div class="status-content">
                    <i class="bi bi-info-circle-fill"></i>
                    <span id="status-text">è¯·é€‰æ‹©è‡³å°‘2åªåŸºé‡‘è¿›è¡Œåˆ†æ</span>
                </div>
                <a href="/my-holdings-new" class="btn btn-outline">
                    <i class="bi bi-arrow-left"></i>
                    è¿”å›æŒä»“é¡µé¢
                </a>
            </section>

            <!-- ç›¸å…³æ€§æ¦‚è§ˆå¡ç‰‡ -->
            <section class="cards-grid" id="overview-cards" style="display: none;">
                <div class="info-card">
                    <div class="card-icon blue">
                        <i class="bi bi-grid-3x3"></i>
                    </div>
                    <div class="card-content">
                        <span class="card-label">åˆ†æåŸºé‡‘æ•°é‡</span>
                        <span class="card-value" id="fund-count">-</span>
                    </div>
                </div>
                <div class="info-card">
                    <div class="card-icon orange">
                        <i class="bi bi-lightning-fill"></i>
                    </div>
                    <div class="card-content">
                        <span class="card-label">é«˜ç›¸å…³æ€§ç»„åˆ</span>
                        <span class="card-value" id="high-correlation-count">-</span>
                    </div>
                </div>
                <div class="info-card">
                    <div class="card-icon green">
                        <i class="bi bi-shield-check"></i>
                    </div>
                    <div class="card-content">
                        <span class="card-label">åˆ†æ•£åº¦è¯„åˆ†</span>
                        <span class="card-value" id="diversification-score">-</span>
                    </div>
                </div>
            </section>

            <!-- é«˜ç›¸å…³æ€§åŸºé‡‘ç»„åˆ -->
            <section class="content-section" id="top-pairs-section" style="display: none;">
                <div class="section-header">
                    <div class="section-title">
                        <i class="bi bi-lightning-charge"></i>
                        <h2>é«˜ç›¸å…³æ€§åŸºé‡‘ç»„åˆ</h2>
                    </div>
                    <span class="section-badge">éœ€å…³æ³¨</span>
                </div>
                <div class="section-body">
                    <div id="top-pairs-content">
                        <div class="loading-state">
                            <i class="bi bi-arrow-repeat"></i>
                            <span>åŠ è½½ä¸­...</span>
                        </div>
                    </div>
                </div>
            </section>

            <!-- ç›¸å…³æ€§çŸ©é˜µ -->
            <section class="content-section" id="matrix-section" style="display: none;">
                <div class="section-header">
                    <div class="section-title">
                        <i class="bi bi-table"></i>
                        <h2>ç›¸å…³æ€§çŸ©é˜µ</h2>
                    </div>
                    <div class="section-actions">
                        <button class="btn btn-sm btn-ghost" onclick="toggleMatrixFullscreen()">
                            <i class="bi bi-fullscreen"></i>
                            å…¨å±æŸ¥çœ‹
                        </button>
                    </div>
                </div>
                <div class="section-body">
                    <div class="matrix-wrapper" id="matrix-wrapper">
                        <div id="matrix-content">
                            <div class="loading-state">
                                <i class="bi bi-arrow-repeat"></i>
                                <span>åŠ è½½ä¸­...</span>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="matrix-legend">
                    <div class="legend-item">
                        <span class="legend-color high"></span>
                        <span class="legend-label">é«˜ç›¸å…³ (>0.7)</span>
                    </div>
                    <div class="legend-item">
                        <span class="legend-color medium"></span>
                        <span class="legend-label">ä¸­ç­‰ç›¸å…³ (0.3-0.7)</span>
                    </div>
                    <div class="legend-item">
                        <span class="legend-color low"></span>
                        <span class="legend-label">ä½ç›¸å…³ (<0.3)</span>
                    </div>
                </div>
            </section>

            <!-- å¢å¼ºç›¸å…³æ€§åˆ†æ -->
            <section class="content-section" id="enhanced-analysis-section" style="display: none;">
                <div class="section-header">
                    <div class="section-title">
                        <i class="bi bi-graph-up-arrow"></i>
                        <h2>æ·±åº¦ç›¸å…³æ€§åˆ†æ</h2>
                    </div>
                </div>
                <div class="section-body">
                    <div id="enhanced-content">
                        <div class="loading-state">
                            <i class="bi bi-arrow-repeat"></i>
                            <span>åŠ è½½ä¸­...</span>
                        </div>
                    </div>
                </div>
            </section>

            <!-- äº¤äº’å¼ç›¸å…³æ€§å›¾è¡¨ -->
            <section class="content-section" id="interactive-charts-section" style="display: none;">
                <div class="section-header">
                    <div class="section-title">
                        <i class="bi bi-bar-chart-line"></i>
                        <h2>å¯è§†åŒ–åˆ†æå›¾è¡¨</h2>
                    </div>
                </div>
                <div class="section-body">
                    <div id="interactive-charts-content" class="charts-container">
                        <div class="loading-state">
                            <i class="bi bi-arrow-repeat"></i>
                            <span>åŠ è½½ä¸­...</span>
                        </div>
                    </div>
                </div>
            </section>

            <!-- ç©ºçŠ¶æ€æç¤º -->
            <section class="empty-state" id="empty-state">
                <div class="empty-icon">
                    <i class="bi bi-diagram-3"></i>
                </div>
                <h3>æš‚æ— åˆ†ææ•°æ®</h3>
                <p>è¯·ä»åŸºé‡‘æŒä»“é¡µé¢é€‰æ‹©è‡³å°‘2åªåŸºé‡‘è¿›è¡Œç›¸å…³æ€§åˆ†æ</p>
                <a href="/my-holdings-new" class="btn btn-primary">
                    <i class="bi bi-arrow-left"></i>
                    å‰å¾€æŒä»“é¡µé¢
                </a>
            </section>
        </main>

        <!-- é¡µè„š -->
        <footer class="page-footer">
            <p>åŸºé‡‘ç›¸å…³æ€§åˆ†æ &copy; 2024</p>
        </footer>
    </div>

    <script>
        // ==================== å…¨å±€å˜é‡ ====================
        let analysisData = null;
        let currentFundCodes = [];

        // ==================== åˆå§‹åŒ– ====================
        document.addEventListener('DOMContentLoaded', function() {
            console.log('=== ç›¸å…³æ€§åˆ†æé¡µé¢åŠ è½½å¼€å§‹ï¼ˆä¼˜åŒ–ç‰ˆ - æ”¯æŒæ‡’åŠ è½½ï¼‰===');
            initializePage();
        });

        async function initializePage() {
            const data = getAnalysisData();
            console.log('ä»sessionStorageè·å–çš„æ•°æ®:', data);
            
            if (data && data.fund_codes && data.fund_codes.length >= 2) {
                console.log('æ£€æµ‹åˆ°ä¼ é€’çš„åŸºé‡‘ä»£ç :', data.fund_codes);
                analysisData = data;
                currentFundCodes = data.fund_codes;
                
                // æ˜¾ç¤ºåˆ†æå†…å®¹ï¼ˆé¡µé¢ç»“æ„ç«‹å³æ˜¾ç¤ºï¼‰
                showAnalysisContent();
                
                // æ›´æ–°çŠ¶æ€æ æ˜¾ç¤ºæ­£åœ¨åŠ è½½
                const statusText = document.getElementById('status-text');
                if (statusText) {
                    statusText.innerHTML = `æ­£åœ¨åˆ†æ ${data.fund_codes.length} åªåŸºé‡‘çš„ç›¸å…³æ€§ <span class="loading-dots">...</span>`;
                }
                
                // å¦‚æœæœ‰åŸºç¡€æ•°æ®ï¼Œå…ˆå¿«é€Ÿæ˜¾ç¤ºåŸºç¡€ç»“æœ
                if (data.basic_correlation) {
                    console.log('ğŸ“Š å…ˆæ˜¾ç¤ºåŸºç¡€æ•°æ®...');
                    renderAnalysisResult(data);
                }
                
                // ä½¿ç”¨ setTimeout è®©é¡µé¢å…ˆæ¸²æŸ“ï¼Œç„¶åå†åŠ è½½äº¤äº’å¼æ•°æ®
                // è¿™æ ·ç”¨æˆ·ä¸ä¼šçœ‹åˆ°ç™½å±æˆ–loadingï¼Œè€Œæ˜¯å…ˆçœ‹åˆ°é¡µé¢ç»“æ„
                setTimeout(() => {
                    console.log('ğŸ”„ å¼€å§‹å¼‚æ­¥åŠ è½½äº¤äº’å¼å›¾è¡¨æ•°æ®...');
                    loadInteractiveCorrelationData(data.fund_codes);
                }, 100);
                
            } else {
                console.log('æœªæ£€æµ‹åˆ°æœ‰æ•ˆçš„åŸºé‡‘æ•°æ®ï¼Œæ˜¾ç¤ºç©ºçŠ¶æ€');
                showEmptyState();
            }
            
            console.log('=== é¡µé¢åˆå§‹åŒ–å®Œæˆï¼Œæ•°æ®åŠ è½½ä¸­... ===');
        }
        
        // åŠ è½½äº¤äº’å¼ç›¸å…³æ€§æ•°æ®ï¼ˆæ‡’åŠ è½½ä¼˜åŒ–ç‰ˆ - åˆ†é˜¶æ®µæ˜¾ç¤ºï¼‰
        async function loadInteractiveCorrelationData(fundCodes) {
            console.log('ğŸ”„ å¼€å§‹åŠ è½½äº¤äº’å¼ç›¸å…³æ€§æ•°æ®ï¼ˆæ‡’åŠ è½½æ¨¡å¼ï¼‰...');
            console.log(`[Performance] å¼€å§‹APIè¯·æ±‚æ—¶é—´: ${new Date().toISOString()}`);
            
            const requestStartTime = performance.now();
            
            try {
                // å…ˆæ˜¾ç¤ºåŸºç¡€é¡µé¢ç»“æ„ï¼Œè®©ç”¨æˆ·çœ‹åˆ°æ­£åœ¨åŠ è½½çš„çŠ¶æ€
                hideLoadingIndicator();
                
                // æ›´æ–°çŠ¶æ€æ æ˜¾ç¤ºæ­£åœ¨åŠ è½½
                const statusText = document.getElementById('status-text');
                if (statusText) {
                    statusText.innerHTML = `æ­£åœ¨åˆ†æ ${fundCodes.length} åªåŸºé‡‘çš„ç›¸å…³æ€§ <span class="loading-dots">...</span>`;
                }
                
                const response = await fetch('/api/holdings/analyze/correlation-interactive', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ 
                        fund_codes: fundCodes
                    })
                });
                
                const requestEndTime = performance.now();
                const requestDuration = requestEndTime - requestStartTime;
                console.log(`[Performance] APIå“åº”æ—¶é—´: ${requestDuration.toFixed(2)} ms`);
                
                const result = await response.json();
                
                if (result.success) {
                    const responseData = result.data;
                    
                    // è®°å½•åç«¯æ€§èƒ½æ•°æ®
                    if (responseData._api_performance) {
                        console.log('[Performance] åç«¯æ€§èƒ½æ•°æ®:', responseData._api_performance);
                    }
                    
                    // æ›´æ–°åˆ†ææ•°æ®
                    analysisData = {
                        ...analysisData,
                        ...responseData,
                        fund_codes: fundCodes
                    };
                    
                    const renderStartTime = performance.now();
                    
                    // ä¾æ¬¡æ¸²æŸ“å„ä¸ªéƒ¨åˆ†ï¼Œè®©ç”¨æˆ·é€æ­¥çœ‹åˆ°å†…å®¹
                    console.log('ğŸ“Š å¼€å§‹æ¸²æŸ“é¡µé¢ç»„ä»¶...');
                    
                    // 1. å…ˆæ¸²æŸ“æ¦‚è§ˆï¼ˆæœ€å¿«ï¼‰
                    if (responseData.all_combinations_summary) {
                        updateOverviewFromCombinations(responseData.all_combinations_summary, fundCodes.length);
                    }
                    
                    // 2. æ¸²æŸ“ç›¸å…³æ€§çŸ©é˜µ
                    if (responseData.all_combinations_summary) {
                        renderCorrelationMatrixFromSummary(responseData.all_combinations_summary, fundCodes);
                    }
                    
                    // 3. æ¸²æŸ“ç»„åˆåˆ—è¡¨
                    if (responseData.all_combinations_summary) {
                        renderCombinationsList(responseData.all_combinations_summary);
                    }
                    
                    // 4. æœ€åæ¸²æŸ“å›¾è¡¨ï¼ˆæœ€è€—æ—¶ï¼‰
                    if (responseData.primary_combination) {
                        renderInteractiveCharts(responseData);
                    }
                    
                    const renderEndTime = performance.now();
                    console.log(`[Performance] å‰ç«¯æ¸²æŸ“æ—¶é—´: ${(renderEndTime - renderStartTime).toFixed(2)} ms`);
                    console.log(`[Performance] æ€»è€—æ—¶: ${(renderEndTime - requestStartTime).toFixed(2)} ms`);
                    
                    // æ›´æ–°çŠ¶æ€æ 
                    if (statusText) {
                        statusText.textContent = `å·²å®Œæˆ ${fundCodes.length} åªåŸºé‡‘çš„ç›¸å…³æ€§åˆ†æ`;
                    }
                    
                    // æ˜¾ç¤ºæ‡’åŠ è½½æç¤º
                    if (responseData.lazy_load_enabled && responseData.all_combinations_summary && responseData.all_combinations_summary.length > 1) {
                        showLazyLoadHint(responseData.all_combinations_summary.length);
                    }
                    
                    console.log('âœ… é¡µé¢æ¸²æŸ“å®Œæˆ');
                } else {
                    console.error('âŒ åŠ è½½æ•°æ®å¤±è´¥:', result.error);
                    showErrorMessage('åˆ†ææ•°æ®åŠ è½½å¤±è´¥: ' + (result.error || 'æœªçŸ¥é”™è¯¯'));
                }
            } catch (error) {
                const requestEndTime = performance.now();
                console.error(`âŒ ç½‘ç»œé”™è¯¯ï¼Œè€—æ—¶: ${(requestEndTime - requestStartTime).toFixed(2)} ms, é”™è¯¯:`, error);
                showErrorMessage('ç½‘ç»œé”™è¯¯ï¼Œéƒ¨åˆ†åˆ†ææ•°æ®å¯èƒ½æ— æ³•æ˜¾ç¤º');
            }
        }
        
        // æŒ‰éœ€åŠ è½½å•ä¸ªåŸºé‡‘å¯¹çš„è¯¦ç»†æ•°æ®
        async function loadPairDetail(fund1Code, fund2Code) {
            console.log(`ğŸ”„ æ‡’åŠ è½½: åŠ è½½ ${fund1Code} vs ${fund2Code} çš„è¯¦ç»†æ•°æ®`);
            
            try {
                // æ˜¾ç¤ºåŠ è½½çŠ¶æ€
                const chartsContainer = document.getElementById('interactive-charts-content');
                chartsContainer.innerHTML = `
                    <div class="loading-state">
                        <i class="bi bi-arrow-repeat spin"></i>
                        <span>æ­£åœ¨åŠ è½½å›¾è¡¨æ•°æ®...</span>
                    </div>
                `;
                
                const response = await fetch('/api/holdings/analyze/correlation-interactive', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ 
                        fund_codes: currentFundCodes,
                        detail_pair: {
                            fund1: fund1Code,
                            fund2: fund2Code
                        }
                    })
                });
                
                const result = await response.json();
                
                if (result.success && result.data.pair_detail) {
                    console.log('âœ… è¯¦ç»†æ•°æ®åŠ è½½æˆåŠŸ');
                    
                    // æ›´æ–°ä¸»ç»„åˆæ˜¾ç¤º
                    const detail = result.data.pair_detail;
                    
                    // æ„é€ ä¸ä¹‹å‰å…¼å®¹çš„æ•°æ®æ ¼å¼
                    const chartData = {
                        primary_combination: detail,
                        all_funds_nav_comparison: analysisData.all_funds_nav_comparison,
                        all_funds_distribution: analysisData.all_funds_distribution
                    };
                    
                    renderInteractiveCharts(chartData);
                    
                    // æ›´æ–°ç»„åˆåˆ—è¡¨ä¸­çš„æ¿€æ´»çŠ¶æ€
                    updateActiveCombination(fund1Code, fund2Code);
                } else {
                    showChartsError('åŠ è½½è¯¦ç»†æ•°æ®å¤±è´¥');
                }
            } catch (error) {
                console.error('âŒ åŠ è½½è¯¦ç»†æ•°æ®å¤±è´¥:', error);
                showChartsError('ç½‘ç»œé”™è¯¯');
            }
        }
        
        // æ¸²æŸ“ç»„åˆåˆ—è¡¨ï¼ˆæ”¯æŒç‚¹å‡»åˆ‡æ¢ï¼‰
        function renderCombinationsList(combinations) {
            const container = document.getElementById('top-pairs-content');
            
            if (!combinations || combinations.length === 0) {
                container.innerHTML = '<div class="empty-data">æš‚æ— ç»„åˆæ•°æ®</div>';
                return;
            }
            
            // å–ç›¸å…³æ€§æœ€é«˜çš„å‰10ä¸ªç»„åˆ
            const topCombinations = combinations.slice(0, 10);
            
            let html = '<div class="pairs-list lazy-load-list">';
            topCombinations.forEach((pair, index) => {
                const correlationClass = getCorrelationClass(pair.correlation);
                const strengthLabel = getCorrelationStrength(pair.correlation);
                const barWidth = `${(Math.abs(pair.correlation) * 100).toFixed(0)}%`;
                const isActive = pair.has_detail ? 'active' : '';
                const canClick = !pair.has_detail; // ä¸»ç»„åˆä¸éœ€è¦ç‚¹å‡»
                
                html += `
                    <div class="pair-item ${correlationClass} ${isActive} ${canClick ? 'clickable' : ''}" 
                         ${canClick ? `onclick="loadPairDetail('${pair.fund1_code}', '${pair.fund2_code}')"` : ''}
                         style="${canClick ? 'cursor: pointer;' : ''}">
                        <div class="pair-rank">${index + 1}</div>
                        <div class="pair-funds">
                            <span class="fund-name">${escapeHtml(pair.fund1_name)}</span>
                            <span class="pair-arrow">â†”</span>
                            <span class="fund-name">${escapeHtml(pair.fund2_name)}</span>
                        </div>
                        <div class="pair-info">
                            <div class="pair-value">${pair.correlation.toFixed(4)}</div>
                            <div class="pair-strength">${strengthLabel}</div>
                        </div>
                        <div class="pair-bar">
                            <div class="correlation-bar" style="width: ${barWidth}"></div>
                        </div>
                        ${canClick ? '<div class="pair-hint"><i class="bi bi-arrow-right-circle"></i> ç‚¹å‡»æŸ¥çœ‹è¯¦æƒ…</div>' : ''}
                    </div>
                `;
            });
            html += '</div>';
            
            container.innerHTML = html;
        }
        
        // ä»ç»„åˆæ‘˜è¦æ›´æ–°æ¦‚è§ˆ
        function updateOverviewFromCombinations(combinations, fundCount) {
            document.getElementById('fund-count').textContent = fundCount;
            
            // è®¡ç®—é«˜ç›¸å…³æ€§ç»„åˆæ•°é‡
            let highCorrCount = 0;
            combinations.forEach(pair => {
                if (pair.correlation > 0.7) {
                    highCorrCount++;
                }
            });
            document.getElementById('high-correlation-count').textContent = highCorrCount;
            
            // è®¡ç®—åˆ†æ•£åº¦è¯„åˆ†
            let diversificationScore = 'ä¼˜ç§€';
            const totalPairs = combinations.length;
            if (totalPairs > 0) {
                const ratio = highCorrCount / totalPairs;
                if (ratio > 0.5) diversificationScore = 'è¾ƒå·®';
                else if (ratio > 0.3) diversificationScore = 'ä¸€èˆ¬';
                else if (ratio > 0.1) diversificationScore = 'è‰¯å¥½';
            }
            document.getElementById('diversification-score').textContent = diversificationScore;
        }
        
        // ä»ç»„åˆæ‘˜è¦æ¸²æŸ“ç›¸å…³æ€§çŸ©é˜µ
        function renderCorrelationMatrixFromSummary(combinations, fundCodes) {
            const container = document.getElementById('matrix-content');
            
            if (!combinations || combinations.length === 0) {
                container.innerHTML = '<div class="empty-data">æš‚æ— ç›¸å…³æ€§çŸ©é˜µæ•°æ®</div>';
                return;
            }
            
            // æ„å»ºåŸºé‡‘åç§°åˆ—è¡¨
            const fundNames = {};
            combinations.forEach(pair => {
                fundNames[pair.fund1_code] = pair.fund1_name;
                fundNames[pair.fund2_code] = pair.fund2_name;
            });
            
            const uniqueFunds = fundCodes.filter(code => fundNames[code]).map(code => ({
                code: code,
                name: fundNames[code] || code
            }));
            
            // æ„å»ºç›¸å…³æ€§çŸ©é˜µ
            const matrix = {};
            combinations.forEach(pair => {
                if (!matrix[pair.fund1_code]) matrix[pair.fund1_code] = {};
                if (!matrix[pair.fund2_code]) matrix[pair.fund2_code] = {};
                matrix[pair.fund1_code][pair.fund2_code] = pair.correlation;
                matrix[pair.fund2_code][pair.fund1_code] = pair.correlation;
            });
            
            // æ¸²æŸ“çŸ©é˜µï¼ˆç®€åŒ–ç‰ˆï¼‰
            let html = '<table class="correlation-matrix">';
            html += '<thead><tr><th class="corner-cell"></th>';
            uniqueFunds.forEach(fund => {
                html += `<th>${escapeHtml(fund.name)}</th>`;
            });
            html += '</tr></thead><tbody>';
            
            uniqueFunds.forEach((rowFund, rowIndex) => {
                html += `<tr><th>${escapeHtml(rowFund.name)}</th>`;
                uniqueFunds.forEach((colFund, colIndex) => {
                    if (rowIndex === colIndex) {
                        html += '<td class="corr-cell correlation-1">1.0000</td>';
                    } else {
                        const value = matrix[rowFund.code]?.[colFund.code] || 0;
                        let className = 'corr-cell ';
                        if (value > 0.7) className += 'correlation-high';
                        else if (value > 0.3) className += 'correlation-medium';
                        else className += 'correlation-low';
                        html += `<td class="${className}">${value.toFixed(4)}</td>`;
                    }
                });
                html += '</tr>';
            });
            
            html += '</tbody></table>';
            container.innerHTML = html;
        }
        
        // æ˜¾ç¤ºæ‡’åŠ è½½æç¤º
        function showLazyLoadHint(combinationCount) {
            const container = document.getElementById('interactive-charts-section');
            const hint = document.createElement('div');
            hint.className = 'lazy-load-hint';
            hint.innerHTML = `
                <div style="background: #e3f2fd; border-left: 4px solid #2196f3; padding: 12px 16px; margin: 10px 0; border-radius: 4px;">
                    <i class="bi bi-info-circle" style="color: #2196f3; margin-right: 8px;"></i>
                    <span style="color: #1976d2;">
                        å½“å‰æ˜¾ç¤ºç›¸å…³æ€§æœ€é«˜çš„ç»„åˆã€‚ç‚¹å‡»ä¸Šæ–¹"é«˜ç›¸å…³æ€§åŸºé‡‘ç»„åˆ"åˆ—è¡¨ä¸­çš„å…¶ä»–ç»„åˆå¯æŸ¥çœ‹è¯¦æƒ…ã€‚
                        å…± ${combinationCount} ä¸ªç»„åˆã€‚
                    </span>
                </div>
            `;
            container.querySelector('.section-body').insertBefore(hint, container.querySelector('.section-body').firstChild);
        }
        
        // æ›´æ–°æ¿€æ´»çš„ç»„åˆçŠ¶æ€
        function updateActiveCombination(fund1Code, fund2Code) {
            document.querySelectorAll('.pair-item').forEach(item => {
                item.classList.remove('active');
            });
            // æ‰¾åˆ°å¯¹åº”çš„å…ƒç´ å¹¶æ ‡è®°ä¸ºæ¿€æ´»
            // è¿™é‡Œå¯ä»¥æ ¹æ®å®é™…æƒ…å†µå®ç°
        }
        
        // æ˜¾ç¤ºåŠ è½½æŒ‡ç¤ºå™¨
        function showLoadingIndicator() {
            const indicator = document.getElementById('loading-indicator');
            if (indicator) {
                indicator.style.display = 'flex';
            }
        }
        
        // éšè—åŠ è½½æŒ‡ç¤ºå™¨
        function hideLoadingIndicator() {
            const indicator = document.getElementById('loading-indicator');
            if (indicator) {
                indicator.style.display = 'none';
            }
        }
        
        // æ˜¾ç¤ºé”™è¯¯æ¶ˆæ¯
        function showErrorMessage(message) {
            // åˆ›å»ºä¸€ä¸ªä¸´æ—¶é€šçŸ¥
            const notification = document.createElement('div');
            notification.className = 'alert alert-warning alert-dismissible fade show';
            notification.style.cssText = 'position: fixed; top: 20px; right: 20px; z-index: 9999; max-width: 400px;';
            notification.innerHTML = `
                <strong>æ³¨æ„</strong> ${message}
                <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
            `;
            document.body.appendChild(notification);
            
            // 5ç§’åè‡ªåŠ¨ç§»é™¤
            setTimeout(() => {
                notification.remove();
            }, 5000);
        }

        // ==================== æ•°æ®è·å– ====================
        function getAnalysisData() {
            // é¦–å…ˆå°è¯•ä» sessionStorage è·å–
            const sessionData = sessionStorage.getItem('correlationAnalysisData');
            if (sessionData) {
                try {
                    const data = JSON.parse(sessionData);
                    // æ¸…é™¤å·²ä½¿ç”¨çš„sessionæ•°æ®
                    sessionStorage.removeItem('correlationAnalysisData');
                    return data;
                } catch (error) {
                    console.error('è§£æsessionæ•°æ®å¤±è´¥:', error);
                }
            }
            
            // å¦‚æœsessionä¸­æ²¡æœ‰ï¼Œåˆ™å°è¯•ä»URLå‚æ•°è·å–ï¼ˆå‘åå…¼å®¹ï¼‰
            const urlParams = new URLSearchParams(window.location.search);
            const dataParam = urlParams.get('data');
            
            if (dataParam) {
                try {
                    return JSON.parse(decodeURIComponent(dataParam));
                } catch (error) {
                    console.error('è§£æURLæ•°æ®å¤±è´¥:', error);
                    return null;
                }
            }
            
            return null;
        }

        // ==================== é¡µé¢çŠ¶æ€æ§åˆ¶ ====================
        function showEmptyState() {
            document.getElementById('empty-state').style.display = 'flex';
            document.getElementById('fund-status-bar').style.display = 'none';
            document.getElementById('overview-cards').style.display = 'none';
            document.getElementById('top-pairs-section').style.display = 'none';
            document.getElementById('matrix-section').style.display = 'none';
            document.getElementById('enhanced-analysis-section').style.display = 'none';
            document.getElementById('interactive-charts-section').style.display = 'none';
        }

        function showAnalysisContent() {
            document.getElementById('empty-state').style.display = 'none';
            document.getElementById('fund-status-bar').style.display = 'flex';
            document.getElementById('overview-cards').style.display = 'grid';
            document.getElementById('top-pairs-section').style.display = 'block';
            document.getElementById('matrix-section').style.display = 'block';
            document.getElementById('enhanced-analysis-section').style.display = 'block';
            document.getElementById('interactive-charts-section').style.display = 'block';
            
            // æ›´æ–°çŠ¶æ€æ 
            updateStatusBar();
        }

        function updateStatusBar() {
            const statusText = document.getElementById('status-text');
            if (currentFundCodes.length > 0) {
                statusText.textContent = `æ­£åœ¨åˆ†æ ${currentFundCodes.length} åªåŸºé‡‘çš„ç›¸å…³æ€§`;
            }
        }

        // ==================== æ ¸å¿ƒåˆ†æåŠŸèƒ½ ====================
        function renderAnalysisResult(data) {
            // æ›´æ–°æ¦‚è§ˆå¡ç‰‡ï¼ˆä½¿ç”¨å·²æœ‰çš„æ•°æ®ï¼‰
            updateOverviewCards(data);
            
            // æ¸²æŸ“é«˜ç›¸å…³æ€§ç»„åˆï¼ˆå¦‚æœæœ‰çŸ©é˜µæ•°æ®ï¼‰
            if (data.correlation_matrix && data.fund_names) {
                renderTopPairs(data);
                renderCorrelationMatrix(data);
            } else {
                // æ˜¾ç¤ºåŠ è½½ä¸­çŠ¶æ€
                document.getElementById('top-pairs-content').innerHTML = `
                    <div class="loading-state">
                        <i class="bi bi-arrow-repeat"></i>
                        <span>æ­£åœ¨è®¡ç®—ç›¸å…³æ€§...</span>
                    </div>
                `;
                document.getElementById('matrix-content').innerHTML = `
                    <div class="loading-state">
                        <i class="bi bi-arrow-repeat"></i>
                        <span>æ­£åœ¨è®¡ç®—ç›¸å…³æ€§çŸ©é˜µ...</span>
                    </div>
                `;
            }
        }

        function updateOverviewCards(data) {
            if (!data) return;
            
            // æ›´æ–°åŸºé‡‘æ•°é‡ï¼ˆä¼˜å…ˆä½¿ç”¨ fund_codesï¼Œå…¶æ¬¡ä½¿ç”¨ fund_namesï¼‰
            const fundCount = data.fund_codes ? data.fund_codes.length : 
                             (data.fund_names ? data.fund_names.length : 0);
            document.getElementById('fund-count').textContent = fundCount;
            
            // è®¡ç®—é«˜ç›¸å…³æ€§ç»„åˆæ•°é‡
            let highCorrCount = 0;
            if (data.correlation_matrix) {
                for (let i = 0; i < data.correlation_matrix.length; i++) {
                    for (let j = i + 1; j < data.correlation_matrix[i].length; j++) {
                        if (data.correlation_matrix[i][j] > 0.7) {
                            highCorrCount++;
                        }
                    }
                }
            }
            document.getElementById('high-correlation-count').textContent = highCorrCount;
            
            // è®¡ç®—åˆ†æ•£åº¦è¯„åˆ† (ç®€å•çš„ç®—æ³•)
            let diversificationScore = 'ä¼˜ç§€';
            const totalPairs = fundCount * (fundCount - 1) / 2;
            if (totalPairs > 0) {
                const ratio = highCorrCount / totalPairs;
                if (ratio > 0.5) diversificationScore = 'è¾ƒå·®';
                else if (ratio > 0.3) diversificationScore = 'ä¸€èˆ¬';
                else if (ratio > 0.1) diversificationScore = 'è‰¯å¥½';
            }
            document.getElementById('diversification-score').textContent = diversificationScore;
        }

        // åœ¨è·å–å¢å¼ºåˆ†ææ•°æ®åæ›´æ–°æ‰€æœ‰ç»„ä»¶
        function updateAnalysisFromEnhanced(data) {
            if (!data) return;
            
            console.log('ğŸ“Š updateAnalysisFromEnhanced æ¥æ”¶æ•°æ®:', data);
            
            // ä»å¢å¼ºåˆ†ææ•°æ®ä¸­æå–åŸºé‡‘ä¿¡æ¯
            // å¤„ç†ä¸¤ç§å¯èƒ½çš„æ•°æ®ç»“æ„
            const fundCodes = data.fund_codes || data.basic_correlation?.fund_codes;
            const correlationMatrix = data.correlation_matrix || data.basic_correlation?.correlation_matrix;
            const fundNames = data.fund_names || data.basic_correlation?.fund_names || fundCodes;
            
            console.log('ğŸ“Š æå–çš„æ•°æ®:', { fundCodes, fundNames, hasMatrix: !!correlationMatrix });
            
            if (fundCodes && fundCodes.length > 0) {
                const fundCount = fundCodes.length;
                document.getElementById('fund-count').textContent = fundCount;
                
                // è®¡ç®—é«˜ç›¸å…³æ€§ç»„åˆæ•°é‡ï¼ˆä»çŸ©é˜µæ•°æ®ï¼‰
                let highCorrCount = 0;
                if (correlationMatrix) {
                    for (let i = 0; i < correlationMatrix.length; i++) {
                        for (let j = i + 1; j < correlationMatrix[i].length; j++) {
                            if (correlationMatrix[i][j] > 0.7) {
                                highCorrCount++;
                            }
                        }
                    }
                }
                document.getElementById('high-correlation-count').textContent = highCorrCount;
                
                // è®¡ç®—åˆ†æ•£åº¦è¯„åˆ†
                let diversificationScore = 'ä¼˜ç§€';
                const totalPairs = fundCount * (fundCount - 1) / 2;
                if (totalPairs > 0) {
                    const ratio = highCorrCount / totalPairs;
                    if (ratio > 0.5) diversificationScore = 'è¾ƒå·®';
                    else if (ratio > 0.3) diversificationScore = 'ä¸€èˆ¬';
                    else if (ratio > 0.1) diversificationScore = 'è‰¯å¥½';
                }
                document.getElementById('diversification-score').textContent = diversificationScore;
                
                // æ›´æ–°é«˜ç›¸å…³æ€§ç»„åˆå’Œç›¸å…³æ€§çŸ©é˜µï¼ˆä½¿ç”¨å¢å¼ºåˆ†æçš„æ•°æ®ï¼‰
                if (correlationMatrix && fundNames) {
                    const renderData = {
                        correlation_matrix: correlationMatrix,
                        fund_names: fundNames
                    };
                    console.log('ğŸ“Š æ¸²æŸ“é«˜ç›¸å…³æ€§ç»„åˆå’ŒçŸ©é˜µ:', renderData);
                    renderTopPairs(renderData);
                    renderCorrelationMatrix(renderData);
                } else {
                    console.warn('âš ï¸ ç¼ºå°‘çŸ©é˜µæˆ–åŸºé‡‘åç§°æ•°æ®ï¼Œæ— æ³•æ¸²æŸ“');
                    document.getElementById('top-pairs-content').innerHTML = `
                        <div class="error-message">
                            <i class="bi bi-exclamation-triangle-fill"></i>
                            <span>æ— æ³•è·å–ç›¸å…³æ€§æ•°æ®ï¼Œè¯·ç¨ååˆ·æ–°é‡è¯•</span>
                        </div>
                    `;
                    document.getElementById('matrix-content').innerHTML = `
                        <div class="error-message">
                            <i class="bi bi-exclamation-triangle-fill"></i>
                            <span>æ— æ³•è·å–ç›¸å…³æ€§çŸ©é˜µæ•°æ®</span>
                        </div>
                    `;
                }
            }
        }

        function renderTopPairs(data) {
            const container = document.getElementById('top-pairs-content');
            
            if (!data.correlation_matrix || !data.fund_names || data.fund_names.length < 2) {
                container.innerHTML = '<div class="empty-data">æ— æ³•æå–ç›¸å…³åŸºé‡‘ç»„åˆ</div>';
                return;
            }
            
            const topPairs = getTopCorrelatedPairs(data.correlation_matrix, data.fund_names);
            
            if (topPairs.length === 0) {
                container.innerHTML = `
                    <div class="success-state">
                        <i class="bi bi-check-circle-fill"></i>
                        <p>æœªå‘ç°é«˜ç›¸å…³æ€§åŸºé‡‘ç»„åˆï¼Œæ‚¨çš„æŠ•èµ„ç»„åˆåˆ†æ•£åº¦è‰¯å¥½</p>
                    </div>
                `;
                return;
            }
            
            let html = '<div class="pairs-list">';
            topPairs.forEach((pair, index) => {
                const correlationClass = getCorrelationClass(pair.correlation);
                const strengthLabel = getCorrelationStrength(pair.correlation);
                const barWidth = `${(Math.abs(pair.correlation) * 100).toFixed(0)}%`;
                
                // å¦‚æœæœ‰åŸºé‡‘ä»£ç ä¿¡æ¯ï¼Œåˆ™åŒæ—¶æ˜¾ç¤ºä»£ç å’Œåç§°
                let fund1Display = escapeHtml(pair.fund1);
                let fund2Display = escapeHtml(pair.fund2);
                
                // å°è¯•ä»æ•°æ®ä¸­è·å–åŸºé‡‘ä»£ç ï¼ˆå¦‚æœå¯ç”¨ï¼‰
                if (data.fund_codes && data.fund_names) {
                    const fund1Index = data.fund_names.indexOf(pair.fund1);
                    const fund2Index = data.fund_names.indexOf(pair.fund2);
                    
                    if (fund1Index !== -1 && fund1Index < data.fund_codes.length) {
                        fund1Display = `${data.fund_codes[fund1Index]} ${escapeHtml(pair.fund1)}`;
                    }
                    if (fund2Index !== -1 && fund2Index < data.fund_codes.length) {
                        fund2Display = `${data.fund_codes[fund2Index]} ${escapeHtml(pair.fund2)}`;
                    }
                }
                
                html += `
                    <div class="pair-item ${correlationClass}">
                        <div class="pair-rank">${index + 1}</div>
                        <div class="pair-funds">
                            <span class="fund-name">${fund1Display}</span>
                            <span class="pair-arrow">â†”</span>
                            <span class="fund-name">${fund2Display}</span>
                        </div>
                        <div class="pair-info">
                            <div class="pair-value">${pair.correlation.toFixed(4)}</div>
                            <div class="pair-strength">${strengthLabel}</div>
                        </div>
                        <div class="pair-bar">
                            <div class="correlation-bar" style="width: ${barWidth}"></div>
                        </div>
                    </div>
                `;
            });
            html += '</div>';
            
            container.innerHTML = html;
        }

        function renderCorrelationMatrix(data) {
            const container = document.getElementById('matrix-content');
            
            if (!data.correlation_matrix || !data.fund_names) {
                container.innerHTML = '<div class="empty-data">æš‚æ— ç›¸å…³æ€§çŸ©é˜µæ•°æ®</div>';
                return;
            }
            
            let html = `
                <table class="correlation-matrix">
                    <thead>
                        <tr>
                            <th class="corner-cell"></th>
            `;
            
            // è¡¨å¤´
            data.fund_names.forEach((fundName, index) => {
                let displayText = escapeHtml(fundName);
                // å¦‚æœæœ‰åŸºé‡‘ä»£ç ï¼ŒåŒæ—¶æ˜¾ç¤ºä»£ç å’Œåç§°
                if (data.fund_codes && index < data.fund_codes.length) {
                    displayText = `${data.fund_codes[index]} ${displayText}`;
                }
                html += `<th>${displayText}</th>`;
            });
            
            html += '</tr></thead><tbody>';
            
            // è¡¨æ ¼å†…å®¹
            data.correlation_matrix.forEach((row, rowIndex) => {
                // è¡Œæ ‡ç­¾ï¼šåŒæ—¶æ˜¾ç¤ºåŸºé‡‘ä»£ç å’Œåç§°
                let rowHeader = escapeHtml(data.fund_names[rowIndex]);
                if (data.fund_codes && rowIndex < data.fund_codes.length) {
                    rowHeader = `${data.fund_codes[rowIndex]} ${rowHeader}`;
                }
                html += `<tr>
                    <th>${rowHeader}</th>`;
                
                row.forEach(value => {
                    let className = 'corr-cell ';
                    if (value === 1) {
                        className += 'correlation-1';
                    } else if (value > 0.7) {
                        className += 'correlation-high';
                    } else if (value > 0.3) {
                        className += 'correlation-medium';
                    } else {
                        className += 'correlation-low';
                    }
                    
                    html += `<td class="${className}">${value.toFixed(4)}</td>`;
                });
                
                html += '</tr>';
            });
            
            html += '</tbody></table>';
            container.innerHTML = html;
        }

        // ==================== å¢å¼ºåˆ†æåŠŸèƒ½ ====================
        async function loadEnhancedCorrelationAnalysis(fundCodes) {
            const controller = new AbortController();
            const timeoutId = setTimeout(() => controller.abort(), 60000); // 60ç§’è¶…æ—¶
            
            try {
                console.log(`[Enhanced] å¼€å§‹åŠ è½½ç›¸å…³æ€§åˆ†æï¼ŒåŸºé‡‘æ•°é‡: ${fundCodes.length}`);
                const startTime = Date.now();
                
                const response = await fetch('/api/holdings/analyze/correlation', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ 
                        fund_codes: fundCodes,
                        enhanced_analysis: true
                    }),
                    signal: controller.signal
                });
                
                clearTimeout(timeoutId);
                
                const elapsed = Date.now() - startTime;
                console.log(`[Enhanced] APIå“åº”æ—¶é—´: ${elapsed}ms`);
                
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                
                const result = await response.json();
                console.log('[Enhanced] APIè¿”å›:', result);
                
                if (result.success) {
                    renderEnhancedAnalysis(result.data);
                    // ä½¿ç”¨å¢å¼ºåˆ†ææ•°æ®æ›´æ–°æ‰€æœ‰ç»„ä»¶
                    updateAnalysisFromEnhanced(result.data);
                } else {
                    showEnhancedError(result.error || 'åŠ è½½å¤±è´¥');
                }
            } catch (error) {
                clearTimeout(timeoutId);
                
                if (error.name === 'AbortError') {
                    console.error('[Enhanced] è¯·æ±‚è¶…æ—¶');
                    showEnhancedError('è¯·æ±‚è¶…æ—¶ï¼Œè¯·ç¨åé‡è¯•');
                } else {
                    console.error('[Enhanced] åŠ è½½å¤±è´¥:', error);
                    showEnhancedError('åŠ è½½å¤±è´¥: ' + error.message);
                }
            }
        }

        function renderEnhancedAnalysis(data) {
            const container = document.getElementById('enhanced-content');
            
            if (!data.enhanced_analysis) {
                container.innerHTML = '<div class="empty-data">æš‚æ— å¢å¼ºåˆ†ææ•°æ®</div>';
                return;
            }
            
            const enhancedData = data.enhanced_analysis;
            let html = '<div class="enhanced-grid">';
            
            // 1. å¤šç§ç›¸å…³ç³»æ•°å¯¹æ¯”
            if (enhancedData.enhanced_analysis?.correlation_methods) {
                html += `
                    <div class="enhanced-card">
                        <div class="enhanced-card-header">
                            <i class="bi bi-graph-up"></i>
                            <h4>å¤šç§ç›¸å…³ç³»æ•°å¯¹æ¯”</h4>
                        </div>
                        <div class="enhanced-card-body">
                            ${renderCorrelationMethodsTable(enhancedData.enhanced_analysis.correlation_methods)}
                        </div>
                    </div>
                `;
            }
            
            // 2. ä¸åŒå‘¨æœŸç›¸å…³æ€§
            if (enhancedData.enhanced_analysis?.period_correlation) {
                html += `
                    <div class="enhanced-card">
                        <div class="enhanced-card-header">
                            <i class="bi bi-clock-history"></i>
                            <h4>ä¸åŒå‘¨æœŸç›¸å…³æ€§</h4>
                        </div>
                        <div class="enhanced-card-body">
                            ${renderPeriodCorrelation(enhancedData.enhanced_analysis.period_correlation)}
                        </div>
                    </div>
                `;
            }
            
            // 3. åˆ†æç»“è®º
            if (enhancedData.enhanced_analysis?.interpretation) {
                html += `
                    <div class="enhanced-card full-width">
                        <div class="enhanced-card-header">
                            <i class="bi bi-chat-square-text"></i>
                            <h4>åˆ†æç»“è®º</h4>
                        </div>
                        <div class="enhanced-card-body">
                            <div class="interpretation-text">
                                ${escapeHtml(enhancedData.enhanced_analysis.interpretation)}
                            </div>
                        </div>
                    </div>
                `;
            }
            
            html += '</div>';
            container.innerHTML = html;
        }

        function renderCorrelationMethodsTable(correlationMethods) {
            const pairs = Object.keys(correlationMethods);
            if (pairs.length === 0) return '<div class="empty-data">æš‚æ— ç›¸å…³ç³»æ•°æ•°æ®</div>';
            
            const firstPair = correlationMethods[pairs[0]];
            const methods = Object.keys(firstPair);
            
            let html = '<table class="data-table">';
            html += '<thead><tr><th>ç±»å‹</th><th>ç³»æ•°</th><th>På€¼</th><th>è§£è¯»</th></tr></thead><tbody>';
            
            methods.forEach(method => {
                const methodName = method === 'pearson' ? 'çš®å°”é€Š' :
                                 method === 'spearman' ? 'æ–¯çš®å°”æ›¼' : 'è‚¯å¾·å°”';
                const methodData = firstPair[method];
                const strength = getCorrelationStrength(methodData.corr);
                
                html += `
                    <tr>
                        <td>${methodName}</td>
                        <td class="value ${getMethodColorClass(methodData.corr)}">${methodData.corr.toFixed(4)}</td>
                        <td>${methodData.p_value.toExponential(2)}</td>
                        <td>${strength}</td>
                    </tr>
                `;
            });
            
            html += '</tbody></table>';
            return html;
        }

        function renderPeriodCorrelation(periodCorrelation) {
            const periods = [
                { key: 'weekly', name: 'å‘¨æ”¶ç›Š', days: '5æ—¥' },
                { key: 'biweekly', name: 'åŒå‘¨æ”¶ç›Š', days: '10æ—¥' },
                { key: 'monthly', name: 'æœˆæ”¶ç›Š', days: '20æ—¥' },
                { key: 'quarterly', name: 'å­£åº¦æ”¶ç›Š', days: '60æ—¥' }
            ];
            
            let html = '<div class="period-grid">';
            periods.forEach(period => {
                const value = periodCorrelation[period.key] || 0;
                const strength = getCorrelationStrength(value);
                
                html += `
                    <div class="period-item">
                        <div class="period-name">${period.name}</div>
                        <div class="period-days">${period.days}</div>
                        <div class="period-value ${getMethodColorClass(value)}">${value.toFixed(4)}</div>
                        <div class="period-strength">${strength}</div>
                    </div>
                `;
            });
            html += '</div>';
            return html;
        }

        function showEnhancedError(message) {
            const container = document.getElementById('enhanced-content');
            container.innerHTML = `
                <div class="error-message" style="padding: 20px; text-align: center;">
                    <i class="bi bi-exclamation-triangle-fill" style="font-size: 2rem; color: #dc3545; margin-bottom: 10px; display: block;"></i>
                    <div style="margin-bottom: 15px;">${message}</div>
                    <button onclick="retryEnhancedAnalysis()" class="btn btn-primary btn-sm">
                        <i class="bi bi-arrow-clockwise"></i> é‡æ–°åŠ è½½
                    </button>
                </div>
            `;
        }
        
        // é‡è¯•å¢å¼ºåˆ†æ
        async function retryEnhancedAnalysis() {
            // æ˜¾ç¤ºåŠ è½½çŠ¶æ€
            document.getElementById('enhanced-content').innerHTML = `
                <div class="loading-state">
                    <i class="bi bi-arrow-repeat"></i>
                    <span>é‡æ–°åŠ è½½ä¸­...</span>
                </div>
            `;
            
            // é‡æ–°åŠ è½½
            const fundCodes = getSelectedFundCodes();
            if (fundCodes.length >= 2) {
                await loadEnhancedCorrelationAnalysis(fundCodes);
            } else {
                showEnhancedError('è¯·å…ˆé€‰æ‹©è‡³å°‘2åªåŸºé‡‘');
            }
        }

        // ==================== å›¾è¡¨åŠŸèƒ½ ====================
        async function loadCorrelationCharts(fundCodes) {
            try {
                const response = await fetch('/api/holdings/analyze/correlation-interactive', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ fund_codes: fundCodes })
                });
                
                const result = await response.json();
                if (result.success) {
                    renderInteractiveCharts(result.data);
                } else {
                    showChartsError(result.error || 'åŠ è½½å¤±è´¥');
                }
            } catch (error) {
                console.error('åŠ è½½å›¾è¡¨å¤±è´¥:', error);
                showChartsError('ç½‘ç»œé”™è¯¯');
            }
        }

        function renderInteractiveCharts(chartData) {
            const container = document.getElementById('interactive-charts-content');
            
            console.log('ğŸ“Š æ¸²æŸ“äº¤äº’å¼å›¾è¡¨ï¼Œæ•°æ®:', chartData);
            
            // æ£€æŸ¥æ•°æ®ç»“æ„å¹¶è®°å½•åŸºé‡‘åç§°ä¿¡æ¯
            if (chartData.primary_combination) {
                const pc = chartData.primary_combination;
                console.log('ğŸ“Š ä¸»ç»„åˆåŸºé‡‘:', pc.fund1_name, 'vs', pc.fund2_name);
            }
            if (chartData.all_funds_nav_comparison && chartData.all_funds_nav_comparison.funds) {
                console.log('ğŸ“Š å‡€å€¼å¯¹æ¯”åŸºé‡‘åˆ—è¡¨:', chartData.all_funds_nav_comparison.funds.map(f => f.fund_name || f.fund_code));
            }
            
            const hasValidData = chartData.scatter_data || 
                               (chartData.primary_combination && chartData.primary_combination.scatter_data);
            
            if (window.initCorrelationCharts && hasValidData) {
                window.initCorrelationCharts(container, chartData);
            } else {
                showChartsError('å›¾è¡¨æ¨¡å—æœªåŠ è½½æˆ–æ•°æ®æ ¼å¼ä¸æ­£ç¡®');
            }
        }

        function showChartsError(message) {
            document.getElementById('interactive-charts-content').innerHTML = `
                <div class="error-message">
                    <i class="bi bi-exclamation-triangle-fill"></i>
                    <span>å›¾è¡¨åŠ è½½å¤±è´¥: ${message}</span>
                </div>
            `;
        }

        // ==================== å·¥å…·å‡½æ•° ====================
        function getTopCorrelatedPairs(matrix, fundNames, topN = 10) {
            if (!matrix || !fundNames || matrix.length < 2) {
                return [];
            }
            
            const pairs = [];
            
            // éå†ç›¸å…³æ€§çŸ©é˜µï¼Œåªè€ƒè™‘ä¸Šä¸‰è§’ï¼ˆé¿å…é‡å¤ï¼‰
            for (let i = 0; i < matrix.length; i++) {
                for (let j = i + 1; j < matrix[i].length; j++) {
                    const correlation = matrix[i][j];
                    // åªæ·»åŠ ç›¸å…³æ€§å¤§äº0.8çš„ç»„åˆ
                    if (correlation > 0.8) {
                        pairs.push({
                            fund1: fundNames[i],
                            fund2: fundNames[j],
                            correlation: correlation
                        });
                    }
                }
            }
            
            // æŒ‰ç›¸å…³æ€§é™åºæ’åº
            pairs.sort((a, b) => b.correlation - a.correlation);
            
            // è¿”å›å‰Nä¸ª
            return pairs.slice(0, topN);
        }

        function getCorrelationClass(correlation) {
            if (correlation > 0.7) return 'corr-high';
            if (correlation > 0.3) return 'corr-medium';
            return 'corr-low';
        }

        function getCorrelationStrength(corr) {
            const absCorr = Math.abs(corr);
            if (absCorr >= 0.8) return 'æå¼ºç›¸å…³';
            if (absCorr >= 0.6) return 'å¼ºç›¸å…³';
            if (absCorr >= 0.4) return 'ä¸­ç­‰ç›¸å…³';
            if (absCorr >= 0.2) return 'å¼±ç›¸å…³';
            return 'æå¼±ç›¸å…³';
        }

        function getMethodColorClass(corr) {
            const absCorr = Math.abs(corr);
            if (absCorr >= 0.8) return 'value-high';
            if (absCorr >= 0.6) return 'value-medium-high';
            if (absCorr >= 0.4) return 'value-medium';
            if (absCorr >= 0.2) return 'value-low';
            return 'value-very-low';
        }

        function escapeHtml(text) {
            if (!text) return '';
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }

        function toggleMatrixFullscreen() {
            const wrapper = document.getElementById('matrix-wrapper');
            wrapper.classList.toggle('fullscreen');
        }
    </script>
    
    <script src="{{ url_for('static', filename='js/fund-correlation-charts.js') }}"></script>
</body>
</html>
